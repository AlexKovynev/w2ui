/* w2ui 2.0.x (nightly) (5/12/2022, 10:04:46 AM) (c) http://w2ui.com, vitmalina@gmail.com */
class w2event{constructor(e,t){Object.assign(this,{type:t.type??null,detail:t,owner:e,target:t.target??null,phase:t.phase??"before",object:t.object??null,execute:null,isStopped:!1,isCancelled:!1,onComplete:null,doneHandlers:[]}),delete t.type,delete t.target,delete t.object,this.complete=new Promise((e,t)=>{this._resolve=e,this._reject=t})}finish(e){e&&w2utils.extend(this.detail,e),this.phase="after",this.owner.trigger.call(this.owner,this)}done(e){this.doneHandlers.push(e)}preventDefault(){this._reject(),this.isCancelled=!0}stopPropagation(){this.isStopped=!0}}class w2base{constructor(e){if(this.activeEvents=[],this.listeners=[],void 0!==e){if(!w2utils.checkName(e))return;w2ui[e]=this}this.debug=!1}on(e,t){return(e="string"==typeof e?e.split(/[,\s]+/):[e]).forEach(i=>{var e="string"==typeof i?i:i.type+":"+i.execute+"."+i.scope;if("string"==typeof i){let[e,t]=i.split(".");var[s,l]=e.replace(":complete",":after").replace(":done",":after").split(":");i={type:s,execute:l??"before",scope:t}}(i=w2utils.extend({type:null,execute:"before",onComplete:null},i)).type?t?(Array.isArray(this.listeners)||(this.listeners=[]),this.listeners.push({name:e,edata:i,handler:t}),this.debug&&console.log("w2base: add event",{name:e,edata:i,handler:t})):console.log("ERROR: You must specify event handler function when calling .on() method of "+this.name):console.log("ERROR: You must specify event type when calling .on() method of "+this.name)}),this}off(e,r){return(e="string"==typeof e?e.split(/[,\s]+/):[e]).forEach(i=>{var e="string"==typeof i?i:i.type+":"+i.execute+"."+i.scope;if("string"==typeof i){let[e,t]=i.split(".");var[s,l]=e.replace(":complete",":after").replace(":done",":after").split(":");i={type:s||"*",execute:l||"",scope:t||""}}if((i=w2utils.extend({type:null,execute:null,onComplete:null},i)).type||i.scope){r=r||null;let t=0;this.listeners=this.listeners.filter(e=>"*"!==i.type&&i.type!==e.edata.type||""!==i.execute&&i.execute!==e.edata.execute||""!==i.scope&&i.scope!==e.edata.scope||null!=i.handler&&i.handler!==e.edata.handler||(t++,!1)),this.debug&&console.log(`w2base: remove event (${t})`,{name:e,edata:i,handler:r})}else console.log("ERROR: You must specify event type when calling .off() method of "+this.name)}),this}trigger(e,i){if(1==arguments.length?i=e:(i.type=e,i.target=i.target??this),w2utils.isPlainObject(i)&&"after"==i.phase){if(!(i=this.activeEvents.find(e=>e.type==i.type&&e.target==i.target)))return void console.log(`ERROR: Cannot find even handler for "${i.type}" on "${i.target}".`);console.log("NOTICE: This syntax \"edata.trigger({ phase: 'after' })\" is outdated. Use edata.finish() instead.")}else i instanceof w2event||(i=new w2event(this,i),this.activeEvents.push(i));let s,t,l;Array.isArray(this.listeners)||(this.listeners=[]),this.debug&&console.log(`w2base: trigger "${i.type}:${i.phase}"`,i);for(let e=this.listeners.length-1;0<=e;e--){let t=this.listeners[e];if(!(null==t||t.edata.type!==i.type&&"*"!==t.edata.type||t.edata.target!==i.target&&null!=t.edata.target||t.edata.execute!==i.phase&&"*"!==t.edata.execute&&"*"!==t.edata.phase)&&(Object.keys(t.edata).forEach(e=>{null==i[e]&&null!=t.edata[e]&&(i[e]=t.edata[e])}),s=[],l=new RegExp(/\((.*?)\)/).exec(String(t.handler).split("=>")[0]),l&&(s=l[1].split(/\s*,\s*/)),2===s.length?(t.handler.call(this,i.target,i),this.debug&&console.log(" - call (old)",t.handler)):(t.handler.call(this,i),this.debug&&console.log(" - call",t.handler)),!0===i.isStopped||!0===i.stop))return i}var r="on"+i.type.substr(0,1).toUpperCase()+i.type.substr(1);if("before"===i.phase&&"function"==typeof this[r]&&(t=this[r],s=[],l=new RegExp(/\((.*?)\)/).exec(String(t).split("=>")[0]),l&&(s=l[1].split(/\s*,\s*/)),2===s.length?(t.call(this,i.target,i),this.debug&&console.log(" - call: on[Event] (old)",t)):(t.call(this,i),this.debug&&console.log(" - call: on[Event]",t)),!0===i.isStopped||!0===i.stop))return i;if(null!=i.object&&"before"===i.phase&&"function"==typeof i.object[r]&&(t=i.object[r],s=[],l=new RegExp(/\((.*?)\)/).exec(String(t).split("=>")[0]),l&&(s=l[1].split(/\s*,\s*/)),2===s.length?(t.call(this,i.target,i),this.debug&&console.log(" - call: edata.object (old)",t)):(t.call(this,i),this.debug&&console.log(" - call: edata.object",t)),!0===i.isStopped||!0===i.stop))return i;if("after"===i.phase){"function"==typeof i.onComplete&&i.onComplete.call(this,i);for(let e=0;e<i.doneHandlers.length;e++)"function"==typeof i.doneHandlers[e]&&(i.doneHandlers[e].call(this,i),this.debug&&console.log(" - call: done",t));i._resolve(i),this.debug&&console.log(`w2base: trigger "${i.type}:${i.phase}"`,i)}return i}}const w2locale={locale:"en-US",dateFormat:"m/d/yyyy",timeFormat:"hh:mi pm",datetimeFormat:"m/d/yyyy|hh:mi pm",currencyPrefix:"$",currencySuffix:"",currencyPrecision:2,groupSymbol:",",decimalSymbol:".",shortmonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],fullmonths:["January","February","March","April","May","June","July","August","September","October","November","December"],shortdays:["M","T","W","T","F","S","S"],fulldays:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],weekStarts:"S",phrases:{"${count} letters or more...":"---","Add new record":"---","Add New":"---","Advanced Search":"---",after:"---","AJAX error. See console for more details.":"---","All Fields":"---",All:"---",Any:"---","Are you sure you want to delete ${count} ${records}?":"---","Attach files by dragging and dropping or Click to Select":"---",before:"---","begins with":"---",begins:"---",between:"---",buffered:"---",Cancel:"---",Close:"---",Column:"---",Confirmation:"---",contains:"---",Copied:"---","Copy to clipboard":"---","Current Date & Time":"---","Delete selected records":"---",Delete:"---",'Do you want to delete search item "${item}"?':"---","Edit selected record":"---",Edit:"---","Empty list":"---","ends with":"---",ends:"---","Field should be at least ${count} characters.":"---",Hide:"---",in:"---","is not":"---",is:"---","less than":"---","Line #":"---","Load ${count} more...":"---","Loading...":"---","Maximum number of files is ${count}":"---","Maximum total size is ${count}":"---",Modified:"---","more than":"---","Multiple Fields":"---",Name:"---","No items found":"---","No matches":"---",No:"---",none:"---","Not a float":"---","Not a hex number":"---","Not a valid date":"---","Not a valid email":"---","Not alpha-numeric":"---","Not an integer":"---","Not in money format":"---","not in":"---",Notification:"---",of:"---",Ok:"---",Opacity:"---","Record ID":"---",record:"---",records:"---","Refreshing...":"---","Reload data in the list":"---",Remove:"---","Request aborted.":"---","Required field":"---",Reset:"---","Restore Default State":"---","Returned data is not in valid JSON format.":"---","Save changed records":"---","Save Grid State":"---",Save:"---","Saved Searches":"---","Saving...":"---","Search took ${count} seconds":"---",Search:"---","Select Hour":"---","Select Minute":"---",selected:"---","Server Response ${count} seconds":"---","Show/hide columns":"---",Show:"---",Size:"---",Skip:"---","Sorting took ${count} seconds":"---","Type to search...":"---",Type:"---",Yes:"---",Yesterday:"---","Your remote data source record count has changed, reloading from the first record.":"---"}};class Query{constructor(e,t,i){this.version=.4,this.context=t??document,this.previous=i??null;let s=[];if(Array.isArray(e))s=e;else if(Query._isEl(e))s=[e];else if(e instanceof Query)s=e.nodes;else if("string"==typeof e){if("function"!=typeof this.context.querySelector)throw new Error("Invalid context");s=Array.from(this.context.querySelectorAll(e))}else if(null==e)s=[];else{i=Array.from(e??[]);if("object"!=typeof e||!Array.isArray(i))throw new Error(`Invalid selector "${e}"`);s=i}this.nodes=s,this.length=s.length,this.each((e,t)=>{this[t]=e})}static _isEl(e){return e instanceof Document||e instanceof DocumentFragment||e instanceof HTMLElement||e instanceof Text}static _fragment(e){let t=document.createElement("template");return t.innerHTML=e,t.content}_insert(l,i){let r=[],n=this.length;if(!(n<1)){var t=Query._isEl(i);let e=this;if("string"==typeof i)this.each(e=>{var t=Query._fragment(i);r.push(...t.childNodes),e[l](t)});else if(i instanceof Query){let s=1==n&&1==i.length;i.each(i=>{this.each(e=>{var t=s?i:i.cloneNode(!0);e[l](t),r.push(t)})}),s||i.remove()}else{if(!t)throw new Error(`Incorrect argument for "${l}(html)". It expects one string argument.`);this.each(e=>{var t=1===n?i:Query._fragment(i.outerHTML);r.push(...1===n?[i]:t.childNodes),e[l](t)}),1<n&&i.remove()}return"replaceWith"==l&&(e=new Query(r,this.context,this)),e}}_save(e,t,i){e._mQuery=e._mQuery??{},Array.isArray(i)?(e._mQuery[t]=e._mQuery[t]??[],e._mQuery[t].push(...i)):null!=i?e._mQuery[t]=i:delete e._mQuery[t]}get(e){var t=this[e=e<0?this.length+e:e];return t||(null!=e?null:this.nodes)}eq(e){let t=[this[e=e<0?this.length+e:e]];return null==t[0]&&(t=[]),new Query(t,this.context,this)}then(e){e=e(this);return null!=e?e:this}find(t){let i=[];return this.each(e=>{e=Array.from(e.querySelectorAll(t));0<e.length&&i.push(...e)}),new Query(i,this.context,this)}filter(t){let i=[];return this.each(e=>{(e===t||"string"==typeof t&&e.matches&&e.matches(t)||"function"==typeof t&&t(e))&&i.push(e)}),new Query(i,this.context,this)}shadow(e){let t=[];this.each(e=>{e.shadowRoot&&t.push(e.shadowRoot)});let i=new Query(t,this.context,this);return e?i.find(e):i}closest(t){let i=[];return this.each(e=>{e=e.closest(t);e&&i.push(e)}),new Query(i,this.context,this)}host(t){let i=[],s=e=>e.parentNode?s(e.parentNode):e,l=e=>{e=s(e);i.push(e.host||e),e.host&&t&&l(e.host)};return this.each(e=>{l(e)}),new Query(i,this.context,this)}parent(e){return this.parents(e,!0)}parents(e,t){let i=[],s=e=>{if(-1==i.indexOf(e)&&i.push(e),!t&&e.parentNode)return s(e.parentNode)};this.each(e=>{e.parentNode&&s(e.parentNode)});let l=new Query(i,this.context,this);return e?l.filter(e):l}each(i){return this.nodes.forEach((e,t)=>{i(e,t,this)}),this}append(e){return this._insert("append",e)}prepend(e){return this._insert("prepend",e)}after(e){return this._insert("after",e)}before(e){return this._insert("before",e)}replace(e){return this._insert("replaceWith",e)}remove(){return this.each(e=>{e.remove()}),this}css(e,t){let i=e;var s=arguments.length;return 0===s||1===s&&"string"==typeof e?this[0]?"string"==typeof e?this[0].style[e]:Object.fromEntries(this[0].style.cssText.split(";").filter(e=>!!e).map(e=>e.split(":").map(e=>e.trim()))):void 0:("object"!=typeof e&&(i={},i[e]=t),this.each((t,e)=>{Object.keys(i).forEach(e=>{t.style[e]=i[e]})}),this)}addClass(e){return this.toggleClass(e,!0),this}removeClass(e){return this.toggleClass(e,!1),this}toggleClass(t,s){return"string"==typeof t&&(t=t.split(/[,\s]+/)),this.each(i=>{let e=t;null==e&&!1===s&&(e=Array.from(i.classList)),e.forEach(t=>{if(""!==t){let e=null!=s?s?"add":"remove":"toggle";i.classList[e](t)}})}),this}hasClass(e){if(null==(e="string"==typeof e?e.split(/[,\s]+/):e)&&0<this.length)return Array.from(this[0].classList);let i=!1;return this.each(t=>{i=i||e.every(e=>Array.from(t.classList).includes(e))}),i}on(e,s,l){"function"==typeof s&&(l=s,s=void 0);let r;return s?.delegate&&(r=s.delegate,delete s.delegate),(e=e.split(/[,\s]+/)).forEach(e=>{let[t,i]=String(e).toLowerCase().split(".");if(r){let i=l;l=e=>{var t=query(e.target).parents(r);0<t.length?e.delegate=t[0]:e.delegate=e.target,(e.target.matches(r)||0<t.length)&&i(e)}}this.each(e=>{this._save(e,"events",[{event:t,scope:i,callback:l,options:s}]),e.addEventListener(t,l,s)})}),this}off(e,t,r){return"function"==typeof t&&(r=t,t=void 0),(e=e.split(/[,\s]+/)).forEach(e=>{let[s,l]=String(e).toLowerCase().split(".");this.each(t=>{if(Array.isArray(t._mQuery?.events))for(let e=t._mQuery.events.length-1;0<=e;e--){var i=t._mQuery.events[e];null==l||""===l?i.event!=s||i.scope!=l||i.callback!=r&&null!=r||(t.removeEventListener(s,i.callback,i.options),t._mQuery.events.splice(e,1)):i.event!=s&&""!==s||i.scope!=l&&"*"!==l||(t.removeEventListener(i.event,i.callback,i.options),t._mQuery.events.splice(e,1))}})}),this}trigger(e,t){let i;return i=e instanceof Event||e instanceof CustomEvent?e:new(["click","dblclick","mousedown","mouseup","mousemove"].includes(e)?MouseEvent:["keydown","keyup","keypress"].includes(e)?KeyboardEvent:Event)(e,t),this.each(e=>{e.dispatchEvent(i)}),this}attr(t,i){if(void 0===i&&"string"==typeof t)return this[0]?this[0].getAttribute(t):void 0;{let e={};return"object"==typeof t?e=t:e[t]=i,this.each(i=>{Object.entries(e).forEach(([e,t])=>{i.setAttribute(e,t)})}),this}}removeAttr(){return this.each(t=>{Array.from(arguments).forEach(e=>{t.removeAttribute(e)})}),this}prop(t,i){if(void 0===i&&"string"==typeof t)return this[0]?this[0][t]:void 0;{let e={};return"object"==typeof t?e=t:e[t]=i,this.each(i=>{Object.entries(e).forEach(([e,t])=>{i[e]=t})}),this}}removeProp(){return this.each(t=>{Array.from(arguments).forEach(e=>{delete t[e]})}),this}data(i,t){if(i instanceof Object)Object.entries(i).forEach(e=>{this.data(e[0],e[1])});else{if(i&&-1!=i.indexOf("-")&&console.error(`Key "${i}" contains "-" (dash). Dashes are not allowed in property names. Use camelCase instead.`),!(arguments.length<2))return this.each(e=>{null!=t?e.dataset[i]=t instanceof Object?JSON.stringify(t):t:delete e.dataset[i]}),this;if(this[0]){let t=Object.assign({},this[0].dataset);return Object.keys(t).forEach(e=>{if(t[e].startsWith("[")||t[e].startsWith("{"))try{t[e]=JSON.parse(t[e])}catch(e){}}),i?t[i]:t}}}removeData(t){return this.each(e=>{delete e.dataset[t]}),this}show(){return this.toggle(!0)}hide(){return this.toggle(!1)}toggle(i){return this.each(e=>{var t=e.style.display;"none"==t&&null==i||!0===i?(e.style.display=e._mQuery?.prevDisplay??"",this._save(e,"prevDisplay",null)):("none"!=t&&this._save(e,"prevDisplay",t),e.style.display="none")})}empty(){return this.html("")}html(e){return this.prop("innerHTML",e)}text(e){return this.prop("textContent",e)}val(e){return this.prop("value",e)}change(){return this.trigger("change")}click(){return this.trigger("click")}}let query=function(e,t){if("function"!=typeof e)return new Query(e,t);"complete"==document.readyState?e():window.addEventListener("load",e)};query.html=e=>{e=Query._fragment(e);return query(e.children,e)};let w2ui={};class Utils{constructor(){this.version="2.0.x",this.tmp={},this.settings=this.extend({},{dataType:"HTTPJSON",dateStartYear:1950,dateEndYear:2030,macButtonOrder:!1,warnNoPhrase:!1},w2locale,{phrases:null}),this.i18nCompare=Intl.Collator().compare,this.hasLocalStorage=function(){var e="w2ui_test";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}}(),this.isMac=/Mac/i.test(navigator.platform),this.isMobile=/(iphone|ipod|ipad|mobile|android)/i.test(navigator.userAgent),this.isIOS=/(iphone|ipod|ipad)/i.test(navigator.platform),this.isAndroid=/(android)/i.test(navigator.userAgent),this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.formatters={number(e,t){return 20<parseInt(t)&&(t=20),parseInt(t)<0&&(t=0),null==e||""===e?"":w2utils.formatNumber(parseFloat(e),t,!0)},float(e,t){return w2utils.formatters.number(e,t)},int(e,t){return w2utils.formatters.number(e,0)},money(e,t){if(null==e||""===e)return"";e=w2utils.formatNumber(Number(e),w2utils.settings.currencyPrecision);return(w2utils.settings.currencyPrefix||"")+e+(w2utils.settings.currencySuffix||"")},currency(e,t){return w2utils.formatters.money(e,t)},percent(e,t){return null==e||""===e?"":w2utils.formatNumber(e,t||1)+"%"},size(e,t){return null==e||""===e?"":w2utils.formatSize(parseInt(e))},date(e,t){if(""===t&&(t=w2utils.settings.dateFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return!1===i&&(i=w2utils.isDate(e,t,!0)),'<span title="'+i+'">'+w2utils.formatDate(i,t)+"</span>"},datetime(e,t){if(""===t&&(t=w2utils.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return!1===i&&(i=w2utils.isDate(e,t,!0)),'<span title="'+i+'">'+w2utils.formatDateTime(i,t)+"</span>"},time(e,t){if(""===t&&(t=w2utils.settings.timeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t="h24"===(t="h12"===t?"hh:mi pm":t)?"h24:mi":t,!0);return!1===i&&(i=w2utils.isDate(e,t,!0)),'<span title="'+i+'">'+w2utils.formatTime(e,t)+"</span>"},timestamp(e,t){if(""===t&&(t=w2utils.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return!1===i&&(i=w2utils.isDate(e,t,!0)),i.toString?i.toString():""},gmt(e,t){if(""===t&&(t=w2utils.settings.datetimeFormat),null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,t,!0);return!1===i&&(i=w2utils.isDate(e,t,!0)),i.toUTCString?i.toUTCString():""},age(e,t){if(null==e||0===e||""===e)return"";let i=w2utils.isDateTime(e,null,!0);return!1===i&&(i=w2utils.isDate(e,null,!0)),'<span title="'+i+'">'+w2utils.age(e)+(t?" "+t:"")+"</span>"},interval(e,t){return null==e||0===e||""===e?"":w2utils.interval(e)+(t?" "+t:"")},toggle(e,t){return e?"Yes":""},password(t,e){let i="";for(let e=0;e<t.length;e++)i+="*";return i}}}isBin(e){return/^[0-1]+$/.test(e)}isInt(e){return/^[-+]?[0-9]+$/.test(e)}isFloat(e){return("number"==typeof(e="string"==typeof e?e.replace(this.settings.groupSymbol,"").replace(this.settings.decimalSymbol,"."):e)||"string"==typeof e&&""!==e)&&!isNaN(Number(e))}isMoney(e){if("object"==typeof e||""===e)return!1;if(this.isFloat(e))return!0;var t=this.settings;let i=new RegExp("^"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[-+]?"+(t.currencyPrefix?"\\"+t.currencyPrefix+"?":"")+"[0-9]*[\\"+t.decimalSymbol+"]?[0-9]+"+(t.currencySuffix?"\\"+t.currencySuffix+"?":"")+"$","i");return"string"==typeof e&&(e=e.replace(new RegExp(t.groupSymbol,"g"),"")),i.test(e)}isHex(e){return/^(0x)?[0-9a-fA-F]+$/.test(e)}isAlphaNumeric(e){return/^[a-zA-Z0-9_-]+$/.test(e)}isEmail(e){return/^[a-zA-Z0-9._%\-+]+@[а-яА-Яa-zA-Z0-9.-]+\.[а-яА-Яa-zA-Z]+$/.test(e)}isIpAddress(e){let t=new RegExp("^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$");return t.test(e)}isDate(i,e,t){if(!i)return!1;let s="Invalid Date",l,r,n;if(null==e&&(e=this.settings.dateFormat),"function"==typeof i.getFullYear)n=i.getFullYear(),l=i.getMonth()+1,r=i.getDate();else if(parseInt(i)==i&&0<parseInt(i))i=new Date(parseInt(i)),n=i.getFullYear(),l=i.getMonth()+1,r=i.getDate();else{if(i=String(i),new RegExp("mon","ig").test(e)){e=e.replace(/month/gi,"m").replace(/mon/gi,"m").replace(/dd/gi,"d").replace(/[, ]/gi,"/").replace(/\/\//g,"/").toLowerCase(),i=i.replace(/[, ]/gi,"/").replace(/\/\//g,"/").toLowerCase();for(let t=0,e=this.settings.fullmonths.length;t<e;t++){let e=this.settings.fullmonths[t];i=i.replace(new RegExp(e,"ig"),parseInt(t)+1).replace(new RegExp(e.substr(0,3),"ig"),parseInt(t)+1)}}var a=i.replace(/-/g,"/").replace(/\./g,"/").toLowerCase().split("/"),e=e.replace(/-/g,"/").replace(/\./g,"/").toLowerCase();"mm/dd/yyyy"===e&&(l=a[0],r=a[1],n=a[2]),"m/d/yyyy"===e&&(l=a[0],r=a[1],n=a[2]),"dd/mm/yyyy"===e&&(l=a[1],r=a[0],n=a[2]),"d/m/yyyy"===e&&(l=a[1],r=a[0],n=a[2]),"yyyy/dd/mm"===e&&(l=a[2],r=a[1],n=a[0]),"yyyy/d/m"===e&&(l=a[2],r=a[1],n=a[0]),"yyyy/mm/dd"===e&&(l=a[1],r=a[2],n=a[0]),"yyyy/m/d"===e&&(l=a[1],r=a[2],n=a[0]),"mm/dd/yy"===e&&(l=a[0],r=a[1],n=a[2]),"m/d/yy"===e&&(l=a[0],r=a[1],n=parseInt(a[2])+1900),"dd/mm/yy"===e&&(l=a[1],r=a[0],n=parseInt(a[2])+1900),"d/m/yy"===e&&(l=a[1],r=a[0],n=parseInt(a[2])+1900),"yy/dd/mm"===e&&(l=a[2],r=a[1],n=parseInt(a[0])+1900),"yy/d/m"===e&&(l=a[2],r=a[1],n=parseInt(a[0])+1900),"yy/mm/dd"===e&&(l=a[1],r=a[2],n=parseInt(a[0])+1900),"yy/m/d"===e&&(l=a[1],r=a[2],n=parseInt(a[0])+1900)}return!!this.isInt(n)&&(!!this.isInt(l)&&(!!this.isInt(r)&&(n=+n,l=+l,r=+r,s=new Date(n,l-1,r),s.setFullYear(n),null!=l&&("Invalid Date"!==String(s)&&(s.getMonth()+1===l&&s.getDate()===r&&s.getFullYear()===n&&(!0!==t||s))))))}isTime(e,t){if(null==e)return!1;let i,s,l;s=0<=(e=(e=String(e)).toUpperCase()).indexOf("AM");var r=(l=0<=e.indexOf("PM"))||s;i=r?12:24;e=(e=e.replace("AM","").replace("PM","").trim()).split(":");let n=parseInt(e[0]||0),a=parseInt(e[1]||0),o=parseInt(e[2]||0);return(r&&1===e.length||2===e.length||3===e.length)&&(!(""===e[0]||n<0||n>i||!this.isInt(e[0])||2<e[0].length)&&(!(1<e.length&&(""===e[1]||a<0||59<a||!this.isInt(e[1])||2!==e[1].length))&&(!(2<e.length&&(""===e[2]||o<0||59<o||!this.isInt(e[2])||2!==e[2].length))&&((r||i!==n||0===a&&0===o)&&((!r||1!==e.length||0!==n)&&(!0!==t||(l&&12!==n&&(n+=12),s&&12===n&&(n+=12),{hours:n,minutes:a,seconds:o})))))))}isDateTime(i,s,l){if("function"==typeof i.getFullYear)return!0!==l||i;var r=parseInt(i);if(r===i)return!(r<0)&&(!0!==l||new Date(r));r=String(i).indexOf(" ");if(r<0)return!(String(i).indexOf("T")<0||"Invalid Date"==String(new Date(i)))&&(!0!==l||new Date(i));{let e=(s=null==s?this.settings.datetimeFormat:s).split("|");r=[i.substr(0,r),i.substr(r).trim()];e[0]=e[0].trim(),e[1]&&(e[1]=e[1].trim());let t=this.isDate(r[0],e[0],!0);r=this.isTime(r[1],!0);return!1!==t&&!1!==r&&(!0!==l||(t.setHours(r.hours),t.setMinutes(r.minutes),t.setSeconds(r.seconds),t))}}age(e){let t;if(""===e||null==e)return"";if(t="function"==typeof e.getFullYear?e:parseInt(e)==e&&0<parseInt(e)?new Date(parseInt(e)):new Date(e),"Invalid Date"===String(t))return"";let i=new Date;e=(i.getTime()-t.getTime())/1e3;let s="",l="";return e<0?(s=0,l="sec"):e<60?(s=Math.floor(e),l="sec",e<0&&(s=0,l="sec")):e<3600?(s=Math.floor(e/60),l="min"):e<86400?(s=Math.floor(e/60/60),l="hour"):e<2592e3?(s=Math.floor(e/24/60/60),l="day"):e<31536e3?(s=Math.floor(e/30/24/60/60*10)/10,l="month"):e<126144e3?(s=Math.floor(e/365/24/60/60*10)/10,l="year"):126144e3<=e&&(s=Math.floor(e/365.25/24/60/60*10)/10,l="year"),s+" "+l+(1<s?"s":"")}interval(e){let t="";return t=e<100?"< 0.01 sec":e<1e3?Math.floor(e/10)/100+" sec":e<1e4?Math.floor(e/100)/10+" sec":e<6e4?Math.floor(e/1e3)+" secs":e<36e5?Math.floor(e/6e4)+" mins":e<864e5?Math.floor(e/36e5*10)/10+" hours":e<2628e6?Math.floor(e/864e5*10)/10+" days":e<31536e6?Math.floor(e/2628e6*10)/10+" months":Math.floor(e/31536e5)/10+" years",t}date(e){if(""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let t=new Date(e);if(this.isInt(e)&&(t=new Date(Number(e))),"Invalid Date"===String(t))return"";var i=this.settings.shortmonths;let s=new Date,l=new Date;l.setTime(l.getTime()-864e5);var r=i[t.getMonth()]+" "+t.getDate()+", "+t.getFullYear(),n=i[s.getMonth()]+" "+s.getDate()+", "+s.getFullYear(),a=i[l.getMonth()]+" "+l.getDate()+", "+l.getFullYear(),e=t.getHours()-(12<t.getHours()?12:0)+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+" "+(12<=t.getHours()?"pm":"am"),i=t.getHours()-(12<t.getHours()?12:0)+":"+(t.getMinutes()<10?"0":"")+t.getMinutes()+":"+(t.getSeconds()<10?"0":"")+t.getSeconds()+" "+(12<=t.getHours()?"pm":"am");let o=r==n?e:r;return r==a&&(o=this.lang("Yesterday")),'<span title="'+r+" "+i+'">'+o+"</span>"}formatSize(e){if(!this.isFloat(e)||""===e)return"";if(0===(e=parseFloat(e)))return 0;var t=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return(Math.floor(e/Math.pow(1024,t)*10)/10).toFixed(0===t?0:1)+" "+(["Bt","KB","MB","GB","TB","PB","EB","ZB"][t]||"??")}formatNumber(e,t,i){if(null==e||""===e||"object"==typeof e)return"";let s={minimumFractionDigits:t,maximumFractionDigits:t,useGrouping:i};return(null==t||t<0)&&(s.minimumFractionDigits=0,s.maximumFractionDigits=20),parseFloat(e).toLocaleString(this.settings.locale,s)}formatDate(e,t){if(t=t||this.settings.dateFormat,""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let i=new Date(e);if(this.isInt(e)&&(i=new Date(Number(e))),"Invalid Date"===String(i))return"";var s=i.getFullYear(),l=i.getMonth(),e=i.getDate();return t.toLowerCase().replace("month",this.settings.fullmonths[l]).replace("mon",this.settings.shortmonths[l]).replace(/yyyy/g,("000"+s).slice(-4)).replace(/yyy/g,("000"+s).slice(-4)).replace(/yy/g,("0"+s).slice(-2)).replace(/(^|[^a-z$])y/g,"$1"+s).replace(/mm/g,("0"+(l+1)).slice(-2)).replace(/dd/g,("0"+e).slice(-2)).replace(/th/g,1==e?"st":"th").replace(/th/g,2==e?"nd":"th").replace(/th/g,3==e?"rd":"th").replace(/(^|[^a-z$])m/g,"$1"+(l+1)).replace(/(^|[^a-z$])d/g,"$1"+e)}formatTime(e,t){if(t=t||this.settings.timeFormat,""===e||null==e||"object"==typeof e&&!e.getMonth)return"";let i=new Date(e);if(this.isInt(e)&&(i=new Date(Number(e))),this.isTime(e)&&(r=this.isTime(e,!0),i=new Date,i.setHours(r.hours),i.setMinutes(r.minutes)),"Invalid Date"===String(i))return"";let s="am",l=i.getHours();var r=i.getHours();let n=i.getMinutes(),a=i.getSeconds();return n<10&&(n="0"+n),a<10&&(a="0"+a),-1===t.indexOf("am")&&-1===t.indexOf("pm")||(12<=l&&(s="pm"),12<l&&(l-=12),0===l&&(l=12)),t.toLowerCase().replace("am",s).replace("pm",s).replace("hhh",l<10?"0"+l:l).replace("hh24",r<10?"0"+r:r).replace("h24",r).replace("hh",l).replace("mm",n).replace("mi",n).replace("ss",a).replace(/(^|[^a-z$])h/g,"$1"+l).replace(/(^|[^a-z$])m/g,"$1"+n).replace(/(^|[^a-z$])s/g,"$1"+a)}formatDateTime(e,t){let i;return""===e||null==e||"object"==typeof e&&!e.getMonth?"":("string"!=typeof t?i=[this.settings.dateFormat,this.settings.timeFormat]:(i=t.split("|"),i[0]=i[0].trim(),i[1]=1<i.length?i[1].trim():this.settings.timeFormat),"h12"===i[1]&&(i[1]="h:m pm"),"h24"===i[1]&&(i[1]="h24:m"),this.formatDate(e,i[0])+" "+this.formatTime(e,i[1]))}stripSpaces(i){if(null==i)return i;switch(typeof i){case"number":break;case"string":i=String(i).replace(/(?:\r\n|\r|\n)/g," ").replace(/\s\s+/g," ").trim();break;case"object":Array.isArray(i)?(i=this.extend([],i)).forEach((e,t)=>{i[t]=this.stripSpaces(e)}):(i=this.extend({},i),Object.keys(i).forEach(e=>{i[e]=this.stripSpaces(i[e])}))}return i}stripTags(i){if(null==i)return i;switch(typeof i){case"number":break;case"string":i=String(i).replace(/<(?:[^>=]|='[^']*'|="[^"]*"|=[^'"][^\s>]*)*>/gi,"");break;case"object":Array.isArray(i)?(i=this.extend([],i)).forEach((e,t)=>{i[t]=this.stripTags(e)}):(i=this.extend({},i),Object.keys(i).forEach(e=>{i[e]=this.stripTags(i[e])}))}return i}encodeTags(i){if(null==i)return i;switch(typeof i){case"number":break;case"string":i=String(i).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;");break;case"object":Array.isArray(i)?(i=this.extend([],i)).forEach((e,t)=>{i[t]=this.encodeTags(e)}):(i=this.extend({},i),Object.keys(i).forEach(e=>{i[e]=this.encodeTags(i[e])}))}return i}decodeTags(i){if(null==i)return i;switch(typeof i){case"number":break;case"string":i=String(i).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&");break;case"object":Array.isArray(i)?(i=this.extend([],i)).forEach((e,t)=>{i[t]=this.decodeTags(e)}):(i=this.extend({},i),Object.keys(i).forEach(e=>{i[e]=this.decodeTags(i[e])}))}return i}escapeId(e){if(""===e||null==e)return"";return(e+"").replace(/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,(e,t)=>t?"\0"===e?"�":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e)}unescapeId(e){if(""===e||null==e)return"";return e.replace(/\\[\da-fA-F]{1,6}[\x20\t\r\n\f]?|\\([^\r\n\f])/g,(e,t)=>{e="0x"+e.slice(1)-65536;return t||(e<0?String.fromCharCode(65536+e):String.fromCharCode(e>>10|55296,1023&e|56320))})}base64encode(e){let t="",i,s,l,r,n,a,o,h=0;var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";for(e=function(t){t=String(t).replace(/\r\n/g,"\n");let i="";for(let e=0;e<t.length;e++){var s=t.charCodeAt(e);s<128?i+=String.fromCharCode(s):(127<s&&s<2048?i+=String.fromCharCode(s>>6|192):(i+=String.fromCharCode(s>>12|224),i+=String.fromCharCode(s>>6&63|128)),i+=String.fromCharCode(63&s|128))}return i}(e);h<e.length;)i=e.charCodeAt(h++),s=e.charCodeAt(h++),l=e.charCodeAt(h++),r=i>>2,n=(3&i)<<4|s>>4,a=(15&s)<<2|l>>6,o=63&l,isNaN(s)?a=o=64:isNaN(l)&&(o=64),t=t+d.charAt(r)+d.charAt(n)+d.charAt(a)+d.charAt(o);return t}base64decode(e){let t="";var i,s,l,r,n,a;let o=0;var h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");o<e.length;)l=h.indexOf(e.charAt(o++)),i=(15&(r=h.indexOf(e.charAt(o++))))<<4|(n=h.indexOf(e.charAt(o++)))>>2,s=(3&n)<<6|(a=h.indexOf(e.charAt(o++))),t+=String.fromCharCode(l<<2|r>>4),64!==n&&(t+=String.fromCharCode(i)),64!==a&&(t+=String.fromCharCode(s));return t=function(e){let t="",i=0,s=0,l,r;for(;i<e.length;)(s=e.charCodeAt(i))<128?(t+=String.fromCharCode(s),i++):191<s&&s<224?(l=e.charCodeAt(i+1),t+=String.fromCharCode((31&s)<<6|63&l),i+=2):(l=e.charCodeAt(i+1),r=e.charCodeAt(i+2),t+=String.fromCharCode((15&s)<<12|(63&l)<<6|63&r),i+=3);return t}(t),t}async sha256(e){e=(new TextEncoder).encode(e);return crypto.subtle.digest("SHA-256",e).then(e=>{const t=Array.from(new Uint8Array(e));return t.map(e=>e.toString(16).padStart(2,"0")).join("")})}transition(r,n,a,o){return new Promise((e,t)=>{let i=r.computedStyleMap(),s=i.get("width").value,l=i.get("height").value;if(r&&n){switch(r.parentNode.style.cssText+="perspective: 900px; overflow: hidden;",r.style.cssText+="; position: absolute; z-index: 1019; backface-visibility: hidden",n.style.cssText+="; position: absolute; z-index: 1020; backface-visibility: hidden",a){case"slide-left":r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; transform: translate3d("+s+"px, 0, 0)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",r.style.cssText+="transition: 0.5s; transform: translate3d(-"+s+"px, 0, 0)"},1);break;case"slide-right":r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; transform: translate3d(-"+s+"px, 0, 0)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: translate3d(0px, 0, 0)",r.style.cssText+="transition: 0.5s; transform: translate3d("+s+"px, 0, 0)"},1);break;case"slide-down":r.style.cssText+="overflow: hidden; z-index: 1; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; z-index: 0; transform: translate3d(0, 0, 0)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",r.style.cssText+="transition: 0.5s; transform: translate3d(0, "+l+"px, 0)"},1);break;case"slide-up":r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; transform: translate3d(0, "+l+"px, 0)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)",r.style.cssText+="transition: 0.5s; transform: translate3d(0, 0, 0)"},1);break;case"flip-left":r.style.cssText+="overflow: hidden; transform: rotateY(0deg)",n.style.cssText+="overflow: hidden; transform: rotateY(-180deg)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: rotateY(0deg)",r.style.cssText+="transition: 0.5s; transform: rotateY(180deg)"},1);break;case"flip-right":r.style.cssText+="overflow: hidden; transform: rotateY(0deg)",n.style.cssText+="overflow: hidden; transform: rotateY(180deg)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: rotateY(0deg)",r.style.cssText+="transition: 0.5s; transform: rotateY(-180deg)"},1);break;case"flip-down":r.style.cssText+="overflow: hidden; transform: rotateX(0deg)",n.style.cssText+="overflow: hidden; transform: rotateX(180deg)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: rotateX(0deg)",r.style.cssText+="transition: 0.5s; transform: rotateX(-180deg)"},1);break;case"flip-up":r.style.cssText+="overflow: hidden; transform: rotateX(0deg)",n.style.cssText+="overflow: hidden; transform: rotateX(-180deg)",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: rotateX(0deg)",r.style.cssText+="transition: 0.5s; transform: rotateX(180deg)"},1);break;case"pop-in":r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(.8); opacity: 0;",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; transform: scale(1); opacity: 1;",r.style.cssText+="transition: 0.5s;"},1);break;case"pop-out":r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); transform: scale(1); opacity: 1;",n.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0); opacity: 0;",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; opacity: 1;",r.style.cssText+="transition: 0.5s; transform: scale(1.7); opacity: 0;"},1);break;default:r.style.cssText+="overflow: hidden; transform: translate3d(0, 0, 0)",n.style.cssText+="overflow: hidden; translate3d(0, 0, 0); opacity: 0;",query(n).show(),setTimeout(()=>{n.style.cssText+="transition: 0.5s; opacity: 1;",r.style.cssText+="transition: 0.5s"},1)}setTimeout(()=>{"slide-down"===a&&(query(r).css("z-index","1019"),query(n).css("z-index","1020")),n&&query(n).css({opacity:"1"}).css({transition:"",transform:""}),r&&query(r).css({opacity:"1"}).css({transition:"",transform:""}),"function"==typeof o&&o(),e()},500)}else console.log("ERROR: Cannot do transition when one of the divs is null")})}lock(s,l={}){if(null!=s){"string"==typeof l&&(l={msg:l}),arguments[2]&&(l.spinner=arguments[2]),l=this.extend({spinner:!1},l),s&&!(s instanceof HTMLElement)&&s[0]instanceof HTMLElement&&(s=Array.isArray(s)?s:s.get()),l.msg||0===l.msg||(l.msg=""),this.unlock(s),query(s).prepend('<div class="w2ui-lock"></div><div class="w2ui-lock-msg"></div>');let e=query(s).find(".w2ui-lock"),t=query(s).find(".w2ui-lock-msg");l.msg||t.css({"background-color":"transparent","background-image":"none",border:"0px","box-shadow":"none"}),!0===l.spinner&&(l.msg=`<div class="w2ui-spinner" ${l.msg?"":'style="width: 35px; height: 35px"'}></div>`+l.msg),l.msg?t.html(l.msg).css("display","block"):t.remove(),null!=l.opacity&&e.css("opacity",l.opacity),e.css({display:"block"}),l.bgColor&&e.css({"background-color":l.bgColor});let i=e.css("opacity")||.3;e.on("mousedown",function(){"function"==typeof l.onClick?l.onClick():e.css({transition:".2s",opacity:1.5*i})}).on("mouseup",function(){"function"!=typeof l.onClick&&e.css({transition:".2s",opacity:i})}).on("mousewheel",function(e){e&&(e.stopPropagation(),e.preventDefault())})}}unlock(e,t){null!=e&&(e&&!(e instanceof HTMLElement)&&e[0]instanceof HTMLElement&&(e=Array.isArray(e)?e:e.get()),this.isInt(t)?(query(e).find(".w2ui-lock").css({transition:t/1e3+"s",opacity:0}),query(e).find(".w2ui-lock-msg").remove(),setTimeout(()=>{query(e).find(".w2ui-lock").remove()},t)):(query(e).find(".w2ui-lock").remove(),query(e).find(".w2ui-lock-msg").remove()))}message(r,n){let i,a,o;if("object"==typeof(n="string"==typeof n?{width:n.length<300?350:550,height:n.length<300?170:250,text:n}:n)){null!=n.text&&(n.body=`<div class="w2ui-centered w2ui-msg-text">${n.text}</div>`),null==n.width&&(n.width=350),null==n.height&&(n.height=170),null==n.hideOn&&(n.hideOn=["esc"]),null==n.on&&(d=n,n=new w2base,w2utils.extend(n,d)),n.on("open",e=>{w2utils.bindEvents(query(n.box).find(".w2ui-eaction"),n),query(e.detail.box).find("button, input, textarea, [name=hidden-first]").off(".message").on("keydown.message",function(e){27==e.keyCode&&n.hideOn.includes("esc")&&(n.cancelAction?n.action(n.cancelAction):n.close())}),n.setFocus(n.focus)}),n.off(".prom");let s={self:n,action(e){return n.on("action.prom",e),s},close(e){return n.on("close.prom",e),s},then(e){return n.on("open:after.prom",e),s}};null==n.actions&&null==n.buttons&&null==n.html&&(n.actions={Ok(e){e.detail.self.close()}}),n.off(".buttons"),null!=n.actions&&(n.buttons="",Object.keys(n.actions).forEach(e=>{var t=n.actions[e];let i=e;"function"==typeof t&&(n.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${e}","event"]'>${e}</button>`),"object"==typeof t&&(n.buttons+=`<button class="w2ui-btn w2ui-eaction ${t.class||""}" data-click='["action","${e}","event"]'
                        style="${t.style}" ${t.attrs}>${t.text||e}</button>`,i=Array.isArray(n.actions)?t.text:e),"string"==typeof t&&(n.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${t}","event"]'>${t}</button>`,i=t),"string"==typeof i&&(i=i[0].toLowerCase()+i.substr(1).replace(/\s+/g,"")),s[i]=function(t){return n.on("action.buttons",e=>{e.detail.action[0].toLowerCase()+e.detail.action.substr(1).replace(/\s+/g,"")==i&&t(e)}),s}})),Array("html","body","buttons").forEach(e=>{n[e]=String(n[e]??"").trim()}),""===n.body&&""===n.buttons||(n.html=`
                <div class="w2ui-message-body">${n.body||""}</div>
                <div class="w2ui-message-buttons">${n.buttons||""}</div>
            `);let e=getComputedStyle(r.box);var h=parseFloat(e.width),d=parseFloat(e.height);let t=0;r.after&&(e=getComputedStyle(query(r.after).get(0)),t=parseInt("none"!=e.display?parseInt(e.height):0)),n.width>h&&(n.width=h-10),n.height>d-t&&(n.height=d-10-t),n.originalWidth=n.width,n.originalHeight=n.height,parseInt(n.width)<0&&(n.width=h+n.width),parseInt(n.width)<10&&(n.width=10),parseInt(n.height)<0&&(n.height=d+n.height-t),parseInt(n.height)<10&&(n.height=10),n.originalHeight<0&&(n.height=d+n.originalHeight-t),n.originalWidth<0&&(n.width=h+2*n.originalWidth);let l=query(r.box).find(r.after);return n.tmp||(n.tmp={zIndex:l.css("z-index"),overflow:e.overflow}),""===n.html&&""===n.body&&""===n.buttons?u():(n.msgIndex=query(r.box).find(".w2ui-message").length,0===n.msgIndex&&"function"==typeof this.lock&&(query(r.box).css("overflow","hidden"),r.owner?r.owner.lock(r.param):this.lock(r.box)),query(r.box).find(".w2ui-message").css("z-index",1390),l.css("z-index",1501),h=`
                <div id="w2ui-message-${r.owner?.name}-${n.msgIndex}" class="w2ui-message" data-mousedown="stop"
                    style="z-index: 1500; left: ${(h-n.width)/2}px; top: ${t}px;
                        width: ${n.width}px; height: ${n.height}px; transform: translateY(-${n.height}px)"
                    ${n.hideOn.includes("click")?r.param?`data-click='["message", "${r.param}"]`:'data-click="message"':""}>
                    <span name="hidden-first" tabindex="0" style="position: absolute; top: -100px"></span>
                    ${n.html}
                    <span name="hidden-last" tabindex="0" style="position: absolute; top: -100px"></span>
                </div>`,r.after?query(r.box).find(r.after).after(h):query(r.box).prepend(h),n.box=query(r.box).find(`#w2ui-message-${r.owner?.name}-${n.msgIndex}`)[0],w2utils.bindEvents(n.box,this),query(n.box).addClass("animating"),(n.box._msg_options=n).box._msg_prevFocus=document.activeElement,setTimeout(()=>(o=n.trigger("open",{target:this.name,box:n.box,self:n}),!0===o.isCancelled?(query(r.box).find(`#w2ui-message-${r.owner?.name}-${n.msgIndex}`).remove(),void(0===n.msgIndex&&(l.css("z-index",n.tmp.zIndex),query(r.box).css("overflow",n.tmp.overflow)))):void query(n.box).css({transition:"0.3s",transform:"translateY(0px)"})),0),a=setTimeout(()=>{query(r.box).find(`#w2ui-message-${r.owner?.name}-${n.msgIndex}`).removeClass("animating").css({transition:"0s"}),o.finish()},300)),n.action=(e,t)=>{let i=n.actions[e];i instanceof Object&&i.onClick&&(i=i.onClick);let s=n.trigger("action",{target:this.name,action:e,self:n,originalEvent:t,value:n.input?n.input.value:null});!0!==s.isCancelled&&("function"==typeof i&&i(s),s.finish())},n.close=()=>{if(o=n.trigger("close",{target:"self",box:n.box,self:n}),!0!==o.isCancelled){if(clearTimeout(a),query(n.box).hasClass("animating"))return clearTimeout(i),void c.call(this,n);query(n.box).addClass("w2ui-closing animating").css({transition:"0.15s",transform:"translateY(-"+n.height+"px)"}),0!==n.msgIndex&&query(r.box).find(`#w2ui-message-${r.owner?.name}-${n.msgIndex-1}`).css("z-index",1499),i=setTimeout(()=>{c.call(this,n)},150)}},n.setFocus=t=>{var e=query(r.box).find(".w2ui-message").length-1;let s=query(r.box).find(`#w2ui-message-${r.owner?.name}-${e}`),l="input, button, select, textarea, [contentEditable], .w2ui-input";if(null!=t){let e=isNaN(t)?s.find(l).filter(t).get(0):s.find(l).get(t);e?.focus()}else s.find("[name=hidden-first]").get(0)?.focus();query(r.box).find(".w2ui-message").find(l+",[name=hidden-first],[name=hidden-last]").off(".keep-focus"),query(s).find(l+",[name=hidden-first],[name=hidden-last]").on("blur.keep-focus",function(e){setTimeout(()=>{var e=document.activeElement,t=0<query(s).find(l).filter(e).length,i=query(e).attr("name");!t&&e&&e!==document.body&&query(s).find(l).get(0)?.focus(),"hidden-last"==i&&query(s).find(l).get(0)?.focus(),"hidden-first"==i&&query(s).find(l).get(-1)?.focus()},1)})},s;function u(){let e=query(r?.box).find(".w2ui-message");0!=e.length&&"function"==typeof(n=e.get(0)._msg_options||{})?.close&&n.close()}function c(e){let i=e.box._msg_prevFocus;if(query(r.box).find(".w2ui-message").length<=1?r.owner?r.owner.unlock(r.param,150):this.unlock(r.box,150):query(r.box).find(`#w2ui-message-${r.owner?.name}-${e.msgIndex-1}`).css("z-index",1500),i){let t=query(i).closest(".w2ui-message");if(0<t.length){let e=t.get(0)._msg_options;e.setFocus(i)}else i.focus()}else"function"==typeof r.owner?.focus&&owner.focus();query(e.box).remove(),0===e.msgIndex&&(l.css("z-index",e.tmp.zIndex),query(r.box).css("overflow",e.tmp.overflow)),e.trigger&&o.finish()}}else u()}confirm(e,t){w2utils.normButtons(t="string"==typeof t?{text:t}:t,{yes:"Yes",no:"No"});let i=w2utils.message(e,t);return i&&i.action(e=>{e.detail.self.close()}),i}normButtons(i,s){i.actions=i.actions??{};let e=Object.keys(s);return e.forEach(t=>{var e=i["btn_"+t];e&&(s[t]={text:w2utils.lang(e.text??""),class:e.class??"",style:e.style??"",attrs:e.attrs??""},delete i["btn_"+t]),Array("text","class","style","attrs").forEach(e=>{i[t+"_"+e]&&("string"==typeof s[t]&&(s[t]={text:s[t]}),s[t][e]=i[t+"_"+e],delete i[t+"_"+e])})}),e.includes("yes")&&e.includes("no")&&(w2utils.settings.macButtonOrder?w2utils.extend(i.actions,{no:s.no,yes:s.yes}):w2utils.extend(i.actions,{yes:s.yes,no:s.no})),e.includes("ok")&&e.includes("cancel")&&(w2utils.settings.macButtonOrder?w2utils.extend(i.actions,{cancel:s.cancel,ok:s.ok}):w2utils.extend(i.actions,{ok:s.ok,cancel:s.cancel})),i}getSize(e,t){let i=0;if(0<(e=query(e)).length){e=e[0];var s=getComputedStyle(e);switch(t){case"width":i=parseFloat(s.width),"auto"===s.width&&(i=0);break;case"height":i=parseFloat(s.height),"auto"===s.height&&(i=0)}}return i}getStrWidth(e,t){query("body").append(`
            <div id="_tmp_width" style="position: absolute; top: -9000px; ${t||""}">
                ${this.encodeTags(e)}
            </div>`);e=query("#_tmp_width")[0].clientWidth;return query("#_tmp_width").remove(),e}execTemplate(e,i){return"string"==typeof e&&i&&"object"==typeof i?e.replace(/\${([^}]+)?}/g,function(e,t){return i[t]||t}):e}marker(e,i,s={onlyFirst:!1,wholeWord:!1}){Array.isArray(i)||(i=null!=i&&""!==i?[i]:[]);let l=s.wholeWord;query(e).each(t=>{!function(e){var t=/\<span class=\"w2ui\-marker\"\>((.|\n|\r)*)\<\/span\>/gi;for(;-1!==e.innerHTML.indexOf('<span class="w2ui-marker"');)e.innerHTML=e.innerHTML.replace(t,"$1")}(t),i.forEach(e=>{e=(e="string"!=typeof e?String(e):e).replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&").replace(/&/g,"&amp;").replace(/</g,"&gt;").replace(/>/g,"&lt;");e=new RegExp((l?"\\b":"")+e+(l?"\\b":"")+"(?!([^<]+)?>)","i"+(s.onlyFirst?"":"g"));t.innerHTML=t.innerHTML.replace(e,e=>'<span class="w2ui-marker">'+e+"</span>")})})}lang(e,t){if(!e||null==this.settings.phrases||"string"!=typeof e||"<=>=".includes(e))return this.execTemplate(e,t);let i=this.settings.phrases[e];return null==i?(i=e,this.settings.warnNoPhrase&&(this.settings.missing||(this.settings.missing={}),this.settings.missing[e]="---",this.settings.phrases[e]="---",console.log(`Missing translation for "%c${e}%c", see %c w2utils.settings.phrases %c with value "---"`,"color: orange","","color: #999",""))):"---"!==i||this.settings.warnNoPhrase||(i=e),"---"===i&&(i=`<span ${this.tooltip(e)}>---</span>`),this.execTemplate(i,t)}locale(l,i,r){return new Promise((s,t)=>{if(Array.isArray(l)){this.settings.phrases={};let i=[],t={};return l.forEach((e,t)=>{5===e.length&&(e="locale/"+e.toLowerCase()+".json",l[t]=e),i.push(this.locale(e,!0,!1))}),void Promise.allSettled(i).then(e=>{e.forEach(e=>{t[e.value.file]=e.value.data}),l.forEach(e=>{this.settings=this.extend({},this.settings,t[e])}),s()})}(l=l||"en-us")instanceof Object?this.settings=this.extend({},this.settings,w2locale,l):(5===l.length&&(l="locale/"+l.toLowerCase()+".json"),fetch(l,{method:"GET"}).then(e=>e.json()).then(e=>{!0!==r&&(this.settings=i?this.extend({},this.settings,e):this.extend({},this.settings,w2locale,{phrases:{}},e)),s({file:l,data:e})}).catch(e=>{console.log("ERROR: Cannot load locale "+l),t(e)}))})}scrollBarSize(){if(this.tmp.scrollBarSize)return this.tmp.scrollBarSize;return query("body").append(`
            <div id="_scrollbar_width" style="position: absolute; top: -300px; width: 100px; height: 100px; overflow-y: scroll;">
                <div style="height: 120px">1</div>
            </div>
        `),this.tmp.scrollBarSize=100-query("#_scrollbar_width > div")[0].clientWidth,query("#_scrollbar_width").remove(),this.tmp.scrollBarSize}checkName(e){return null==e?(console.log('ERROR: Property "name" is required but not supplied.'),!1):null!=w2ui[e]?(console.log(`ERROR: Object named "${e}" is already registered as w2ui.${e}.`),!1):!!this.isAlphaNumeric(e)||(console.log('ERROR: Property "name" has to be alpha-numeric (a-z, 0-9, dash and underscore).'),!1)}checkUniqueId(t,i,s,l){Array.isArray(i)||(i=[i]);let r=!0;return i.forEach(e=>{e.id===t&&(console.log(`ERROR: The item id="${t}" is not unique within the ${s} "${l}".`,i),r=!1)}),r}encodeParams(t,i=""){let s="";return Object.keys(t).forEach(e=>{""!=s&&(s+="&"),"object"==typeof t[e]?s+=this.encodeParams(t[e],i+e+(i?"]":"")+"["):s+=`${i}${e}${i?"]":""}=${t[e]}`}),s}parseRoute(e){let n=[];e=e.replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,(e,t,i,s,l,r)=>(n.push({name:s,optional:!!r}),t=t||"",(r?"":t)+"(?:"+(r?t:"")+(i||"")+(l||(i?"([^/.]+?)":"([^/]+?)"))+")"+(r||""))).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)");return{path:new RegExp("^"+e+"$","i"),keys:n}}cssPrefix(e,t,i){let s={},l={},r="";for(var n in e instanceof Object?(s=e,!0===t&&(i=!0)):s[e]=t,s)l[n]=s[n],l["-webkit-"+n]=s[n],l["-moz-"+n]=s[n].replace("-webkit-","-moz-"),l["-ms-"+n]=s[n].replace("-webkit-","-ms-"),l["-o-"+n]=s[n].replace("-webkit-","-o-");if(!0===i)for(var a in l)r+=a+": "+l[a]+"; ";else r=l;return r}getCursorPosition(i){if(null==i)return null;let s=0,t=i.ownerDocument||i.document,e=t.defaultView||t.parentWindow,l;if(["INPUT","TEXTAREA"].includes(i.tagName))s=i.selectionStart;else if(e.getSelection){if(l=e.getSelection(),0<l.rangeCount){let e=l.getRangeAt(0),t=e.cloneRange();t.selectNodeContents(i),t.setEnd(e.endContainer,e.endOffset),s=t.toString().length}}else if((l=t.selection)&&"Control"!==l.type){var r=l.createRange();let e=t.body.createTextRange();e.moveToElementText(i),e.setEndPoint("EndToEnd",r),s=e.text.length}return s}setCursorPosition(s,l,r){if(null!=s){let e=document.createRange(),i,t=window.getSelection();if(["INPUT","TEXTAREA"].includes(s.tagName))s.setSelectionRange(l,r??l);else{for(let t=0;t<s.childNodes.length;t++){let e=query(s.childNodes[t]).text();if(s.childNodes[t].tagName&&(e=query(s.childNodes[t]).html(),e=e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&nbsp;/g," ")),l<=e.length){i=s.childNodes[t],i.childNodes&&0<i.childNodes.length&&(i=i.childNodes[0]),i.childNodes&&0<i.childNodes.length&&(i=i.childNodes[0]);break}l-=e.length}null!=i&&(l>i.length&&(l=i.length),e.setStart(i,l),r?e.setEnd(i,r):e.collapse(!0),t.removeAllRanges(),t.addRange(e))}}}parseColor(e){if("string"!=typeof e)return null;let t={};if(3===(e="#"===(e=e.trim().toUpperCase())[0]?e.substr(1):e).length)t={r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:1};else if(6===e.length)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:1};else if(8===e.length)t={r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:Math.round(parseInt(e.substr(6,2),16)/255*100)/100};else if(4<e.length&&"RGB("===e.substr(0,4)){var i=e.replace("RGB","").replace(/\(/g,"").replace(/\)/g,"").split(",");t={r:parseInt(i[0],10),g:parseInt(i[1],10),b:parseInt(i[2],10),a:1}}else{if(!(5<e.length&&"RGBA("===e.substr(0,5)))return null;e=e.replace("RGBA","").replace(/\(/g,"").replace(/\)/g,"").split(",");t={r:parseInt(e[0],10),g:parseInt(e[1],10),b:parseInt(e[2],10),a:parseFloat(e[3])}}return t}hsv2rgb(e,t,i,s){let l,r,n,a,o,h,d,u;switch(1===arguments.length&&(t=e.s,i=e.v,s=e.a,e=e.h),h=(i/=100)*(1-(t/=100)),d=i*(1-(o=6*(e/=360)-(a=Math.floor(6*e)))*t),u=i*(1-(1-o)*t),a%6){case 0:l=i,r=u,n=h;break;case 1:l=d,r=i,n=h;break;case 2:l=h,r=i,n=u;break;case 3:l=h,r=d,n=i;break;case 4:l=u,r=h,n=i;break;case 5:l=i,r=h,n=d}return{r:Math.round(255*l),g:Math.round(255*r),b:Math.round(255*n),a:null!=s?s:1}}rgb2hsv(e,t,i,s){1===arguments.length&&(t=e.g,i=e.b,s=e.a,e=e.r);let l=Math.max(e,t,i),r=Math.min(e,t,i),n=l-r,a,o=0===l?0:n/l,h=l/255;switch(l){case r:a=0;break;case e:a=t-i+n*(t<i?6:0),a/=6*n;break;case t:a=i-e+2*n,a/=6*n;break;case i:a=e-t+4*n,a/=6*n}return{h:Math.round(360*a),s:Math.round(100*o),v:Math.round(100*h),a:null!=s?s:1}}tooltip(e,t){let i="mouseenter",s="mouseleave",l=!1;return t=(t="object"==typeof e?e:t)||{},"string"==typeof e&&(t.html=e),t.showOn&&(i=t.showOn,delete t.showOn),t.hideOn&&(s=t.hideOn,delete t.hideOn),!0===t.overlay&&(l=!0,delete t.overlay),` on${i}="jQuery(this).${l?"w2overlay":"w2tag"}(`+`JSON.parse(w2utils.base64decode('${this.base64encode(JSON.stringify(t))}')))" `+`on${s}="jQuery(this).${l?"w2overlay":"w2tag"}(`+`${l&&null!=t.name?`JSON.parse(w2utils.base64decode('${this.base64encode(JSON.stringify({name:t.name}))}'))`:""}`+')"'}isPlainObject(e){if(null==e)return!1;if("[object Object]"!==Object.prototype.toString.call(e))return!1;if(void 0===e.constructor)return!0;e=Object.getPrototypeOf(e);return null===e||e===Object.prototype}clone(e){let i;return Array.isArray(e)?(i=Array.from(e),i.forEach((e,t)=>{i[t]=this.clone(e)})):this.isPlainObject(e)?(i={},Object.assign(i,e),Object.keys(i).forEach(e=>{i[e]=this.clone(i[e])})):i=e,i}extend(i,s){if(Array.isArray(i)){if(!Array.isArray(s))throw new Error("Arrays can be extended with arrays only");s.forEach(e=>{i.push(this.clone(e))})}else if(i&&"object"==typeof i&&null!=s){if("object"!=typeof s)throw new Error("Object can be extended with other objects only.");Object.keys(s).forEach(e=>{var t;null!=i[e]&&"object"==typeof i[e]&&null!=s[e]&&"object"==typeof s[e]?(t=this.clone(s[e]),Array.isArray(i[e])&&this.isPlainObject(t)&&(i[e]={}),this.extend(i[e],t)):i[e]=this.clone(s[e])})}else if(null!=s)throw new Error("Object is not extendable, only {} or [] can be extended.");if(2<arguments.length)for(let e=2;e<arguments.length;e++)this.extend(i,arguments[e]);return i}naturalCompare(e,t){let s,i,l=1,r=0,n=0,a=String.alphabet;function o(e,t,i){if(i){for(s=t;(i=o(e,s))<76&&65<i;)++s;return+e.slice(t-1,s)}return-1<(i=a&&a.indexOf(e.charAt(t)))?i+76:(i=e.charCodeAt(t)||0)<45||127<i?i:i<46?65:i<48?i-1:i<58?i+18:i<65?i-11:i<91?i+11:i<97?i-37:i<123?i+5:i-63}if((e+="")!=(t+=""))for(;l;)if(i=o(e,r++),l=o(t,n++),i<76&&l<76&&66<i&&66<l&&(i=o(e,r,r),l=o(t,n,r=s),n=s),i!=l)return i<l?-1:1;return 0}normMenu(i,e){if(Array.isArray(i))return i.forEach((e,t)=>{"string"==typeof e||"number"==typeof e?i[t]={id:e,text:e}:null!=e?(null!=e.caption&&null==e.text&&(e.text=e.caption),null!=e.text&&null==e.id&&(e.id=e.text),null==e.text&&null!=e.id&&(e.text=e.id)):i[t]={id:null,text:"null"}}),i;if("function"!=typeof i)return"object"==typeof i?Object.keys(i).map(e=>({id:e,text:i[e]})):void 0;e=i.call(this,i,e);return w2utils.normMenu.call(this,e)}bindEvents(e,r){0!=e.length&&(e&&!(e instanceof HTMLElement)&&e[0]instanceof HTMLElement&&(e=Array.isArray(e)?e:e.get()),query(e).each(s=>{let l=query(s).data();Object.keys(l).forEach(i=>{if(-1!=["click","dblclick","mouseenter","mouseleave","mouseover","mouseout","mousedown","mousemove","mouseup","contextmenu","focus","focusin","focusout","blur","input","change","keydown","keyup","keypress"].indexOf(String(i).toLowerCase())){let e=l[i];"string"==typeof e&&(e=e.split("|").map(e=>("null"===(e="undefined"===(e="false"===(e="true"===e?!0:e)?!1:e)?void 0:e)&&(e=null),parseFloat(e)==e&&(e=parseFloat(e)),e=["'",'"',"`"].includes(e[0])&&["'",'"',"`"].includes(e[e.length-1])?e.substring(1,e.length-1):e)));let t=e[0];e=e.slice(1),query(s).off(i+".w2utils-bind").on(i+".w2utils-bind",function(i){switch(t){case"alert":alert(e[0]);break;case"stop":i.stopPropagation();break;case"prevent":i.preventDefault();break;case"stopPrevent":return i.stopPropagation(),i.preventDefault(),!1;default:if(null==r[t])throw new Error(`Cannot dispatch event as the method "${t}" does not exist.`);r[t].apply(r,e.map((e,t)=>{switch(String(e).toLowerCase()){case"event":return i;case"this":return this;default:return e}}))}})}})}))}}var w2utils=new Utils;class Dialog extends w2base{constructor(){super(),this.defaults={title:"",text:"",body:"",buttons:"",width:450,height:250,focus:null,actions:null,style:"",speed:.3,modal:!1,maximized:!1,keyboard:!0,showClose:!0,showMax:!1,transition:null,openMaximized:!1},this.name="popup",this.status="closed",this.onOpen=null,this.onClose=null,this.onMax=null,this.onMin=null,this.onToggle=null,this.onKeydown=null,this.onAction=null,this.onMove=null}open(n){let a=this;if("closing"!=w2popup.status){var o=this.options;null!=(n=["string","number"].includes(typeof n)?w2utils.extend({title:"Notification",body:`<div class="w2ui-centered">${n}</div>`,actions:{Ok(){w2popup.close()}},cancelAction:"ok"},arguments[1]??{}):n).text&&(n.body=`<div class="w2ui-centered w2ui-msg-text">${n.text}</div>`),n=Object.assign({},this.defaults,o,{title:"",body:""},n,{maximized:!1}),this.options=n,0===query("#w2ui-popup").length&&(w2popup.off("*"),Object.keys(w2popup).forEach(e=>{e.startsWith("on")&&"on"!=e&&(w2popup[e]=null)})),Object.keys(n).forEach(e=>{e.startsWith("on")&&"on"!=e&&n[e]&&(w2popup[e]=n[e])}),n.width=parseInt(n.width),n.height=parseInt(n.height);let e,t,s,i,l;t=null==window.innerHeight?(e=parseInt(document.documentElement.offsetWidth),parseInt(document.documentElement.offsetHeight)):(e=parseInt(window.innerWidth),parseInt(window.innerHeight)),e-10<n.width&&(n.width=e-10),t-10<n.height&&(n.height=t-10);var h=(t-n.height)/2,d=(e-n.width)/2;let r={self:this,action(e){return a.on("action.prom",e),r},close(e){return a.on("close.prom",e),r},then(e){return a.on("open:after.prom",e),r}};if(null==n.actions||n.buttons||(n.buttons="",Object.keys(n.actions).forEach(e=>{var t=n.actions[e];let i=e;"function"==typeof t&&(n.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${e}","event"]'>${e}</button>`),"object"==typeof t&&(n.buttons+=`<button class="w2ui-btn w2ui-eaction ${t.class||""}" data-click='["action","${e}","event"]'
                        style="${t.style}" ${t.attrs}>${t.text||e}</button>`,i=Array.isArray(n.actions)?t.text:e),"string"==typeof t&&(n.buttons+=`<button class="w2ui-btn w2ui-eaction" data-click='["action","${t}","event"]'>${t}</button>`,i=t),"string"==typeof i&&(i=i[0].toLowerCase()+i.substr(1).replace(/\s+/g,"")),r[i]=function(t){return a.on("action.buttons",e=>{e.detail.action[0].toLowerCase()+e.detail.action.substr(1).replace(/\s+/g,"")==i&&t(e)}),r}})),0===query("#w2ui-popup").length){if(s=this.trigger("open",{target:"popup",present:!1}),!0===s.isCancelled)return;w2popup.status="opening",w2utils.lock(document.body,{opacity:.3,onClick:n.modal?null:()=>{w2popup.close()}});let e="";n.showClose&&(e+=`<div class="w2ui-popup-button w2ui-popup-close">
                            <span class="w2ui-icon w2ui-icon-cross w2ui-eaction" data-mousedown="stop" data-click="close"></span>
                        </div>`),n.showMax&&(e+=`<div class="w2ui-popup-button w2ui-popup-max">
                            <span class="w2ui-icon w2ui-icon-box w2ui-eaction" data-mousedown="stop" data-click="toggle"></span>
                        </div>`),i=`<div id="w2ui-popup" class="w2ui-popup w2ui-anim-open animating" style="left: ${d}px; top: ${h}px;
                        width: ${parseInt(n.width)}px; height: ${parseInt(n.height)}px;
                        transition: ${n.speed}s"></div>`,query("body").append(i),i=`
                <span name="hidden-first" tabindex="0" style="position: absolute; top: -100px"></span>
                <div class="w2ui-popup-title" style="${n.title?"":"display: none"}">${e}</div>
                <div class="w2ui-box" style="${n.title?"":"top: 0px !important;"}
                        ${n.buttons?"":"bottom: 0px !important;"}">
                    <div class="w2ui-popup-body ${!n.title||" w2ui-popup-no-title"}
                        ${!n.buttons||" w2ui-popup-no-buttons"}" style="${n.style}">
                    </div>
                </div>
                <div class="w2ui-popup-buttons" style="${n.buttons?"":"display: none"}"></div>
                <span name="hidden-last" tabindex="0" style="position: absolute; top: -100px"></span>
            `,query("#w2ui-popup").html(i),n.title&&query("#w2ui-popup .w2ui-popup-title").append(w2utils.lang(n.title)),n.buttons&&query("#w2ui-popup .w2ui-popup-buttons").append(n.buttons),n.body&&query("#w2ui-popup .w2ui-popup-body").append(n.body),setTimeout(()=>{query("#w2ui-popup").css("transition",n.speed+"s").removeClass("w2ui-anim-open"),w2utils.bindEvents("#w2ui-popup .w2ui-eaction",w2popup),query("#w2ui-popup").find(".w2ui-popup-body").show(),a.setFocus(n.focus),s.finish()},1),clearTimeout(this._timer),this._timer=setTimeout(()=>{query("#w2ui-popup").removeClass("animating"),w2popup.status="open"},1e3*n.speed)}else{if(s=this.trigger("open",{target:"popup",present:!0}),!0===s.isCancelled)return;w2popup.status="opening",null!=o&&(o.maximized||o.width==n.width&&o.height==n.height||w2popup.resize(n.width,n.height),n.prevSize=n.width+"px:"+n.height+"px",n.maximized=o.maximized);o=query("#w2ui-popup .w2ui-box").get(0).cloneNode(!0);query(o).removeClass("w2ui-box").addClass("w2ui-box-temp").find(".w2ui-popup-body").empty().append(n.body),query("#w2ui-popup .w2ui-box").after(o),n.buttons?(query("#w2ui-popup .w2ui-popup-buttons").show().html("").append(n.buttons),query("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-buttons"),query("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","")):(query("#w2ui-popup .w2ui-popup-buttons").hide().html(""),query("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-buttons"),query("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("bottom","0px")),n.title?(query("#w2ui-popup .w2ui-popup-title").show().html((n.showClose?`<div class="w2ui-popup-button w2ui-popup-close">
                                <span class="w2ui-icon w2ui-icon-cross w2ui-eaction" data-mousedown="stop" data-click="close"></span>
                            </div>`:"")+(n.showMax?`<div class="w2ui-popup-button w2ui-popup-max">
                                <span class="w2ui-icon w2ui-icon-box w2ui-eaction" data-mousedown="stop" data-click="toggle"></span>
                            </div>`:"")).append(n.title),query("#w2ui-popup .w2ui-popup-body").removeClass("w2ui-popup-no-title"),query("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","")):(query("#w2ui-popup .w2ui-popup-title").hide().html(""),query("#w2ui-popup .w2ui-popup-body").addClass("w2ui-popup-no-title"),query("#w2ui-popup .w2ui-box, #w2ui-popup .w2ui-box-temp").css("top","0px"));let t=query("#w2ui-popup .w2ui-box")[0],i=query("#w2ui-popup .w2ui-box-temp")[0];w2utils.transition(t,i,n.transition,()=>{query(t).remove(),query(i).removeClass("w2ui-box-temp").addClass("w2ui-box");let e=query(i).find(".w2ui-popup-body");1==e.length&&(e[0].style.cssText=n.style,e.show()),a.setFocus(n.focus)}),w2popup.status="open",s.finish(),w2utils.bindEvents("#w2ui-popup .w2ui-eaction",w2popup),query("#w2ui-popup").find(".w2ui-popup-body").show()}return n.openMaximized&&this.max(),n._last_focus=document.activeElement,n.keyboard&&query(document.body).on("keydown",this.keydown),l={resizing:!1,mvMove:function(t){if(1==l.resizing){t=t||window.event,l.div_x=t.screenX-l.x,l.div_y=t.screenY-l.y;let e=w2popup.trigger("move",{target:"popup",div_x:l.div_x,div_y:l.div_y,originalEvent:t});!0!==e.isCancelled&&(query("#w2ui-popup").css({transition:"none",transform:"translate3d("+l.div_x+"px, "+l.div_y+"px, 0px)"}),e.finish())}},mvStop:function(e){1==l.resizing&&(e=e||window.event,w2popup.status="open",l.div_x=e.screenX-l.x,l.div_y=e.screenY-l.y,query("#w2ui-popup").css({left:l.pos_x+l.div_x+"px",top:l.pos_y+l.div_y+"px"}).css({transition:"none",transform:"translate3d(0px, 0px, 0px)"}),l.resizing=!1,query(document.body).off(".w2ui-popup"),l.isLocked||w2popup.unlock())}},query("#w2ui-popup .w2ui-popup-title").on("mousedown",function(e){w2popup.options.maximized||function(e){e=e||window.event;w2popup.status="moving";var t=query("#w2ui-popup").get(0).getBoundingClientRect();Object.assign(l,{resizing:!0,isLocked:1==query("#w2ui-popup > .w2ui-lock").length,x:e.screenX,y:e.screenY,pos_x:t.x,pos_y:t.y}),l.isLocked||w2popup.lock({opacity:0});query(document.body).on("mousemove.w2ui-popup",l.mvMove).on("mouseup.w2ui-popup",l.mvStop),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0;{if(!e.preventDefault)return;e.preventDefault()}}(e)}),r}else setTimeout(()=>{a.open.call(a,n)},100)}load(l){return new Promise((t,e)=>{if(null==(l="string"==typeof l?{url:l}:l).url)return console.log("ERROR: The url is not defined."),void e("The url is not defined");w2popup.status="loading";let[i,s]=String(l.url).split("#");i&&fetch(i).then(e=>e.text()).then(e=>{this.template(e,s,l).then(()=>{t()})})})}template(t,e,i={}){let s;try{s=query(t)}catch(e){s=query.html(t)}return e&&(s=s.filter("#"+e)),Object.assign(i,{width:parseInt(query(s).css("width")),height:parseInt(query(s).css("height")),title:query(s).find("[rel=title]").html(),body:query(s).find("[rel=body]").html(),buttons:query(s).find("[rel=buttons]").html(),style:query(s).find("[rel=body]").get(0).style.cssText}),w2popup.open(i)}action(e,t){let i=this.options.actions[e];i instanceof Object&&i.onClick&&(i=i.onClick);let s=this.trigger("action",{action:e,target:"popup",self:this,originalEvent:t,value:this.input?this.input.value:null});!0!==s.isCancelled&&("function"==typeof i&&i.call(this,t),s.finish())}keydown(t){if(!this.options||this.options.keyboard){let e=w2popup.trigger("keydown",{target:"popup",originalEvent:t});!0!==e.isCancelled&&(27===t.keyCode&&(t.preventDefault(),0==query("#w2ui-popup .w2ui-message").length&&(w2popup.options.cancelAction?w2popup.action(w2popup.options.cancelAction):w2popup.close())),e.finish())}}close(){if(0!==query("#w2ui-popup").length&&"closed"!=this.status)if("opening"!=this.status){let e=this.trigger("close",{target:"popup"});!0!==e.isCancelled&&(w2popup.status="closing",query("#w2ui-popup").css("transition",this.options.speed+"s").addClass("w2ui-anim-close animating"),w2utils.unlock(document.body,300),setTimeout(()=>{query("#w2ui-popup").remove(),this.options._last_focus&&0<this.options._last_focus.length&&this.options._last_focus.focus(),w2popup.status="closed",w2popup.options={},e.finish()},1e3*this.options.speed),this.options.keyboard&&query(document.body).off("keydown",this.keydown))}else setTimeout(()=>{w2popup.close()},100)}toggle(){let e=this.trigger("togle",{target:"popup"});!0!==e.isCancelled&&(!0===this.options.maximized?w2popup.min():w2popup.max(),setTimeout(()=>{e.finish()},1e3*this.options.speed+50))}max(){var t;if(!0!==this.options.maximized){let e=this.trigger("max",{target:"popup"});!0!==e.isCancelled&&(w2popup.status="resizing",t=query("#w2ui-popup").get(0).getBoundingClientRect(),this.options.prevSize=t.width+":"+t.height,w2popup.resize(1e4,1e4,()=>{w2popup.status="open",this.options.maximized=!0,e.finish()}))}}min(){if(!0===this.options.maximized){var t=this.options.prevSize.split(":");let e=this.trigger("min",{target:"popup"});!0!==e.isCancelled&&(w2popup.status="resizing",w2popup.resize(parseInt(t[0]),parseInt(t[1]),()=>{w2popup.status="open",this.options.maximized=!1,this.options.prevSize=null,e.finish()}))}}clear(){query("#w2ui-popup .w2ui-popup-title").html(""),query("#w2ui-popup .w2ui-popup-body").html(""),query("#w2ui-popup .w2ui-popup-buttons").html("")}reset(){w2popup.open(w2popup.defaults)}message(e){return w2utils.message({owner:this,box:query("#w2ui-popup").get(0),after:".w2ui-popup-title"},e)}confirm(e){return w2utils.confirm({owner:this,box:query("#w2ui-popup"),after:".w2ui-popup-title"},e)}setFocus(t){let s=query("#w2ui-popup"),l="input, button, select, textarea, [contentEditable], .w2ui-input";if(null!=t){let e=isNaN(t)?s.find(l).filter(t).get(0):s.find(l).get(t);e?.focus()}else s.find("[name=hidden-first]").get(0).focus();query(s).find(l+",[name=hidden-first],[name=hidden-last]").off(".keep-focus").on("blur.keep-focus",function(e){setTimeout(()=>{var e=document.activeElement,t=0<query(s).find(l).filter(e).length,i=query(e).attr("name");!t&&e&&e!==document.body&&query(s).find(l).get(0)?.focus(),"hidden-last"==i&&query(s).find(l).get(0)?.focus(),"hidden-first"==i&&query(s).find(l).get(-1)?.focus()},1)})}lock(e,t){let i=Array.from(arguments);i.unshift(query("#w2ui-popup")),w2utils.lock(...i)}unlock(e){w2utils.unlock(query("#w2ui-popup"),e)}resize(e,t,i){let s=this;null==this.options.speed&&(this.options.speed=0),e=parseInt(e),t=parseInt(t);let l,r;r=null==window.innerHeight?(l=parseInt(document.documentElement.offsetWidth),parseInt(document.documentElement.offsetHeight)):(l=parseInt(window.innerWidth),parseInt(window.innerHeight)),l-10<e&&(e=l-10),r-10<t&&(t=r-10);var n=(r-t)/2,a=(l-e)/2,o=this.options.speed;query("#w2ui-popup").css({transition:`${o}s width, ${o}s height, ${o}s left, ${o}s top`,top:n+"px",left:a+"px",width:e+"px",height:t+"px"});let h=setInterval(()=>{s.resizeMessages()},10);setTimeout(()=>{clearInterval(h),this.options.width=e,this.options.height=t,s.resizeMessages(),"function"==typeof i&&i()},1e3*this.options.speed+50)}resizeMessages(){query("#w2ui-popup .w2ui-message").each(e=>{let t=query(e).data("options"),i=query("#w2ui-popup");parseInt(t.width)<10&&(t.width=10),parseInt(t.height)<10&&(t.height=10);var s=i[0].getBoundingClientRect(),l=parseInt(i.find(".w2ui-popup-title")[0].clientHeight),r=parseInt(s.width),s=parseInt(s.height);t.width=t.originalWidth,t.width>r-10&&(t.width=r-10),t.height=t.originalHeight,t.height>s-l-5&&(t.height=s-l-5),t.originalHeight<0&&(t.height=s+t.originalHeight-l),t.originalWidth<0&&(t.width=r+2*t.originalWidth),query(e).css({left:(r-t.width)/2+"px",width:t.width+"px",height:t.height+"px"})})}}function w2alert(e,t,i){let s;e={title:w2utils.lang(t??"Notification"),body:`<div class="w2ui-centered w2ui-msg-text">${e}</div>`,showClose:!1,actions:["Ok"],cancelAction:"ok"};return s=0<query("#w2ui-popup").length&&"closing"!=w2popup.status?w2popup.message(e):w2popup.open(e),s.ok(e=>{"function"==typeof e.detail.self?.close&&e.detail.self.close(),"function"==typeof i&&i()}),s}function w2confirm(e,t,i){let s,l=e;return["string","number"].includes(typeof l)&&(l={msg:l}),l.msg&&(l.body=`<div class="w2ui-centered w2ui-msg-text">${l.msg}</div>`,delete l.msg),w2utils.extend(l,{title:w2utils.lang(t??"Confirmation"),showClose:!1,modal:!0,cancelAction:"no"}),w2utils.normButtons(l,{yes:"Yes",no:"No"}),s=0<query("#w2ui-popup").length&&"closing"!=w2popup.status?w2popup.message(l):w2popup.open(l),s.self.off(".confirm").on("action:after.confirm",e=>{"function"==typeof e.detail.self?.close&&e.detail.self.close(),"function"==typeof i&&i(e.detail.action)}),s}function w2prompt(e,t,i){let s,l=e;return["string","number"].includes(typeof l)&&(l={label:l}),l.label&&(l.focus=0,l.body=l.textarea?`<div class="w2ui-prompt textarea">
                 <div>${l.label}</div>
                 <textarea id="w2prompt" class="w2ui-input" ${l.attrs??""}
                    data-keydown="keydown|event" data-keyup="change|event">${l.value??""}</textarea>
               </div>`:`<div class="w2ui-prompt w2ui-centered">
                 <label>${l.label}</label>
                 <input id="w2prompt" class="w2ui-input" ${l.attrs??""}
                    data-keydown="keydown|event" data-keyup="change|event" value="${l.value??""}">
               </div>`),w2utils.extend(l,{title:w2utils.lang(t??"Notification"),showClose:!1,modal:!0,cancelAction:"cancel"}),w2utils.normButtons(l,{ok:"Ok",cancel:"Cancel"}),s=0<query("#w2ui-popup").length&&"closing"!=w2popup.status?w2popup.message(l):w2popup.open(l),s.self.box?s.self.input=query(s.self.box).find("#w2prompt").get(0):s.self.input=query("#w2ui-popup .w2ui-popup-body #w2prompt").get(0),null!==l.value&&s.self.input.select(),s.change=function(e){return s.self.on("change",e),this},s.self.off(".prompt").on("open:after.prompt",e=>{e=e.detail.box||query("#w2ui-popup .w2ui-popup-body").get(0);w2utils.bindEvents(query(e).find("#w2prompt"),{keydown(e){27==e.keyCode&&e.stopPropagation()},change(e){let t=s.self.trigger("change",{target:"prompt",originalEvent:e});!0!==t.isCancelled&&(13==e.keyCode&&e.ctrlKey&&s.self.action("Ok",e),27==e.keyCode&&s.self.action("Cancel",e),t.finish())}}),query(e).find(".w2ui-eaction").trigger("keyup")}).on("action:after.prompt",e=>{"function"==typeof e.detail.self?.close&&e.detail.self.close(),"function"==typeof i&&i(e.detail.action)}),s}let w2popup=new Dialog;class Tooltip{static active={};constructor(){this.defaults={name:null,html:"",style:"",class:"",position:"top|bottom",align:"",anchor:null,anchorClass:"",anchorStyle:"",autoShow:!1,autoShowOn:null,autoHideOn:null,arrowSize:8,margin:0,screenMargin:2,autoResize:!0,offsetX:0,offsetY:0,maxWidth:null,maxHeight:null,watchScroll:null,watchResize:null,hideOn:null,onThen:null,onShow:null,onHide:null,onUpdate:null,onMove:null}}static observeRemove=new MutationObserver(e=>{let i=0;Object.keys(Tooltip.active).forEach(e=>{let t=Tooltip.active[e];t.displayed&&(t.anchor&&t.anchor.isConnected?i++:t.hide())}),0===i&&Tooltip.observeRemove.disconnect()});trigger(e,t){var i;if(2==arguments.length&&(i=e,(e=t).type=i),e.overlay)return e.overlay.trigger(e);console.log("ERROR: cannot find overlay where to trigger events")}get(e){return 0==arguments.length?Object.keys(Tooltip.active):!0===e?Tooltip.active:Tooltip.active[e.replace(/[\s\.#]/g,"_")]}attach(t,s){let l,r,n=this;if(0!=arguments.length){1==arguments.length&&t.anchor?(l=t,t=l.anchor):2===arguments.length&&"string"==typeof s?(l={anchor:t,html:s},s=l.html):2===arguments.length&&null!=s&&"object"==typeof s&&(l=s,s=l.html),l=w2utils.extend({},this.defaults,l||{}),!(s=!s&&l.text?l.text:s)&&l.html&&(s=l.html),delete l.anchor;let e=l.name||t.id;var a;e||(e="noname-"+Object.keys(Tooltip.active).length,console.log("NOTICE: name property is not defined for tooltip, could lead to too many instances")),e=e.replace(/[\s\.#]/g,"_"),t!=document&&t!=document.body||(t=document.body,e="context-menu"),Tooltip.active[e]?(r=Tooltip.active[e],r.prevOptions=r.options,r.options=l,r.anchor=t,r.prevOptions.html==r.options.html&&r.prevOptions.class==r.options.class&&r.prevOptions.style==r.options.style||(r.needsUpdate=!0),l=r.options):(r=new w2base,Object.assign(r,{id:"w2overlay-"+e,name:e,options:l,anchor:t,displayed:!1,tmp:{observeResize:new ResizeObserver(()=>{this.resize(r.name)})},hide(){n.hide(e)}}),Tooltip.active[e]=r),Object.keys(r.options).forEach(e=>{var t=r.options[e];e.startsWith("on")&&"function"==typeof t&&(r[e]=t,delete r.options[e])}),!0===l.autoShow&&(l.autoShowOn=l.autoShowOn??"mouseenter",l.autoHideOn=l.autoHideOn??"mouseleave",l.autoShow=!1),l.autoShowOn&&(a="autoShow-"+r.name,query(t).off(`.${a}`).on(`${l.autoShowOn}.${a}`,e=>{n.show(r.name),e.stopPropagation()}),delete l.autoShowOn),l.autoHideOn&&(a="autoHide-"+r.name,query(t).off(`.${a}`).on(`${l.autoHideOn}.${a}`,e=>{n.hide(r.name),e.stopPropagation()}),delete l.autoHideOn),r.off(".attach");let i={overlay:r,then:t=>(r.on("show:after.attach",e=>{t(e)}),i),show:t=>(r.on("show.attach",e=>{t(e)}),i),hide:t=>(r.on("hide.attach",e=>{t(e)}),i),update:t=>(r.on("update.attach",e=>{t(e)}),i),move:t=>(r.on("move.attach",e=>{t(e)}),i)};return i}}show(i){if(i instanceof HTMLElement||i instanceof Object){let e=i;i instanceof HTMLElement&&(e=arguments[1]||{},e.anchor=i);let t=this.attach(e);return query(t.overlay.anchor).off(".autoShow-"+t.overlay.name).off(".autoHide-"+t.overlay.name),setTimeout(()=>{this.show(t.overlay.name)},1),t}let s,r=this,n=Tooltip.active[i.replace(/[\s\.#]/g,"_")];if(n){let l=n.options;if(!n||n.displayed&&!n.needsUpdate)this.resize(n?.name);else{var e=l.position.split("|"),e=["top","bottom"].includes(e[0]);let t="both"==l.align&&e?"":"white-space: nowrap;";if(l.maxWidth&&w2utils.getStrWidth(l.html,"")>l.maxWidth&&(t="width: "+l.maxWidth+"px; white-space: inherit; overflow: auto;"),t+=" max-height: "+(l.maxHeight||window.innerHeight-40)+"px;",""!==l.html&&null!=l.html){if(n.box){if(s=this.trigger("update",{target:i,overlay:n}),!0===s.isCancelled)return void(n.prevOptions&&(n.options=n.prevOptions,delete n.prevOptions));query(n.box).find(".w2ui-overlay-body").attr("style",(l.style||"")+"; "+t).removeClass().addClass("w2ui-overlay-body "+l.class).html(l.html),this.resize(n.name)}else{if(s=this.trigger("show",{target:i,overlay:n}),!0===s.isCancelled)return;query("body").append(`<div id="${n.id}" name="${i}" style="display: none;" class="w2ui-overlay"
                        data-click="stop" data-focusin="stop">
                    <style></style>
                    <div class="w2ui-overlay-body ${l.class}" style="${l.style||""}; ${t}">
                        ${l.html}
                    </div>
                </div>`),n.box=query("#"+w2utils.escapeId(n.id))[0],n.displayed=!0;let e=query(n.anchor).data("tooltipName")??[];e.push(i),query(n.anchor).data("tooltipName",e),w2utils.bindEvents(n.box,{}),n.tmp.originalCSS="",0<query(n.anchor).length&&(n.tmp.originalCSS=query(n.anchor)[0].style.cssText)}l.anchorStyle&&(n.anchor.style.cssText+=";"+l.anchorStyle),l.anchorClass&&("w2ui-focus"==l.anchorClass&&n.anchor==document.body||query(n.anchor).addClass(l.anchorClass)),"string"==typeof l.hideOn&&(l.hideOn=[l.hideOn]),Array.isArray(l.hideOn)||(l.hideOn=[]),Object.assign(n.tmp,{scrollLeft:document.body.scrollLeft,scrollTop:document.body.scrollTop}),function(){let t=e=>{r.hide(n.name)},i=query(n.anchor),s="tooltip-"+n.name;query("body").off(`.${s}`),l.hideOn.includes("doc-click")&&(["INPUT","TEXTAREA"].includes(n.anchor.tagName)&&i.off(`.${s}-doc`).on(`click.${s}-doc`,e=>{e.stopPropagation()}),query("body").on(`click.${s}`,t));l.hideOn.includes("focus-change")&&query("body").on(`focusin.${s}`,e=>{document.activeElement!=n.anchor&&r.hide(n.name)});["INPUT","TEXTAREA"].includes(n.anchor.tagName)&&(i.off(`.${s}`),l.hideOn.forEach(e=>{-1==["doc-click","focus-change"].indexOf(e)&&i.on(`${e}.${s}`,{once:!0},t)}))}(),function(t){let e="tooltip-"+n.name,i=t;"BODY"==t.tagName&&(i=t.ownerDocument);query(i).off(`.${e}`).on(`scroll.${e}`,e=>{Object.assign(n.tmp,{scrollLeft:t.scrollLeft,scrollTop:t.scrollTop}),r.resize(n.name)})}(document.body),query(n.box).show(),n.tmp.observeResize.observe(n.box),Tooltip.observeRemove.observe(document.body,{subtree:!0,childList:!0}),query(n.box).find(".w2ui-overlay-body").html(l.html),setTimeout(()=>{query(n.box).css("opacity",1)},0),delete n.needsUpdate,n.box.overlay=n,s&&s.finish()}else r.hide(i)}}}hide(t){let s;if(0!=arguments.length){if(t instanceof HTMLElement){let e=query(t).data("tooltipName")??[];e.forEach(e=>{this.hide(e)})}else if("string"==typeof t&&(t=t.replace(/[\s\.#]/g,"_"),s=Tooltip.active[t]),s&&s.box){delete Tooltip.active[t];let i=this.trigger("hide",{target:t,overlay:s});if(!0!==i.isCancelled){var l="tooltip-"+s.name;s.tmp.observeResize?.disconnect(),s.options.watchScroll&&query(s.options.watchScroll).off(".w2scroll-"+s.name);let t=0;Object.keys(Tooltip.active).forEach(e=>{Tooltip.active[e].displayed&&t++}),0==t&&Tooltip.observeRemove.disconnect(),query("body").off(`.${l}`),query(document).off(`.${l}`),s.box.remove(),s.box=null,s.displayed=!1;let e=query(s.anchor).data("tooltipName")??[];-1!=e.indexOf(s.name)&&e.splice(e.indexOf(s.name),1),0==e.length?query(s.anchor).removeData("tooltipName"):query(s.anchor).data("tooltipName",e),s.anchor.style.cssText=s.tmp.originalCSS,query(s.anchor).off(`.${l}`).removeClass(s.options.anchorClass),i.finish()}}}else Object.keys(Tooltip.active).forEach(e=>{this.hide(e)})}resize(s){if(0!=arguments.length){let e=Tooltip.active[s.replace(/[\s\.#]/g,"_")],t=this.getPosition(e.name);var l=t.left+"x"+t.top;let i;e.tmp.lastPos!=l&&(i=this.trigger("move",{target:s,overlay:e,pos:t})),query(e.box).css({left:t.left+"px",top:t.top+"px"}).then(e=>{null!=t.width&&e.css("width",t.width+"px").find(".w2ui-overlay-body").css("width","100%"),null!=t.height&&e.css("height",t.height+"px").find(".w2ui-overlay-body").css("height","100%")}).find(".w2ui-overlay-body").removeClass("w2ui-arrow-right w2ui-arrow-left w2ui-arrow-top w2ui-arrow-bottom").addClass(t.arrow.class).closest(".w2ui-overlay").find("style").text(t.arrow.style),e.tmp.lastPos!=l&&i&&(e.tmp.lastPos=l,i.finish())}else Object.keys(Tooltip.active).forEach(e=>{e=Tooltip.active[e];e.displayed&&this.resize(e.name)})}getPosition(s){let y=Tooltip.active[s.replace(/[\s\.#]/g,"_")];if(y&&y.box){let r=y.options;(y.tmp.resizedY||y.tmp.resizedX)&&query(y.box).css({width:"",height:"",scroll:"auto"});var l,b,v,x=w2utils.scrollBarSize(),_=!(document.body.scrollWidth==document.body.clientWidth),$=!(document.body.scrollHeight==document.body.clientHeight);let n={width:window.innerWidth-($?x:0),height:window.innerHeight-(_?x:0)},e=("auto"==r.position?"top|bottom|right|left":r.position).split("|"),a=["top","bottom"].includes(e[0]),o=y.box.getBoundingClientRect(),h=y.anchor.getBoundingClientRect();y.anchor==document.body&&({x:l,y:b,width:v,height:s}=r.originalEvent,h={left:l-2,top:b-4,width:v,height:s,arrow:"none"});let d=r.arrowSize;"none"==h.arrow&&(d=0);let t={top:h.top,bottom:n.height-(h.top+h.height)-+(_?x:0),left:h.left,right:n.width-(h.left+h.width)+($?x:0)};o.width<22&&(o.width=22),o.height<14&&(o.height=14);let u,c,p,f,m="",g={offset:0,class:"",style:`#${y.id} { --tip-size: ${d}px; }`},w={left:0,top:0},i={posX:"",x:0,posY:"",y:0};e.forEach(e=>{["top","bottom"].includes(e)&&(!m&&o.height+d/1.893<t[e]&&(m=e),t[e]>i.y&&Object.assign(i,{posY:e,y:t[e]})),["left","right"].includes(e)&&(!m&&o.width+d/1.893<t[e]&&(m=e),t[e]>i.x&&Object.assign(i,{posX:e,x:t[e]}))}),m=m||(a?i.posY:i.posX),r.autoResize&&(["top","bottom"].includes(m)&&(o.height>t[m]?(f=t[m],y.tmp.resizedY=!0):y.tmp.resizedY=!1),["left","right"].includes(m)&&(o.width>t[m]?(p=t[m],y.tmp.resizedX=!0):y.tmp.resizedX=!1)),function(e){switch(g.class=h.arrow||`w2ui-arrow-${e}`,e){case"top":u=h.left+(h.width-(p??o.width))/2,c=h.top-(f??o.height)-d/1.5+1;break;case"bottom":u=h.left+(h.width-(p??o.width))/2,c=h.top+h.height+d/1.25+1;break;case"left":u=h.left-(p??o.width)-d/1.2-1,c=h.top+(h.height-(f??o.height))/2;break;case"right":u=h.left+h.width+d/1.2+1,c=h.top+(h.height-(f??o.height))/2}}(m),a&&function(){"left"==r.align&&(w.left=h.left-u,u=h.left);"right"==r.align&&(w.left=h.left+h.width-(p??o.width)-u,u=h.left+h.width-(p??o.width));["top","bottom"].includes(m)&&r.align.startsWith("both")&&(e=r.align.split(":")[1]??50,h.width>=e&&(u=h.left,p=h.width));"top"==r.align&&(w.top=h.top-c,c=h.top);"bottom"==r.align&&(w.top=h.top+h.height-(f??o.height)-c,c=h.top+h.height-(f??o.height));{var e;["left","right"].includes(m)&&r.align.startsWith("both")&&(e=r.align.split(":")[1]??50,h.height>=e&&(c=h.top,f=h.height))}}(),function(){let e;(["left","right"].includes(r.align)&&h.width<(p??o.width)||["top","bottom"].includes(r.align)&&h.height<(f??o.height))&&(e=!0);var t="right"==m?d:r.screenMargin,i="bottom"==m?d:r.screenMargin,s=n.width-(p??o.width)-("left"==m?d:r.screenMargin),l=n.height-(f??o.height)-("top"==m?d:r.screenMargin)+3;(["top","bottom"].includes(m)||r.autoResize)&&(u<t&&(e=!0,w.left-=u,u=t),u>s&&(e=!0,w.left-=u-s,u+=s-u));(["left","right"].includes(m)||r.autoResize)&&(c<i&&(e=!0,w.top-=c,c=i),c>l&&(e=!0,w.top-=c-l,c+=l-c));e&&(i=a?"left":"top",l=a?"width":"height",g.offset=-w[i],l=o[l]/2-d,Math.abs(g.offset)>l+d&&(g.class=""),Math.abs(g.offset)>l&&(g.offset=g.offset<0?-l:l),g.style=w2utils.stripSpaces(`#${y.id} .w2ui-overlay-body:after,
                            #${y.id} .w2ui-overlay-body:before {
                                --tip-size: ${d}px;
                                margin-${i}: ${g.offset}px;
                            }`))}();$="top"==m?-r.margin:"bottom"==m?r.margin:0,x="left"==m?-r.margin:"right"==m?r.margin:0;return c=c+parseFloat(r.offsetY)+parseInt($),u=u+parseFloat(r.offsetX)+parseInt(x),{left:u,top:c,arrow:g,adjust:w,width:p,height:f,pos:m}}}}class ColorTooltip extends Tooltip{constructor(){super(),this.palette=[["000000","333333","555555","777777","888888","999999","AAAAAA","CCCCCC","DDDDDD","EEEEEE","F7F7F7","FFFFFF"],["FF011B","FF9838","FFC300","FFFD59","86FF14","14FF7A","2EFFFC","2693FF","006CE7","9B24F4","FF21F5","FF0099"],["FFEAEA","FCEFE1","FCF4DC","FFFECF","EBFFD9","D9FFE9","E0FFFF","E8F4FF","ECF4FC","EAE6F4","FFF5FE","FCF0F7"],["F4CCCC","FCE5CD","FFF1C2","FFFDA1","D5FCB1","B5F7D0","BFFFFF","D6ECFF","CFE2F3","D9D1E9","FFE3FD","FFD9F0"],["EA9899","F9CB9C","FFE48C","F7F56F","B9F77E","84F0B1","83F7F7","B5DAFF","9FC5E8","B4A7D6","FAB9F6","FFADDE"],["E06666","F6B26B","DEB737","E0DE51","8FDB48","52D189","4EDEDB","76ACE3","6FA8DC","8E7CC3","E07EDA","F26DBD"],["CC0814","E69138","AB8816","B5B20E","6BAB30","27A85F","1BA8A6","3C81C7","3D85C6","674EA7","A14F9D","BF4990"],["99050C","B45F17","80650E","737103","395E14","10783D","13615E","094785","0A5394","351C75","780172","782C5A"]],this.defaults=w2utils.extend({},this.defaults,{advanced:!1,transparent:!0,position:"top|bottom",class:"w2ui-white",color:"",liveUpdate:!0,arrowSize:12,autoResize:!1,anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change"],onSelect:null,onLiveUpdate:null})}attach(e,t){let i;1==arguments.length&&e.anchor?(i=e,e=i.anchor):2===arguments.length&&null!=t&&"object"==typeof t&&(i=t,i.anchor=e);var s=i.hideOn;i=w2utils.extend({},this.defaults,i||{}),s&&(i.hideOn=s),i.style+="; padding: 0;",i.transparent&&"333333"==this.palette[0][1]&&(this.palette[0].splice(1,1),this.palette[0].push("")),i.transparent||"333333"==this.palette[0][1]||(this.palette[0].splice(1,0,"333333"),this.palette[0].pop()),i.color&&(i.color=String(i.color).toUpperCase()),"string"==typeof i.color&&"#"===i.color.substr(0,1)&&(i.color=i.color.substr(1)),this.index=[-1,-1];let l=super.attach(i),r=l.overlay;return r.options.html=this.getColorHTML(r.name,i),r.on("show.attach",e=>{let t=e.detail.overlay;var i=t.anchor,e=t.options;["INPUT","TEXTAREA"].includes(i.tagName)&&!e.color&&i.value&&(t.tmp.initColor=i.value),delete t.newColor}),r.on("show:after.attach",e=>{var t;l.overlay?.box&&(t=query(l.overlay.box).find(".w2ui-eaction"),w2utils.bindEvents(t,this),this.initControls(l.overlay))}),r.on("update:after.attach",e=>{var t;l.overlay?.box&&(t=query(l.overlay.box).find(".w2ui-eaction"),w2utils.bindEvents(t,this),this.initControls(l.overlay))}),r.on("hide.attach",e=>{var t=e.detail.overlay;let i=t.anchor;e=t.newColor??t.options.color??"";["INPUT","TEXTAREA"].includes(i.tagName)&&i.value!=e&&(i.value=e);let s=this.trigger("select",{color:e,target:t.name,overlay:t});!0!==s.isCancelled&&s.finish()}),l.liveUpdate=t=>(r.on("liveUpdate.attach",e=>{t(e)}),l),l.select=t=>(r.on("select.attach",e=>{t(e)}),l),l}select(e,t){let i;this.index=[-1,-1],"string"!=typeof t&&(i=t.target,this.index=query(i).attr("index").split(":"),t=query(i).closest(".w2ui-overlay").attr("name"));let s=this.get(t),l=this.trigger("liveUpdate",{color:e,target:t,overlay:s,param:arguments[1]});!0!==l.isCancelled&&(["INPUT","TEXTAREA"].includes(s.anchor.tagName)&&s.options.liveUpdate&&query(s.anchor).val(e),s.newColor=e,query(s.box).find(".w2ui-selected").removeClass("w2ui-selected"),i&&query(i).addClass("w2ui-selected"),l.finish())}nextColor(e){var t=this.palette;switch(e){case"up":index[0]--;break;case"down":index[0]++;break;case"right":index[1]++;break;case"left":index[1]--}return index[0]<0&&(index[0]=0),index[0]>t.length-2&&(index[0]=t.length-2),index[1]<0&&(index[1]=0),index[1]>t[0].length-1&&(index[1]=t[0].length-1),t[index[0]][index[1]]}tabClick(e,t){"string"!=typeof t&&(t=query(t.target).closest(".w2ui-overlay").attr("name"));var i=this.get(t),t=query(i.box).find(`.w2ui-color-tab:nth-child(${e})`);query(i.box).find(".w2ui-color-tab").removeClass("selected"),query(t).addClass("selected"),query(i.box).find(".w2ui-tab-content").hide().closest(".w2ui-colors").find(".tab-"+e).show()}getColorHTML(s,l){let r=`
            <div class="w2ui-colors">
                <div class="w2ui-tab-content tab-1">`;for(let i=0;i<this.palette.length;i++){r+='<div class="w2ui-color-row">';for(let t=0;t<this.palette[i].length;t++){var n=this.palette[i][t];let e="FFFFFF"===n?"; border: 1px solid #efefef":"";r+=`
                    <div class="w2ui-color w2ui-eaction ${""===n?"w2ui-no-color":""} ${l.color==n?"w2ui-selected":""}"
                        style="background-color: #${n+e};" name="${n}" index="${i}:${t}"
                        data-mousedown="select|'${n}'|event" data-mouseup="hide|${s}">&nbsp;
                    </div>`}r+="</div>",i<2&&(r+='<div style="height: 8px"></div>')}return r+="</div>",r+=`
            <div class="w2ui-tab-content tab-2" style="display: none">
                <div class="color-info">
                    <div class="color-preview-bg"><div class="color-preview"></div><div class="color-original"></div></div>
                    <div class="color-part">
                        <span>H</span> <input class="w2ui-input" name="h" maxlength="3" max="360" tabindex="101">
                        <span>R</span> <input class="w2ui-input" name="r" maxlength="3" max="255" tabindex="104">
                    </div>
                    <div class="color-part">
                        <span>S</span> <input class="w2ui-input" name="s" maxlength="3" max="100" tabindex="102">
                        <span>G</span> <input class="w2ui-input" name="g" maxlength="3" max="255" tabindex="105">
                    </div>
                    <div class="color-part">
                        <span>V</span> <input class="w2ui-input" name="v" maxlength="3" max="100" tabindex="103">
                        <span>B</span> <input class="w2ui-input" name="b" maxlength="3" max="255" tabindex="106">
                    </div>
                    <div class="color-part opacity">
                        <span>${w2utils.lang("Opacity")}</span>
                        <input class="w2ui-input" name="a" maxlength="5" max="1" tabindex="107">
                    </div>
                </div>
                <div class="palette" name="palette">
                    <div class="palette-bg"></div>
                    <div class="value1 move-x move-y"></div>
                </div>
                <div class="rainbow" name="rainbow">
                    <div class="value2 move-x"></div>
                </div>
                <div class="alpha" name="alpha">
                    <div class="alpha-bg"></div>
                    <div class="value2 move-x"></div>
                </div>
            </div>`,r+=`
            <div class="w2ui-color-tabs">
                <div class="w2ui-color-tab selected w2ui-eaction" data-click="tabClick|1|event|this"><span class="w2ui-icon w2ui-icon-colors"></span></div>
                <div class="w2ui-color-tab w2ui-eaction" data-click="tabClick|2|event|this"><span class="w2ui-icon w2ui-icon-settings"></span></div>
                <div style="padding: 5px; width: 100%; text-align: right;">
                    ${"string"==typeof l.html?l.html:""}
                </div>
            </div>`,r}initControls(r){let n,a=this;var e=r.options;let o=w2utils.parseColor(e.color||r.tmp.initColor);null==o&&(o={r:140,g:150,b:160,a:1});let h=w2utils.rgb2hsv(o);!0===e.advanced&&this.tabClick(2,r.name),d(h,!0,!0),query(r.box).find("input").off(".w2color").on("change.w2color",e=>{let t=query(e.target),i=parseFloat(t.val());e=parseFloat(t.attr("max"));isNaN(i)&&(i=0,t.val(0)),1<e&&(i=parseInt(i)),0<e&&i>e&&(t.val(e),i=e),i<0&&(t.val(0),i=0);e=t.attr("name");let s={};-1!==["r","g","b","a"].indexOf(e)?(o[e]=i,h=w2utils.rgb2hsv(o)):-1!==["h","s","v"].indexOf(e)&&(s[e]=i),d(s,!0)}),query(r.box).find(".color-original").off(".w2color").on("click.w2color",e=>{e=w2utils.parseColor(query(e.target).css("background-color"));null!=e&&(o=e,h=w2utils.rgb2hsv(o),d(h,!0))});e=`${w2utils.isIOS?"touchstart":"mousedown"}.w2color`;let s=`${w2utils.isIOS?"touchend":"mouseup"}.w2color`,l=`${w2utils.isIOS?"touchmove":"mousemove"}.w2color`;function d(e,t,i){null!=e.h&&(h.h=e.h),null!=e.s&&(h.s=e.s),null!=e.v&&(h.v=e.v),null!=e.a&&(o.a=e.a,h.a=e.a),o=w2utils.hsv2rgb(h);let s="rgba("+o.r+","+o.g+","+o.b+","+o.a+")",l=[Number(o.r).toString(16).toUpperCase(),Number(o.g).toString(16).toUpperCase(),Number(o.b).toString(16).toUpperCase(),Math.round(255*Number(o.a)).toString(16).toUpperCase()];l.forEach((e,t)=>{1===e.length&&(l[t]="0"+e)}),s=l[0]+l[1]+l[2]+l[3],1===o.a&&(s=l[0]+l[1]+l[2]),query(r.box).find(".color-preview").css("background-color","#"+s),query(r.box).find("input").each(e=>{e.name&&(null!=o[e.name]&&(e.value=o[e.name]),null!=h[e.name]&&(e.value=h[e.name]),"a"===e.name&&(e.value=o.a))}),i?(i=r.tmp?.initColor||s,query(r.box).find(".color-original").css("background-color","#"+i),query(r.box).find(".w2ui-colors .w2ui-selected").removeClass("w2ui-selected"),query(r.box).find(`.w2ui-colors [name="${i}"]`).addClass("w2ui-selected"),8==s.length&&a.tabClick(2,r.name)):a.select(s,r.name),t&&(function(){let e=query(r.box).find(".palette .value1"),t=query(r.box).find(".rainbow .value2"),i=query(r.box).find(".alpha .value2"),s=parseInt(e[0].clientWidth)/2,l=parseInt(t[0].clientWidth)/2;e.css({left:150*h.s/100-s+"px",top:125*(100-h.v)/100-s+"px"}),t.css("left",h.h/2.4-l+"px"),i.css("left",150*o.a-l+"px")}(),u())}function u(){var e=w2utils.hsv2rgb(h.h,100,100),e=`${e.r},${e.g},${e.b}`;query(r.box).find(".palette").css("background-image",`linear-gradient(90deg, rgba(${e},0) 0%, rgba(${e},1) 100%)`)}function c(e){query("body").off(".w2color")}function p(e){let t=n.el;var i=e.pageX-n.x,s=e.pageY-n.y;let l=n.left+i,r=n.top+s;e=parseInt(t.prop("clientWidth"))/2;l<-e&&(l=-e),r<-e&&(r=-e),l>n.width-e&&(l=n.width-e),r>n.height-e&&(r=n.height-e),t.hasClass("move-x")&&t.css({left:l+"px"}),t.hasClass("move-y")&&t.css({top:r+"px"});i=query(t.get(0).parentNode).attr("name"),s=parseInt(t.css("left"))+e,e=parseInt(t.css("top"))+e;"palette"===i&&d({s:Math.round(s/n.width*100),v:Math.round(100-e/n.height*100)}),"rainbow"===i&&(d({h:Math.round(2.4*s)}),u()),"alpha"===i&&d({a:parseFloat(Number(s/150).toFixed(2))})}query(r.box).find(".palette, .rainbow, .alpha").off(".w2color").on(`${e}.w2color`,function(e){let t=query(this).find(".value1, .value2"),i=parseInt(t.prop("clientWidth"))/2;t.hasClass("move-x")&&t.css({left:e.offsetX-i+"px"});t.hasClass("move-y")&&t.css({top:e.offsetY-i+"px"});n={el:t,x:e.pageX,y:e.pageY,width:t.prop("parentNode").clientWidth,height:t.prop("parentNode").clientHeight,left:parseInt(t.css("left")),top:parseInt(t.css("top"))},p(e),query("body").off(".w2color").on(l,p).on(s,c)})}}class MenuTooltip extends Tooltip{constructor(){super(),this.defaults=w2utils.extend({},this.defaults,{type:"normal",items:[],index:null,render:null,spinner:!1,msgNoItems:w2utils.lang("No items found"),topHTML:"",menuStyle:"",filter:!1,markSearch:!1,match:"contains",search:!1,altRows:!1,arrowSize:10,align:"left",position:"bottom|top",class:"w2ui-white",anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change","select"],onSelect:null,onSubMenu:null,onRemove:null})}attach(e,t){let i;1==arguments.length&&e.anchor?(i=e,e=i.anchor):2===arguments.length&&null!=t&&"object"==typeof t&&(i=t,i.anchor=e);var s=i.hideOn;i=w2utils.extend({},this.defaults,i||{}),s&&(i.hideOn=s),i.style+="; padding: 0;",Array.isArray(i.items)||"function"==typeof i.items||(i.items=[]),i.html=this.getMenuHTML(i);let l=super.attach(i),r=l.overlay;return r.on("show:after.attach, update:after.attach",e=>{if(l.overlay?.box){let e="";r.selected=null,["INPUT","TEXTAREA"].includes(r.anchor.tagName)&&(e=r.anchor.value,r.selected=r.anchor.dataset.selectedIndex);var t=query(l.overlay.box).find(".w2ui-eaction");w2utils.bindEvents(t,this);t=this.applyFilter(r.name,null,e);r.tmp.searchCount=t,r.tmp.search=e,this.refreshSearch(r.name),this.initControls(l.overlay),this.refreshIndex(r.name)}}),r.on("hide:after.attach",e=>{w2tooltip.hide(r.name+"-tooltip")}),l.select=t=>(r.on("select.attach",e=>{t(e)}),l),l.remove=t=>(r.on("remove.attach",e=>{t(e)}),l),l.subMenu=t=>(r.on("subMenu.attach",e=>{t(e)}),l),l}initControls(i){query(i.box).find(".w2ui-menu:not(.w2ui-sub-menu)").off(".w2menu").on("mouseDown.w2menu",{delegate:".w2ui-menu-item"},e=>{var t=e.delegate.dataset;this.menuDown(i,e,t.index,t.parents)}).on((w2utils.isIOS?"touchStart":"click")+".w2menu",{delegate:".w2ui-menu-item"},e=>{var t=e.delegate.dataset;this.menuClick(i,e,parseInt(t.index),t.parents)}).find(".w2ui-menu-item").off(".w2menu").on("mouseEnter.w2menu",e=>{var t=e.target.dataset,t=i.options.items[t.index]?.tooltip;t&&w2tooltip.show({name:i.name+"-tooltip",anchor:e.target,html:t,position:"right|left",hideOn:["doc-click"]})}).on("mouseLeave.w2menu",e=>{w2tooltip.hide(i.name+"-tooltip")}),["INPUT","TEXTAREA"].includes(i.anchor.tagName)&&query(i.anchor).off(".w2menu").on("input.w2menu",e=>{}).on("keyup.w2menu",e=>{e._searchType="filter",this.keyUp(i,e)}),i.options.search&&query(i.box).find("#menu-search").off(".w2menu").on("keyup.w2menu",e=>{e._searchType="search",this.keyUp(i,e)})}getCurrent(e,t){let i=Tooltip.active[e.replace(/[\s\.#]/g,"_")];var s=i.options;let l=(t||(i.selected??"")).split("-");e=l.length-1;let r=l[e];t=l.slice(0,l.length-1).join("-");r=w2utils.isInt(r)?parseInt(r):0;let n=w2utils.normMenu(s.items);return l.forEach((e,t)=>{t<l.length-1&&(n=w2utils.normMenu(n[e].items))}),{last:e,index:r,items:n,item:n[r],parents:t}}getMenuHTML(h,t,d,u){if(h.spinner)return`
            <div class="w2ui-menu">
                <div class="w2ui-no-items">
                    <div class="w2ui-spinner"></div>
                    ${w2utils.lang("Loading...")}
                </div>
            </div>`;u=u||[],null==t&&(t=h.items),t=w2utils.normMenu(t),Array.isArray(t)||(t=[]);let c=0,i=null,e="";!d&&h.search&&(e+=`
                <div class="w2ui-menu-search">
                    <span class="w2ui-icon w2ui-icon-search"></span>
                    <input id="menu-search" class="w2ui-input" type="text"/>
                </div>`,t.forEach(e=>e.hidden=!1)),!d&&h.topHTML&&(e+=`<div class="w2ui-menu-top">${h.topHTML}</div>`);let p=`
            ${e}
            <div class="w2ui-menu ${d?"w2ui-sub-menu":""}" ${d?"":`style="${h.menuStyle}"`}
                data-parent="${u}">
        `;return t.forEach((n,a)=>{i=n.icon;var o=(0<u.length?u.join("-")+"-":"")+a;if(null==i&&(i=null),-1==["radio","check"].indexOf(h.type)||Array.isArray(n.items)||!1===n.group||(i=!0===n.checked?"w2ui-icon-check":"w2ui-icon-empty"),!0!==n.hidden){let s=n.text,l="",r="";if("function"==typeof h.render&&(s=h.render(n,h)),"function"==typeof s&&(s=s(n,h)),i&&(l='<div class="menu-icon"><span class="w2ui-icon '+i+'"></span></div>'),"break"!==n.type&&null!=s&&""!==s&&"--"!=String(s).substr(0,2)){let e=["w2ui-menu-item"];1==h.altRows&&e.push(c%2==0?"w2ui-even":"w2ui-odd");let t=1;""===l&&t++,null==n.count&&null==n.hotkey&&!0!==n.remove&&null==n.items&&t++,null==n.tooltip&&null!=n.hint&&(n.tooltip=n.hint);let i="";if(!0===n.remove)i='<span class="remove">x</span>';else if(null!=n.items){let e=[];"function"==typeof n.items?e=n.items(n):Array.isArray(n.items)&&(e=n.items),i="<span></span>",r=`
                            <div class="w2ui-sub-menu-box" style="${n.expanded?"":"display: none"}">
                                ${this.getMenuHTML(h,e,!0,u.concat(a))}
                            </div>`}else null!=n.count&&(i+="<span>"+n.count+"</span>"),null!=n.hotkey&&(i+='<span class="hotkey">'+n.hotkey+"</span>");!0===n.disabled&&e.push("w2ui-disabled"),!0===n._noSearchInside&&e.push("w2ui-no-search-inside"),""!==r&&(e.push("has-sub-menu"),n.expanded?e.push("expanded"):e.push("collapsed")),p+=`
                        <div index="${o}" class="${e.join(" ")}" style="${n.style||""}"
                            data-index="${a}" data-parents="${u.join("-")}">
                                <div style="width: ${(d?20:0)+parseInt(n.indent??0)}px"></div>
                                ${l}
                                <div class="menu-text" colspan="${t}">${w2utils.lang(s)}</div>
                                <div class="menu-extra">${i}</div>
                        </div>
                        ${r}`,c++}else{var e=(s??"").replace(/^-+/g,"");p+=`
                        <div index="${o}" class="w2ui-menu-divider ${""!=e?"has-text":""}">
                            <div class="line"></div>
                            ${e?`<div class="text">${e}</div>`:""}
                        </div>`}}t[a]=n}),0===c&&h.msgNoItems&&(p+=`
                <div class="w2ui-no-items">
                    ${w2utils.lang(h.msgNoItems)}
                </div>`),p+="</div>",p}refreshIndex(t){var i=Tooltip.active[t.replace(/[\s\.#]/g,"_")];if(i){i.displayed||this.show(i.name);var s=query(i.box).find(".w2ui-overlay-body").get(0),t=query(i.box).find(".w2ui-menu-search, .w2ui-menu-top").get(0);query(i.box).find(".w2ui-menu-item.w2ui-selected").removeClass("w2ui-selected");let e=query(i.box).find(`.w2ui-menu-item[index="${i.selected}"]`).addClass("w2ui-selected").get(0);e&&(e.offsetTop+e.clientHeight>s.clientHeight+s.scrollTop&&e.scrollIntoView({behavior:"smooth",block:"start",inline:"start"}),e.offsetTop<s.scrollTop+(t?t.clientHeight:0)&&e.scrollIntoView({behavior:"smooth",block:"end",inline:"end"}))}}refreshSearch(i){let s=Tooltip.active[i.replace(/[\s\.#]/g,"_")];s&&(s.displayed||this.show(s.name),query(s.box).find(".w2ui-no-items").hide(),query(s.box).find(".w2ui-menu-item, .w2ui-menu-divider").each(e=>{var t;this.getCurrent(i,e.getAttribute("index")).item.hidden?query(e).hide():((t=s.tmp?.search)&&s.options.markSearch&&w2utils.marker(e,t,{onlyFirst:"begins"==s.options.match}),query(e).show())}),query(s.box).find(".w2ui-sub-menu").each(e=>{var t=query(e).find(".w2ui-menu-item").get().some(e=>"none"!=e.style.display);this.getCurrent(i,e.dataset.parent).item.expanded&&(t?query(e).parent().show():query(e).parent().hide())}),0==s.tmp.searchCount&&(0==query(s.box).find(".w2ui-no-items").length&&query(s.box).find(".w2ui-menu:not(.w2ui-sub-menu)").append(`
                    <div class="w2ui-no-items">
                        ${w2utils.lang(s.options.msgNoItems)}
                    </div>`),query(s.box).find(".w2ui-no-items").show()))}applyFilter(r,e,n){let a=0,t=Tooltip.active[r.replace(/[\s\.#]/g,"_")],o=t.options;if(!1!==o.filter){null==e&&(e=o.items),null==n&&(n=["INPUT","TEXTAREA"].includes(t.anchor.tagName)?t.anchor.value:"");let l=[];return o.selected&&(Array.isArray(o.selected)?l=o.selected.map(e=>e?.id??e):o.selected?.id&&(l=[o.selected.id])),e.forEach(t=>{let i="",s="";-1!==["is","begins","begins with"].indexOf(o.match)&&(i="^"),-1!==["is","ends","ends with"].indexOf(o.match)&&(s="$");try{let e=new RegExp(i+n+s,"i");e.test(t.text)||"..."===t.text?t.hidden=!1:t.hidden=!0}catch(e){}var e;o.hideSelected&&l.includes(t.id)&&(t.hidden=!0),Array.isArray(t.items)&&0<t.items.length&&(delete t._noSearchInside,0<(e=this.applyFilter(r,t.items,n))&&(a+=e,t.hidden&&(t._noSearchInside=!0),n&&(t.expanded=!0),t.hidden=!1)),!0!==t.hidden&&a++}),t.tmp.activeChain=null,a}}getActiveChain(i,e,s=[],l=[],t){let r=Tooltip.active[i.replace(/[\s\.#]/g,"_")];return null!=r.tmp.activeChain?r.tmp.activeChain:((e=null==e?r.options.items:e).forEach((e,t)=>{e.hidden||e.disabled||e?.text.startsWith("--")||(l.push(s.concat([t]).join("-")),Array.isArray(e.items)&&0<e.items.length&&e.expanded&&(s.push(t),this.getActiveChain(i,e.items,s,l,!0),s.pop()))}),null==t&&(r.tmp.activeChain=l),l)}menuDown(e,t,i,s){e=e.options;let l=w2utils.normMenu(e.items),r=query(t.delegate).find(".w2ui-icon"),n=query(t.target).closest(".w2ui-menu:not(.w2ui-sub-menu)");if("string"==typeof s&&""!==s){let e=s.split("-");e.forEach(e=>{l=w2utils.normMenu(l[e].items)})}let a=l[i];if(!a.disabled){let l=(i,s)=>{i.forEach((e,t)=>{e.id!=a.id&&(e.group===a.group&&e.checked&&(n.find(`.w2ui-menu-item[index="${(s?s+"-":"")+t}"] .w2ui-icon`).removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),i[t].checked=!1),Array.isArray(e.items)&&l(e.items,t))})};"check"!==e.type&&"radio"!==e.type||!1===a.group||query(t.target).hasClass("remove")||query(t.target).closest(".w2ui-menu-item").hasClass("has-sub-menu")||(a.checked="radio"==e.type||!a.checked,a.checked?("radio"===e.type&&query(t.target).closest(".w2ui-menu").find(".w2ui-icon").removeClass("w2ui-icon-check").addClass("w2ui-icon-empty"),"check"===e.type&&null!=a.group&&l(e.items),r.removeClass("w2ui-icon-empty").addClass("w2ui-icon-check")):"check"===e.type&&r.removeClass("w2ui-icon-check").addClass("w2ui-icon-empty")),query(t.target).hasClass("remove")||(n.find(".w2ui-menu-item").removeClass("w2ui-selected"),query(t.delegate).addClass("w2ui-selected"))}}menuClick(t,i,s,l){let r=t.options,n=w2utils.normMenu(r.items),a=query(i.delegate).closest(".w2ui-menu-item"),o=!r.hideOn.includes("select");if((i.shiftKey||i.metaKey||i.ctrlKey)&&(o=!0),"string"==typeof l&&""!==l){let e=l.split("-");e.forEach(e=>{n=w2utils.normMenu(n[e].items)})}else l=null;"function"==typeof n&&(n=n({overlay:t,index:s,parentIndex:l,event:i}));let h=n[s];if(!h.disabled||query(i.target).hasClass("remove")){let e;if(query(i.target).hasClass("remove")){if(e=this.trigger("remove",{target:t.name,overlay:t,item:h,index:s,parentIndex:l,el:a[0]}),!0===e.isCancelled)return;o=!r.hideOn.includes("item-remove"),a.remove()}else if(a.hasClass("has-sub-menu")){if(e=this.trigger("subMenu",{target:t.name,overlay:t,item:h,index:s,parentIndex:l,el:a[0]}),!0===e.isCancelled)return;o=!0,a.hasClass("expanded")?(h.expanded=!1,a.removeClass("expanded").addClass("collapsed"),query(a.get(0).nextElementSibling).hide()):(h.expanded=!0,a.addClass("expanded").removeClass("collapsed"),query(a.get(0).nextElementSibling).show()),t.selected=parseInt(a.attr("index"))}else{i=this.findChecked(r.items);if(e=this.trigger("select",{target:t.name,overlay:t,item:h,index:s,parentIndex:l,selected:i,keepOpen:o,el:a[0]}),!0===e.isCancelled)return;t.selected=parseInt(a.attr("index")),null!=h.keepOpen&&(o=h.keepOpen),["INPUT","TEXTAREA"].includes(t.anchor.tagName)&&(t.anchor.dataset.selected=h.id,t.anchor.dataset.selectedIndex=t.selected)}o||this.hide(t.name),e.finish()}}findChecked(e){let t=[];return e.forEach(e=>{e.checked&&t.push(e),Array.isArray(e.items)&&(t=t.concat(this.findSelected(e.items)))}),t}keyUp(s,l){var t,e,r=s.options,i=l.target.value;let n=!0,a=!1;switch(l.keyCode){case 8:""!==i||s.displayed||(n=!1);break;case 13:if(!s.displayed||!s.selected)return;var{index:o,parents:h}=this.getCurrent(s.name);l.delegate=query(s.box).find(".w2ui-selected").get(0),this.menuClick(s,l,parseInt(o),h),n=!1;break;case 27:if(n=!1,s.displayed)this.hide(s.name);else{let e=s.anchor;["INPUT","TEXTAREA"].includes(e.tagName)&&(e.value="",delete e.dataset.selected,delete e.dataset.selectedIndex)}break;case 37:{if(!s.displayed)return;let{item:e,index:t,parents:i}=this.getCurrent(s.name);i&&(e=r.items[i],t=parseInt(i),i="",a=!0),Array.isArray(e.items)&&0<e.items.length&&e.expanded&&(l.delegate=query(s.box).find(`.w2ui-menu-item[index="${t}"]`).get(0),s.selected=t,this.menuClick(s,l,parseInt(t),i)),n=!1;break}case 39:if(!s.displayed)return;var{item:d,index:o,parents:h}=this.getCurrent(s.name);Array.isArray(d.items)&&0<d.items.length&&!d.expanded&&(l.delegate=query(s.box).find(".w2ui-selected").get(0),this.menuClick(s,l,parseInt(o),h)),n=!1;break;case 38:{if(!s.displayed)break;let e=this.getActiveChain(s.name);null==s.selected||0==s.selected?.length?s.selected=e[e.length-1]:(-1==(t=e.indexOf(s.selected))&&(s.selected=e[e.length-1]),0<t&&(s.selected=e[t-1])),n=!1,a=!0,l.preventDefault();break}case 40:{if(!s.displayed)break;let e=this.getActiveChain(s.name);null==s.selected||0==s.selected?.length?s.selected=e[0]:(-1==(t=e.indexOf(s.selected))&&(s.selected=e[0]),t<e.length-1&&(s.selected=e[t+1])),n=!1,a=!0,l.preventDefault();break}}n&&s.displayed&&(r.filter&&"filter"==l._searchType||r.search&&"search"==l._searchType)&&(e=this.applyFilter(s.name,r.items,i),s.tmp.searchCount=e,s.tmp.search=i,0!==e&&this.getActiveChain(s.name).includes(s.selected)||(s.selected=null),this.refreshSearch(s.name)),a&&this.refreshIndex(s.name)}}class DateTooltip extends Tooltip{constructor(){super();let e=new Date;this.months=w2utils.settings.fullmonths,this.smonths=w2utils.settings.shortmonths,this.daysCount=[31,28,31,30,31,30,31,31,30,31,30,31],this.today=e.getFullYear()+"/"+(Number(e.getMonth())+1)+"/"+e.getDate(),this.days=w2utils.settings.fulldays.slice(),this.sdays=w2utils.settings.shortdays.slice(),"M"!==w2utils.settings.weekStarts&&(this.days.unshift(this.days.pop()),this.sdays.unshift(this.sdays.pop())),this.defaults=w2utils.extend({},this.defaults,{position:"top|bottom",class:"w2ui-calendar",type:"date",format:"",value:"",start:null,end:null,blockDates:[],blockWeekdays:[],colored:{},arrowSize:12,autoResize:!1,anchorClass:"w2ui-focus",autoShowOn:"focus",hideOn:["doc-click","focus-change"],onSelect:null})}attach(e,t){let i;1==arguments.length&&e.anchor?(i=e,e=i.anchor):2===arguments.length&&null!=t&&"object"==typeof t&&(i=t,i.anchor=e);var s=i.hideOn;i=w2utils.extend({},this.defaults,i||{}),s&&(i.hideOn=s),i.format||(s=w2utils.settings.dateFormat,l=w2utils.settings.timeFormat,"date"==i.type?i.format=s:"time"==i.type?i.format=l:i.format=s+"|"+l);var l="time"==i.type?this.getHourHTML(i):this.getMonthHTML(i);i.style+="; padding: 0;",i.html=l.html;let r=super.attach(i),n=r.overlay;return Object.assign(n.tmp,l),n.on("show.attach",e=>{let t=e.detail.overlay;var i=t.anchor,e=t.options;["INPUT","TEXTAREA"].includes(i.tagName)&&!e.value&&i.value&&(t.tmp.initValue=i.value),delete t.newValue,delete t.newDate}),n.on("show:after.attach",e=>{r.overlay?.box&&this.initControls(r.overlay)}),n.on("update:after.attach",e=>{r.overlay?.box&&this.initControls(r.overlay)}),n.on("hide.attach",e=>{let t=e.detail.overlay,i=t.anchor;if(null!=t.newValue){t.newDate&&(t.newValue=t.newDate+" "+t.newValue),["INPUT","TEXTAREA"].includes(i.tagName)&&i.value!=t.newValue&&(i.value=t.newValue);let e=this.trigger("select",{date:t.newValue,target:t.name,overlay:t});!0!==e.isCancelled&&e.finish()}}),r.select=t=>(n.on("select.attach",e=>{t(e)}),r),r}initControls(r){let n=r.options,t=e=>{let{month:t,year:i}=r.tmp;t+=e,12<t&&(t=1,i++),t<1&&(t=12,i--);e=this.getMonthHTML(n,t,i);Object.assign(r.tmp,e),query(r.box).find(".w2ui-overlay-body").html(e.html),this.initControls(r)},i=(e,t)=>{query(e.target).parent().find(".w2ui-jump-month, .w2ui-jump-year").removeClass("selected"),query(e.target).addClass("selected");let i=new Date,{jumpMonth:s,jumpYear:l}=r.tmp;t&&(null==l&&(l=i.getFullYear()),null==s&&(s=i.getMonth()+1)),s&&l&&(t=this.getMonthHTML(n,s,l),Object.assign(r.tmp,t),query(r.box).find(".w2ui-overlay-body").html(t.html),r.tmp.jump=!1,this.initControls(r))};query(r.box).find(".w2ui-cal-title").off(".calendar").on("click.calendar",e=>{if(Object.assign(r.tmp,{jumpYear:null,jumpMonth:null}),r.tmp.jump){var{month:t,year:i}=r.tmp,i=this.getMonthHTML(n,t,i);query(r.box).find(".w2ui-overlay-body").html(i.html),r.tmp.jump=!1}else{query(r.box).find(".w2ui-overlay-body .w2ui-cal-days").replace(this.getYearHTML());let e=query(r.box).find(`[name="${r.tmp.year}"]`).get(0);e&&e.scrollIntoView(!0),r.tmp.jump=!0}this.initControls(r),e.stopPropagation()}).find(".w2ui-cal-previous").off(".calendar").on("click.calendar",e=>{t(-1),e.stopPropagation()}).parent().find(".w2ui-cal-next").off(".calendar").on("click.calendar",e=>{t(1),e.stopPropagation()}),query(r.box).find(".w2ui-cal-now").off(".calendar").on("click.calendar",e=>{"datetime"==n.type?r.newDate?r.newValue=w2utils.formatTime(new Date,n.format.split("|")[1]):r.newValue=w2utils.formatDateTime(new Date,n.format):"date"==n.type?r.newValue=w2utils.formatDate(new Date,n.format):"time"==n.type&&(r.newValue=w2utils.formatTime(new Date,n.format)),this.hide(r.name)}),query(r.box).off(".calendar").on("click.calendar",{delegate:".w2ui-day.date"},e=>{"datetime"==n.type?(r.newDate=query(e.target).attr("date"),query(r.box).find(".w2ui-overlay-body").html(this.getHourHTML(r.options).html),this.initControls(r)):(r.newValue=query(e.target).attr("date"),this.hide(r.name))}).on("click.calendar",{delegate:".w2ui-jump-month"},e=>{r.tmp.jumpMonth=parseInt(query(e.target).attr("name")),i(e)}).on("dblclick.calendar",{delegate:".w2ui-jump-month"},e=>{r.tmp.jumpMonth=parseInt(query(e.target).attr("name")),i(e,!0)}).on("click.calendar",{delegate:".w2ui-jump-year"},e=>{r.tmp.jumpYear=parseInt(query(e.target).attr("name")),i(e)}).on("dblclick.calendar",{delegate:".w2ui-jump-year"},e=>{r.tmp.jumpYear=parseInt(query(e.target).attr("name")),i(e,!0)}).on("click.calendar",{delegate:".w2ui-time.hour"},e=>{e=query(e.target).attr("hour");let t=this.str2min(n.value)%60;r.tmp.initValue&&!n.value&&(t=this.str2min(r.tmp.initValue)%60),n.noMinutes?(r.newValue=this.min2str(60*e,n.format),this.hide(r.name)):(r.newValue=e+":"+t,e=this.getMinHTML(e,n).html,query(r.box).find(".w2ui-overlay-body").html(e),this.initControls(r))}).on("click.calendar",{delegate:".w2ui-time.min"},e=>{e=60*Math.floor(this.str2min(r.newValue)/60)+parseInt(query(e.target).attr("min"));r.newValue=this.min2str(e,n.format),this.hide(r.name)})}getMonthHTML(r,n,e){let t=new Date;let i="datetime"===r.type?w2utils.isDateTime(r.value,r.format,!0):w2utils.isDate(r.value,r.format,!0);var a=w2utils.formatDate(i);null!=n&&null!=e||(e=(i||t).getFullYear(),n=i?i.getMonth()+1:t.getMonth()+1),12<n&&(n-=12,e++),(n<1||0===n)&&(n+=12,e--),e/4==Math.floor(e/4)?this.daysCount[1]=29:this.daysCount[1]=28,r.current=n+"/"+e,t=new Date(e,n-1,1);let s=t.getDay(),l="";var o=w2utils.settings.weekStarts;for(let e=0;e<this.sdays.length;e++){var h="M"==o&&5==e||"M"!=o&&6==e,d="M"==o&&6==e||"M"!=o&&0==e;l+=`<div class="w2ui-day weekday ${h?"sunday":""} ${d?"saturday":""}">${this.sdays[e]}</div>`}let u=`
            <div class="w2ui-cal-title">
                <div class="w2ui-cal-previous">
                    <div></div>
                </div>
                <div class="w2ui-cal-next">
                    <div></div>
                </div>
                ${this.months[n-1]}, ${e}
                <span class="arrow-down"></span>
            </div>
            <div class="w2ui-cal-days">
                ${l}
        `,c=new Date(`${e}/${n}/1`);var p=c.getDay();"M"==w2utils.settings.weekStarts&&s--,0<p&&(c=new Date(c.getTime()-864e5*s));for(let e=0;e<42;e++){let e=[];var f=`${c.getFullYear()}/${c.getMonth()+1}/${c.getDate()}`;6===c.getDay()&&e.push("saturday"),0===c.getDay()&&e.push("sunday"),c.getMonth()+1!==n&&e.push("outside"),f==this.today&&e.push("today");var m=c.getDate();let t="",i="",s,l;l="datetime"===r.type?(s=w2utils.formatDateTime(f,r.format),w2utils.formatDate(f,w2utils.settings.dateFormat)):(s=w2utils.formatDate(f,r.format),s),r.colored&&void 0!==r.colored[l]&&(f=r.colored[l].split("|"),i="background-color: "+f[0]+";",t="color: "+f[1]+";"),u+=`<div class="w2ui-day ${this.inRange(s,r,!0)?"date "+(l==a?"selected":""):"blocked"} ${e.join(" ")}"
                       style="${t+i}" date="${l}" data-date="${c.getTime()}">
                            ${m}
                    </div>`,c=new Date(c.getTime()+864e5)}return u+="</div>",r.btnNow&&(p=w2utils.lang("Today"+("datetime"==r.type?" & Now":"")),u+=`<div class="w2ui-cal-now">${p}</div>`),{html:u,month:n,year:e}}getYearHTML(){let t="",i="";for(let e=0;e<this.months.length;e++)t+=`<div class="w2ui-jump-month" name="${e+1}">${this.smonths[e]}</div>`;for(let e=w2utils.settings.dateStartYear;e<=w2utils.settings.dateEndYear;e++)i+=`<div class="w2ui-jump-year" name="${e}">${e}</div>`;return`<div class="w2ui-cal-jump">
            <div id="w2ui-jump-month">${t}</div>
            <div id="w2ui-jump-year">${i}</div>
        </div>`}getHourHTML(l){(l=l??{}).format||(l.format=w2utils.settings.timeFormat);var r,n=-1<l.format.indexOf("h24"),a=l.value||(l.anchor?l.anchor.value:"");let o=[];for(let s=0;s<24;s++){let e=(12<=s&&!n?s-12:s)+":00"+(n?"":s<12?" am":" pm");12!=s||n||(e="12:00 pm"),o[Math.floor(s/8)]||(o[Math.floor(s/8)]="");let t=this.min2str(this.str2min(e)),i=this.min2str(this.str2min(e)+59);"datetime"===l.type&&(r=w2utils.isDateTime(a,l.format,!0),h=l.format.split("|")[0].trim(),t=w2utils.formatDate(r,h)+" "+t,i=w2utils.formatDate(r,h)+" "+i);var h=this.inRange(t,l)||this.inRange(i,l);o[Math.floor(s/8)]+=`<span hour="${s}"
                class="hour ${h?"w2ui-time ":"blocked"}">${e}</span>`}return{html:`<div class="w2ui-calendar">
            <div class="w2ui-time-title">${w2utils.lang("Select Hour")}</div>
            <div class="w2ui-cal-time">
                <div class="w2ui-cal-column">${o[0]}</div>
                <div class="w2ui-cal-column">${o[1]}</div>
                <div class="w2ui-cal-column">${o[2]}</div>
            </div>
            ${l.btnNow?`<div class="w2ui-cal-now">${w2utils.lang("Now")}</div>`:""}
        </div>`}}getMinHTML(i,s){null==i&&(i=0),(s=s??{}).format||(s.format=w2utils.settings.timeFormat);var l=-1<s.format.indexOf("h24"),r=s.value||(s.anchor?s.anchor.value:"");let n=[];for(let t=0;t<60;t+=5){var a=(12<i&&!l?i-12:i)+":"+(t<10?0:"")+t+" "+(l?"":i<12?"am":"pm");let e=a;var o,h,d=t<20?0:t<40?1:2;n[d]||(n[d]=""),"datetime"===s.type&&(o=w2utils.isDateTime(r,s.format,!0),h=s.format.split("|")[0].trim(),e=w2utils.formatDate(o,h)+" "+e),n[d]+=`<span min="${t}" class="min ${this.inRange(e,s)?"w2ui-time ":"blocked"}">${a}</span>`}return{html:`<div class="w2ui-calendar">
            <div class="w2ui-time-title">${w2utils.lang("Select Minute")}</div>
            <div class="w2ui-cal-time">
                <div class="w2ui-cal-column">${n[0]}</div>
                <div class="w2ui-cal-column">${n[1]}</div>
                <div class="w2ui-cal-column">${n[2]}</div>
            </div>
            ${s.btnNow?`<div class="w2ui-cal-now">${w2utils.lang("Now")}</div>`:""}
        </div>`}}inRange(s,l,e){let r=!1;if("date"===l.type){let i=w2utils.isDate(s,l.format,!0);if(i){if(l.start||l.end){var n="string"==typeof l.start?l.start:query(l.start).val(),a="string"==typeof l.end?l.end:query(l.end).val();let e=w2utils.isDate(n,l.format,!0),t=w2utils.isDate(a,l.format,!0);a=new Date(i);e=e||a,t=t||a,a>=e&&a<=t&&(r=!0)}else r=!0;Array.isArray(l.blockDates)&&l.blockDates.includes(s)&&(r=!1),Array.isArray(l.blockWeekdays)&&l.blockWeekdays.includes(i.getDay())&&(r=!1)}}else if("time"===l.type)if(l.start||l.end){var i=this.str2min(s);let e=this.str2min(l.start),t=this.str2min(l.end);e=e||i,t=t||i,i>=e&&i<=t&&(r=!0)}else r=!0;else"datetime"===l.type&&w2utils.isDateTime(s,l.format,!0)&&(a=l.format.split("|").map(e=>e.trim()),e?(i=w2utils.formatDate(s,a[0]),e=w2utils.extend({},l,{type:"date",format:a[0]}),this.inRange(i,e)&&(r=!0)):(s=w2utils.formatTime(s,a[1]),l={type:"time",format:a[1],start:l.startTime,end:l.endTime},this.inRange(s,l)&&(r=!0)));return r}str2min(e){if("string"!=typeof e)return null;let t=e.split(":");return 2!==t.length?null:(t[0]=parseInt(t[0]),t[1]=parseInt(t[1]),-1!==e.indexOf("pm")&&12!==t[0]&&(t[0]+=12),e.includes("am")&&12==t[0]&&(t[0]=0),60*t[0]+t[1])}min2str(e,t){let i="";1440<=e&&(e%=1440),e<0&&(e=1440+e);var s=Math.floor(e/60),e=(e%60<10?"0":"")+e%60;return t=t||w2utils.settings.timeFormat,i=-1!==t.indexOf("h24")?s+":"+e:(s<=12?s:s-12)+":"+e+" "+(12<=s?"pm":"am"),i}}let w2tooltip=new Tooltip,w2menu=new MenuTooltip,w2color=new ColorTooltip,w2date=new DateTooltip;class w2toolbar extends w2base{constructor(e){super(e.name),this.box=null,this.name=null,this.routeData={},this.items=[],this.right="",this.tooltip="top|left",this.onClick=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.item_template={id:null,type:"button",text:null,html:"",tooltip:null,count:null,hidden:!1,disabled:!1,checked:!1,icon:null,route:null,arrow:null,style:null,group:null,items:null,selected:null,color:null,overlay:{anchorClass:""},onClick:null,onRefresh:null},this.last={badge:{}};var t=e.items;delete e.items,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.items=t}add(e){this.insert(null,e)}insert(r,e){(e=!Array.isArray(e)?[e]:e).forEach((e,t,i)=>{"string"==typeof e&&(e=i[t]={id:e,text:e});let s=["button","check","radio","drop","menu","menu-radio","menu-check","color","text-color","html","break","spacer","new-line"];if(s.includes(String(e.type)))if(null!=e.id||["break","spacer","new-line"].includes(e.type))if(null!=e.type){if(w2utils.checkUniqueId(e.id,this.items,"toolbar",this.name)){let s=w2utils.extend({},this.item_template,e);var l;"menu-check"==s.type?(Array.isArray(s.selected)||(s.selected=[]),Array.isArray(s.items)&&s.items.forEach(e=>{(e="string"==typeof e?i[t]={id:e,text:e}:e).checked&&!s.selected.includes(e.id)&&s.selected.push(e.id),!e.checked&&s.selected.includes(e.id)&&(e.checked=!0),null==e.checked&&(e.checked=!1)})):"menu-radio"==s.type&&Array.isArray(s.items)&&s.items.forEach((e,t,i)=>{(e="string"==typeof e?i[t]={id:e,text:e}:e).checked&&null==s.selected?s.selected=e.id:e.checked=!1,e.checked||s.selected!=e.id||(e.checked=!0),null==e.checked&&(e.checked=!1)}),null==r?this.items.push(s):(l=this.get(r,!0),this.items=this.items.slice(0,l).concat([s],this.items.slice(l))),s.line=s.line||1,this.refresh(s.id)}}else console.log('ERROR: The parameter "type" is required but not supplied.',e);else console.log('ERROR: The parameter "id" is required but not supplied.',e);else console.log('ERROR: The parameter "type" should be one of the following:',s,`, but ${e.type} is supplied.`,e)}),this.resize()}remove(){let i=0;return Array.from(arguments).forEach(e=>{var t=this.get(e);t&&-1==String(e).indexOf(":")&&(i++,query(this.box).find("#tb_"+this.name+"_item_"+w2utils.escapeId(t.id)).remove(),null!=(t=this.get(t.id,!0))&&this.items.splice(t,1))}),this.resize(),i}set(e,t){var i=this.get(e);return null!=i&&(Object.assign(i,t),this.refresh(String(e).split(":")[0]),!0)}get(e,i){if(0===arguments.length){let t=[];for(let e=0;e<this.items.length;e++)null!=this.items[e].id&&t.push(this.items[e].id);return t}var s=String(e).split(":");for(let e=0;e<this.items.length;e++){var t=this.items[e];if(["menu","menu-radio","menu-check"].includes(t.type)&&2==s.length&&t.id==s[0]){let e=t.items;"function"==typeof e&&(e=e(this));for(let t=0;t<e.length;t++){var l=e[t];if(l.id==s[1]||null==l.id&&l.text==s[1])return 1==i?t:l;if(Array.isArray(l.items))for(let e=0;e<l.items.length;e++)if(l.items[e].id==s[1]||null==l.items[e].id&&l.items[e].text==s[1])return 1==i?t:l.items[e]}}else if(t.id==s[0])return 1==i?e:t}return null}setCount(t,i,s,l){let r=query(this.box).find(`#tb_${this.name}_item_${w2utils.escapeId(t)} .w2ui-tb-count > span`);if(0<r.length){r.removeClass().addClass(s||"").text(i).get(0).style.cssText=l||"",this.last.badge[t]={className:s||"",style:l||""};let e=this.get(t);e.count=i}else this.set(t,{count:i}),this.setCount(...arguments)}show(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.hidden=!1,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.resize()})},15),i}hide(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.hidden=!0,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.tooltipHide(e),this.resize()})},15),i}enable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.disabled=!1,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}disable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&(t.disabled=!0,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.tooltipHide(e)})},15),i}check(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&-1==String(e).indexOf(":")&&(t.checked=!0,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}uncheck(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&-1==String(e).indexOf(":")&&(["menu","menu-radio","menu-check","drop","color","text-color"].includes(t.type)&&t.checked&&w2tooltip.hide(this.name+"-drop"),t.checked=!1,i.push(String(e).split(":")[0]))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}click(t,i){var e=String(t).split(":");let l=this.get(e[0]),r=l&&l.items?w2utils.normMenu.call(this,l.items,l):[];if(1<e.length){e=this.get(t);e&&!e.disabled&&this.menuClick({name:this.name,item:l,subItem:e,originalEvent:i})}else if(l&&!l.disabled){let e=this.trigger("click",{target:null!=t?t:this.name,item:l,object:l,originalEvent:i});if(!0!==e.isCancelled){r=l&&l.items?w2utils.normMenu.call(this,l.items,l):[];let s="#tb_"+this.name+"_item_"+w2utils.escapeId(l.id);if(query(this.box).find(s).removeClass("down"),"radio"==l.type){for(let t=0;t<this.items.length;t++){let e=this.items[t];null!=e&&e.id!=l.id&&"radio"===e.type&&e.group==l.group&&e.checked&&(e.checked=!1,this.refresh(e.id))}l.checked=!0,query(this.box).find(s).addClass("checked")}if(["menu","menu-radio","menu-check","drop","color","text-color"].includes(l.type)){if(this.tooltipHide(t),l.checked)return void w2tooltip.hide(this.name+"-drop");setTimeout(()=>{var t=(e,t)=>{let i=this;return function(){i.set(e,{checked:!1})}},i=query(this.box).find("#tb_"+this.name+"_item_"+w2utils.escapeId(l.id));if(w2utils.isPlainObject(l.overlay)||(l.overlay={}),"drop"==l.type&&w2tooltip.show(w2utils.extend({html:l.html,class:"w2ui-white",hideOn:["doc-click"]},l.overlay,{anchor:i[0],name:this.name+"-drop",data:{item:l,btn:s}})).hide(t(l.id,s)),["menu","menu-radio","menu-check"].includes(l.type)){let e="normal";"menu-radio"==l.type&&(e="radio",r.forEach(e=>{l.selected==e.id?e.checked=!0:e.checked=!1})),"menu-check"==l.type&&(e="check",r.forEach(e=>{Array.isArray(l.selected)&&l.selected.includes(e.id)?e.checked=!0:e.checked=!1})),w2menu.show(w2utils.extend({items:r},l.overlay,{type:e,name:this.name+"-drop",anchor:i[0],data:{item:l,btn:s}})).hide(t(l.id,s)).remove(e=>{this.menuClick({name:this.name,remove:!0,item:l,subItem:e.detail.item,originalEvent:e})}).select(e=>{this.menuClick({name:this.name,item:l,subItem:e.detail.item,originalEvent:e})})}["color","text-color"].includes(l.type)&&w2color.show(w2utils.extend({color:l.color},l.overlay,{anchor:i[0],name:this.name+"-drop",data:{item:l,btn:s}})).hide(t(l.id,s)).select(e=>{null!=e.detail.color&&this.colorClick({name:this.name,item:l,color:e.detail.color})})},0)}if(["check","menu","menu-radio","menu-check","drop","color","text-color"].includes(l.type)&&(l.checked=!l.checked,l.checked?query(this.box).find(s).addClass("checked"):query(this.box).find(s).removeClass("checked")),l.route){let t=String("/"+l.route).replace(/\/{2,}/g,"/");var n=w2utils.parseRoute(t);if(0<n.keys.length)for(let e=0;e<n.keys.length;e++)t=t.replace(new RegExp(":"+n.keys[e].name,"g"),this.routeData[n.keys[e].name]);setTimeout(()=>{window.location.hash=t},1)}this.tooltipShow(t),e.finish()}}}scroll(a,o,h){return new Promise((e,t)=>{let i=query(this.box).find(`.w2ui-tb-line:nth-child(${o}) .w2ui-scroll-wrapper`);var s=i.get(0).scrollLeft,l=i.find(".w2ui-tb-right").get(0),r=i.parent().get(0).getBoundingClientRect().width,n=s+parseInt(l.offsetLeft)+parseInt(l.clientWidth);switch(a){case"left":scroll=s-r+50,scroll<=0&&(scroll=0),i.get(0).scrollTo({top:0,left:scroll,behavior:h?"atuo":"smooth"});break;case"right":scroll=s+r-50,scroll>=n-r&&(scroll=n-r),i.get(0).scrollTo({top:0,left:scroll,behavior:h?"atuo":"smooth"})}setTimeout(()=>{this.resize(),e()},h?0:500)})}render(e){var t=(new Date).getTime();let l=this.trigger("render",{target:this.name,box:e});if(!0!==l.isCancelled&&(null!=e&&(0<query(this.box).find(".w2ui-scroll-wrapper .w2ui-tb-right").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-toolbar").html(""),this.box=e),this.box)){Array.isArray(this.right)||(this.right=[this.right]);let i="",s=0;for(let t=0;t<this.items.length;t++){let e=this.items[t];null!=e&&(null==e.id&&(e.id="item_"+t),null!=e.caption&&console.log("NOTICE: toolbar item.caption property is deprecated, please use item.text. Item -> ",e),null!=e.hint&&console.log("NOTICE: toolbar item.hint property is deprecated, please use item.tooltip. Item -> ",e),0!==t&&"new-line"!=e.type||(s++,i+=`
                    <div class="w2ui-tb-line">
                        <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">
                            <div class="w2ui-tb-right">${this.right[s-1]||""}</div>
                        </div>
                        <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll", "left", "${s}"]'></div>
                        <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll", "right", "${s}"]'></div>
                    </div>
                `),e.line=s)}return query(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-toolbar").html(i),0<query(this.box).length&&(query(this.box)[0].style.cssText+=this.style),w2utils.bindEvents(query(this.box).find(".w2ui-tb-line .w2ui-eaction"),this),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),this.refresh(),this.resize(),l.finish(),(new Date).getTime()-t}}refresh(t){var i=(new Date).getTime();let l=this.trigger("refresh",{target:null!=t?t:this.name,item:this.get(t)});if(!0!==l.isCancelled){let e;if(null!=t){var r=this.get(t);if(null==r)return!1;if("function"!=typeof r.onRefresh||(e=this.trigger("refresh",{target:t,item:r,object:r}),!0!==e.isCancelled)){var n=`#tb_${this.name}_item_${w2utils.escapeId(r.id)}`;let s=query(this.box).find(n);var a=this.getItemHTML(r);if(this.tooltipHide(t),"spacer"==r.type&&query(this.box).find(`.w2ui-tb-line:nth-child(${r.line}`).find(".w2ui-tb-right").css("width","auto"),0===s.length){t=parseInt(this.get(t,!0))+1;let e=query(this.box).find(`#tb_${this.name}_item_${w2utils.escapeId(this.items[t]?this.items[t].id:"")}`);0==e.length?e=query(this.box).find(`.w2ui-tb-line:nth-child(${r.line}`).find(".w2ui-tb-right").before(a):e.after(a),w2utils.bindEvents(query(this.box).find(n),this)}else{query(this.box).find(n).replace(query.html(a));let t=query(this.box).find(n).get(0);w2utils.bindEvents(t,this);let i=w2tooltip.get(!0);Object.keys(i).forEach(e=>{i[e].anchor==s.get(0)&&(i[e].anchor=t)})}return"function"==typeof r.onRefresh&&e.finish(),l.finish(),(new Date).getTime()-i}}else for(let t=0;t<this.items.length;t++){let e=this.items[t];null==e.id&&(e.id="item_"+t),this.refresh(e.id)}}}resize(){var e=(new Date).getTime();let t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled)return query(this.box).find(".w2ui-tb-line").each(e=>{let t=query(e);t.find(".w2ui-scroll-left, .w2ui-scroll-right").hide();var i=t.find(".w2ui-scroll-wrapper").get(0),s=t.find(".w2ui-tb-right"),e=t.get(0).getBoundingClientRect().width,s=0<s.length?s[0].offsetLeft+s[0].clientWidth:0;e<s&&(0<i.scrollLeft&&t.find(".w2ui-scroll-left").show(),e<s-i.scrollLeft&&t.find(".w2ui-scroll-right").show())}),t.finish(),(new Date).getTime()-e}destroy(){let e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<query(this.box).find(".w2ui-scroll-wrapper  .w2ui-tb-right").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-toolbar").html(""),query(this.box).html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish())}getItemHTML(i){let e="";null!=i.caption&&null==i.text&&(i.text=i.caption),null==i.text&&(i.text=""),null==i.tooltip&&null!=i.hint&&(i.tooltip=i.hint),null==i.tooltip&&(i.tooltip=""),"function"==typeof i.get||!Array.isArray(i.items)&&"function"!=typeof i.items||(i.get=function(t){let e=i.items;return"function"==typeof e&&(e=i.items(i)),e.find(e=>e.id==t)});let t="",s="function"==typeof i.text?i.text.call(this,i):i.text;i.icon&&(t=i.icon,"function"==typeof i.icon&&(t=i.icon.call(this,i)),"<"!==String(t).slice(0,1)&&(t=`<span class="${t}"></span>`),t=`<div class="w2ui-tb-icon">${t}</div>`);let l=["w2ui-tb-button"];switch(i.checked&&l.push("checked"),i.disabled&&l.push("disabled"),i.hidden&&l.push("hidden"),t||l.push("no-icon"),i.type){case"color":case"text-color":"string"==typeof i.color&&("#"==i.color.slice(0,1)&&(i.color=i.color.slice(1)),[3,6,8].includes(i.color.length)&&(i.color="#"+i.color)),"color"==i.type&&(s=`<span class="w2ui-tb-color-box" style="background-color: ${null!=i.color?i.color:"#fff"}"></span>
                           ${i.text?`<div style="margin-left: 17px;">${w2utils.lang(i.text)}</div>`:""}`),"text-color"==i.type&&(s='<span style="color: '+(null!=i.color?i.color:"#444")+';">'+(i.text?w2utils.lang(i.text):"<b>Aa</b>")+"</span>");case"menu":case"menu-check":case"menu-radio":case"button":case"check":case"radio":case"drop":var r=!0===i.arrow||!1!==i.arrow&&["menu","menu-radio","menu-check","drop","color","text-color"].includes(i.type);e=`
                    <div id="tb_${this.name}_item_${i.id}" style="${i.hidden?"display: none":""}"
                        class="${l.join(" ")} ${i.class||""}"
                        ${i.disabled?"":`data-click='["click","${i.id}"]'
                               data-mouseenter='["mouseAction", "event", "this", "enter", "${i.id}"]'
                               data-mouseleave='["mouseAction", "event", "this", "leave", "${i.id}"]'
                               data-mousedown='["mouseAction", "event", "this", "down", "${i.id}"]'
                               data-mouseup='["mouseAction", "event", "this", "up", "${i.id}"]'`}
                    >
                        ${t}
                        ${""!=s?`<div class="w2ui-tb-text" style="${i.style||""}">
                                    ${w2utils.lang(s)}
                                    ${null!=i.count?w2utils.stripSpaces(`<span class="w2ui-tb-count">
                                                <span class="${this.last.badge[i.id]&&this.last.badge[i.id].className||""}"
                                                    style="${this.last.badge[i.id]&&this.last.badge[i.id].style||""}"
                                                >${i.count}</span>
                                           </span>`):""}
                                    ${r?'<span class="w2ui-tb-down"><span></span></span>':""}
                                </div>`:""}
                    </div>
                `;break;case"break":e=`<div id="tb_${this.name}_item_${i.id}" class="w2ui-tb-break"
                            style="${i.hidden?"display: none":""}; ${i.style||""}">
                            &#160;
                        </div>`;break;case"spacer":e=`<div id="tb_${this.name}_item_${i.id}" class="w2ui-tb-spacer"
                            style="${i.hidden?"display: none":""}; ${i.style||""}">
                        </div>`;break;case"html":e=`<div id="tb_${this.name}_item_${i.id}" class="w2ui-tb-html ${l.join(" ")}"
                            style="${i.hidden?"display: none":""}; ${i.style||""}">
                            ${"function"==typeof i.html?i.html.call(this,i):i.html}
                        </div>`}return e}tooltipShow(t){if(null!=this.tooltip){var i=query(this.box).find("#tb_"+this.name+"_item_"+w2utils.escapeId(t)).get(0),s=this.get(t),t=this.tooltip;let e=s.tooltip;"function"==typeof e&&(e=e.call(this,s)),["menu","menu-radio","menu-check","drop","color","text-color"].includes(s.type)&&1==s.checked||w2tooltip.show({anchor:i,name:this.name+"-tooltip",html:e,position:t})}}tooltipHide(e){null!=this.tooltip&&w2tooltip.hide(this.name+"-tooltip")}menuClick(i){if(i.item&&!i.item.disabled){let t=this.trigger(!0!==i.remove?"click":"remove",{target:i.item.id+":"+i.subItem.id,item:i.item,subItem:i.subItem,originalEvent:i.originalEvent});if(!0!==t.isCancelled){let l=i.subItem,r=this.get(i.item.id),e=r.items;if("function"==typeof e&&(e=r.items()),"menu"==r.type&&(r.selected=l.id),"menu-radio"==r.type&&(r.selected=l.id,Array.isArray(e)&&e.forEach(e=>{!0===e.checked&&delete e.checked,Array.isArray(e.items)&&e.items.forEach(e=>{!0===e.checked&&delete e.checked})}),l.checked=!0),"menu-check"==r.type)if(Array.isArray(r.selected)||(r.selected=[]),null==l.group){var s=r.selected.indexOf(l.id);-1==s?(r.selected.push(l.id),l.checked=!0):(r.selected.splice(s,1),l.checked=!1)}else if(!1!==l.group){let s=[];!function i(e){e.forEach(e=>{var t;e.group!==l.group||-1!=(t=r.selected.indexOf(e.id))&&(e.id!=l.id&&s.push(e.id),r.selected.splice(t,1)),Array.isArray(e.items)&&i(e.items)})}(e),-1==r.selected.indexOf(l.id)&&(r.selected.push(l.id),l.checked=!0)}if("string"==typeof l.route){let t=""!==l.route?String("/"+l.route).replace(/\/{2,}/g,"/"):"";var n=w2utils.parseRoute(t);if(0<n.keys.length)for(let e=0;e<n.keys.length;e++)null!=this.routeData[n.keys[e].name]&&(t=t.replace(new RegExp(":"+n.keys[e].name,"g"),this.routeData[n.keys[e].name]));setTimeout(()=>{window.location.hash=t},1)}this.refresh(i.item.id),t.finish()}}}colorClick(t){if(t.item&&!t.item.disabled){let e=this.trigger("click",{target:t.item.id,item:t.item,color:t.color,final:t.final,originalEvent:t.originalEvent});!0!==e.isCancelled&&(t.item.color=t.color,this.refresh(t.item.id),e.finish())}}mouseAction(e,t,i,s){var l=this.get(s);if(!l.disabled&&!l.hidden)switch(i){case"enter":query(t).addClass("over"),this.tooltipShow(s);break;case"leave":query(t).removeClass("over down"),this.tooltipHide(s);break;case"down":query(t).addClass("down");break;case"up":query(t).removeClass("down")}}}class w2sidebar extends w2base{constructor(e){super(e.name),this.name=null,this.box=null,this.sidebar=null,this.parent=null,this.nodes=[],this.menu=[],this.routeData={},this.selected=null,this.icon=null,this.style="",this.topHTML="",this.bottomHTML="",this.flatButton=!1,this.keyboard=!0,this.flat=!1,this.hasFocus=!1,this.levelPadding=12,this.skipRefresh=!1,this.tabIndex=null,this.handle={size:0,style:"",html:""},this.onClick=null,this.onDblClick=null,this.onContextMenu=null,this.onMenuClick=null,this.onExpand=null,this.onCollapse=null,this.onKeydown=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onFocus=null,this.onBlur=null,this.onFlat=null,this.node_template={id:null,text:"",order:null,count:null,icon:null,nodes:[],style:"",route:null,selected:!1,expanded:!1,hidden:!1,disabled:!1,group:!1,groupShowHide:!0,collapsible:!1,plus:!1,onClick:null,onDblClick:null,onContextMenu:null,onExpand:null,onCollapse:null,parent:null,sidebar:null},this.last={badge:{}};var t=e.nodes;delete e.nodes,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.nodes=t}add(e,t){return 1==arguments.length&&(t=arguments[0],e=this),"string"==typeof e&&(e=this.get(e)),this.insert(e=null==e||""==e?this:e,null,t)}insert(t,i,s){let l,r,n,a,o;if(2==arguments.length&&"string"==typeof t)if(s=arguments[1],null!=(i=arguments[0])){if(r=this.get(i),null==r)return null!=(s=!Array.isArray(s)?[s]:s)[0].caption&&null==s[0].text&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",s[0]),s[0].text=s[0].caption),l=s[0].text,console.log('ERROR: Cannot insert node "'+l+'" because cannot find node "'+i+'" to insert before.'),null;t=this.get(i).parent}else t=this;null!=(t="string"==typeof t?this.get(t):t)&&""!=t||(t=this),Array.isArray(s)||(s=[s]);for(let e=0;e<s.length;e++)if(a=s[e],null!=a.caption&&null==a.text&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text"),a.text=a.caption),null!=typeof a.id)if(null==this.get(this,a.id)){if(n=Object.assign({},this.node_template,a),n.sidebar=this,n.parent=t,o=n.nodes||[],n.nodes=[],null==i)t.nodes.push(n);else{if(r=this.get(t,i,!0),null==r)return console.log('ERROR: Cannot insert node "'+a.text+'" because cannot find node "'+i+'" to insert before.'),null;t.nodes.splice(r,0,n)}0<o.length&&this.insert(n,null,o)}else console.log("ERROR: Cannot insert node with id="+a.id+" (text: "+a.text+") because another node with the same id already exists.");else l=a.text,console.log('ERROR: Cannot insert node "'+l+'" because it has no id.');return this.skipRefresh||this.refresh(t.id),n}remove(){let t=0,i;return Array.from(arguments).forEach(e=>{i=this.get(e),null!=i&&(null!=this.selected&&this.selected===i.id&&(this.selected=null),null!=(e=this.get(i.parent,e,!0))&&(i.parent.nodes[e].selected&&i.sidebar.unselect(i.id),i.parent.nodes.splice(e,1),t++))}),this.skipRefresh||(0<t&&1==arguments.length?this.refresh(i.parent.id):this.refresh()),t}set(t,i,s){if(2==arguments.length&&(s=i,i=t,t=this),null==(t="string"==typeof t?this.get(t):t).nodes)return null;for(let e=0;e<t.nodes.length;e++){if(t.nodes[e].id===i){var l=this.update(i,s);return 0!=Object.keys(l).length&&(l=s.nodes,w2utils.extend(t.nodes[e],s,{nodes:[]}),null!=l&&this.add(t.nodes[e],l),this.skipRefresh||this.refresh(i)),!0}if(this.set(t.nodes[e],i,s))return!0}return!1}get(t,i,s){if(0===arguments.length){let t=[];var l=this.find({});for(let e=0;e<l.length;e++)null!=l[e].id&&t.push(l[e].id);return t}if((1==arguments.length||2==arguments.length&&!0===i)&&(s=i,i=t,t=this),null==(t="string"==typeof t?this.get(t):t).nodes)return null;for(let e=0;e<t.nodes.length;e++){if(t.nodes[e].id==i)return!0===s?e:t.nodes[e];var r=this.get(t.nodes[e],i,s);if(r||0===r)return r}return null}setCount(t,i,s,l){let r=query(this.box).find(`#node_${w2utils.escapeId(t)} .w2ui-node-count`);if(0<r.length){r.removeClass().addClass(`w2ui-node-count ${s||""}`).text(i).get(0).style.cssText=l||"",this.last.badge[t]={className:s||"",style:l||""};let e=this.get(t);e.count=i}else this.set(t,{count:i}),this.setCount(...arguments)}find(i,s,l){if(1==arguments.length&&(s=i,i=this),l=l||[],null==(i="string"==typeof i?this.get(i):i).nodes)return l;for(let t=0;t<i.nodes.length;t++){let e=!0;for(var r in s)i.nodes[t][r]!=s[r]&&(e=!1);e&&l.push(i.nodes[t]),0<i.nodes[t].nodes.length&&(l=this.find(i.nodes[t],s,l))}return l}sort(l,e){null==(l=!l||"object"!=typeof l?{}:l).foldersFirst&&(l.foldersFirst=!0),null==l.caseSensitive&&(l.caseSensitive=!1),null==l.reverse&&(l.reverse=!1),(e=null==e?this.nodes:e).sort((i,s)=>{var e=i.nodes&&0<i.nodes.length,t=s.nodes&&0<s.nodes.length;if(!1===l.foldersFirst||!e&&!t||e&&t){let e=i.text,t=s.text;l.caseSensitive||(e=e.toLowerCase(),t=t.toLowerCase()),null!=i.order&&(e=i.order),null!=s.order&&(t=s.order);s=w2utils.naturalCompare(e,t);return(1===s||-1===s)&l.reverse?-s:s}return e&&!t?l.reverse?1:-1:!e&&t?l.reverse?-1:1:void 0}),e.forEach(e=>{e.nodes&&0<e.nodes.length&&this.sort(l,e.nodes)})}each(t,e){(e=null==e?this.nodes:e).forEach(e=>{t.call(this,e),e.nodes&&0<e.nodes.length&&this.each(t,e.nodes)})}search(e){let t=0,i=e.toLowerCase();return this.each(e=>{-1===e.text.toLowerCase().indexOf(i)?e.hidden=!0:(t++,function e(t){t.parent&&(t.parent.hidden=!1,e(t.parent))}(e),e.hidden=!1)}),this.refresh(),t}show(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!1!==t.hidden&&(t.hidden=!1,i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}hide(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!0!==t.hidden&&(t.hidden=!0,i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}enable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!1!==t.disabled&&(t.disabled=!1,i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}disable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);null!=t&&!0!==t.disabled&&(t.disabled=!0,t.selected&&this.unselect(t.id),i.push(t.id))}),0<i.length&&(1==arguments.length?this.refresh(arguments[0]):this.refresh()),i}select(e){let t=this.get(e);if(!t)return!1;if(this.selected==e&&t.selected)return!1;this.unselect(this.selected);let i=query(this.box).find("#node_"+w2utils.escapeId(e));return i.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),0<i.length&&(this.inView(e)||this.scrollIntoView(e)),t.selected=!0,this.selected=e,!0}unselect(e){0===arguments.length&&(e=this.selected);let t=this.get(e);return!!t&&(t.selected=!1,query(this.box).find("#node_"+w2utils.escapeId(e)).removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected"),this.selected==e&&(this.selected=null),!0)}toggle(e){var t=this.get(e);return null!=t&&(t.plus?(this.set(e,{plus:!1}),this.expand(e),void this.refresh(e)):0!==t.nodes.length&&(!!t.collapsible&&(this.get(e).expanded?this.collapse(e):this.expand(e))))}collapse(e){let t=this,i=this.get(e);if(null==i)return!1;let s=this.trigger("collapse",{target:e,object:i});return!0!==s.isCancelled?(query(this.box).find("#node_"+w2utils.escapeId(e)+"_sub").hide(),query(this.box).find("#node_"+w2utils.escapeId(e)+" .w2ui-expanded").removeClass("w2ui-expanded").addClass("w2ui-collapsed"),i.expanded=!1,s.finish(),setTimeout(()=>{t.refresh(e)},0),!0):void 0}expand(e){let t=this.get(e),i=this.trigger("expand",{target:e,object:t});if(!0!==i.isCancelled)return query(this.box).find("#node_"+w2utils.escapeId(e)+"_sub").show(),query(this.box).find("#node_"+w2utils.escapeId(e)+" .w2ui-collapsed").removeClass("w2ui-collapsed").addClass("w2ui-expanded"),t.expanded=!0,i.finish(),this.refresh(e),!0}collapseAll(t){if(null==(t="string"==typeof(t=null==t?this:t)?this.get(t):t).nodes)return!1;for(let e=0;e<t.nodes.length;e++)!0===t.nodes[e].expanded&&(t.nodes[e].expanded=!1),t.nodes[e].nodes&&0<t.nodes[e].nodes.length&&this.collapseAll(t.nodes[e]);return this.refresh(t.id),!0}expandAll(t){if(null==(t="string"==typeof(t=null==t?this:t)?this.get(t):t).nodes)return!1;for(let e=0;e<t.nodes.length;e++)!1===t.nodes[e].expanded&&(t.nodes[e].expanded=!0),t.nodes[e].nodes&&0<t.nodes[e].nodes.length&&this.expandAll(t.nodes[e]);this.refresh(t.id)}expandParents(e){let t=this.get(e);return null!=t&&(t.parent&&(t.parent.expanded||(t.parent.expanded=!0,this.refresh(t.parent.id)),this.expandParents(t.parent.id)),!0)}click(l,r){let n=this,a=this.get(l);if(null!=a&&!a.disabled&&!a.group){query(n.box).find(".w2ui-node.w2ui-selected").each(e=>{var t=query(e).attr("id").replace("node_","");let i=n.get(t);null!=i&&(i.selected=!1),query(e).removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected")});let t=query(n.box).find("#node_"+w2utils.escapeId(l)),s=query(n.box).find("#node_"+w2utils.escapeId(n.selected));t.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected"),setTimeout(()=>{let e=n.trigger("click",{target:l,originalEvent:r,node:a,object:a});if(!0===e.isCancelled)return t.removeClass("w2ui-selected").find(".w2ui-icon").removeClass("w2ui-icon-selected"),void s.addClass("w2ui-selected").find(".w2ui-icon").addClass("w2ui-icon-selected");if(null!=s&&(s.selected=!1),n.get(l).selected=!0,n.selected=l,"string"==typeof a.route){let t=""!==a.route?String("/"+a.route).replace(/\/{2,}/g,"/"):"";var i=w2utils.parseRoute(t);if(0<i.keys.length)for(let e=0;e<i.keys.length;e++)null!=n.routeData[i.keys[e].name]&&(t=t.replace(new RegExp(":"+i.keys[e].name,"g"),n.routeData[i.keys[e].name]));setTimeout(()=>{window.location.hash=t},1)}e.finish()},1)}}focus(e){let t=this,i=this.trigger("focus",{target:this.name,originalEvent:e});if(!0===i.isCancelled)return!1;this.hasFocus=!0,query(this.box).find(".w2ui-sidebar-body").addClass("w2ui-focus"),setTimeout(()=>{let e=query(t.box).find("#sidebar_"+t.name+"_focus").get(0);document.activeElement!=e&&e.focus()},10),i.finish()}blur(e){let t=this.trigger("blur",{target:this.name,originalEvent:e});if(!0===t.isCancelled)return!1;this.hasFocus=!1,query(this.box).find(".w2ui-sidebar-body").removeClass("w2ui-focus"),t.finish()}keydown(t){let n=this,i=n.get(n.selected);if(!0===n.keyboard){i=i||n.nodes[0];let e=n.trigger("keydown",{target:n.name,originalEvent:t});function s(e,t){null==e||e.hidden||e.disabled||e.group||(n.click(e.id,t),n.inView(e.id)||n.scrollIntoView(e.id))}function l(e,t){for(e=t(e);null!=e&&(e.hidden||e.disabled)&&!e.group;)e=t(e);return e}function r(e){if(null==e)return null;var t=e.parent,e=n.get(e.id,!0);let i=0<e?function t(i){if(i.expanded&&0<i.nodes.length){let e=i.nodes[i.nodes.length-1];return(e.hidden||e.disabled||e.group?r:t)(e)}return i}(t.nodes[e-1]):t;return null!=i&&(i.hidden||i.disabled||i.group)&&(i=r(i)),i}!0!==e.isCancelled&&(13!=t.keyCode&&32!=t.keyCode||0<i.nodes.length&&n.toggle(n.selected),37==t.keyCode&&(0<i.nodes.length&&i.expanded?n.collapse(n.selected):(s(i.parent),i.parent.group||n.collapse(i.parent.id))),39==t.keyCode&&(0<i.nodes.length||i.plus)&&!i.expanded&&n.expand(n.selected),38==t.keyCode&&(null==n.get(n.selected)?s(this.nodes[0]||null):s(l(i,r))),40==t.keyCode&&(null==n.get(n.selected)?s(this.nodes[0]||null):s(l(i,function t(i,e){if(null==i)return null;let s=i.parent;let l=n.get(i.id,!0);let r=null;if(i.expanded&&0<i.nodes.length&&!0!==e){let e=i.nodes[0];r=e.hidden||e.disabled||e.group?t(e):e}else r=s&&l+1<s.nodes.length?s.nodes[l+1]:t(s,!0);null!=r&&(r.hidden||r.disabled||r.group)&&(r=t(r));return r}))),[13,32,37,38,39,40].includes(t.keyCode)&&(t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation()),e.finish())}}inView(e){var t=query(this.box).find("#node_"+w2utils.escapeId(e)).get(0);if(!t)return!1;e=query(this.box).find(".w2ui-sidebar-body").get(0);return!(t.offsetTop<e.scrollTop||t.offsetTop+t.clientHeight>e.clientHeight+e.scrollTop)}scrollIntoView(i,s){return new Promise((t,e)=>{if(null==i&&(i=this.selected),null!=this.get(i)){let e=query(this.box).find("#node_"+w2utils.escapeId(i)).get(0);e.scrollIntoView({block:"center",inline:"center",behavior:s?"atuo":"smooth"}),setTimeout(()=>{this.resize(),t()},s?0:500)}})}dblClick(e,t){var i=this.get(e);let s=this.trigger("dblClick",{target:e,originalEvent:t,object:i});!0!==s.isCancelled&&(this.toggle(e),s.finish())}contextMenu(t,i){var e=this.get(t);t!=this.selected&&this.click(t);let s=this.trigger("contextMenu",{target:t,originalEvent:i,object:e,allowOnDisabled:!1});!0!==s.isCancelled&&(e.disabled&&!s.allowOnDisabled||(0<this.menu.length&&w2menu.show({name:this.name+"_menu",anchor:document.body,items:this.menu,originalEvent:i}).select(e=>{this.menuClick(t,parseInt(e.detail.index),i)}),i.preventDefault&&i.preventDefault(),s.finish()))}menuClick(e,t,i){let s=this.trigger("menuClick",{target:e,originalEvent:i,menuIndex:t,menuItem:this.menu[t]});!0!==s.isCancelled&&s.finish()}goFlat(){let e=this.trigger("flat",{goFlat:!this.flat});!0!==e.isCancelled&&(this.flat=!this.flat,this.refresh(),e.finish())}render(e){var i=(new Date).getTime();let s=this,l=this.trigger("render",{target:this.name,box:e});if(!0!==l.isCancelled&&(null!=e&&(0<query(this.box).find(".w2ui-sidebar-body").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-sidebar").html(""),this.box=e),this.box)){query(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-sidebar").html(`<div>
                <div class="w2ui-sidebar-top"></div>
                <input id="sidebar_${this.name}_focus" ${this.tabIndex?'tabindex="'+this.tabIndex+'"':""}
                    style="position: absolute; top: 0; right: 0; width: 1px; z-index: -1; opacity: 0"
                    ${w2utils.isIOS?"readonly":""}/>
                <div class="w2ui-sidebar-body"></div>
                <div class="w2ui-sidebar-bottom"></div>
            </div>`);e=query(this.box).get(0).getBoundingClientRect();query(this.box).find(":scope > div").css({width:e.width+"px",height:e.height+"px"}),query(this.box).get(0).style.cssText+=this.style;let t;return query(this.box).find("#sidebar_"+this.name+"_focus").on("focus",function(e){clearTimeout(t),s.hasFocus||s.focus(e)}).on("blur",function(e){t=setTimeout(()=>{s.hasFocus&&s.blur(e)},100)}).on("keydown",function(e){9!=e.keyCode&&w2ui[s.name].keydown.call(w2ui[s.name],e)}),query(this.box).off("mousedown").on("mousedown",function(e){setTimeout(()=>{if(-1==["INPUT","TEXTAREA","SELECT"].indexOf(e.target.tagName.toUpperCase())){let e=query(s.box).find("#sidebar_"+s.name+"_focus");document.activeElement!=e.get(0)&&e.get(0).focus()}},1)}),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),l.finish(),this.refresh(),(new Date).getTime()-i}}update(e,i){let s=this.get(e),l;if(s){let t=query(this.box).find("#node_"+w2utils.escapeId(s.id));if(s.group)i.text&&(s.text=i.text,t.find(".w2ui-group-text").replace("function"==typeof s.text?s.text.call(this,s):'<span class="w2ui-group-text">'+s.text+"</span>"),delete i.text),i.class&&(s.class=i.class,l=t.data("level"),t.get(0).className="w2ui-node-group w2ui-level-"+l+(s.class?" "+s.class:""),delete i.class),i.style&&(s.style=i.style,t.get(0).nextElementSibling.style=s.style+";"+(!s.hidden&&s.expanded?"":"display: none;"),delete i.style);else{if(i.icon){let e=t.find(".w2ui-node-image > span");0<e.length&&(s.icon=i.icon,e[0].className="function"==typeof s.icon?s.icon.call(this,s):s.icon,delete i.icon)}if(i.count&&(s.count=i.count,t.find(".w2ui-node-count").html(s.count),0<t.find(".w2ui-node-count").length&&delete i.count),i.class&&0<t.length&&(s.class=i.class,l=t.data("level"),t[0].className="w2ui-node w2ui-level-"+l+(s.selected?" w2ui-selected":"")+(s.disabled?" w2ui-disabled":"")+(s.class?" "+s.class:""),delete i.class),i.text&&(s.text=i.text,t.find(".w2ui-node-text").html("function"==typeof s.text?s.text.call(this,s):s.text),delete i.text),i.style&&0<t.length){let e=t.find(".w2ui-node-text");s.style=i.style,e[0].style=s.style,delete i.style}}}return i}refresh(n,a){if(null!=this.box){var o=(new Date).getTime();let r=this.trigger("refresh",{target:null!=n?n:this.name,fullRefresh:null==n});if(!0!==r.isCancelled){let e="";1==this.flatButton&&(e=`<div class="w2ui-flat w2ui-flat-${this.flat?"right":"left"}"></div>`),null!=n||""===this.topHTML&&""===e||(query(this.box).find(".w2ui-sidebar-top").html(this.topHTML+e),query(this.box).find(".w2ui-sidebar-body").css("top",query(this.box).find(".w2ui-sidebar-top").get(0).clientHeight+"px"),query(this.box).find(".w2ui-flat").off("clcik").on("click",e=>{this.goFlat()})),null!=n&&""!==this.bottomHTML&&(query(this.box).find(".w2ui-sidebar-bottom").html(this.bottomHTML),query(this.box).find(".w2ui-sidebar-body").css("bottom",query(this.box).find(".w2ui-sidebar-bottom").get(0).clientHeight+"px")),query(this.box).find(":scope > div").removeClass("w2ui-sidebar-flat").addClass(this.flat?"w2ui-sidebar-flat":"").css({width:query(this.box).get(0).clientWidth+"px",height:query(this.box).get(0).clientHeight+"px"}),0<this.nodes.length&&null==this.nodes[0].parent&&(d=this.nodes,this.nodes=[],this.add(this,d));let h=this,t,i;if(null==n)t=this,i=".w2ui-sidebar-body";else{if(t=this.get(n),null==t)return;i="#node_"+w2utils.escapeId(t.id)+"_sub"}var d="#node_"+w2utils.escapeId(t.id);let s;t!==this&&(s=c(t),query(this.box).find(d).before('<div id="sidebar_'+this.name+'_tmp"></div>'),query(this.box).find(d).remove(),query(this.box).find(i).remove(),query(this.box).find("#sidebar_"+this.name+"_tmp").before(s),query(this.box).find("#sidebar_"+this.name+"_tmp").remove());let l=query(this.box).find(":scope > div").get(0);n={top:l.scrollTop,left:l.scrollLeft};query(this.box).find(i).html("");for(let e=0;e<t.nodes.length;e++){var u=t.nodes[e];if(s=c(u),query(this.box).find(i).append(s),0!==u.nodes.length)this.refresh(u.id,!0);else{let e=this.trigger("refresh",{target:u.id});if(!0===e.isCancelled)return;e.finish()}}return l.scrollTop=n.top,l.scrollLeft=n.left,a||(d=query(this.box).find(`${d}.w2ui-eaction, ${i} .w2ui-eaction`),w2utils.bindEvents(d,this)),r.finish(),(new Date).getTime()-o;function c(i){let s="",l=i.icon;null==l&&(l=h.icon);let r=i.parent,n=0;for(;r&&null!=r.parent;)r=r.parent,n++;if(null!=i.caption&&null==i.text&&(i.text=i.caption),null!=i.caption&&(console.log("NOTICE: sidebar node.caption property is deprecated, please use node.text. Node -> ",i),i.text=i.caption),Array.isArray(i.nodes)&&0<i.nodes.length&&(i.collapsible=!0),i.group){let e=w2utils.lang("function"==typeof i.text?i.text.call(h,i):i.text);"<span"!=String(e).substr(0,5)&&(e=`<span class="w2ui-group-text">${e}</span>`),s=`
                    <div id="node_${i.id}" data-level="${n}" style="${i.hidden?"display: none":""}"
                        class="w2ui-node-group w2ui-level-${n} ${i.class||""} w2ui-eaction"
                        data-click="toggle|${i.id}"
                        data-contextmenu="contextMenu|${i.id}|event"
                        data-mouseenter="showPlus|this|inherit"
                        data-mouseleave="showPlus|this|transparent">
                        ${i.groupShowHide&&i.collapsible?`<span>${!i.hidden&&i.expanded?w2utils.lang("Hide"):w2utils.lang("Show")}</span>`:"<span></span>"} ${e}
                    </div>
                    <div class="w2ui-node-sub" id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}">
                </div>`,h.flat&&(s=`
                        <div class="w2ui-node-group" id="node_${i.id}"><span>&#160;</span></div>
                        <div id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}"></div>`)}else{i.selected&&!i.disabled&&(h.selected=i.id),r="",l&&(r=`
                    <div class="w2ui-node-image">
                        <span class="${"function"==typeof l?l.call(h,i):l}"></span>
                    </div>`);let e="";var a=null!=i.count?`<div class="w2ui-node-count ${h.last.badge[i.id]&&h.last.badge[i.id].className||""}"
                            style="${h.last.badge[i.id]&&h.last.badge[i.id].style||""}">
                                ${i.count}
                       </div>`:"";!0===i.collapsible&&(e=`<div class="w2ui-${i.expanded?"expanded":"collapsed"}"><span></span></div>`);var o=w2utils.lang("function"==typeof i.text?i.text.call(h,i):i.text);let t=["w2ui-node",`w2ui-level-${n}`,"w2ui-eaction"];i.selected&&t.push("w2ui-selected"),i.disabled&&t.push("w2ui-disabled"),i.class&&t.push(i.class),s=`
                    <div id="node_${i.id}" class="${t.join(" ")}" data-level="${n}"
                        style="position: relative; ${i.hidden?"display: none;":""}"
                        data-click="click|${i.id}|event"
                        data-dblclick="dblClick|${i.id}|event"
                        data-contextmenu="contextMenu|${i.id}|event">
                        ${h.handle.html?`<div class="w2ui-node-handle" style="width: ${h.handle.size}px; ${h.handle.style}">
                                   ${"function"==typeof h.handle.html?h.handle.html.call(h,i):h.handle.html}
                              </div>`:""}
                      <div class="w2ui-node-data" style="margin-left: ${n*h.levelPadding+h.handle.size}px">
                            ${e} ${r} ${a}
                            <div class="w2ui-node-text w2ui-node-caption" style="${i.style||""}">${o}</div>
                       </div>
                    </div>
                    <div class="w2ui-node-sub" id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}"></div>`,h.flat&&(o=w2utils.base64encode(o+(i.count||0===i.count?' - <span class="w2ui-node-count">'+i.count+"</span>":"")),s=`
                        <div id="node_${i.id}" class="${t.join(" ")}" style="${i.hidden?"display: none;":""}"
                            data-click="click|${i.id}|event"
                            data-dblclick="dblClick|${i.id}|event"
                            data-contextmenu="contextMenu|${i.id}|event"
                            data-mouseenter="tooltip|this|${o}|${i.id}"
                            data-mouseleave="tooltip|this|">
                            <div class="w2ui-node-data w2ui-node-flat">${r}</div>
                        </div>
                        <div class="w2ui-node-sub" id="node_${i.id}_sub" style="${i.style}; ${!i.hidden&&i.expanded?"":"display: none;"}"></div>`)}return s}}}}tooltip(e,t,i){let s=query(e).find(".w2ui-node-data");""!==t?w2tooltip.show({anchor:s.get(0),name:this.name+"_tooltip",html:w2utils.base64decode(t),position:"right|left"}):w2tooltip.hide(this.name+"_tooltip")}showPlus(e,t){query(e).find("span:nth-child(1)").css("color",t)}resize(){var e=(new Date).getTime();let t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled){var i=query(this.box).get(0).getBoundingClientRect();return query(this.box).css("overflow","hidden"),query(this.box).find(":scope > div").css({width:i.width+"px",height:i.height+"px"}),t.finish(),(new Date).getTime()-e}}destroy(){let e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<query(this.box).find(".w2ui-sidebar-body").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-sidebar").html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish())}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),w2utils.lock(...i)}unlock(e){w2utils.unlock(this.box,e)}}class w2tabs extends w2base{constructor(e){super(e.name),this.box=null,this.name=null,this.active=null,this.reorder=!1,this.flow="down",this.tooltip="top|left",this.tabs=[],this.routeData={},this.last={},this.right="",this.style="",this.onClick=null,this.onClose=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.tab_template={id:null,text:null,route:null,hidden:!1,disabled:!1,closable:!1,tooltip:null,style:"",onClick:null,onRefresh:null,onClose:null};var t=e.tabs;delete e.tabs,Object.assign(this,e),Array.isArray(t)&&this.add(t),e.tabs=t}add(e){return this.insert(null,e)}insert(s,e){Array.isArray(e)||(e=[e]);let l=[];return e.forEach(e=>{var t,i;null!=e.id?w2utils.checkUniqueId(e.id,this.tabs,"tabs",this.name)&&(t=Object.assign({},this.tab_template,e),null==s?(this.tabs.push(t),l.push(this.animateInsert(null,t))):(i=this.get(s,!0),e=this.tabs[i].id,this.tabs.splice(i,0,t),l.push(this.animateInsert(e,t)))):console.log(`ERROR: The parameter "id" is required but not supplied. (obj: ${this.name})`)}),Promise.all(l)}remove(){let t=0;return Array.from(arguments).forEach(e=>{e=this.get(e);e&&(t++,this.tabs.splice(this.get(e.id,!0),1),query(this.box).find(`#tabs_${this.name}_tab_${w2utils.escapeId(e.id)}`).remove())}),this.resize(),t}select(e){return this.active!=e&&null!=this.get(e)&&(this.active=e,this.refresh(),!0)}set(e,t){var i=this.get(e,!0);return null!=i&&(w2utils.extend(this.tabs[i],t),this.refresh(e),!0)}get(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.tabs.length;e++)null!=this.tabs[e].id&&t.push(this.tabs[e].id);return t}for(let e=0;e<this.tabs.length;e++)if(this.tabs[e].id==t)return!0===i?e:this.tabs[e];return null}show(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!1!==t.hidden&&(t.hidden=!1,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.resize()})},15),i}hide(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!0!==t.hidden&&(t.hidden=!0,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e),this.resize()})},15),i}enable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!1!==t.disabled&&(t.disabled=!1,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}disable(){let i=[];return Array.from(arguments).forEach(e=>{let t=this.get(e);t&&!0!==t.disabled&&(t.disabled=!0,i.push(t.id))}),setTimeout(()=>{i.forEach(e=>{this.refresh(e)})},15),i}dragMove(n){if(this.last.reordering){let s=this,l=this.last.moving;var e=this.tabs[l.index],a=h(l.index,1),o=h(l.index,-1);let r=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(e.id));if(0<l.divX&&a){let e=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(a.id)),t=parseInt(r.get(0).clientWidth),i=parseInt(e.get(0).clientWidth);if(t=t<i?Math.floor(t/3):Math.floor(i/3),i-=t,l.divX>i){a=this.tabs.indexOf(a);return this.tabs.splice(l.index,0,this.tabs.splice(a,1)[0]),l.$tab.before(e.get(0)),l.$tab.css("opacity",0),void Object.assign(this.last.moving,{index:a,divX:-t,x:n.pageX+t,left:l.left+l.divX+t})}}if(l.divX<0&&o){let e=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(o.id)),t=parseInt(r.get(0).clientWidth),i=parseInt(e.get(0).clientWidth);t=t<i?Math.floor(t/3):Math.floor(i/3),i-=t,Math.abs(l.divX)>i&&(o=this.tabs.indexOf(o),this.tabs.splice(l.index,0,this.tabs.splice(o,1)[0]),e.before(l.$tab),l.$tab.css("opacity",0),Object.assign(l,{index:o,divX:t,x:n.pageX-t,left:l.left+l.divX-t}))}function h(e,t){e+=t;let i=s.tabs[e];return i&&i.hidden&&(i=h(e,t)),i}}}tooltipShow(t){var i=this.get(t),s=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(t)).get(0);if(null!=this.tooltip&&!i.disabled&&!this.last.reordering){t=this.tooltip;let e=i.tooltip;"function"==typeof e&&(e=e.call(this,i)),w2tooltip.show({anchor:s,name:this.name+"_tooltip",html:e,position:t})}}tooltipHide(e){null!=this.tooltip&&w2tooltip.hide(this.name+"_tooltip")}getTabHTML(e){e=this.get(e,!0);let t=this.tabs[e];if(null==t)return!1;null==t.text&&null!=t.caption&&(t.text=t.caption),null==t.tooltip&&null!=t.hint&&(t.tooltip=t.hint),null!=t.caption&&console.log("NOTICE: tabs tab.caption property is deprecated, please use tab.text. Tab -> ",t),null!=t.hint&&console.log("NOTICE: tabs tab.hint property is deprecated, please use tab.tooltip. Tab -> ",t);let i=t.text;"function"==typeof i&&(i=i.call(this,t)),null==i&&(i="");let s="",l="";return t.hidden&&(l+="display: none;"),t.disabled&&(l+="opacity: 0.2;"),t.closable&&!t.disabled&&(s=`<div class="w2ui-tab-close w2ui-eaction ${this.active===t.id?"active":""}"
                data-mouseenter='["tooltipShow", "${t.id}"]'
                data-mouseleave='["tooltipHide", "${t.id}"]'
                data-mousedown="stop"
                data-mouseup='["clickClose", "${t.id}", "event"]'>
            </div>`),`
            <div id="tabs_${this.name}_tab_${t.id}" style="${l} ${t.style}"
               class="w2ui-tab w2ui-eaction ${this.active===t.id?"active":""} ${t.closable?"closable":""} ${t.class||""}"
               data-mouseenter ='["tooltipShow", "${t.id}"]'
               data-mouseleave ='["tooltipHide", "${t.id}"]'
               data-mousedown  ='["initReorder", "${t.id}", "event"]'
               data-click      ='["click", "${t.id}", "event"]'
               >
                    ${w2utils.lang(i)+s}
            </div>`}refresh(t){var e=(new Date).getTime();"up"==this.flow?query(this.box).addClass("w2ui-tabs-up"):query(this.box).removeClass("w2ui-tabs-up");let i=this.trigger("refresh",{target:null!=t?t:this.name,object:this.get(t)});if(!0!==i.isCancelled){if(null==t)for(let e=0;e<this.tabs.length;e++)this.refresh(this.tabs[e].id);else{var s="#tabs_"+this.name+"_tab_"+w2utils.escapeId(t);let e=query(this.box).find(s);t=this.getTabHTML(t);0===e.length?query(this.box).find("#tabs_"+this.name+"_right").before(t):0==query(this.box).find(".tab-animate-insert").length&&e.replace(t),w2utils.bindEvents(query(this.box).find(`${s}, ${s} .w2ui-eaction`),this)}return query(this.box).find("#tabs_"+this.name+"_right").html(this.right),i.finish(),(new Date).getTime()-e}}render(e){var t=(new Date).getTime();let i=this.trigger("render",{target:this.name,box:e});if(!0!==i.isCancelled){if(null!=e&&(0<query(this.box).find("#tabs_"+this.name+"_right").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-tabs").html(""),this.box=e),!this.box)return!1;e=`
            <div class="w2ui-tabs-line"></div>
            <div class="w2ui-scroll-wrapper w2ui-eaction" data-mousedown="resize">
                <div id="tabs_${this.name}_right" class="w2ui-tabs-right">${this.right}</div>
            </div>
            <div class="w2ui-scroll-left w2ui-eaction" data-click='["scroll","left"]'></div>
            <div class="w2ui-scroll-right w2ui-eaction" data-click='["scroll","right"]'></div>`;return query(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-tabs").html(e),0<query(this.box).length&&(query(this.box)[0].style.cssText+=this.style),w2utils.bindEvents(query(this.box).find(".w2ui-eaction"),this),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),i.finish(),this.refresh(),this.resize(),(new Date).getTime()-t}}initReorder(e,n){if(this.reorder){let t=this,i=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(e)),s=this.get(e,!0),l=query(i.get(0).cloneNode(!0)),r;l.attr("id","#tabs_"+this.name+"_tab_ghost"),this.last.moving={index:s,indexFrom:s,$tab:i,$ghost:l,divX:0,left:i.get(0).getBoundingClientRect().left,parentX:query(this.box).get(0).getBoundingClientRect().left,x:n.pageX,opacity:i.css("opacity")},query(document).off(".w2uiTabReorder").on("mousemove.w2uiTabReorder",function(e){if(!t.last.reordering){if(r=t.trigger("reorder",{target:t.tabs[s].id,indexFrom:s,tab:t.tabs[s]}),!0===r.isCancelled)return;w2tooltip.hide(this.name+"_tooltip"),t.last.reordering=!0,l.addClass("moving"),l.css({"pointer-events":"none",position:"absolute",left:i.get(0).getBoundingClientRect().left}),i.css("opacity",0),query(t.box).find(".w2ui-scroll-wrapper").append(l.get(0)),query(t.box).find(".w2ui-tab-close").hide()}t.last.moving.divX=e.pageX-t.last.moving.x,l.css("left",t.last.moving.left-t.last.moving.parentX+t.last.moving.divX+"px"),t.dragMove(e)}).on("mouseup.w2uiTabReorder",function(){query(document).off(".w2uiTabReorder"),l.css({transition:"0.1s",left:t.last.moving.$tab.get(0).getBoundingClientRect().left-t.last.moving.parentX}),query(t.box).find(".w2ui-tab-close").show(),setTimeout(()=>{l.remove(),i.css({opacity:t.last.moving.opacity}),t.last.reordering&&r.finish({indexTo:t.last.moving.index}),t.last.reordering=!1},100)})}}scroll(a,o){return new Promise((e,t)=>{let i=query(this.box).find(".w2ui-scroll-wrapper");var s=i.get(0).scrollLeft,l=i.find(".w2ui-tabs-right").get(0),r=i.parent().get(0).getBoundingClientRect().width,n=s+parseInt(l.offsetLeft)+parseInt(l.clientWidth);switch(a){case"left":{let e=s-r+50;e<=0&&(e=0),i.get(0).scrollTo({top:0,left:e,behavior:o?"atuo":"smooth"});break}case"right":{let e=s+r-50;e>=n-r&&(e=n-r),i.get(0).scrollTo({top:0,left:e,behavior:o?"atuo":"smooth"});break}}setTimeout(()=>{this.resize(),e()},o?0:350)})}scrollIntoView(i,s){return new Promise((t,e)=>{if(null==i&&(i=this.active),null!=this.get(i)){let e=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(i)).get(0);e.scrollIntoView({block:"start",inline:"center",behavior:s?"atuo":"smooth"}),setTimeout(()=>{this.resize(),t()},s?0:500)}})}resize(){var i=(new Date).getTime();if(null!=this.box){let t=this.trigger("resize",{target:this.name});if(!0!==t.isCancelled){let e=query(this.box);e.find(".w2ui-scroll-left, .w2ui-scroll-right").hide();var s=e.find(".w2ui-scroll-wrapper").get(0),l=e.find(".w2ui-tabs-right"),r=e.get(0).getBoundingClientRect().width,l=0<l.length?l[0].offsetLeft+l[0].clientWidth:0;return r<l&&(0<s.scrollLeft&&e.find(".w2ui-scroll-left").show(),r<l-s.scrollLeft&&e.find(".w2ui-scroll-right").show()),t.finish(),(new Date).getTime()-i}}}destroy(){let e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&(0<query(this.box).find("#tabs_"+this.name+"_right").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-tabs").html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish())}click(e,t){var i=this.get(e);if(null==i||i.disabled||this.last.reordering)return!1;let s=this.trigger("click",{target:e,tab:i,object:i,originalEvent:t});if(!0!==s.isCancelled){if(query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(this.active)).removeClass("active"),query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(this.active)).removeClass("active"),this.active=i.id,"string"==typeof i.route){let t=""!==i.route?String("/"+i.route).replace(/\/{2,}/g,"/"):"";var l=w2utils.parseRoute(t);if(0<l.keys.length)for(let e=0;e<l.keys.length;e++)null!=this.routeData[l.keys[e].name]&&(t=t.replace(new RegExp(":"+l.keys[e].name,"g"),this.routeData[l.keys[e].name]));setTimeout(()=>{window.location.hash=t},1)}s.finish(),this.refresh(e)}}clickClose(e,t){var i=this.get(e);if(null==i||i.disabled)return!1;let s=this.trigger("close",{target:e,object:this.get(e),originalEvent:t});!0!==s.isCancelled&&(this.animateClose(e).then(()=>{this.remove(e),s.finish(),this.refresh()}),t&&t.stopPropagation())}animateClose(r){return new Promise((e,t)=>{let i=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(r));var s=parseInt(i.get(0).clientWidth||0);let l=i.replace(`<div class="tab-animate-close" style="display: inline-block; flex-shrink: 0; width: ${s}px; transition: width 0.25s"></div>`);setTimeout(()=>{l.css({width:"0px"})},1),setTimeout(()=>{l.remove(),this.resize(),e()},500)})}animateInsert(t,n){return new Promise((s,e)=>{let l=query(this.box).find("#tabs_"+this.name+"_tab_"+w2utils.escapeId(t)),r=query.html(this.getTabHTML(n.id));if(0==l.length)l=query(this.box).find("#tabs_tabs_right"),l.before(r),this.resize();else{r.css({opacity:0}),query(this.box).find("#tabs_tabs_right").before(r.get(0));let e=query(this.box).find("#"+r.attr("id")),t=e.get(0).clientWidth??0,i=query.html('<div class="tab-animate-insert" style="flex-shrink: 0; width: 0; transition: width 0.25s"></div>');l.before(i),r.hide(),i.before(r[0]),setTimeout(()=>{i.css({width:t+"px"})},1),setTimeout(()=>{i.remove(),r.css({opacity:1}).show(),this.refresh(n.id),this.resize(),s()},500)}})}}let w2panels=["top","left","main","preview","right","bottom"];class w2layout extends w2base{constructor(e){super(e.name),this.box=null,this.name=null,this.panels=[],this.last={},this.padding=1,this.resizer=4,this.style="",this.onShow=null,this.onHide=null,this.onResizing=null,this.onResizerClick=null,this.onRender=null,this.onRefresh=null,this.onChange=null,this.onResize=null,this.onDestroy=null,this.panel_template={type:null,title:"",size:100,minSize:20,maxSize:!1,hidden:!1,resizable:!1,overflow:"auto",style:"",html:"",tabs:null,toolbar:null,width:null,height:null,show:{toolbar:!1,tabs:!1},removed:null,onRefresh:null,onShow:null,onHide:null},Object.assign(this,e),Array.isArray(this.panels)||(this.panels=[]),this.panels.forEach((e,t)=>{this.panels[t]=w2utils.extend({},this.panel_template,e),(w2utils.isPlainObject(e.tabs)||Array.isArray(e.tabs))&&function(e,t,i){let s=e.get(t);null!=s&&null==i&&(i=s.tabs);if(null==s||null==i)return;Array.isArray(i)&&(i={tabs:i});var l=e.name+"_"+t+"_tabs";w2ui[l]&&w2ui[l].destroy();s.tabs=new w2tabs(w2utils.extend({},i,{owner:e,name:e.name+"_"+t+"_tabs"})),s.show.tabs=!0}(this,e.type),(w2utils.isPlainObject(e.toolbar)||Array.isArray(e.toolbar))&&function(e,t,i){let s=e.get(t);null!=s&&null==i&&(i=s.toolbar);if(null==s||null==i)return;Array.isArray(i)&&(i={items:i});var l=e.name+"_"+t+"_toolbar";w2ui[l]&&w2ui[l].destroy();s.toolbar=new w2toolbar(w2utils.extend({},i,{owner:e,name:e.name+"_"+t+"_toolbar"})),s.show.toolbar=!0}(this,e.type)}),w2panels.forEach(e=>{null==this.get(e)&&this.panels.push(w2utils.extend({},this.panel_template,{type:e,hidden:"main"!==e,size:50}))})}html(i,s,l){let r=this.get(i),e={panel:i,html:r.html,error:!1,cancelled:!1,removed(e){"function"==typeof e&&(r.removed=e)}};if("function"==typeof r.removed&&(r.removed({panel:i,html:r.html,html_new:s,transition:l||"none"}),r.removed=null),"css"==i)return query(this.box).find("#layout_"+this.name+"_panel_css").html("<style>"+s+"</style>"),e.status=!0,e;if(null==r)return console.log("ERROR: incorrect panel name. Panel name can be main, left, right, top, bottom, preview or css"),e.error=!0,e;if(null==s)return e;let t=this.trigger("change",{target:i,panel:r,html_new:s,transition:l});if(!0===t.isCancelled)return e.cancelled=!0,e;let n="#layout_"+this.name+"_panel_"+r.type;var a=query(this.box).find(n+"> .w2ui-panel-content");let o=0;if(0<a.length&&(query(this.box).find(n).get(0).scrollTop=0,o=query(a).css("top")),""===r.html)r.html=s,this.refresh(i);else if(r.html=s,!r.hidden)if(null!=l&&""!==l){query(this.box).addClass("animating");let e=query(this.box).find(n+"> .w2ui-panel-content");e.after('<div class="w2ui-panel-content new-panel" style="'+e[0].style.cssText+'"></div>');let t=query(this.box).find(n+"> .w2ui-panel-content.new-panel");e.css("top",o),t.css("top",o),"object"==typeof s?(s.box=t[0],s.render()):t.hide().html(s),w2utils.transition(e[0],t[0],l,()=>{e.remove(),t.removeClass("new-panel"),t.css("overflow",r.overflow),query(query(this.box).find(n+"> .w2ui-panel-content").get(1)).remove(),query(this.box).removeClass("animating"),this.refresh(i)})}else this.refresh(i);return t.finish(),e}message(e,t){var i=this.get(e);let s=query(this.box).find("#layout_"+this.name+"_panel_"+i.type),l=s.css("overflow");s.css("overflow","hidden");let r=w2utils.message({owner:this,box:s.get(0),after:".w2ui-panel-title",param:e},t);return r&&r.self.on("close:after",()=>{s.css("overflow",l)}),r}confirm(e,t){var i=this.get(e);let s=query(this.box).find("#layout_"+this.name+"_panel_"+i.type),l=s.css("overflow");s.css("overflow","hidden");let r=w2utils.confirm({owner:this,box:s.get(0),after:".w2ui-panel-title",param:e},t);return r&&r.self.on("close:after",()=>{s.css("overflow",l)}),r}load(i,s,l){return new Promise((t,e)=>{"css"!=i&&null==this.get(i)||null==s?e():fetch(s).then(e=>e.text()).then(e=>{this.resize(),t(this.html(i,e,l))})})}sizeTo(e,t,i){return null!=this.get(e)&&(query(this.box).find(":scope > div > .w2ui-panel").css("transition",!0!==i?".2s":"0s"),setTimeout(()=>{this.set(e,{size:t})},1),setTimeout(()=>{query(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),this.resize()},300),!0)}show(t,i){let s=this.trigger("show",{target:t,thisect:this.get(t),immediate:i});if(!0!==s.isCancelled){let e=this.get(t);return null==e?!1:(!(e.hidden=!1)===i?(query(this.box).find("#layout_"+this.name+"_panel_"+t).css({opacity:"1"}),s.finish(),this.resize()):(query(this.box).addClass("animating"),query(this.box).find("#layout_"+this.name+"_panel_"+t).css({opacity:"0"}),query(this.box).find(":scope > div > .w2ui-panel").css("transition",".2s"),setTimeout(()=>{this.resize()},1),setTimeout(()=>{query(this.box).find("#layout_"+this.name+"_panel_"+t).css({opacity:"1"})},250),setTimeout(()=>{query(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),query(this.box).removeClass("animating"),s.finish(),this.resize()},300)),!0)}}hide(t,i){let s=this.trigger("hide",{target:t,object:this.get(t),immediate:i});if(!0!==s.isCancelled){let e=this.get(t);return null==e?!1:((e.hidden=!0)===i?(query(this.box).find("#layout_"+this.name+"_panel_"+t).css({opacity:"0"}),s.finish(),this.resize()):(query(this.box).addClass("animating"),query(this.box).find(":scope > div > .w2ui-panel").css("transition",".2s"),query(this.box).find("#layout_"+this.name+"_panel_"+t).css({opacity:"0"}),setTimeout(()=>{this.resize()},1),setTimeout(()=>{query(this.box).find(":scope > div > .w2ui-panel").css("transition","0s"),query(this.box).removeClass("animating"),s.finish(),this.resize()},300)),!0)}}toggle(e,t){var i=this.get(e);return null!=i&&(i.hidden?this.show(e,t):this.hide(e,t))}set(e,t){var i=this.get(e,!0);return null!=i&&(w2utils.extend(this.panels[i],t),null==t.html&&null==t.resizable||this.refresh(e),this.resize(),!0)}get(t,i){for(let e=0;e<this.panels.length;e++)if(this.panels[e].type==t)return!0===i?e:this.panels[e];return null}el(e){e=query(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-content");return 1!=e.length?null:e[0]}hideToolbar(e){let t=this.get(e);t&&(t.show.toolbar=!1,query(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-toolbar").hide(),this.resize())}showToolbar(e){let t=this.get(e);t&&(t.show.toolbar=!0,query(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-toolbar").show(),this.resize())}toggleToolbar(e){var t=this.get(e);t&&(t.show.toolbar?this.hideToolbar(e):this.showToolbar(e))}assignToolbar(e,t){"string"==typeof t&&null!=w2ui[t]&&(t=w2ui[t]);let i=this.get(e);i.toolbar=t;let s=query(this.box).find(e+"> .w2ui-panel-toolbar");null!=i.toolbar?(0===s.find("[name="+i.toolbar.name+"]").length?i.toolbar.render(s.get(0)):null!=i.toolbar&&i.toolbar.refresh(),(t.owner=this).showToolbar(e),this.refresh(e)):(s.html(""),this.hideToolbar(e))}hideTabs(e){let t=this.get(e);t&&(t.show.tabs=!1,query(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-tabs").hide(),this.resize())}showTabs(e){let t=this.get(e);t&&(t.show.tabs=!0,query(this.box).find("#layout_"+this.name+"_panel_"+e+"> .w2ui-panel-tabs").show(),this.resize())}toggleTabs(e){var t=this.get(e);t&&(t.show.tabs?this.hideTabs(e):this.showTabs(e))}render(e){let o=this;var t=(new Date).getTime();let i=this.trigger("render",{target:this.name,box:e});if(!0!==i.isCancelled){if(null!=e&&(0<query(this.box).find("#layout_"+this.name+"_panel_main").length&&query(this.box).removeAttr("name").removeClass("w2ui-layout").html(""),this.box=e),!this.box)return!1;query(this.box).attr("name",this.name).addClass("w2ui-layout").html("<div></div>"),0<query(this.box).length&&(query(this.box)[0].style.cssText+=this.style);for(let e=0;e<w2panels.length;e++){var s='<div id="layout_'+this.name+"_panel_"+w2panels[e]+'" class="w2ui-panel">    <div class="w2ui-panel-title"></div>    <div class="w2ui-panel-tabs"></div>    <div class="w2ui-panel-toolbar"></div>    <div class="w2ui-panel-content"></div></div><div id="layout_'+this.name+"_resizer_"+w2panels[e]+'" class="w2ui-resizer"></div>';query(this.box).find(":scope > div").append(s)}return query(this.box).find(":scope > div").append('<div id="layout_'+this.name+'_panel_css" style="position: absolute; top: 10000px;"></div>'),this.refresh(),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),i.finish(),setTimeout(()=>{o.last.events={resizeStart:l,mouseMove:n,mouseUp:r},this.resize()},0),(new Date).getTime()-t}function l(e,t){o.box&&(t=t||window.event,query(document).off("mousemove",o.last.events.mouseMove).on("mousemove",o.last.events.mouseMove),query(document).off("mouseup",o.last.events.mouseUp).on("mouseup",o.last.events.mouseUp),o.last.resize={type:e,x:t.screenX,y:t.screenY,diff_x:0,diff_y:0,value:0},w2panels.forEach(e=>{let t=query(o.el(e)).find(".w2ui-lock");0<t.length?t.data("locked","yes"):o.lock(e,{opacity:0})}),t=query(o.box).find("#layout_"+o.name+"_resizer_"+e).get(0),"left"!=e&&"right"!=e||(o.last.resize.value=parseInt(t.style.left)),"top"!=e&&"preview"!=e&&"bottom"!=e||(o.last.resize.value=parseInt(t.style.top)))}function r(l){if(o.box&&(l=l||window.event,query(document).off("mousemove",o.last.events.mouseMove),query(document).off("mouseup",o.last.events.mouseUp),null!=o.last.resize)){if(w2panels.forEach(e=>{let t=query(o.el(e)).find(".w2ui-lock");"yes"==t.data("locked")?t.removeData("locked"):o.unlock(e)}),0!==o.last.diff_x||0!==o.last.resize.diff_y){var r=o.get("top"),n=o.get("bottom");let e=o.get(o.last.resize.type);var a=w2utils.getSize(query(o.box),"width"),l=w2utils.getSize(query(o.box),"height");let t=String(e.size),i,s;switch(o.last.resize.type){case"top":i=parseInt(e.sizeCalculated)+o.last.resize.diff_y,s=0;break;case"bottom":i=parseInt(e.sizeCalculated)-o.last.resize.diff_y,s=0;break;case"preview":i=parseInt(e.sizeCalculated)-o.last.resize.diff_y,s=(r&&!r.hidden?r.sizeCalculated:0)+(n&&!n.hidden?n.sizeCalculated:0);break;case"left":i=parseInt(e.sizeCalculated)+o.last.resize.diff_x,s=0;break;case"right":i=parseInt(e.sizeCalculated)-o.last.resize.diff_x,s=0}"%"==t.substr(t.length-1)?e.size=Math.floor(100*i/("left"==e.type||"right"==e.type?a:l-s)*100)/100+"%":"-"==String(e.size).substr(0,1)?e.size=parseInt(e.size)-e.sizeCalculated+i:e.size=i,o.resize()}query(o.box).find("#layout_"+o.name+"_resizer_"+o.last.resize.type).removeClass("active"),delete o.last.resize}}function n(r){if(o.box&&(r=r||window.event,null!=o.last.resize)){var n=o.get(o.last.resize.type);let s=o.last.resize,l=o.trigger("resizing",{target:o.name,object:n,originalEvent:r,panel:s?s.type:"all",diff_x:s?s.diff_x:0,diff_y:s?s.diff_y:0});if(!0!==l.isCancelled){let e=query(o.box).find("#layout_"+o.name+"_resizer_"+s.type),t=r.screenX-s.x,i=r.screenY-s.y;var a=o.get("main");switch(e.hasClass("active")||e.addClass("active"),s.type){case"left":n.minSize-t>n.width&&(t=n.minSize-n.width),n.maxSize&&n.width+t>n.maxSize&&(t=n.maxSize-n.width),a.minSize+t>a.width&&(t=a.width-a.minSize);break;case"right":n.minSize+t>n.width&&(t=n.width-n.minSize),n.maxSize&&n.width-t>n.maxSize&&(t=n.width-n.maxSize),a.minSize-t>a.width&&(t=a.minSize-a.width);break;case"top":n.minSize-i>n.height&&(i=n.minSize-n.height),n.maxSize&&n.height+i>n.maxSize&&(i=n.maxSize-n.height),a.minSize+i>a.height&&(i=a.height-a.minSize);break;case"preview":case"bottom":n.minSize+i>n.height&&(i=n.height-n.minSize),n.maxSize&&n.height-i>n.maxSize&&(i=n.height-n.maxSize),a.minSize-i>a.height&&(i=a.minSize-a.height)}switch(s.diff_x=t,s.diff_y=i,s.type){case"top":case"preview":case"bottom":(s.diff_x=0)<e.length&&(e[0].style.top=s.value+s.diff_y+"px");break;case"left":case"right":(s.diff_y=0)<e.length&&(e[0].style.left=s.value+s.diff_x+"px")}l.finish()}}}}refresh(s){let l=this;null==s&&(s=null);var e=(new Date).getTime();let t=l.trigger("refresh",{target:null!=s?s:l.name,object:l.get(s)});if(!0!==t.isCancelled){if("string"==typeof s){let e=l.get(s);if(null==e)return;let t="#layout_"+l.name+"_panel_"+e.type;s="#layout_"+l.name+"_resizer_"+e.type;query(l.box).find(t).css({display:e.hidden?"none":"block"}),e.resizable?query(l.box).find(s).show():query(l.box).find(s).hide(),"object"==typeof e.html&&"function"==typeof e.html.render?(e.html.box=query(l.box).find(t+"> .w2ui-panel-content")[0],setTimeout(()=>{0<query(l.box).find(t+"> .w2ui-panel-content").length&&(query(l.box).find(t+"> .w2ui-panel-content").removeClass().removeAttr("name").addClass("w2ui-panel-content").css("overflow",e.overflow)[0].style.cssText+=";"+e.style),e.html&&"function"==typeof e.html.render&&e.html.render()},1)):0<query(l.box).find(t+"> .w2ui-panel-content").length&&(query(l.box).find(t+"> .w2ui-panel-content").removeClass().removeAttr("name").addClass("w2ui-panel-content").html(e.html).css("overflow",e.overflow)[0].style.cssText+=";"+e.style);let i=query(l.box).find(t+"> .w2ui-panel-tabs");e.show.tabs?0===i.find("[name="+e.tabs.name+"]").length&&null!=e.tabs?e.tabs.render(i.get(0)):e.tabs.refresh():i.html("").removeClass("w2ui-tabs").hide(),i=query(l.box).find(t+"> .w2ui-panel-toolbar"),e.show.toolbar?0===i.find("[name="+e.toolbar.name+"]").length&&null!=e.toolbar?e.toolbar.render(i.get(0)):e.toolbar.refresh():i.html("").removeClass("w2ui-toolbar").hide(),i=query(l.box).find(t+"> .w2ui-panel-title"),e.title?i.html(e.title).show():i.html("").hide()}else{if(0===query(l.box).find("#layout_"+l.name+"_panel_main").length)return void l.render();l.resize();for(let e=0;e<this.panels.length;e++)l.refresh(this.panels[e].type)}return t.finish(),(new Date).getTime()-e}}resize(){if(!this.box)return!1;var u=(new Date).getTime();let c=this.last.resize,p=this.trigger("resize",{target:this.name,panel:c?c.type:"all",diff_x:c?c.diff_x:0,diff_y:c?c.diff_y:0});if(!0!==p.isCancelled){this.padding<0&&(this.padding=0);var f=w2utils.getSize(query(this.box),"width"),m=w2utils.getSize(query(this.box),"height");query(this.box).find(":scope > div").css({width:f+"px",height:m+"px"});let i=this,e=this.get("main"),t=this.get("preview"),s=this.get("left"),l=this.get("right"),r=this.get("top"),n=this.get("bottom");var g=null!=t&&!0!==t.hidden,w=null!=s&&!0!==s.hidden,y=null!=l&&!0!==l.hidden,b=null!=r&&!0!==r.hidden,v=null!=n&&!0!==n.hidden;let a,o,h,d;for(let e=0;e<w2panels.length;e++)if("main"!==w2panels[e]&&(c=this.get(w2panels[e]),c)){let e=String(c.size||0);if("%"==e.substr(e.length-1)){let e=m;"preview"==c.type&&(e=e-(r&&!r.hidden?r.sizeCalculated:0)-(n&&!n.hidden?n.sizeCalculated:0)),c.sizeCalculated=parseInt(("left"==c.type||"right"==c.type?f:e)*parseFloat(c.size)/100)}else c.sizeCalculated=parseInt(c.size);c.sizeCalculated=Math.max(c.sizeCalculated,parseInt(c.minSize))}"-"==String(l.size).substr(0,1)&&(w&&"-"==String(s.size).substr(0,1)?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):l.sizeCalculated=f-(w?s.sizeCalculated:0)+parseInt(l.size)),"-"==String(s.size).substr(0,1)&&(y&&"-"==String(l.size).substr(0,1)?console.log("ERROR: you cannot have both left panel.size and right panel.size be negative."):s.sizeCalculated=f-(y?l.sizeCalculated:0)+parseInt(s.size)),null!=r&&!0!==r.hidden?(a=0,o=0,h=f,d=r.sizeCalculated,query(this.box).find("#layout_"+this.name+"_panel_top").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),r.width=h,r.height=d,r.resizable&&(o=r.sizeCalculated-(0===this.padding?this.resizer:0),d=this.resizer>this.padding?this.resizer:this.padding,query(this.box).find("#layout_"+this.name+"_resizer_top").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(e){let t=i.trigger("resizerClick",{target:"top",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].last.events.resizeStart("top",e),t.finish(),!1}))):(query(this.box).find("#layout_"+this.name+"_panel_top").hide(),query(this.box).find("#layout_"+this.name+"_resizer_top").hide()),null!=s&&!0!==s.hidden?(a=0,o=0+(b?r.sizeCalculated+this.padding:0),h=s.sizeCalculated,d=m-(b?r.sizeCalculated+this.padding:0)-(v?n.sizeCalculated+this.padding:0),query(this.box).find("#layout_"+this.name+"_panel_left").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),s.width=h,s.height=d,s.resizable&&(a=s.sizeCalculated-(0===this.padding?this.resizer:0),h=this.resizer>this.padding?this.resizer:this.padding,query(this.box).find("#layout_"+this.name+"_resizer_left").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",function(e){let t=i.trigger("resizerClick",{target:"left",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].last.events.resizeStart("left",e),t.finish(),!1}))):(query(this.box).find("#layout_"+this.name+"_panel_left").hide(),query(this.box).find("#layout_"+this.name+"_resizer_left").hide()),null!=l&&!0!==l.hidden?(a=f-l.sizeCalculated,o=0+(b?r.sizeCalculated+this.padding:0),h=l.sizeCalculated,d=m-(b?r.sizeCalculated+this.padding:0)-(v?n.sizeCalculated+this.padding:0),query(this.box).find("#layout_"+this.name+"_panel_right").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),l.width=h,l.height=d,l.resizable&&(a-=this.padding,h=this.resizer>this.padding?this.resizer:this.padding,query(this.box).find("#layout_"+this.name+"_resizer_right").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px",cursor:"ew-resize"}).off("mousedown").on("mousedown",function(e){let t=i.trigger("resizerClick",{target:"right",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].last.events.resizeStart("right",e),t.finish(),!1}))):(query(this.box).find("#layout_"+this.name+"_panel_right").hide(),query(this.box).find("#layout_"+this.name+"_resizer_right").hide()),null!=n&&!0!==n.hidden?(a=0,o=m-n.sizeCalculated,h=f,d=n.sizeCalculated,query(this.box).find("#layout_"+this.name+"_panel_bottom").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),n.width=h,n.height=d,n.resizable&&(o-=0===this.padding?0:this.padding,d=this.resizer>this.padding?this.resizer:this.padding,query(this.box).find("#layout_"+this.name+"_resizer_bottom").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(e){let t=i.trigger("resizerClick",{target:"bottom",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].last.events.resizeStart("bottom",e),t.finish(),!1}))):(query(this.box).find("#layout_"+this.name+"_panel_bottom").hide(),query(this.box).find("#layout_"+this.name+"_resizer_bottom").hide()),a=0+(w?s.sizeCalculated+this.padding:0),o=0+(b?r.sizeCalculated+this.padding:0),h=f-(w?s.sizeCalculated+this.padding:0)-(y?l.sizeCalculated+this.padding:0),d=m-(b?r.sizeCalculated+this.padding:0)-(v?n.sizeCalculated+this.padding:0)-(g?t.sizeCalculated+this.padding:0),query(this.box).find("#layout_"+this.name+"_panel_main").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),e.width=h,e.height=d,null!=t&&!0!==t.hidden?(a=0+(w?s.sizeCalculated+this.padding:0),o=m-(v?n.sizeCalculated+this.padding:0)-t.sizeCalculated,h=f-(w?s.sizeCalculated+this.padding:0)-(y?l.sizeCalculated+this.padding:0),d=t.sizeCalculated,query(this.box).find("#layout_"+this.name+"_panel_preview").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px"}),t.width=h,t.height=d,t.resizable&&(o-=0===this.padding?0:this.padding,d=this.resizer>this.padding?this.resizer:this.padding,query(this.box).find("#layout_"+this.name+"_resizer_preview").css({display:"block",left:a+"px",top:o+"px",width:h+"px",height:d+"px",cursor:"ns-resize"}).off("mousedown").on("mousedown",function(e){let t=i.trigger("resizerClick",{target:"preview",originalEvent:e});if(!0!==t.isCancelled)return w2ui[i.name].last.events.resizeStart("preview",e),t.finish(),!1}))):(query(this.box).find("#layout_"+this.name+"_panel_preview").hide(),query(this.box).find("#layout_"+this.name+"_resizer_preview").hide());for(let t=0;t<w2panels.length;t++){var x,_=this.get(w2panels[t]),$="#layout_"+this.name+"_panel_"+w2panels[t]+" > .w2ui-panel-";let e=0;_&&(_.title&&(x=query(this.box).find($+"title").css({top:e+"px",display:"block"}),e+=w2utils.getSize(x,"height")),_.show.tabs&&(x=query(this.box).find($+"tabs").css({top:e+"px",display:"block"}),e+=w2utils.getSize(x,"height")),_.show.toolbar&&(_=query(this.box).find($+"toolbar").css({top:e+"px",display:"block"}),e+=w2utils.getSize(_,"height"))),query(this.box).find($+"content").css({display:"block"}).css({top:e+"px"})}return p.finish(),(new Date).getTime()-u}}destroy(){let e=this.trigger("destroy",{target:this.name});if(!0!==e.isCancelled)return null!=w2ui[this.name]&&(0<query(this.box).find("#layout_"+this.name+"_panel_main").length&&query(this.box).removeAttr("name").removeClass("w2ui-layout").html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish(),this.last.events&&this.last.events.resize&&query(window).off("resize",this.last.events.resize),!0)}lock(t,e,i){if(-1!=w2panels.indexOf(t)){let e=Array.from(arguments);e[0]="#layout_"+this.name+"_panel_"+t,w2utils.lock(...e)}else console.log("ERROR: First parameter needs to be the a valid panel name.")}unlock(e,t){-1!=w2panels.indexOf(e)?(e="#layout_"+this.name+"_panel_"+e,w2utils.unlock(e,t)):console.log("ERROR: First parameter needs to be the a valid panel name.")}}class w2grid extends w2base{constructor(e){if(super(e.name),this.name=null,this.box=null,this.columns=[],this.columnGroups=[],this.records=[],this.summary=[],this.searches=[],this.toolbar={},this.ranges=[],this.menu=[],this.searchMap={},this.searchData=[],this.sortMap={},this.sortData=[],this.savedSearches=[],this.total=0,this.recid=null,this.last={field:"",label:"",logic:"AND",search:"",searchIds:[],selection:{indexes:[],columns:{}},_selection:null,multi:!1,scrollTop:0,scrollLeft:0,colStart:0,colEnd:0,xhr:null,xhr_cmd:"",xhr_offset:null,xhr_start:0,xhr_response:0,xhr_hasMore:!1,pull_more:!1,pull_refresh:!0,loaded:!1,range_start:null,range_end:null,sel_ind:null,sel_col:null,sel_type:null,sel_recid:null,idCache:{},move:null,cancelClick:null,inEditMode:!1,_edit:null,kbd_timer:null,marker_timer:null,click_time:null,click_recid:null,bubbleEl:null,colResizing:!1,tmp:null,copy_event:null,userSelect:"",columnDrag:!1,state:null,show_extra:0,_toolbar_height:0},this.header="",this.url="",this.limit=100,this.offset=0,this.postData={},this.routeData={},this.httpHeaders={},this.show={header:!1,toolbar:!1,footer:!1,columnHeaders:!0,lineNumbers:!1,orderColumn:!1,expandColumn:!1,selectColumn:!1,emptyRecords:!0,toolbarReload:!0,toolbarColumns:!1,toolbarSearch:!0,toolbarAdd:!1,toolbarEdit:!1,toolbarDelete:!1,toolbarSave:!1,searchAll:!0,searchLogic:!0,searchHiddenMsg:!1,searchSave:!0,statusRange:!0,statusBuffered:!1,statusRecordID:!0,statusSelection:!0,statusResponse:!0,statusSort:!1,statusSearch:!1,recordTitles:!1,selectionBorder:!0,skipRecords:!0,saveRestoreState:!0},this.stateId=null,this.hasFocus=!1,this.autoLoad=!0,this.fixedBody=!0,this.recordHeight=32,this.lineNumberWidth=34,this.keyboard=!0,this.selectType="row",this.multiSearch=!0,this.multiSelect=!0,this.multiSort=!0,this.reorderColumns=!1,this.reorderRows=!1,this.showExtraOnSearch=0,this.markSearch=!0,this.columnTooltip="top|bottom",this.disableCVS=!1,this.nestedFields=!0,this.vs_start=150,this.vs_extra=15,this.style="",this.tabIndex=null,this.method=null,this.dataType=null,this.parser=null,this.advanceOnEdit=!0,this.useLocalStorage=!0,this.colDefaults={text:"",field:"",size:null,min:20,max:null,gridMinWidth:null,sizeCorrected:null,sizeCalculated:null,sizeOriginal:null,sizeType:null,hidden:!1,sortable:!1,sortMode:null,searchable:!1,resizable:!0,hideable:!0,autoResize:null,attr:"",style:"",render:null,title:null,tooltip:null,editable:{},frozen:!1,info:null,clipboardCopy:!1},this.stateColProps={text:!1,field:!0,size:!0,min:!1,max:!1,gridMinWidth:!1,sizeCorrected:!1,sizeCalculated:!0,sizeOriginal:!0,sizeType:!0,hidden:!0,sortable:!1,sortMode:!0,searchable:!1,resizable:!1,hideable:!1,autoResize:!1,attr:!1,style:!1,render:!1,title:!1,tooltip:!1,editable:!1,frozen:!0,info:!1,clipboardCopy:!1},this.msgDelete="Are you sure you want to delete ${count} ${records}?",this.msgNotJSON="Returned data is not in valid JSON format.",this.msgAJAXerror="AJAX error. See console for more details.",this.msgRefresh="Refreshing...",this.msgNeedReload="Your remote data source record count has changed, reloading from the first record.",this.msgEmpty="",this.buttons={reload:{type:"button",id:"w2ui-reload",icon:"w2ui-icon-reload",tooltip:"Reload data in the list"},columns:{type:"menu-check",id:"w2ui-column-on-off",icon:"w2ui-icon-columns",tooltip:"Show/hide columns",overlay:{align:"none"}},search:{type:"html",id:"w2ui-search",html:"<div class=\"w2ui-icon w2ui-icon-search w2ui-search-down\" onclick=\"let grid = w2ui[jQuery(this).parents('div.w2ui-grid').attr('name')]; grid.searchShowFields()\"></div>"},add:{type:"button",id:"w2ui-add",text:"Add New",tooltip:"Add new record",icon:"w2ui-icon-plus"},edit:{type:"button",id:"w2ui-edit",text:"Edit",tooltip:"Edit selected record",icon:"w2ui-icon-pencil",batch:1,disabled:!0},delete:{type:"button",id:"w2ui-delete",text:"Delete",tooltip:"Delete selected records",icon:"w2ui-icon-cross",batch:!0,disabled:!0},save:{type:"button",id:"w2ui-save",text:"Save",tooltip:"Save changed records",icon:"w2ui-icon-check"}},this.operators={text:["is","begins","contains","ends"],number:["=","between",">","<",">=","<="],date:["is","between",{oper:"less",text:"before"},{oper:"more",text:"after"}],list:["is"],hex:["is","between"],color:["is","begins","contains","ends"],enum:["in","not in"]},this.defaultOperator={text:"begins",number:"=",date:"is",list:"is",enum:"in",hex:"begins",color:"begins"},this.operatorsMap={text:"text",int:"number",float:"number",money:"number",currency:"number",percent:"number",hex:"hex",alphanumeric:"text",color:"color",date:"date",time:"date",datetime:"date",list:"list",combo:"text",enum:"enum",file:"enum",select:"list",radio:"list",checkbox:"list",toggle:"list"},this.onAdd=null,this.onEdit=null,this.onRequest=null,this.onLoad=null,this.onDelete=null,this.onSave=null,this.onSelect=null,this.onUnselect=null,this.onClick=null,this.onDblClick=null,this.onContextMenu=null,this.onMenuClick=null,this.onColumnClick=null,this.onColumnDblClick=null,this.onColumnResize=null,this.onColumnAutoResize=null,this.onSort=null,this.onSearch=null,this.onSearchOpen=null,this.onChange=null,this.onRestore=null,this.onExpand=null,this.onCollapse=null,this.onError=null,this.onKeydown=null,this.onToolbar=null,this.onColumnOnOff=null,this.onCopy=null,this.onPaste=null,this.onSelectionExtend=null,this.onEditField=null,this.onRender=null,this.onRefresh=null,this.onReload=null,this.onResize=null,this.onDestroy=null,this.onStateSave=null,this.onStateRestore=null,this.onFocus=null,this.onBlur=null,this.onReorderRow=null,this.onSearchSave=null,this.onSearchRemove=null,this.onSearchSelect=null,this.onColumnSelect=null,this.onColumnDragStart=null,this.onColumnDragEnd=null,this.onResizerDblClick=null,w2utils.extend(this,e),Array.isArray(this.records)){let i=[];this.records.forEach((e,t)=>{null!=e[this.recid]&&(e.recid=e[this.recid]),null==e.recid&&console.log("ERROR: Cannot add records without recid. (obj: "+this.name+")"),e.w2ui&&!0===e.w2ui.summary&&(this.summary.push(e),i.push(t))}),i.sort();for(let e=i.length-1;0<=e;e--)this.records.splice(i[e],1)}if(Array.isArray(this.columns)&&this.columns.forEach((i,e)=>{i=$.extend({},this.colDefaults,i);e=(this.columns[e]=i).searchable;if(null!=e&&!1!==e&&null==this.getSearch(i.field))if($.isPlainObject(e))this.addSearch($.extend({field:i.field,label:i.text,type:"text"},e));else{let e=i.searchable,t="";!0===i.searchable&&(e="text",t='size="20"'),this.addSearch({field:i.field,label:i.text,type:e,attr:t})}}),w2utils.hasLocalStorage&&this.useLocalStorage)try{var t=JSON.parse(localStorage.w2ui||"{}");if(t&&t.searches){let e=t.searches[this.stateId||this.name];Array.isArray(e)&&e.forEach(e=>{this.savedSearches.push({id:e.name,text:e.name,icon:"w2ui-icon-search",remove:!0,logic:e.logic,data:e.data})})}}catch(e){}}add(i,s){Array.isArray(i)||(i=[i]);let l=0;for(let t=0;t<i.length;t++){let e=i[t];null!=e[this.recid]&&(e.recid=e[this.recid]),null!=e.recid?(e.w2ui&&!0===e.w2ui.summary?s?this.summary.unshift(e):this.summary.push(e):s?this.records.unshift(e):this.records.push(e),l++):console.log("ERROR: Cannot add record without recid. (obj: "+this.name+")")}return("object"!=typeof this.url?this.url:this.url.get)||(this.total=this.records.length,this.localSort(!1,!0),this.localSearch()),this.refresh(),l}find(s,e,t){let l=[],r=!1;for(var i in s=null==s?{}:s)-1!=String(i).indexOf(".")&&(r=!0);var n=t?this.last.range_start:0;let a=t?this.last.range_end+1:this.records.length;a>this.records.length&&(a=this.records.length);for(let i=n;i<a;i++){let t=!0;for(var o in s){let e=this.records[i][o];r&&-1!=String(o).indexOf(".")&&(e=this.parseField(this.records[i],o)),"not-null"==s[o]?null!=e&&""!==e||(t=!1):s[o]!=e&&(t=!1)}t&&!0!==e&&l.push(this.records[i].recid),t&&!0===e&&l.push(i)}return l}set(e,t,i){if("object"==typeof e&&null!==e&&(i=t,t=e,e=null),null==e){for(let e=0;e<this.records.length;e++)$.extend(!0,this.records[e],t);!0!==i&&this.refresh()}else{var s=this.get(e,!0);if(null==s)return!1;!this.records[s]||this.records[s].recid!=e?$.extend(!0,this.summary[s],t):$.extend(!0,this.records[s],t),!0!==i&&this.refreshRow(e,s)}return!0}get(i,s){if(Array.isArray(i)){let t=[];for(let e=0;e<i.length;e++){var l=this.get(i[e],s);null!==l&&t.push(l)}return t}{let t=this.last.idCache;t||(this.last.idCache=t={});let e=t[i];if("number"==typeof e){if(0<=e&&e<this.records.length&&this.records[e].recid==i)return!0===s?e:this.records[e];if(e=~e,0<=e&&e<this.summary.length&&this.summary[e].recid==i)return!0===s?e:this.summary[e];this.last.idCache=t={}}for(let e=0;e<this.records.length;e++)if(this.records[e].recid==i)return t[i]=e,!0===s?e:this.records[e];for(let e=0;e<this.summary.length;e++)if(this.summary[e].recid==i)return t[i]=~e,!0===s?e:this.summary[e];return null}}getFirst(e){if(0==this.records.length)return null;let t=this.records[0];var i=this.last.searchIds;return 0<this.searchData.length&&(t=Array.isArray(i)&&0<i.length?this.records[i[e||0]]:null),t}remove(){let i=0;for(let t=0;t<arguments.length;t++){for(let e=this.records.length-1;0<=e;e--)this.records[e].recid==arguments[t]&&(this.records.splice(e,1),i++);for(let e=this.summary.length-1;0<=e;e--)this.summary[e].recid==arguments[t]&&(this.summary.splice(e,1),i++)}return("object"!=typeof this.url?this.url:this.url.get)||(this.localSort(!1,!0),this.localSearch()),this.refresh(),i}addColumn(e,s){let t=0;1==arguments.length?(s=e,e=this.columns.length):null==(e="string"==typeof e?this.getColumn(e,!0):e)&&(e=this.columns.length),Array.isArray(s)||(s=[s]);for(let i=0;i<s.length;i++){var l=$.extend({},this.colDefaults,s[i]);if(this.columns.splice(e,0,l),s[i].searchable){let e=s[i].searchable,t="";!0===s[i].searchable&&(e="text",t='size="20"'),this.addSearch({field:s[i].field,label:s[i].label,type:e,attr:t})}e++,t++}return this.refresh(),t}removeColumn(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.columns.length-1;0<=e;e--)this.columns[e].field==arguments[t]&&(this.columns[e].searchable&&this.removeSearch(arguments[t]),this.columns.splice(e,1),i++);return this.refresh(),i}getColumn(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.columns.length;e++)t.push(this.columns[e].field);return t}for(let e=0;e<this.columns.length;e++)if(this.columns[e].field==t)return!0===i?e:this.columns[e];return null}updateColumn(e,s){let l=0;return(e=Array.isArray(e)?e:[e]).forEach(e=>{this.columns.forEach(i=>{if(i.field==e){let t=$.extend(!0,{},s);Object.keys(t).forEach(e=>{"function"==typeof t[e]&&(t[e]=t[e](i)),i[e]!=t[e]&&l++}),$.extend(!0,i,t)}})}),0<l&&this.refresh(),l}toggleColumn(){return this.updateColumn(Array.from(arguments),{hidden(e){return!e.hidden}})}showColumn(){return this.updateColumn(Array.from(arguments),{hidden:!1})}hideColumn(){return this.updateColumn(Array.from(arguments),{hidden:!0})}addSearch(t,i){let s=0;1==arguments.length?(i=t,t=this.searches.length):null==(t="string"==typeof t?this.getSearch(t,!0):t)&&(t=this.searches.length),Array.isArray(i)||(i=[i]);for(let e=0;e<i.length;e++)this.searches.splice(t,0,i[e]),t++,s++;return this.searchClose(),s}removeSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&(this.searches.splice(e,1),i++);return this.searchClose(),i}getSearch(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.searches.length;e++)t.push(this.searches[e].field);return t}for(let e=0;e<this.searches.length;e++)if(this.searches[e].field==t)return!0===i?e:this.searches[e];return null}toggleSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&(this.searches[e].hidden=!this.searches[e].hidden,i++);return this.searchClose(),i}showSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&!1!==this.searches[e].hidden&&(this.searches[e].hidden=!1,i++);return this.searchClose(),i}hideSearch(){let i=0;for(let t=0;t<arguments.length;t++)for(let e=this.searches.length-1;0<=e;e--)this.searches[e].field==arguments[t]&&!0!==this.searches[e].hidden&&(this.searches[e].hidden=!0,i++);return this.searchClose(),i}getSearchData(t){for(let e=0;e<this.searchData.length;e++)if(this.searchData[e].field==t)return this.searchData[e];return null}localSort(t,i){let a=this;if("object"!=typeof this.url?this.url:this.url.get)console.log("ERROR: grid.localSort can only be used on local data source, grid.url should be empty.");else if(!$.isEmptyObject(this.sortData)){let e=(new Date).getTime();this.selectionSave(),this.prepareData(),i||this.reset();for(let t=0;t<this.sortData.length;t++){let e=this.getColumn(this.sortData[t].field);if(!e)return;"string"==typeof e.render&&(-1!=["date","age"].indexOf(e.render.split(":")[0])&&(this.sortData[t].field_=e.field+"_"),-1!=["time"].indexOf(e.render.split(":")[0])&&(this.sortData[t].field_=e.field+"_"))}return function(){for(let t=0;t<a.records.length;t++){let e=a.records[t];e.w2ui&&null!=e.w2ui.parent_recid&&(e.w2ui._path=r(e))}}(),this.records.sort((e,t)=>function(e,t){if(!(e.w2ui&&null!=e.w2ui.parent_recid||t.w2ui&&null!=t.w2ui.parent_recid))return n(e,t);var i=r(e),s=r(t);for(let e=0;e<Math.min(i.length,s.length);e++){var l=n(i[e],s[e]);if(0!==l)return l}return i.length>s.length?1:i.length<s.length?-1:(console.log("ERROR: two paths should not be equal."),0)}(e,t)),function(){for(let t=0;t<a.records.length;t++){let e=a.records[t];e.w2ui&&null!=e.w2ui.parent_recid&&(e.w2ui._path=null)}}(),this.selectionRestore(i),e=(new Date).getTime()-e,!0!==t&&this.show.statusSort&&setTimeout(()=>{this.status(w2utils.lang("Sorting took ${count} seconds",{count:e/1e3}))},10),e;function r(e){if(!e.w2ui||null==e.w2ui.parent_recid)return[e];if(e.w2ui._path)return e.w2ui._path;var t=a.get(e.w2ui.parent_recid);return t?r(t).concat(e):(console.log("ERROR: no parent record: "+e.w2ui.parent_recid),[e])}function n(s,l){if(s===l)return 0;for(let i=0;i<a.sortData.length;i++){var r=a.sortData[i].field,n=a.sortData[i].field_||r;let e=s[n],t=l[n];-1!=String(r).indexOf(".")&&(e=a.parseField(s,n),t=a.parseField(l,n));r=a.getColumn(r);r&&0<Object.keys(r.editable).length&&($.isPlainObject(e)&&e.text&&(e=e.text),$.isPlainObject(t)&&t.text&&(t=t.text));r=o(e,t,i,a.sortData[i].direction,r.sortMode||"default");if(0!==r)return r}return o(s.recid,l.recid,0,"asc")}function o(e,t,i,s,l){if(e===t)return 0;if((null==e||""===e)&&null!=t&&""!==t)return 1;if(null!=e&&""!==e&&(null==t||""===t))return-1;var r="asc"===s.toLowerCase()?1:-1;if(typeof e!=typeof t)return typeof t<typeof e?r:-r;if(e.constructor.name!=t.constructor.name)return e.constructor.name>t.constructor.name?r:-r;e&&"object"==typeof e&&(e=e.valueOf()),t&&"object"==typeof t&&(t=t.valueOf());s={}.toString;switch(e&&"object"==typeof e&&e.toString!=s&&(e=String(e)),t&&"object"==typeof t&&t.toString!=s&&(t=String(t)),"string"==typeof e&&(e=e.toLowerCase().trim()),"string"==typeof t&&(t=t.toLowerCase().trim()),l){case"natural":l=w2utils.naturalCompare;break;case"i18n":l=w2utils.i18nCompare}return"function"==typeof l?l(e,t)*r:t<e?r:e<t?-r:0}}}localSearch(t){let c=this;var i="object"!=typeof this.url?this.url:this.url.get;if(i)console.log("ERROR: grid.localSearch can only be used on local data source, grid.url should be empty.");else{let e=(new Date).getTime(),u={}.toString,l={};if(this.total=this.records.length,this.last.searchIds=[],this.prepareData(),0<this.searchData.length&&!i){for(let s=this.total=0;s<this.records.length;s++){var r=this.records[s];if(function i(l){let r=0,n,a,o,h;let d=!1;for(let e=0;e<c.searchData.length;e++){let i=c.searchData[e],s=c.getSearch(i.field);if(null!=i){null==s&&(s={field:i.field,type:i.type});let t=c.parseField(l,s.field);switch(n=null===t||void 0===t||"object"==typeof t&&t.toString==u?"":String(t).toLowerCase(),null!=i.value&&(Array.isArray(i.value)?(a=i.value[0],o=i.value[1]):a=String(i.value).toLowerCase()),i.operator){case"=":case"is":c.parseField(l,s.field)==i.value?r++:"date"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatDate(h,"yyyy-mm-dd"),a=w2utils.formatDate(w2utils.isDate(a,w2utils.settings.dateFormat,!0),"yyyy-mm-dd"),n==a&&r++):"time"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatTime(h,"hh24:mi"),a=w2utils.formatTime(a,"hh24:mi"),n==a&&r++):"datetime"==s.type&&(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatDateTime(h,"yyyy-mm-dd|hh24:mm:ss"),a=w2utils.formatDateTime(w2utils.isDateTime(a,w2utils.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),n==a&&r++);break;case"between":-1!=["int","float","money","currency","percent"].indexOf(s.type)?parseFloat(c.parseField(l,s.field))>=parseFloat(a)&&parseFloat(c.parseField(l,s.field))<=parseFloat(o)&&r++:"date"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.isDate(h,w2utils.settings.dateFormat,!0),a=w2utils.isDate(a,w2utils.settings.dateFormat,!0),o=w2utils.isDate(o,w2utils.settings.dateFormat,!0),null!=o&&(o=new Date(o.getTime()+864e5)),n>=a&&n<o&&r++):"time"==s.type?(n=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.isTime(a,!0),o=w2utils.isTime(o,!0),a=(new Date).setHours(a.hours,a.minutes,a.seconds||0,0),o=(new Date).setHours(o.hours,o.minutes,o.seconds||0,0),n>=a&&n<o&&r++):"datetime"==s.type&&(n=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),a=w2utils.isDateTime(a,w2utils.settings.datetimeFormat,!0),o=w2utils.isDateTime(o,w2utils.settings.datetimeFormat,!0),o=o&&new Date(o.getTime()+864e5),n>=a&&n<o&&r++);break;case"<=":d=!0;case"<":case"less":-1!=["int","float","money","currency","percent"].indexOf(s.type)?(n=parseFloat(c.parseField(l,s.field)),a=parseFloat(i.value),(n<a||d&&n===a)&&r++):"date"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.isDate(h,w2utils.settings.dateFormat,!0),a=w2utils.isDate(a,w2utils.settings.dateFormat,!0),(n<a||d&&n===a)&&r++):"time"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatTime(h,"hh24:mi"),a=w2utils.formatTime(a,"hh24:mi"),(n<a||d&&n===a)&&r++):"datetime"==s.type&&(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatDateTime(h,"yyyy-mm-dd|hh24:mm:ss"),a=w2utils.formatDateTime(w2utils.isDateTime(a,w2utils.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),n.length==a.length&&(n<a||d&&n===a)&&r++);break;case">=":d=!0;case">":case"more":-1!=["int","float","money","currency","percent"].indexOf(s.type)?(n=parseFloat(c.parseField(l,s.field)),a=parseFloat(i.value),(n>a||d&&n===a)&&r++):"date"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.isDate(h,w2utils.settings.dateFormat,!0),a=w2utils.isDate(a,w2utils.settings.dateFormat,!0),(n>a||d&&n===a)&&r++):"time"==s.type?(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatTime(h,"hh24:mi"),a=w2utils.formatTime(a,"hh24:mi"),(n>a||d&&n===a)&&r++):"datetime"==s.type&&(h=c.parseField(l,s.field+"_")instanceof Date?c.parseField(l,s.field+"_"):c.parseField(l,s.field),n=w2utils.formatDateTime(h,"yyyy-mm-dd|hh24:mm:ss"),a=w2utils.formatDateTime(w2utils.isDateTime(a,w2utils.settings.datetimeFormat,!0),"yyyy-mm-dd|hh24:mm:ss"),n.length==a.length&&(n>a||d&&n===a)&&r++);break;case"in":h=i.value,i.svalue&&(h=i.svalue),-1===h.indexOf(w2utils.isFloat(t)?parseFloat(t):t)&&-1===h.indexOf(n)||r++;break;case"not in":h=i.value,i.svalue&&(h=i.svalue),-1===h.indexOf(w2utils.isFloat(t)?parseFloat(t):t)&&-1===h.indexOf(n)&&r++;break;case"begins":case"begins with":0===n.indexOf(a)&&r++;break;case"contains":0<=n.indexOf(a)&&r++;break;case"null":null==c.parseField(l,s.field)&&r++;break;case"not null":null!=c.parseField(l,s.field)&&r++;break;case"ends":case"ends with":let e=n.lastIndexOf(a);-1!==e&&e==n.length-a.length&&r++}}}if("OR"==c.last.logic&&0!==r||"AND"==c.last.logic&&r==c.searchData.length)return!0;if(l.w2ui&&l.w2ui.children&&!0!==l.w2ui.expanded)for(let t=0;t<l.w2ui.children.length;t++){let e=l.w2ui.children[t];if(i(e))return!0}return!1}(r))if(r&&r.w2ui&&!function e(t){if(void 0===t)return;if(l[t])return;l[t]=!0;let i=c.get(t,!0);if(null==i)return;if(-1!=$.inArray(i,c.last.searchIds))return;let s=c.records[i];s&&s.w2ui&&e(s.w2ui.parent_recid);c.last.searchIds.push(i)}(r.w2ui.parent_recid),0<this.showExtraOnSearch){let t=this.showExtraOnSearch,i=this.showExtraOnSearch;if(s<t&&(t=s),s+i>this.records.length&&(i=this.records.length-s),0<t)for(let e=s-t;e<s;e++)this.last.searchIds.indexOf(e)<0&&this.last.searchIds.push(e);if(this.last.searchIds.indexOf(s)<0&&this.last.searchIds.push(s),0<i)for(let e=s+1;e<=s+i;e++)this.last.searchIds.indexOf(e)<0&&this.last.searchIds.push(e)}else this.last.searchIds.push(s)}this.total=this.last.searchIds.length}return e=(new Date).getTime()-e,!0!==t&&this.show.statusSearch&&setTimeout(()=>{this.status(w2utils.lang("Search took ${count} seconds",{count:e/1e3}))},10),e}}getRangeData(e,i){var s=this.get(e[0].recid,!0),l=this.get(e[1].recid,!0),r=e[0].column,n=e[1].column;let a=[];if(r==n)for(let e=s;e<=l;e++){var t=this.records[e],o=t[this.columns[r].field]||null;!0!==i?a.push(o):a.push({data:o,column:r,index:e,record:t})}else if(s==l){var h=this.records[s];for(let e=r;e<=n;e++){var d=h[this.columns[e].field]||null;!0!==i?a.push(d):a.push({data:d,column:e,index:s,record:h})}}else for(let t=s;t<=l;t++){var u=this.records[t];a.push([]);for(let e=r;e<=n;e++){var c=u[this.columns[e].field];!0!==i?a[a.length-1].push(c):a[a.length-1].push({data:c,column:e,index:t,record:u})}}return a}addRange(s){let e=0,l,r;if("row"==this.selectType)return e;Array.isArray(s)||(s=[s]);for(let i=0;i<s.length;i++){if("object"!=typeof s[i]&&(s[i]={name:"selection"}),"selection"==s[i].name){if(!1===this.show.selectionBorder)continue;var n=this.getSelection();if(0===n.length){this.removeRange("selection");continue}l=n[0],r=n[n.length-1]}else l=s[i].range[0],r=s[i].range[1];if(l){n={name:s[i].name,range:[{recid:l.recid,column:l.column},{recid:r.recid,column:r.column}],style:s[i].style||""};let t=!1;for(let e=0;e<this.ranges.length;e++)if(this.ranges[e].name==s[i].name){t=e;break}!1!==t?this.ranges[t]=n:this.ranges.push(n),e++}}return this.refreshRanges(),e}removeRange(){let t=0;for(let e=0;e<arguments.length;e++){var i=arguments[e];$(this.box).find("#grid_"+this.name+"_"+i).remove(),$(this.box).find("#grid_"+this.name+"_f"+i).remove();for(let e=this.ranges.length-1;0<=e;e--)this.ranges[e].name==i&&(this.ranges.splice(e,1),t++)}return t}refreshRanges(){if(0!==this.ranges.length){let r=this,d,u,c;var e=(new Date).getTime();let p=$(this.box).find("#grid_"+this.name+"_frecords"),f=$(this.box).find("#grid_"+this.name+"_records");for(let h=0;h<this.ranges.length;h++){var m=this.ranges[h];let e=m.range[0],t=m.range[1];null==e.index&&(e.index=this.get(e.recid,!0)),null==t.index&&(t.index=this.get(t.recid,!0));let i=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(e.recid)+' td[col="'+e.column+'"]'),s=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t.recid)+' td[col="'+t.column+'"]'),l=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(e.recid)+' td[col="'+e.column+'"]'),r=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t.recid)+' td[col="'+t.column+'"]'),n=t.column;e.column<this.last.colStart&&t.column>this.last.colStart&&(i=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(e.recid)+' td[col="start"]')),e.column<this.last.colEnd&&t.column>this.last.colEnd&&(n='"end"',s=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t.recid)+' td[col="end"]'));var g=parseInt($(this.box).find("#grid_"+this.name+"_rec_top").next().attr("index")),w=parseInt($(this.box).find("#grid_"+this.name+"_rec_bottom").prev().attr("index")),y=parseInt($(this.box).find("#grid_"+this.name+"_frec_top").next().attr("index")),b=parseInt($(this.box).find("#grid_"+this.name+"_frec_bottom").prev().attr("index"));0===i.length&&e.index<g&&t.index>g&&(i=$(this.box).find("#grid_"+this.name+"_rec_top").next().find("td[col="+e.column+"]")),0===s.length&&t.index>w&&e.index<w&&(s=$(this.box).find("#grid_"+this.name+"_rec_bottom").prev().find("td[col="+n+"]")),0===l.length&&e.index<y&&t.index>y&&(l=$(this.box).find("#grid_"+this.name+"_frec_top").next().find("td[col="+e.column+"]")),0===r.length&&t.index>b&&e.index<b&&(r=$(this.box).find("#grid_"+this.name+"_frec_bottom").prev().find("td[col="+t.column+"]"));let a=$(this.box).find("#grid_"+this.name+"_editable"),o=a.find(".w2ui-input");y=o.attr("recid"),b=o.attr("column");"selection"==m.name&&m.range[0].recid==y&&m.range[0].column==b||(d=$(this.box).find("#grid_"+this.name+"_f"+m.name),0<l.length||0<r.length?(0===d.length?(p.append('<div id="grid_'+this.name+"_f"+m.name+'" class="w2ui-selection" style="'+m.style+'">'+("selection"==m.name?'<div id="grid_'+this.name+'_resizer" class="w2ui-selection-resizer"></div>':"")+"</div>"),d=$(this.box).find("#grid_"+this.name+"_f"+m.name)):(d.attr("style",m.style),d.find(".w2ui-selection-resizer").show()),0===r.length&&(r=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t.recid)+" td:last-child"),0===r.length&&(r=$(this.box).find("#grid_"+this.name+"_frec_bottom td:first-child")),d.css("border-right","0px"),d.find(".w2ui-selection-resizer").hide()),null!=e.recid&&null!=t.recid&&0<l.length&&0<r.length?(u=l.position().left+l.scrollLeft(),c=l.position().top-l.scrollTop(),d.show().css({left:(0<u?u:0)+"px",top:(0<c?c:0)+"px",width:r.position().left-l.position().left+r.width()+2+"px",height:r.position().top-l.position().top+r.height()+1+"px"})):d.hide()):d.hide(),d=$(this.box).find("#grid_"+this.name+"_"+m.name),0<i.length||0<s.length?(0===d.length?(f.append('<div id="grid_'+this.name+"_"+m.name+'" class="w2ui-selection" style="'+m.style+'">'+("selection"==m.name?'<div id="grid_'+this.name+'_resizer" class="w2ui-selection-resizer"></div>':"")+"</div>"),d=$(this.box).find("#grid_"+this.name+"_"+m.name)):d.attr("style",m.style),0===i.length&&(i=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(e.recid)+" td:first-child"),0===i.length&&(i=$(this.box).find("#grid_"+this.name+"_rec_top td:first-child"))),0!==r.length&&d.css("border-left","0px"),null!=e.recid&&null!=t.recid&&0<i.length&&0<s.length?(u=i.position().left+i.scrollLeft(),c=i.position().top-i.scrollTop(),d.show().css({left:(0<u?u:0)+"px",top:(0<c?c:0)+"px",width:s.position().left-i.position().left+s.width()+2+"px",height:s.position().top-i.position().top+s.height()+1+"px"})):d.hide()):d.hide())}$(this.box).find(".w2ui-selection-resizer").off("mousedown").on("mousedown",function(e){var t=r.getSelection();r.last.move={type:"expand",x:e.screenX,y:e.screenY,divX:0,divY:0,recid:t[0].recid,column:t[0].column,originalRange:[{recid:t[0].recid,column:t[0].column},{recid:t[t.length-1].recid,column:t[t.length-1].column}],newRange:[{recid:t[0].recid,column:t[0].column},{recid:t[t.length-1].recid,column:t[t.length-1].column}]},$(document).off(".w2ui-"+r.name).on("mousemove.w2ui-"+r.name,i).on("mouseup.w2ui-"+r.name,s),e.preventDefault()}).off("dblclick").on("dblclick",function(e){let t=r.trigger("resizerDblClick",{target:r.name,originalEvent:e});!0!==t.isCancelled&&t.finish()});let n={phase:"before",type:"selectionExtend",target:r.name,originalRange:null,newRange:null};return(new Date).getTime()-e;function i(s){let l=r.last.move;if(l&&"expand"==l.type){l.divX=s.screenX-l.x,l.divY=s.screenY-l.y;let e,t,i=s.originalEvent.target;"TD"!=i.tagName.toUpperCase()&&(i=$(i).parents("td")[0]),null!=$(i).attr("col")&&(t=parseInt($(i).attr("col"))),i=$(i).parents("tr")[0],e=$(i).attr("recid"),l.newRange[1].recid==e&&l.newRange[1].column==t||(s=$.extend({},l.newRange),l.newRange=[{recid:l.recid,column:l.column},{recid:e,column:t}],n=r.trigger(w2utils.extend(n,{originalRange:l.originalRange,newRange:l.newRange})),!0===n.isCancelled?(l.newRange=s,n.detail.newRange=s):(r.removeRange("grid-selection-expand"),r.addRange({name:"grid-selection-expand",range:n.detail.newRange,style:"background-color: rgba(100,100,100,0.1); border: 2px dotted rgba(100,100,100,0.5);"})))}}function s(e){r.removeRange("grid-selection-expand"),delete r.last.move,$(document).off(".w2ui-"+r.name),n.finish()}}}select(){if(0===arguments.length)return 0;let n=0,a=this.last.selection;this.multiSelect||this.selectNone();let t=Array.from(arguments);Array.isArray(t[0])&&(t=t[0]);let e={target:this.name};1==t.length?(e.multiple=!1,$.isPlainObject(t[0])?(e.recid=t[0].recid,e.column=t[0].column):e.recid=t[0]):(e.multiple=!0,e.recids=t);let i=this.trigger("select",e);if(!0===i.isCancelled)return 0;if("row"==this.selectType)for(let e=0;e<t.length;e++){var s="object"==typeof t[e]?t[e].recid:t[e],l=this.get(s,!0);if(null!=l){let e=null,t=null;(0!==this.searchData.length||l+1>=this.last.range_start&&l+1<=this.last.range_end)&&(e=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(s)),t=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(s))),"row"==this.selectType&&-1==a.indexes.indexOf(l)&&(a.indexes.push(l),e&&t&&(e.addClass("w2ui-selected").data("selected","yes").find(".w2ui-col-number").addClass("w2ui-row-selected"),t.addClass("w2ui-selected").data("selected","yes").find(".w2ui-col-number").addClass("w2ui-row-selected"),e.find(".w2ui-grid-select-check").prop("checked",!0)),n++)}}else{let l={};for(let e=0;e<t.length;e++){var o="object"==typeof t[e]?t[e].recid:t[e],h="object"==typeof t[e]?t[e].column:null;if(l[o]=l[o]||[],Array.isArray(h))l[o]=h;else if(w2utils.isInt(h))l[o].push(h);else for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||l[o].push(parseInt(e))}let r=[];for(var d in l){var u=this.get(d,!0);if(null!=u){let t=null,i=null;u+1>=this.last.range_start&&u+1<=this.last.range_end&&(t=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(d)),i=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(d)));let s=a.columns[u]||[];-1==a.indexes.indexOf(u)&&a.indexes.push(u);for(let e=0;e<l[d].length;e++)-1==s.indexOf(l[d][e])&&s.push(l[d][e]);s.sort((e,t)=>e-t);for(let e=0;e<l[d].length;e++){var c=l[d][e];-1==r.indexOf(c)&&r.push(c),t&&(t.find("#grid_"+this.name+"_data_"+u+"_"+c).addClass("w2ui-selected"),t.find(".w2ui-col-number").addClass("w2ui-row-selected"),t.data("selected","yes"),t.find(".w2ui-grid-select-check").prop("checked",!0)),i&&(i.find("#grid_"+this.name+"_data_"+u+"_"+c).addClass("w2ui-selected"),i.find(".w2ui-col-number").addClass("w2ui-row-selected"),i.data("selected","yes"),i.find(".w2ui-grid-select-check").prop("checked",!0)),n++}a.columns[u]=s}}for(let e=0;e<r.length;e++)$(this.box).find("#grid_"+this.name+"_column_"+r[e]+" .w2ui-col-header").addClass("w2ui-col-selected")}a.indexes.sort((e,t)=>e-t);var r=0<this.records.length&&a.indexes.length==this.records.length,p=0<a.indexes.length&&0!==this.searchData.length&&a.indexes.length==this.last.searchIds.length;return r||p?$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(a,r),i.finish(),n}unselect(){let r=0,n=this.last.selection,i=Array.from(arguments);Array.isArray(i[0])&&(i=i[0]);let e={target:this.name};1==i.length?(e.multiple=!1,$.isPlainObject(i[0])?(e.recid=i[0].recid,e.column=i[0].column):e.recid=i[0]):(e.multiple=!0,e.recids=i);let t=this.trigger("unselect",e);if(!0===t.isCancelled)return 0;for(let t=0;t<i.length;t++){var a="object"==typeof i[t]?i[t].recid:i[t],o=this.get(a);if(null!=o){o=this.get(o.recid,!0);let s=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(a)),l=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(a));if("row"==this.selectType)-1!=n.indexes.indexOf(o)&&(n.indexes.splice(n.indexes.indexOf(o),1),s.removeClass("w2ui-selected w2ui-inactive").removeData("selected").find(".w2ui-col-number").removeClass("w2ui-row-selected"),l.removeClass("w2ui-selected w2ui-inactive").removeData("selected").find(".w2ui-col-number").removeClass("w2ui-row-selected"),0!=s.length&&(s[0].style.cssText="height: "+this.recordHeight+"px; "+s.attr("custom_style"),l[0].style.cssText="height: "+this.recordHeight+"px; "+l.attr("custom_style")),s.find(".w2ui-grid-select-check").prop("checked",!1),r++);else{var h=i[t].column;if(!w2utils.isInt(h)){let t=[];for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||t.push({recid:a,column:e});return this.unselect(t)}let e=n.columns[o];if(Array.isArray(e)&&-1!=e.indexOf(h)){e.splice(e.indexOf(h),1),$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(a)).find(" > td[col="+h+"]").removeClass("w2ui-selected w2ui-inactive"),$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(a)).find(" > td[col="+h+"]").removeClass("w2ui-selected w2ui-inactive");let t=!1,i=!1;var d=this.getSelection();for(let e=0;e<d.length;e++)d[e].column==h&&(t=!0),d[e].recid==a&&(i=!0);t||$(this.box).find(".w2ui-grid-columns td[col="+h+"] .w2ui-col-header, .w2ui-grid-fcolumns td[col="+h+"] .w2ui-col-header").removeClass("w2ui-col-selected"),i||$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(a)).find(".w2ui-col-number").removeClass("w2ui-row-selected"),r++,0===e.length&&(delete n.columns[o],n.indexes.splice(n.indexes.indexOf(o),1),s.removeData("selected"),s.find(".w2ui-grid-select-check").prop("checked",!1),l.removeData("selected"))}}}}var s=0<this.records.length&&n.indexes.length==this.records.length,l=0<n.indexes.length&&0!==this.searchData.length&&n.indexes.length==this.last.searchIds.length;return s||l?$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.addRange("selection"),this.updateToolbar(n,s),t.finish(),r}selectAll(){var t=(new Date).getTime();if(!1!==this.multiSelect){let e=this.trigger("select",{target:this.name,all:!0});if(!0!==e.isCancelled){var l="object"!=typeof this.url?this.url:this.url.get;let i=this.last.selection,s=[];for(let e=0;e<this.columns.length;e++)s.push(e);if(i.indexes=[],l||0===this.searchData.length){let t=this.records.length;0==this.searchData.length||l||(t=this.last.searchIds.length);for(let e=0;e<t;e++)i.indexes.push(e),"row"!=this.selectType&&(i.columns[e]=s.slice())}else for(let e=0;e<this.last.searchIds.length;e++)i.indexes.push(this.last.searchIds[e]),"row"!=this.selectType&&(i.columns[this.last.searchIds[e]]=s.slice());return"row"==this.selectType?($(this.box).find(".w2ui-grid-records tr").not(".w2ui-empty-record").addClass("w2ui-selected").data("selected","yes").find(".w2ui-col-number").addClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-frecords tr").not(".w2ui-empty-record").addClass("w2ui-selected").data("selected","yes").find(".w2ui-col-number").addClass("w2ui-row-selected")):($(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").addClass("w2ui-col-selected"),$(this.box).find(".w2ui-grid-records tr .w2ui-col-number").addClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-records tr").not(".w2ui-empty-record").find(".w2ui-grid-data").not(".w2ui-col-select").addClass("w2ui-selected").data("selected","yes"),$(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").addClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-frecords tr").not(".w2ui-empty-record").find(".w2ui-grid-data").not(".w2ui-col-select").addClass("w2ui-selected").data("selected","yes")),$(this.box).find("input.w2ui-grid-select-check").prop("checked",!0),i=this.getSelection(!0),this.addRange("selection"),$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0),this.status(),this.updateToolbar({indexes:i},!0),e.finish(),(new Date).getTime()-t}}}selectNone(){var t=(new Date).getTime();let i=this.trigger("unselect",{target:this.name,all:!0});if(!0!==i.isCancelled){let e=this.last.selection;return"row"==this.selectType?($(this.box).find(".w2ui-grid-records tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").removeData("selected").find(".w2ui-col-number").removeClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-frecords tr.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").removeData("selected").find(".w2ui-col-number").removeClass("w2ui-row-selected")):($(this.box).find(".w2ui-grid-columns td .w2ui-col-header, .w2ui-grid-fcolumns td .w2ui-col-header").removeClass("w2ui-col-selected"),$(this.box).find(".w2ui-grid-records tr .w2ui-col-number").removeClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-frecords tr .w2ui-col-number").removeClass("w2ui-row-selected"),$(this.box).find(".w2ui-grid-data.w2ui-selected").removeClass("w2ui-selected w2ui-inactive").removeData("selected")),$(this.box).find("input.w2ui-grid-select-check").prop("checked",!1),e.indexes=[],e.columns={},this.removeRange("selection"),$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status(),this.updateToolbar(e,!1),i.finish(),(new Date).getTime()-t}}updateToolbar(s){let l=this,r=s&&s.indexes?s.indexes.length:0;function i(t,i){if(null!=t.batch){let e=!1;!0===t.batch?0<r&&(e=!0):"number"==typeof t.batch?r===t.batch&&(e=!0):"function"==typeof t.batch&&(e=t.batch({cnt:r,sel:s})),e?l.toolbar.enable(i+t.id):l.toolbar.disable(i+t.id)}}this.toolbar.items.forEach(t=>{i(t,""),Array.isArray(t.items)&&t.items.forEach(e=>{i(e,t.id+":")})}),this.show.toolbarSave&&(0<this.getChanges().length?this.toolbar.enable("w2ui-save"):this.toolbar.disable("w2ui-save"))}getSelection(t){let i=[];var s=this.last.selection;if("row"==this.selectType){for(let e=0;e<s.indexes.length;e++)this.records[s.indexes[e]]&&(!0===t?i.push(s.indexes[e]):i.push(this.records[s.indexes[e]].recid));return i}for(let t=0;t<s.indexes.length;t++){var l=s.columns[s.indexes[t]];if(this.records[s.indexes[t]])for(let e=0;e<l.length;e++)i.push({recid:this.records[s.indexes[t]].recid,index:parseInt(s.indexes[t]),column:l[e]})}return i}search(l,r){var i,s,n,e="object"!=typeof this.url?this.url:this.url.get;let a=[],o=this.last.multi,t=this.last.logic,h=this.last.field,d=this.last.search,u=!1;for(let e=0;e<this.searches.length;e++)this.searches[e].hidden&&null!=this.searches[e].value&&(a.push({field:this.searches[e].field,operator:this.searches[e].operator||"is",type:this.searches[e].type,value:this.searches[e].value||""}),u=!0);if(0===arguments.length){this.focus(),t=$(this.box).find(`#grid_${this.name}_logic`).val(),d="";for(let e=0;e<this.searches.length;e++){var c=this.searches[e],p=$(this.box).find("#grid_"+this.name+"_operator_"+e).val();let i=$(this.box).find("#grid_"+this.name+"_field_"+e),s=$(this.box).find("#grid_"+this.name+"_field2_"+e),l=i.val(),r=s.val(),t=null,n=null;if(-1!=["int","float","money","currency","percent"].indexOf(c.type)){let e=i.data("w2field"),t=s.data("w2field");e&&(l=e.clean(l)),t&&(r=t.clean(r))}if(-1!=["list","enum"].indexOf(c.type)||-1!=["in","not in"].indexOf(p))if(l=i.data("selected")||{},Array.isArray(l)){t=[];for(let e=0;e<l.length;e++)t.push(w2utils.isFloat(l[e].id)?parseFloat(l[e].id):String(l[e].id).toLowerCase()),delete l[e].hidden;$.isEmptyObject(l)&&(l="")}else n=l.text||"",l=l.id||"";if(""!==l&&null!=l||null!=r&&""!==r){let e={field:c.field,type:c.type,operator:p};"between"==p?$.extend(e,{value:[l,r]}):"in"==p&&"string"==typeof l||"not in"==p&&"string"==typeof l?$.extend(e,{value:l.split(",")}):$.extend(e,{value:l}),t&&$.extend(e,{svalue:t}),n&&$.extend(e,{text:n});try{"date"==c.type&&"between"==p&&(e.value[0]=l,e.value[1]=r),"date"==c.type&&"is"==p&&(e.value=l)}catch(e){}a.push(e),o=!0}}}if("string"==typeof l&&(1==arguments.length&&(r=l,l="all"),h=l,d=r,o=!1,t=u?"AND":"OR",null!=r))if("all"==l.toLowerCase())if(0<this.searches.length)for(let t=0;t<this.searches.length;t++){let e=this.searches[t];if(("text"==e.type||"alphanumeric"==e.type&&w2utils.isAlphaNumeric(r)||"int"==e.type&&w2utils.isInt(r)||"float"==e.type&&w2utils.isFloat(r)||"percent"==e.type&&w2utils.isFloat(r)||("hex"==e.type||"color"==e.type)&&w2utils.isHex(r)||"currency"==e.type&&w2utils.isMoney(r)||"money"==e.type&&w2utils.isMoney(r)||"date"==e.type&&w2utils.isDate(r)||"time"==e.type&&w2utils.isTime(r)||"datetime"==e.type&&w2utils.isDateTime(r)||"datetime"==e.type&&w2utils.isDate(r)||"enum"==e.type&&w2utils.isAlphaNumeric(r)||"list"==e.type&&w2utils.isAlphaNumeric(r))&&(i=this.defaultOperator[this.operatorsMap[e.type]],i={field:e.field,type:e.type,operator:null!=e.operator?e.operator:i,value:r},""!=String(r).trim()&&a.push(i)),-1!=["int","float","money","currency","percent"].indexOf(e.type)&&2==String(r).trim().split("-").length&&(s=String(r).trim().split("-"),s={field:e.field,type:e.type,operator:null!=e.operator?e.operator:"between",value:[s[0],s[1]]},a.push(s)),-1!=["list","enum"].indexOf(e.type)){let i=[];null==e.options&&(e.options={}),Array.isArray(e.options.items)||(e.options.items=[]);for(let t=0;t<e.options.items;t++){var f=e.options.items[t];try{let e=new RegExp(r,"i");e.test(f)&&i.push(t),f.text&&e.test(f.text)&&i.push(f.id)}catch(e){}}0<i.length&&(s={field:e.field,type:e.type,operator:null!=e.operator?e.operator:"in",value:i},a.push(s))}}else for(let e=0;e<this.columns.length;e++){var m={field:this.columns[e].field,type:"text",operator:this.defaultOperator.text,value:r};a.push(m)}else{let i=$(this.box).find("#grid_"+this.name+"_search_all"),s=this.getSearch(l);if(null==s&&(s={field:l,type:"text"}),s.field==l&&(this.last.label=s.label),""!==r){let e=this.defaultOperator[this.operatorsMap[s.type]],t=r;if(-1!=["date","time","datetime"].indexOf(s.type)&&(e="is"),-1!=["list","enum"].indexOf(s.type)&&(e="is",n=i.data("selected"),t=n&&!$.isEmptyObject(n)?n.id:""),"int"==s.type&&""!==r)if(e="is",-1==String(r).indexOf("-")||2==(w=r.split("-")).length&&(e="between",t=[parseInt(w[0]),parseInt(w[1])]),-1!=String(r).indexOf(",")){var g=r.split(",");e="in",t=[];for(let e=0;e<g.length;e++)t.push(g[e])}null!=s.operator&&(e=s.operator);var w={field:s.field,type:s.type,operator:e,value:t};a.push(w)}}if(Array.isArray(l)){let e="AND";"string"==typeof r&&(e=r.toUpperCase(),"OR"!=e&&"AND"!=e&&(e="AND")),d="",o=!0,t=e;for(let t=0;t<l.length;t++){let e=l[t];"number"==typeof e.value&&(e.operator=this.defaultOperator.number),"string"==typeof e.value&&(e.operator=this.defaultOperator.text),Array.isArray(e.value)&&(e.operator=this.defaultOperator.enum),w2utils.isDate(e.value)&&(e.operator=this.defaultOperator.date),a.push(e)}}let y=this.trigger("search",{target:this.name,multi:0===arguments.length,searchField:l||"multi",searchValue:l?r:"multi",searchData:a,searchLogic:t});!0!==y.isCancelled&&(this.searchData=y.detail.searchData,this.last.field=h,this.last.search=d,this.last.multi=o,this.last.logic=y.detail.searchLogic,this.last.scrollTop=0,this.last.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose(),e?(this.last.xhr_offset=0,this.reload()):(this.localSearch(),this.refresh()),y.finish())}searchOpen(){if(this.box&&0!==this.searches.length){let i=this.trigger("searchOpen",{target:this.name});if(!0!==i.isCancelled){let t=query(this.toolbar.box).find(".w2ui-grid-search-input .w2ui-search-drop");t.addClass("checked"),w2tooltip.show({name:this.name+"-search-overlay",anchor:query(this.box).find("#grid_"+this.name+"_search_all").get(0),html:this.getSearchesHTML(),align:"left",arrowSize:12,class:"w2ui-grid-search-advanced",hideOn:["doc-click"]}).then(e=>{this.initSearches(),this.last.search_opened=!0,query(`#w2overlay-${this.name}-search-overlay .w2ui-grid-search-advanced`).data("gridName",this.name),w2utils.bindEvents(query(`#w2overlay-${this.name}-search-overlay`).find("select, input, button"),this);let t=query(`#w2overlay-${this.name}-search-overlay *[rel=search]`);0<t.length&&t[0].focus(),i.finish()}).hide(e=>{t.removeClass("checked"),this.last.search_opened=!1})}}}searchClose(){w2tooltip.hide(this.name+"-search-overlay")}searchSuggest(e,t,i){clearTimeout(this.last.kbd_timer),clearTimeout(this.last.overlay_timer),this.searchShowFields(!0),this.searchClose(),!0!==t?0<$(`#w2overlay-${this.name}-search-suggest`).length||(e?(e=query(this.box).find(`#grid_${this.name}_search_all`).get(0),Array.isArray(this.savedSearches)&&0<this.savedSearches.length&&w2menu.show({name:this.name+"-search-suggest",anchor:e,align:"both",items:this.savedSearches,topHTML:`<div class="w2ui-grid-search-suggest">${w2utils.lang("Saved Searches")}</div>`,hideOn:["doc-click","sleect","remove"],render(e){let t=e.text;return e.isDefault&&(t=`<b>${t}</b>`),t}}).select(e=>{let t=this.trigger("searchSelect",{target:this.name,index:e.detail.index,item:e.detail.item});!0!==t.isCancelled?(this.last.logic=e.detail.item.logic||"AND",this.last.search="",this.last.label="[Multiple Fields]",this.searchData=w2utils.extend([],e.detail.item.data),this.searchSelected={name:e.detail.item.id,logic:e.detail.item.logic,data:this.searchData},this.reload(),t.finish()):e.preventDefault()}).remove(e=>{let s=e.detail.item,l=this.trigger("searchRemove",{target:this.name,index:e.detail.index,item:s});!0!==l.isCancelled?this.confirm(w2utils.lang('Do you want to delete search item "${item}"?',{item:s.text})).yes(e=>{if(w2utils.hasLocalStorage&&this.useLocalStorage)try{var t,i=JSON.parse(localStorage.w2ui||"{}");if(i&&i.searches){let e=i.searches[this.stateId||this.name];Array.isArray(e)&&(null!==(t=e.findIndex((e,t)=>e.name==s.id))&&e.splice(t,1),localStorage.w2ui=JSON.stringify(i))}}catch(e){}i=this.savedSearches.findIndex((e,t)=>e.name==s.id);null!==i&&this.savedSearches.splice(i,1),e.detail.self.close(),l.finish()}).no(e=>{e.detail.self.close()}):e.preventDefault()})):this.last.overlay_timer=setTimeout(()=>{this.searchSuggest(!0)},100)):w2tooltip.hide(this.name+"-search-suggest")}searchFieldDrop(t,i,e){let s=this;var l=this.searches[t];let r=this.searchData[i];this.name,this.name,this.getOperators(l.type,l.operators);let n="";switch(l.type){case"text":case"alphanumeric":case"hex":case"color":case"list":case"combo":case"enum":{let e="width: 250px;";-1!=["hex","color"].indexOf(l.type)&&(e="width: 90px;"),n+='<input rel="search" type="text" id="grid_'+this.name+"_field_"+t+'" name="'+l.field+'"    class="w2ui-input" style="'+e+l.style+'" '+l.inTag+"/>";break}case"int":case"float":case"money":case"currency":case"percent":case"date":case"time":case"datetime":let e="width: 80px";"datetime"==l.type&&(e="width: 140px;"),n+='<input rel="search" type="text" class="w2ui-input" style="'+e+l.style+'" id="grid_'+this.name+"_field_"+t+'" name="'+l.field+'" '+l.inTag+'/><span id="grid_'+this.name+"_extra1_"+t+'" style="padding-left: 5px; color: #6f6f6f; font-size: 10px"></span><span id="grid_'+this.name+"_range_"+t+'" style="display: none">&#160;-&#160;&#160;<input rel="search" type="text" class="w2ui-input" style="'+e+l.style+'" id="grid_'+this.name+"_field2_"+t+'" name="'+l.field+'" '+l.inTag+'/></span><span id="grid_'+this.name+"_extra2_"+t+'" style="padding-left: 5px; color: #6f6f6f; font-size: 10px"></span>';break;case"select":n+='<select rel="search" class="w2ui-input" style="'+l.style+'" id="grid_'+this.name+"_field_"+t+'"  name="'+l.field+'" '+l.inTag+'  onclick="event.stopPropagation();"></select>'}let a=r.operator;"more"==a&&"date"==r.type&&(a="since"),"less"==a&&"date"==r.type&&(a="before");let o="",h=r.value;Array.isArray(r.value)?(r.value.forEach(e=>{o+=`<li>${e.text||e}</li>`}),"date"==r.type&&(o="",r.value.forEach(e=>{o+=`<li>${w2utils.formatDate(e)}</li>`}))):"date"==r.type&&(h=w2utils.formatDateTime(h)),w2tooltip.show({name:this.name+"-search-props",anchor:e,class:"w2ui-white",hideOn:"doc-click",html:`
                <div class="w2ui-grid-search-single">
                    <span class="operator">${w2utils.lang(a)}</span>
                    ${Array.isArray(r.value)?`<div class="options"> <ul>${o}</ul> </div>`:`<span>${h}</span>`}
                    <div class="buttons">
                        <button id="remove" class="w2ui-btn">${w2utils.lang("Remove This Field")}</button>
                    </div>
                </div>`}).then(e=>{query(e.detail.overlay.box).find("#remove").on("click",()=>{s.searchData.splice(`${i}`,1),s.reload(),s.localSearch(),w2tooltip.hide(this.name+"-search-props")})})}searchSave(){let i="";this.searchSelected&&(i=this.searchSelected.name);let l=this,r=this.trigger("searchSave",{target:this.name,saveLocalStorage:!0});!0!==r.isCancelled&&this.message({width:350,height:150,body:`<div style="padding-top: 29px; text-align: center;">
                <span style="width: 280px; display: inline-block; text-align: left; padding-bottom: 4px;">${w2utils.lang("Save Search")}</span>
                <input class="search-name w2ui-input" placeholder="${w2utils.lang("Search name")}" style="width: 280px">
            </div>`,buttons:`
                <button id="grid-search-cancel" class="w2ui-btn">${w2utils.lang("Cancel")}</button>
                <button id="grid-search-save" class="w2ui-btn w2ui-btn-blue" ${""==String(i).trim()?"disabled":""}>${w2utils.lang("Save")}</button>
            `,onOpen(e){setTimeout(()=>{$(this.box).find("#grid-search-cancel").on("click",()=>{l.message()}),$(this.box).find("#grid-search-save").on("click",()=>{var e,i=$(l.box).find(".w2ui-message .search-name").val();if(l.searchSelected?(e=l.savedSearches.findIndex(e=>e.id==l.searchSelected.name),Object.assign(l.savedSearches[e],{id:i,text:i,logic:l.last.logic,data:$.extend(!0,[],l.searchData)})):l.savedSearches.push({id:i,text:i,icon:"w2ui-icon-search",remove:!0,logic:l.last.logic,data:l.searchData}),w2utils.hasLocalStorage&&l.useLocalStorage)try{let e=JSON.parse(localStorage.w2ui||"{}");e=e||{},e.searches||(e.searches={}),Array.isArray(e.searches[l.stateId||l.name])||(e.searches[l.stateId||l.name]=[]);let t=e.searches[l.stateId||l.name];var s=t.findIndex(e=>e.name==l.searchSelected.name);-1!==s?Object.assign(t[s],{name:i,logic:l.last.logic,data:l.searchData}):t.push({name:i,logic:l.last.logic,data:l.searchData}),localStorage.w2ui=JSON.stringify(e)}catch(e){return delete localStorage.w2ui,null}l.message(),l.searchSelected?(l.searchSelected.name=i,$(l.box).find(`#grid_${l.name}_search_name .name-text`).html(i)):(l.searchSelected={name:i,logic:l.last.logic,data:$.extend(!0,[],l.searchData)},$(l.box).find(`#grid_${l.name}_search_all`).val(" ").prop("readOnly",!0),$(l.box).find(`#grid_${l.name}_search_name`).show().find(".name-text").html(i)),r.finish({name:i})});let t=$(this.box).find("input, button");t.off(".message").on("blur.message",function(e){t.index(e.target)+1===t.length&&(t.get(0).focus(),e.preventDefault())}).on("keydown.message",function(e){var t=String($(l.box).find(".w2ui-message-body input").val()).trim();13==e.keyCode&&""!=t&&$(l.box).find("#grid-search-save").click(),27==e.keyCode&&l.message()}),$(this.box).find(".w2ui-message-body input").on("input",function(e){let t=$(this).closest(".w2ui-message").find("#grid-search-save");""===String($(this).val()).trim()?t.prop("disabled",!0):t.prop("disabled",!1)}).val(i).focus()},25)}})}searchReset(e){let t=[],i=!1;for(let e=0;e<this.searches.length;e++)this.searches[e].hidden&&null!=this.searches[e].value&&(t.push({field:this.searches[e].field,operator:this.searches[e].operator||"is",type:this.searches[e].type,value:this.searches[e].value||""}),i=!0);let s=this.trigger("search",{reset:!0,target:this.name,searchData:t});if(!0!==s.isCancelled){if(this.searchData=s.detail.searchData,this.searchSelected=null,this.last.search="",this.last.logic=i?"AND":"OR",0<this.searches.length)if(this.multiSearch&&this.show.searchAll)this.last.field="all",this.last.label="All Fields";else{let e=0;for(;e<this.searches.length&&(this.searches[e].hidden||!1===this.searches[e].simple);)e++;e>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[e].field,this.last.label=this.searches[e].label)}this.last.multi=!1,this.last.xhr_offset=0,this.last.scrollTop=0,this.last.scrollLeft=0,this.last.selection.indexes=[],this.last.selection.columns={},this.searchClose(),$(this.box).find("#grid_"+this.name+"_search_all").val("").removeData("selected"),e||this.reload(),s.finish()}}searchShowFields(e){if(!0!==e){let l=[];for(let s=-1;s<this.searches.length;s++){let e=this.searches[s];var r=e?e.field:null,r=this.getColumn(r);let t=!1,i=null;if(1==this.show.searchHiddenMsg&&-1!=s&&(null==r||!0===r.hidden&&!1!==r.hideable)&&(t=!0,i=w2utils.lang(`This column ${null==r?"does not exist":"is hidden"}`)),-1==s){if(!this.multiSearch||!this.show.searchAll)continue;e={field:"all",label:"All Fields"}}else{if(null!=r&&!1===r.hideable)continue;if(!0===e.hidden&&(i=w2utils.lang("This column is hidden"),!1===e.simple))continue}null==e.label&&null!=e.caption&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",e),e.label=e.caption),l.push({id:e.field,text:w2utils.lang(e.label),search:e,tooltip:i,disabled:t,checked:e.field==this.last.field})}w2menu.show({type:"radio",name:this.name+"-search-fields",anchor:query(this.box).find("#grid_"+this.name+"_search_name").parent().find(".w2ui-search-down").get(0),items:l,align:"none",hideOn:["doc-click"]}).select(e=>{this.searchInitInput(e.detail.item.search.field)})}else w2tooltip.hide(this.name+"-search-fields")}searchInitInput(e,t){let i,s=query(this.box).find("#grid_"+this.name+"_search_all");if("all"==e)i={field:"all",label:w2utils.lang("All Fields")};else if(i=this.getSearch(e),null==i)return;""!=this.last.search?(this.last.label=i.label,this.search(i.field,this.last.search)):(this.last.field=i.field,this.last.label=i.label),s.attr("placeholder",w2utils.lang("Search")+" "+w2utils.lang(i.label||i.caption||i.field,!0))}clear(e){this.total=0,this.records=[],this.summary=[],this.last.xhr_offset=0,this.last.idCache={},this.reset(!0),e||this.refresh()}reset(e){this.last.scrollTop=0,this.last.scrollLeft=0,this.last.selection={indexes:[],columns:{}},this.last.range_start=null,this.last.range_end=null,$(this.box).find("#grid_"+this.name+"_records").prop("scrollTop",0),e||this.refresh()}skip(e,t){("object"!=typeof this.url?this.url:this.url.get)?(this.offset=parseInt(e),this.offset>this.total&&(this.offset=this.total-this.limit),(this.offset<0||!w2utils.isInt(this.offset))&&(this.offset=0),this.clear(!0),this.reload(t)):console.log("ERROR: grid.skip() can only be called when you have remote data source.")}load(e,t){null!=e?(this.clear(!0),this.request("get",{},e,t)):console.log('ERROR: You need to provide url argument when calling .load() method of "'+this.name+'" object.')}reload(e){let t=this;var i="object"!=typeof this.url?this.url:this.url.get;t.selectionSave(),i?this.load(i,()=>{t.selectionRestore(),"function"==typeof e&&e()}):(this.reset(!0),this.localSearch(),this.selectionRestore(),"function"==typeof e&&e({status:"success"}))}request(l,s,r,n){if(null==s&&(s={}),""!=(r=""==r||null==r?this.url:r)&&null!=r){w2utils.isInt(this.offset)||(this.offset=0),w2utils.isInt(this.last.xhr_offset)||(this.last.xhr_offset=0);let e,t={limit:this.limit,offset:parseInt(this.offset)+parseInt(this.last.xhr_offset),searchLogic:this.last.logic,search:this.searchData.map(e=>{let t=$.extend({},e);return this.searchMap&&this.searchMap[t.field]&&(t.field=this.searchMap[t.field]),t}),sort:this.sortData.map(e=>{let t=$.extend({},e);return this.sortMap&&this.sortMap[t.field]&&(t.field=this.sortMap[t.field]),t})};if(0===this.searchData.length&&(delete t.search,delete t.searchLogic),0===this.sortData.length&&delete t.sort,$.extend(t,this.postData),$.extend(t,s),"delete"!=l&&"save"!=l||(delete t.limit,delete t.offset,"delete"==(t.action=l)&&(t[this.recid||"recid"]=this.getSelection())),"get"==l){if(e=this.trigger("request",{target:this.name,url:r,postData:t,httpHeaders:this.httpHeaders}),!0===e.isCancelled)return void("function"==typeof n&&n({status:"error",message:w2utils.lang("Request aborted.")}))}else e={url:r,postData:t,httpHeaders:this.httpHeaders};if(0===this.last.xhr_offset&&this.lock(w2utils.lang(this.msgRefresh),!0),this.last.xhr)try{this.last.xhr.abort()}catch(e){}if(r="object"!=typeof e.detail.url?e.detail.url:e.detail.url.get,"save"==l&&"object"==typeof e.detail.url&&(r=e.detail.url.save),"delete"==l&&"object"==typeof e.detail.url&&(r=e.detail.url.remove),!$.isEmptyObject(this.routeData)){var a=w2utils.parseRoute(r);if(0<a.keys.length)for(let e=0;e<a.keys.length;e++)null!=this.routeData[a.keys[e].name]&&(r=r.replace(new RegExp(":"+a.keys[e].name,"g"),this.routeData[a.keys[e].name]))}let i={type:"GET",url:r,data:e.detail.postData,headers:e.detail.httpHeaders,dataType:"json"};switch(this.dataType||w2utils.settings.dataType){case"HTTP":i.data="object"==typeof i.data?String($.param(i.data,!1)).replace(/%5B/g,"[").replace(/%5D/g,"]"):i.data;break;case"HTTPJSON":i.data={request:JSON.stringify(i.data)};break;case"RESTFULL":i.type="GET","save"==l&&(i.type="PUT"),"delete"==l&&(i.type="DELETE"),i.data="object"==typeof i.data?String($.param(i.data,!1)).replace(/%5B/g,"[").replace(/%5D/g,"]"):i.data;break;case"RESTFULLJSON":i.type="GET","save"==l&&(i.type="PUT"),"delete"==l&&(i.type="DELETE"),i.data=JSON.stringify(i.data),i.contentType="application/json";break;case"JSON":i.type="POST",i.data=JSON.stringify(i.data),i.contentType="application/json"}this.method&&(i.type=this.method),this.last.xhr_cmd=l,this.last.xhr_start=(new Date).getTime(),this.last.loaded=!1,this.last.xhr=$.ajax(i).done((e,t,i)=>{this.requestComplete(t,i,l,n)}).fail((t,e,i)=>{i={status:e,error:i,rawResponseText:t.responseText};let s=this.trigger("error",{error:i,xhr:t});if(!0!==s.isCancelled){if("abort"!=e){let e;try{e="object"==typeof t.responseJSON?t.responseJSON:JSON.parse(t.responseText)}catch(e){}console.log("ERROR: Server communication failed.","\n   EXPECTED:",{status:"success",total:5,records:[{recid:1,field:"value"}]},"\n         OR:",{status:"error",message:"error message"},"\n   RECEIVED:","object"==typeof e?e:t.responseText),this.requestComplete("error",t,l,n)}s.finish()}}),"get"==l&&e.finish()}}requestComplete(t,i,s,l){this.unlock(),this.last.xhr_response=((new Date).getTime()-this.last.xhr_start)/1e3,setTimeout(()=>{this.show.statusResponse&&this.status(w2utils.lang("Server Response ${count} seconds",{count:this.last.xhr_response}))},10),this.last.pull_more=!1,this.last.pull_refresh=!0;let e="load";"save"==this.last.xhr_cmd&&(e="save"),"delete"==this.last.xhr_cmd&&(e="delete");let r=this.trigger(e,{target:this.name,xhr:i,status:t});if(!0!==r.isCancelled){let e;if("error"!=t){if("function"==typeof this.parser?(e=this.parser(i.responseJSON),"object"!=typeof e&&console.log("ERROR: Your parser did not return proper object")):(e=i.responseJSON,null==e?e={status:"error",message:w2utils.lang(this.msgNotJSON),responseText:i.responseText}:Array.isArray(e)&&(e={status:"success",records:e,total:e.length})),"error"==e.status)this.error(e.message);else if("get"==s){if(null==e.total&&(e.total=-1),null==e.records&&(e.records=[]),e.records.length==this.limit?(t=this.records.length+e.records.length,this.last.xhr_hasMore=t!=this.total):(this.last.xhr_hasMore=!1,this.total=this.offset+this.last.xhr_offset+e.records.length),this.last.xhr_hasMore||$(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more").hide(),0===this.last.xhr_offset)this.records=[],this.summary=[];else if(-1!=e.total&&parseInt(e.total)!=parseInt(this.total)){let e=this;return void this.message(w2utils.lang(this.msgNeedReload)).ok(()=>{delete e.last.xhr_offset,e.reload()})}w2utils.isInt(e.total)&&(this.total=parseInt(e.total)),e.records&&e.records.forEach(e=>{this.recid&&(e.recid=this.parseField(e,this.recid)),null==e.recid&&(e.recid="recid-"+this.records.length),(e.w2ui&&!0===e.w2ui.summary?this.summary:this.records).push(e)}),e.summary&&(this.summary=[],e.summary.forEach(e=>{this.recid&&(e.recid=this.parseField(e,this.recid)),null==e.recid&&(e.recid="recid-"+this.summary.length),this.summary.push(e)}))}else if("delete"==s)return this.reset(),void this.reload()}else e={status:"error",message:w2utils.lang(this.msgAJAXerror),responseText:i.responseText},this.error(w2utils.lang(this.msgAJAXerror));("object"!=typeof this.url?this.url:this.url.get)||(this.localSort(),this.localSearch()),this.total=parseInt(this.total),0===this.last.xhr_offset?this.refresh():(this.scroll(),this.resize()),"function"==typeof l&&l(e),r.finish(),this.last.loaded=!0}else"function"==typeof l&&l({status:"error",message:w2utils.lang("Request aborted.")})}error(e){let t=this.trigger("error",{target:this.name,message:e,xhr:this.last.xhr});!0!==t.isCancelled&&(this.message(e),t.finish())}getChanges(t){let i=[];void 0===t&&(t=this.records);for(let e=0;e<t.length;e++){var s=t[e];if(s.w2ui){if(null!=s.w2ui.changes){let e={};e[this.recid||"recid"]=s.recid,i.push($.extend(!0,e,s.w2ui.changes))}!0!==s.w2ui.expanded&&s.w2ui.children&&s.w2ui.children.length&&$.merge(i,this.getChanges(s.w2ui.children))}}return i}mergeChanges(){let i=this.getChanges();for(let t=0;t<i.length;t++){let e=this.get(i[t][this.recid||"recid"]);for(var s in i[t])if(!("recid"==s||this.recid&&s==this.recid)){"object"==typeof i[t][s]&&(i[t][s]=i[t][s].text);try{!function e(t,i,s){let l=i.split(".");1==l.length?t[i]=s:(t=t[l[0]],l.shift(),e(t,l.join("."),s))}(e,s,i[t][s])}catch(e){console.log("ERROR: Cannot merge. ",e.message||"",e)}e.w2ui&&delete e.w2ui.changes}}this.refresh()}save(t){var e=this.getChanges(),i="object"!=typeof this.url?this.url:this.url.save;let s=this.trigger("save",{target:this.name,changes:e});!0!==s.isCancelled?i?this.request("save",{changes:s.detail.changes},null,e=>{"error"!==e.status&&this.mergeChanges(),s.finish(),"function"==typeof t&&t(e)}):(this.mergeChanges(),s.finish()):i&&"function"==typeof t&&t({status:"error",message:w2utils.lang("Request aborted.")})}editField(h,d,u,t){let c=this,p,f;if(!0!==this.last.inEditMode){p=this.get(h,!0);let o=this.getCellEditable(p,d);if(o){let n=this.records[p],a=this.columns[d];var m=!0===a.frozen?"_f":"_";if(-1==["enum","file"].indexOf(o.type)){let r=this.trigger("editField",{target:this.name,recid:h,column:d,value:u,index:p,originalEvent:t});if(!0!==r.isCancelled&&(u=r.detail.value,this.last.inEditMode=!0,this.last._edit={value:u,index:p,column:d,recid:h},this.selectNone(),this.select({recid:h,column:d}),-1==["checkbox","check"].indexOf(o.type))){let t=$(this.box).find("#grid_"+this.name+m+"rec_"+w2utils.escapeId(h)),i=t.find("[col="+d+"] > div");$(this.box).find("div.w2ui-edit-box").remove(),"row"!=this.selectType&&($(this.box).find("#grid_"+this.name+m+"selection").attr("id","grid_"+this.name+"_editable").removeClass("w2ui-selection").addClass("w2ui-edit-box").prepend('<div style="position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px;"></div>').find(".w2ui-selection-resizer").remove(),i=$(this.box).find("#grid_"+this.name+"_editable >div:first-child")),null==o.inTag&&(o.inTag=""),null==o.outTag&&(o.outTag=""),null==o.style&&(o.style=""),null==o.items&&(o.items=[]);let s=n.w2ui&&n.w2ui.changes&&null!=n.w2ui.changes[a.field]?w2utils.stripTags(n.w2ui.changes[a.field]):w2utils.stripTags(c.parseField(n,a.field));null==s&&(s="");let e="object"!=typeof s?s:"";null!=r.detail.old_value&&(e=r.detail.old_value),null!=u&&(s=u);let l=null!=a.style?a.style+";":"";switch("string"==typeof a.render&&-1!=["number","int","float","money","percent","size"].indexOf(a.render.split(":")[0])&&(l+="text-align: right;"),0<o.items.length&&!$.isPlainObject(o.items[0])&&(o.items=w2utils.normMenu(o.items)),o.type){case"select":{let t="";for(let e=0;e<o.items.length;e++)t+='<option value="'+o.items[e].id+'"'+(o.items[e].id==s?' selected="selected"':"")+">"+o.items[e].text+"</option>";i.addClass("w2ui-editable").html('<select id="grid_'+this.name+"_edit_"+h+"_"+d+'" column="'+d+'" class="w2ui-input"    style="width: 100%; pointer-events: auto; padding: 0 0 0 3px; margin: 0px; border-left: 0; border-right: 0; border-radius: 0px;            outline: none; font-family: inherit;'+l+o.style+'"     field="'+a.field+'" recid="'+h+'"     '+o.inTag+">"+t+"</select>"+o.outTag),setTimeout(()=>{i.find("select").on("change",function(e){delete c.last.move}).on("blur",function(e){1!=$(this).data("keep-open")&&c.editChange.call(c,this,p,d,e)})},10);break}case"div":{let e=t.find("[col="+d+"] > div");var g="font-family: "+e.css("font-family")+"; font-size: "+e.css("font-size")+";";i.addClass("w2ui-editable").html('<div id="grid_'+this.name+"_edit_"+h+"_"+d+'" class="w2ui-input"    contenteditable style="'+g+l+o.style+'" autocorrect="off" autocomplete="off" spellcheck="false"     field="'+a.field+'" recid="'+h+'" column="'+d+'" '+o.inTag+"></div>"+o.outTag),null==u&&i.find("div.w2ui-input").text("object"!=typeof s?s:""),f=i.find("div.w2ui-input").get(0),setTimeout(()=>{let t=f;$(t).on("blur",function(e){1!=$(this).data("keep-open")&&c.editChange.call(c,t,p,d,e)})},10),null!=u&&$(f).text("object"!=typeof s?s:"");break}default:{let e=t.find("[col="+d+"] > div");g="font-family: "+e.css("font-family")+"; font-size: "+e.css("font-size");i.addClass("w2ui-editable").html('<input id="grid_'+this.name+"_edit_"+h+"_"+d+'" autocorrect="off" autocomplete="off" spellcheck="false" type="text"     style="'+g+"; "+l+o.style+'"     field="'+a.field+'" recid="'+h+'" column="'+d+'" class="w2ui-input"'+o.inTag+"/>"+o.outTag),"number"==o.type&&(s=w2utils.formatNumber(s)),"date"==o.type&&(s=w2utils.formatDate(w2utils.isDate(s,o.format,!0)||new Date,o.format)),null==u&&i.find("input").val("object"!=typeof s?s:""),f=i.find("input").get(0),$.fn.w2field&&$(f).w2field(o.type,$.extend(o,{selected:s})),setTimeout(()=>{let e=f;"list"==o.type&&(e=$($(f).data("w2field").helpers.focus).find("input"),"object"!=typeof s&&""!=s&&e.val(s).css({opacity:1}).prev().css({opacity:1}),i.find("input").on("change",function(e){c.editChange.call(c,f,p,d,e)})),$(e).on("blur",function(e){1!=$(this).data("keep-open")&&c.editChange.call(c,f,p,d,e)})},10),null!=u&&$(f).val("object"!=typeof s?s:""),f.select()}}function w(e){try{var t="DIV"==this.tagName.toUpperCase()?$(this).text():this.value;let e=$(c.box).find("#grid_"+c.name+"_editable");var i="font-family: "+$(this).css("font-family")+"; font-size: "+$(this).css("font-size")+"; white-space: pre;",s=w2utils.getStrWidth(t,i);s+20>e.width()&&e.width(s+20)}catch(e){}}setTimeout(()=>{f=f||i.find("input").get(0),this.last.inEditMode&&(i.find("input, select, div.w2ui-input").data("old_value",e).on("mousedown",function(e){e.stopPropagation()}).on("click",function(e){"div"==o.type?w.call(i.find("div.w2ui-input")[0],null):w.call(i.find("input, select")[0],null)}).on("paste",function(e){let t=e.originalEvent;e.preventDefault();e=t.clipboardData.getData("text/plain");document.execCommand("insertHTML",!1,e)}).on("keydown",function(i){let s=this;var e="DIV"==s.tagName.toUpperCase()?$(s).text():$(s).val();switch(i.keyCode){case 8:"list"!=o.type||$(f).data("w2field")||i.preventDefault();break;case 9:case 13:i.preventDefault();break;case 27:i.stopPropagation();break;case 37:0===w2utils.getCursorPosition(s)&&i.preventDefault();break;case 39:w2utils.getCursorPosition(s)==e.length&&(w2utils.setCursorPosition(s,e.length),i.preventDefault())}setTimeout(()=>{switch(i.keyCode){case 9:{let t=i.shiftKey?c.prevCell(p,d,!0):c.nextCell(p,d,!0);if(null!=t){let e=c.records[t.index].recid;s.blur(),setTimeout(()=>{"row"!=c.selectType?(c.selectNone(),c.select({recid:e,column:t.colIndex})):c.editField(e,t.colIndex,null,i)},1),i.preventDefault&&i.preventDefault()}break}case 13:if(s.blur(),c.advanceOnEdit){let e=i.shiftKey?c.prevRow(p,d,1):c.nextRow(p,d,1);null==e&&(e=p),setTimeout(()=>{"row"!=c.selectType?(c.selectNone(),c.select({recid:c.records[e].recid,column:d})):c.editField(c.records[e].recid,d,null,i)},1)}"DIV"==s.tagName.toUpperCase()&&i.preventDefault();break;case 27:{let e=c.parseField(n,a.field);n.w2ui&&n.w2ui.changes&&null!=n.w2ui.changes[a.field]&&(e=n.w2ui.changes[a.field]),null!=$(s).data("old_value")&&(e=$(s).data("old_value")),"DIV"==s.tagName.toUpperCase()?$(s).text(null!=e?e:""):s.value=null!=e?e:"",s.blur(),setTimeout(()=>{c.select({recid:h,column:d})},1);break}}w.call(s,i)},1)}).on("keyup",function(e){w.call(this,e)}),setTimeout(()=>{if(c.last.inEditMode){let e=i.find(".w2ui-input"),t=null!=$(e).val()?$(e).val().length:0;"div"==o.type&&(t=$(e).text().length),0<e.length&&(e.focus(),clearTimeout(c.last.kbd_timer),"SELECT"!=e[0].tagName.toUpperCase()&&w2utils.setCursorPosition(e[0],t),(e[0].resize=w).call(e[0],null))}},50),r.finish({input:i.find("input, select, div.w2ui-input")}))},5)}}else console.log('ERROR: input types "enum" and "file" are not supported in inline editing.')}}else if(t&&13==t.keyCode){if(p=this.last._edit.index,d=this.last._edit.column,h=this.last._edit.recid,this.editChange({type:"custom",value:this.last._edit.value},this.get(h,!0),d,t),this.advanceOnEdit){let e=t.shiftKey?this.prevRow(p,d,1):this.nextRow(p,d,1);null!=e&&e!=p&&setTimeout(()=>{"row"!=this.selectType?(this.selectNone(),this.select({recid:this.records[e].recid,column:d})):this.editField(this.records[e].recid,d,null,t)},1)}this.last.inEditMode=!1}else{let e=$(this.box).find("div.w2ui-edit-box .w2ui-input");0<e.length&&"DIV"==e[0].tagName&&(e.text(e.text()+u),w2utils.setCursorPosition(e[0],e.text().length))}}editChange(e,t,i,s){setTimeout(()=>{let e=$(this.box).find("#grid_"+this.name+"_focus");e.is(":focus")||e.focus()},10);var l=t<0;let r=(l?this.summary:this.records)[t=t<0?-t-1:t];var n=this.columns[i],a=$(this.box).find("#grid_"+this.name+(!0===n.frozen?"_frec_":"_rec_")+w2utils.escapeId(r.recid));let o=e.tagName&&"DIV"==e.tagName.toUpperCase()?$(e).text():e.value,h=$(e).data("w2field");h&&("list"==h.type&&(o=$(e).data("selected")),!$.isEmptyObject(o)&&null!=o||(o=""),$.isPlainObject(o)||(o=h.clean(o))),"checkbox"==e.type&&(r.w2ui&&!1===r.w2ui.editable&&(e.checked=!e.checked),o=e.checked);var d=this.parseField(r,n.field),u=r.w2ui&&r.w2ui.changes&&r.w2ui.changes.hasOwnProperty(n.field)?r.w2ui.changes[n.field]:d;let c={target:this.name,input_id:e.id,recid:r.recid,index:t,column:i,originalEvent:s.originalEvent||s,value_new:o,value_previous:u,value_original:d};for(null!=$(s.target).data("old_value")&&(c.value_previous=$(s.target).data("old_value"));;){if(o=c.value_new,"object"!=typeof o&&String(d)!=String(o)||"object"==typeof o&&o&&o.id!=d&&("object"!=typeof d||null==d||o.id!=d.id)){if(c=this.trigger("change",c),!0!==c.isCancelled){if(o!==c.value_new)continue;(""!==c.value_new&&null!=c.value_new||""!==u&&null!=u)&&(r.w2ui=r.w2ui??{},r.w2ui.changes=r.w2ui.changes??{},r.w2ui.changes[n.field]=c.value_new),c.finish()}}else if(c=this.trigger("restore",c),!0!==c.isCancelled){if(o!==c.value_new)continue;r.w2ui&&r.w2ui.changes&&delete r.w2ui.changes[n.field],r.w2ui&&$.isEmptyObject(r.w2ui.changes)&&delete r.w2ui.changes,c.finish()}break}let p=$(a).find("[col="+i+"]");l||(r.w2ui&&r.w2ui.changes&&null!=r.w2ui.changes[n.field]?p.addClass("w2ui-changed"):p.removeClass("w2ui-changed"),p.replaceWith(this.getCellHTML(t,i,l))),$(this.box).find("div.w2ui-edit-box").remove(),this.last.inEditMode=!1,this.updateToolbar()}delete(e){let t=this.trigger("delete",{target:this.name,force:e});if(e&&this.message(),!0!==t.isCancelled){e=t.detail.force;var i=this.getSelection();if(0!==i.length)if(""==this.msgDelete||e){if("object"!=typeof this.url?this.url:this.url.remove)this.request("delete");else if("object"!=typeof i[0])this.selectNone(),this.remove.apply(this,i);else{for(let t=0;t<i.length;t++){var s=this.columns[i[t].column].field,l=this.get(i[t].recid,!0);let e=this.records[l];null!=l&&"recid"!=s&&(this.records[l][s]="",e.w2ui&&e.w2ui.changes&&delete e.w2ui.changes[s])}this.update()}t.finish()}else this.confirm({text:w2utils.lang(this.msgDelete,{count:i.length,records:w2utils.lang(1==i.length?"record":"records")}),width:380,height:170,yes_text:"Delete",yes_class:"w2ui-btn-red",no_text:"Cancel"}).yes(e=>{e.detail.self.close(),this.delete(!0)}).no(e=>{e.detail.self.close()})}}click(n,a){var o=(new Date).getTime();let h=null;if(!(1==this.last.cancelClick||a&&a.altKey))if("object"==typeof n&&null!==n&&(h=n.column,n=n.recid),null==a&&(a={}),o-parseInt(this.last.click_time)<350&&this.last.click_recid==n&&"click"==a.type)this.dblClick(n,a);else{this.last.bubbleEl&&(this.last.bubbleEl=null),this.last.click_time=o;var d=this.last.click_recid;if(this.last.click_recid=n,null==h&&a.target){let e=a.target;"TD"!=e.tagName.toUpperCase()&&(e=$(e).parents("td")[0]),null!=$(e).attr("col")&&(h=parseInt($(e).attr("col")))}let i=this.trigger("click",{target:this.name,recid:n,column:h,originalEvent:a});if(!0!==i.isCancelled){var u=this.getSelection();$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1);o=this.get(n,!0);let s=[];this.last.sel_ind=o,this.last.sel_col=h,this.last.sel_recid=n,this.last.sel_type="click";let e,l,t,r;if(a.shiftKey&&0<u.length&&this.multiSelect){if(u[0].recid){e=this.get(u[0].recid,!0),l=this.get(n,!0),r=h>u[0].column?(t=u[0].column,h):(t=h,u[0].column);for(let e=t;e<=r;e++)s.push(e)}else e=this.get(d,!0),l=this.get(n,!0);let i=[];e>l&&(d=e,e=l,l=d);var c="object"!=typeof this.url?this.url:this.url.get;for(let t=e;t<=l;t++)if(!(0<this.searchData.length)||c||-1!=$.inArray(t,this.last.searchIds))if("row"==this.selectType)i.push(this.records[t].recid);else for(let e=0;e<s.length;e++)i.push({recid:this.records[t].recid,column:s[e]});this.select(i)}else{let e=this.last.selection,t=-1!=e.indexes.indexOf(o),i=!1;$(a.target).parents("td").hasClass("w2ui-col-select")&&(i=!0),(a.ctrlKey||a.shiftKey||a.metaKey||i)&&this.multiSelect||this.showSelectColumn?(a=$(a.target).parents("tr").find(".w2ui-grid-select-check").is(":checked"),"row"==this.selectType||-1!=$.inArray(h,e.columns[o])||a||(t=!1),!0===t?this.unselect({recid:n,column:h}):this.select({recid:n,column:h})):("row"!=this.selectType&&-1==$.inArray(h,e.columns[o])&&(t=!1),300<u.length?this.selectNone():this.unselect(u),!0===t&&1==u.length?this.unselect({recid:n,column:h}):this.select({recid:n,column:h}))}this.status(),this.initResize(),i.finish()}}}columnClick(l,i){if(!0!==this.last.colResizing){let e=this.trigger("columnClick",{target:this.name,field:l,originalEvent:i});if(!0!==e.isCancelled){if("row"==this.selectType){var t=this.getColumn(l);t&&t.sortable&&this.sort(l,null,!(!i||!i.ctrlKey&&!i.metaKey)),"line-number"==e.detail.field&&(this.getSelection().length>=this.records.length?this.selectNone():this.selectAll())}else if(!i.altKey||(r=this.getColumn(l))&&r.sortable&&this.sort(l,null,!(!i||!i.ctrlKey&&!i.metaKey)),"line-number"==e.detail.field)this.getSelection().length>=this.records.length?this.selectNone():this.selectAll();else{i.shiftKey||i.metaKey||i.ctrlKey||this.selectNone();var r=this.getSelection(),l=this.getColumn(e.detail.field,!0);let t=[],s=[];if(0!=r.length&&i.shiftKey){let t=l,i=r[0].column;t>i&&(t=r[0].column,i=l);for(let e=t;e<=i;e++)s.push(e)}else s.push(l);if(e=this.trigger("columnSelect",{target:this.name,columns:s}),!0!==e.isCancelled){for(let e=0;e<this.records.length;e++)t.push({recid:this.records[e].recid,column:s});this.select(t)}this.trigger($.extend(e,{phase:"after"}))}this.trigger($.extend(e,{phase:"after"}))}}}columnDblClick(e,t){t=this.trigger({phase:"before",type:"columnDblClick",target:this.name,field:e,originalEvent:t});!0!==t.isCancelled&&this.trigger($.extend(t,{phase:"after"}))}focus(e){e=this.trigger({phase:"before",type:"focus",target:this.name,originalEvent:e});if(!0===e.isCancelled)return!1;this.hasFocus=!0,$(this.box).removeClass("w2ui-inactive").find(".w2ui-inactive").removeClass("w2ui-inactive"),setTimeout(()=>{let e=$(this.box).find("#grid_"+this.name+"_focus");e.is(":focus")||e.focus()},10),this.trigger($.extend(e,{phase:"after"}))}blur(e){e=this.trigger({phase:"before",type:"blur",target:this.name,originalEvent:e});if(!0===e.isCancelled)return!1;this.hasFocus=!1,$(this.box).addClass("w2ui-inactive").find(".w2ui-selected").addClass("w2ui-inactive"),$(this.box).find(".w2ui-selection").addClass("w2ui-inactive"),this.trigger($.extend(e,{phase:"after"}))}keydown(p){let f=this,m="object"!=typeof this.url?this.url:this.url.get;if(!0===f.keyboard){var g=f.trigger({phase:"before",type:"keydown",target:f.name,originalEvent:p});if(!0!==g.isCancelled)if(0<$(this.box).find(">.w2ui-message").length)27==p.keyCode&&this.message();else{let t=!1,i=$(f.box).find("#grid_"+f.name+"_records"),r=f.getSelection();0===r.length&&(t=!0);let s=r[0]||null,n=[],l=r[r.length-1];if("object"==typeof s&&null!=s){s=r[0].recid,n=[];let e=0;for(;;){if(!r[e]||r[e].recid!=s)break;n.push(r[e].column),e++}l=r[r.length-1].recid}let a=f.get(s,!0),o=f.get(l,!0),h=$(f.box).find(`#grid_${f.name}_rec_${null!=a?w2utils.escapeId(f.records[a].recid):"none"}`);var w=Math.floor($(f.box).find(`#grid_${f.name}_records`).height()/f.recordHeight);let d=!1,e=p.keyCode,u=p.shiftKey;switch(e){case 8:case 46:f.delete(),d=!0,p.stopPropagation();break;case 27:f.selectNone(),d=!0;break;case 65:if(!p.metaKey&&!p.ctrlKey)break;f.selectAll(),d=!0;break;case 13:if("row"==this.selectType&&!0===f.show.expandColumn){if(h.length<=0)break;f.toggle(s,p),d=!0}else{for(let e=0;e<this.columns.length;e++)if(this.getCellEditable(a,e)){n.push(parseInt(e));break}"row"==this.selectType&&this.last._edit&&this.last._edit.column&&(n=[this.last._edit.column]),0<n.length&&(f.editField(s,n[0],null,p),d=!0)}break;case 37:!function(){if(t)v();else{if("row"==f.selectType){if(h.length<=0)return;var e=f.records[a].w2ui||{};!e||null==e.parent_recid||Array.isArray(e.children)&&0!==e.children.length&&e.expanded?f.collapse(s,p):(f.unselect(s),f.collapse(e.parent_recid,p),f.select(e.parent_recid))}else{let l=f.prevCell(a,n[0]);if(l=l.index!=a?null:l.colIndex,u||null!=l||(f.selectNone(),l=0),null!=l)if(u&&f.multiSelect){if(x())return;let t=[],i=[],s=[];if(0===n.indexOf(f.last.sel_col)&&1<n.length){for(let e=0;e<r.length;e++)-1==t.indexOf(r[e].recid)&&t.push(r[e].recid),s.push({recid:r[e].recid,column:n[n.length-1]});f.unselect(s),f.scrollIntoView(a,n[n.length-1],!0)}else{for(let e=0;e<r.length;e++)-1==t.indexOf(r[e].recid)&&t.push(r[e].recid),i.push({recid:r[e].recid,column:l});f.select(i),f.scrollIntoView(a,l,!0)}}else p.metaKey=!1,f.click({recid:s,column:l},p),f.scrollIntoView(a,l,!0);else if(!u)if(1<r.length)f.selectNone();else for(let e=1;e<r.length;e++)f.unselect(r[e])}d=!0}}();break;case 39:!function(){if(t)v();else{if("row"==f.selectType){if(h.length<=0)return;f.expand(s,p)}else{let l=f.nextCell(a,n[n.length-1]);if(l=l.index!=a?null:l.colIndex,u||null!=l||(f.selectNone(),l=f.columns.length-1),null!=l)if(u&&39==e&&f.multiSelect){if(x())return;let t=[],i=[],s=[];if(n.indexOf(f.last.sel_col)==n.length-1&&1<n.length){for(let e=0;e<r.length;e++)-1==t.indexOf(r[e].recid)&&t.push(r[e].recid),s.push({recid:r[e].recid,column:n[0]});f.unselect(s),f.scrollIntoView(a,n[0],!0)}else{for(let e=0;e<r.length;e++)-1==t.indexOf(r[e].recid)&&t.push(r[e].recid),i.push({recid:r[e].recid,column:l});f.select(i),f.scrollIntoView(a,l,!0)}}else p.metaKey=!1,f.click({recid:s,column:l},p),f.scrollIntoView(a,l,!0);else if(!u)if(1<r.length)f.selectNone();else for(let e=0;e<r.length-1;e++)f.unselect(r[e])}d=!0}}();break;case 33:y(w);break;case 34:b(w);break;case 35:b(-1);break;case 36:y(-1);break;case 38:y(p.metaKey||p.ctrlKey?-1:1);break;case 40:b(p.metaKey||p.ctrlKey?-1:1);break;case 17:case 91:if(t)break;w2utils.isSafari&&(f.last.copy_event=f.copy(!1,p),$(f.box).find("#grid_"+f.name+"_focus").val(f.last.copy_event.text).select());break;case 67:(p.metaKey||p.ctrlKey)&&(w2utils.isSafari||(f.last.copy_event=f.copy(!1,p),$(f.box).find("#grid_"+f.name+"_focus").val(f.last.copy_event.text).select()),f.copy(f.last.copy_event,p));break;case 88:if(t)break;(p.ctrlKey||p.metaKey)&&(w2utils.isSafari||(f.last.copy_event=f.copy(!1,p),$(f.box).find("#grid_"+f.name+"_focus").val(f.last.copy_event.text).select()),f.copy(f.last.copy_event,p))}let c=[32,187,189,192,219,220,221,186,222,188,190,191];for(let e=48;e<=111;e++)c.push(e);function y(e){if(t&&v(),!(h.length<=0)){let i=f.prevRow(a,"row"==f.selectType?0:r[0].column,e);if(u||null!=i||(i=0==f.searchData.length||m?0:f.last.searchIds[0]),null!=i){if(u&&f.multiSelect){if(x())return;if("row"==f.selectType)f.last.sel_ind>i&&f.last.sel_ind!=o?f.unselect(f.records[o].recid):f.select(f.records[i].recid);else if(f.last.sel_ind>i&&f.last.sel_ind!=o){i=o;let t=[];for(let e=0;e<n.length;e++)t.push({recid:f.records[i].recid,column:n[e]});f.unselect(t)}else{let t=[];for(let e=0;e<n.length;e++)t.push({recid:f.records[i].recid,column:n[e]});f.select(t)}}else 300<r.length?f.selectNone():f.unselect(r),f.click({recid:f.records[i].recid,column:n[0]},p);f.scrollIntoView(i,null,!1,1!=e),p.preventDefault&&p.preventDefault()}else if(!u)if(1<r.length)f.selectNone();else for(let e=1;e<r.length;e++)f.unselect(r[e])}}function b(e){if(t&&v(),!(h.length<=0)){let i=f.nextRow(o,"row"==f.selectType?0:r[0].column,e);if(u||null!=i||(i=0==f.searchData.length||m?f.records.length-1:f.last.searchIds[f.last.searchIds.length-1]),null!=i){if(u&&f.multiSelect){if(x())return;if("row"==f.selectType)f.last.sel_ind<i&&f.last.sel_ind!=a?f.unselect(f.records[a].recid):f.select(f.records[i].recid);else if(f.last.sel_ind<i&&f.last.sel_ind!=a){i=a;let t=[];for(let e=0;e<n.length;e++)t.push({recid:f.records[i].recid,column:n[e]});f.unselect(t)}else{let t=[];for(let e=0;e<n.length;e++)t.push({recid:f.records[i].recid,column:n[e]});f.select(t)}}else 300<r.length?f.selectNone():f.unselect(r),f.click({recid:f.records[i].recid,column:n[0]},p);f.scrollIntoView(i,null,!1,1!=e),d=!0}else if(!u)if(1<r.length)f.selectNone();else for(let e=0;e<r.length-1;e++)f.unselect(r[e])}}function v(){if(f.records&&0!==f.records.length){let e=Math.floor(i[0].scrollTop/f.recordHeight)+1;(!f.records[e]||e<2)&&(e=0),void 0!==f.records[e]&&f.select({recid:f.records[e].recid,column:0})}}function x(){if("click"==f.last.sel_type){if("row"==f.selectType)return f.last.sel_type="key",1<r.length&&(r.splice(r.indexOf(f.records[f.last.sel_ind].recid),1),f.unselect(r),1);if(f.last.sel_type="key",1<r.length){for(let e=0;e<r.length;e++)if(r[e].recid==f.last.sel_recid&&r[e].column==f.last.sel_col){r.splice(e,1);break}return f.unselect(r),1}}}-1==c.indexOf(e)||p.ctrlKey||p.metaKey||d||(0===n.length&&n.push(0),d=!1,setTimeout(()=>{let e=$(f.box).find("#grid_"+f.name+"_focus");var t=e.val();e.val(""),f.editField(s,n[0],t,p)},1)),d&&p.preventDefault&&p.preventDefault(),f.trigger($.extend(g,{phase:"after"}))}}}scrollIntoView(s,l,r,t){let i=this.records.length;if(0==this.searchData.length||this.url||(i=this.last.searchIds.length),0!==i){if(null==s){var n=this.getSelection();if(0===n.length)return;$.isPlainObject(n[0])?(s=n[0].index,l=n[0].column):s=this.get(n[0],!0)}let e=$(this.box).find("#grid_"+this.name+"_records");var a=this.last.searchIds.length;if(0<a&&(s=this.last.searchIds.indexOf(s)),e.height()<this.recordHeight*(0<a?a:i)&&0<e.length&&(a=(n=Math.floor(e[0].scrollTop/this.recordHeight))+Math.floor(e.height()/this.recordHeight),s==n&&(!0===r?e.prop({scrollTop:e.scrollTop()-e.height()/1.3}):(e.stop(),e.animate({scrollTop:e.scrollTop()-e.height()/1.3},250,"linear"))),s==a&&(!0===r?e.prop({scrollTop:e.scrollTop()+e.height()/1.3}):(e.stop(),e.animate({scrollTop:e.scrollTop()+e.height()/1.3},250,"linear"))),(s<n||a<s)&&(!0===r?e.prop({scrollTop:(s-1)*this.recordHeight}):(e.stop(),e.animate({scrollTop:(s-1)*this.recordHeight},250,"linear"))),!0===t&&(!0===r?e.prop({scrollTop:s*this.recordHeight}):(e.stop(),e.animate({scrollTop:s*this.recordHeight},250,"linear")))),null!=l){let t=0,i=0;s=w2utils.scrollBarSize();for(let e=0;e<=l;e++){var o=this.columns[e];o.frozen||o.hidden||(t=i,i+=parseInt(o.sizeCalculated))}e.width()<i-e.scrollLeft()?!0===r?e.prop({scrollLeft:t-s}):e.animate({scrollLeft:t-s},250,"linear"):t<e.scrollLeft()&&(!0===r?e.prop({scrollLeft:i-e.width()+2*s}):e.animate({scrollLeft:i-e.width()+2*s},250,"linear"))}}}scrollToColumn(s){if(null!=s){let t=0,i=!1;for(let e=0;e<this.columns.length;e++){var l=this.columns[e];if(l.field==s){i=!0;break}l.frozen||l.hidden||(l=parseInt(l.sizeCalculated||l.size),t+=l)}i&&(this.last.scrollLeft=t+1,this.scroll())}}dblClick(e,t){let i=null;if("object"==typeof e&&null!==e&&(i=e.column,e=e.recid),null==t&&(t={}),null==i&&t.target){let e=t.target;"TD"!=e.tagName.toUpperCase()&&(e=$(e).parents("td")[0]),i=parseInt($(e).attr("col"))}var s=this.get(e,!0),l=this.records[s],r=this.trigger({phase:"before",target:this.name,type:"dblClick",recid:e,column:i,originalEvent:t});!0!==r.isCancelled&&(this.selectNone(),this.getCellEditable(s,i)?this.editField(e,i,null,t):(this.select({recid:e,column:i}),(this.show.expandColumn||l&&l.w2ui&&Array.isArray(l.w2ui.children))&&this.toggle(e)),this.trigger($.extend(r,{phase:"after"})))}contextMenu(s,l,r){if("text"!=this.last.userSelect){null==(r=null==r?{offsetX:0,offsetY:0,target:query(this.box).find(`#grid_${this.name}_rec_${s}`)[0]}:r).offsetX&&(r.offsetX=r.layerX-r.target.offsetLeft,r.offsetY=r.layerY-r.target.offsetTop),w2utils.isFloat(s)&&(s=parseFloat(s));let i=this.getSelection();if("row"==this.selectType)-1==i.indexOf(s)&&this.click(s);else{let e=query(r.target);"TD"!=e[0].tagName.toUpperCase()&&(e=query(r.target).closest("td"));let t=!1;l=e.attr("col");for(let e=0;e<i.length;e++)i[e].recid!=s&&i[e].column!=l||(t=!0);t||null==s||this.click({recid:s,column:l}),t||null==l||this.columnClick(this.columns[l].field,r)}let e=this.trigger("contextMenu",{target:this.name,originalEvent:r,recid:s,column:l});!0!==e.isCancelled&&(0<this.menu.length&&w2menu.show({name:this.name+"-context-menu",anchor:document.body,originalEvent:r.originalEvent,items:this.menu}).select(e=>{this.menuClick(s,e)}),r.preventDefault&&r.preventDefault(),e.finish())}}menuClick(e,t){t=this.trigger("menuClick",{target:this.name,recid:e,originalEvent:t.detail.originalEvent,menuEvent:t,menuIndex:t.detail.index,menuItem:t.detail.item});!0!==t.isCancelled&&this.trigger($.extend(t,{phase:"after"}))}toggle(e){let t=this.get(e);if(null!=t)return t.w2ui=t.w2ui||{},!0===t.w2ui.expanded?this.collapse(e):this.expand(e)}expand(i,s){var e=this.get(i,!0);let l=this.records[e];l.w2ui=l.w2ui||{};var r=w2utils.escapeId(i);let t=l.w2ui.children,n;if(Array.isArray(t)){if(!0===l.w2ui.expanded||0===t.length)return!1;if(n=this.trigger({phase:"before",type:"expand",target:this.name,recid:i}),!0===n.isCancelled)return!1;l.w2ui.expanded=!0,t.forEach(e=>{e.w2ui=e.w2ui||{},e.w2ui.parent_recid=l.recid,null==e.w2ui.children&&(e.w2ui.children=[])}),this.records.splice.apply(this.records,[e+1,0].concat(t)),-1!==this.total&&(this.total+=t.length),("object"!=typeof this.url?this.url:this.url.get)||(this.localSort(!0,!0),0<this.searchData.length&&this.localSearch(!0)),!0!==s&&this.refresh(),this.trigger($.extend(n,{phase:"after"}))}else{if(0<$(this.box).find("#grid_"+this.name+"_rec_"+r+"_expanded_row").length||!0!==this.show.expandColumn)return!1;if("none"==l.w2ui.expanded)return!1;if($(this.box).find("#grid_"+this.name+"_rec_"+r).after('<tr id="grid_'+this.name+"_rec_"+i+'_expanded_row" class="w2ui-expanded-row">    <td colspan="100" class="w2ui-expanded2">        <div id="grid_'+this.name+"_rec_"+i+'_expanded"></div>    </td>    <td class="w2ui-grid-data-last"></td></tr>'),$(this.box).find("#grid_"+this.name+"_frec_"+r).after('<tr id="grid_'+this.name+"_frec_"+i+'_expanded_row" class="w2ui-expanded-row">'+(this.show.lineNumbers?'<td class="w2ui-col-number"></td>':"")+'    <td class="w2ui-grid-data w2ui-expanded1" colspan="100">       <div id="grid_'+this.name+"_frec_"+i+'_expanded"></div>   </td></tr>'),n=this.trigger({phase:"before",type:"expand",target:this.name,recid:i,box_id:"grid_"+this.name+"_rec_"+i+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+r+"_expanded"}),!0===n.isCancelled)return $(this.box).find("#grid_"+this.name+"_rec_"+r+"_expanded_row").remove(),$(this.box).find("#grid_"+this.name+"_frec_"+r+"_expanded_row").remove(),!1;let e=$(this.box).find("#grid_"+this.name+"_rec_"+i+"_expanded"),t=$(this.box).find("#grid_"+this.name+"_frec_"+i+"_expanded");s=e.find("> div:first-child").height();e.height()<s&&e.css({height:s+"px"}),t.height()<s&&t.css({height:s+"px"}),$(this.box).find("#grid_"+this.name+"_rec_"+r).attr("expanded","yes").addClass("w2ui-expanded"),$(this.box).find("#grid_"+this.name+"_frec_"+r).attr("expanded","yes").addClass("w2ui-expanded"),$(this.box).find("#grid_"+this.name+"_cell_"+this.get(i,!0)+"_expand div").html("-"),l.w2ui.expanded=!0,this.trigger($.extend(n,{phase:"after"})),this.resizeRecords()}return!0}collapse(i,s){var l=this.get(i,!0);let r=this.records[l];r.w2ui=r.w2ui||{};let e=w2utils.escapeId(i);var t=r.w2ui.children;let n;if(Array.isArray(t)){if(!0!==r.w2ui.expanded)return!1;if(n=this.trigger({phase:"before",type:"collapse",target:this.name,recid:i}),!0===n.isCancelled)return!1;!function i(s){s.w2ui.expanded=!1;for(let t=0;t<s.w2ui.children.length;t++){let e=s.w2ui.children[t];e.w2ui.expanded&&i(e)}}(r);let t=[];for(let e=r;null!=e;e=this.get(e.w2ui.parent_recid))t.push(e.w2ui.parent_recid);l=l+1;let e=l;for(;;){if(this.records.length<=e+1||null==this.records[e+1].w2ui||0<=t.indexOf(this.records[e+1].w2ui.parent_recid))break;e++}this.records.splice(l,e-l+1),-1!==this.total&&(this.total-=e-l+1),("object"!=typeof this.url?this.url:this.url.get)||0<this.searchData.length&&this.localSearch(!0),!0!==s&&this.refresh(),this.trigger($.extend(n,{phase:"after"}))}else{if(0===$(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded_row").length||!0!==this.show.expandColumn)return!1;if(n=this.trigger({phase:"before",type:"collapse",target:this.name,recid:i,box_id:"grid_"+this.name+"_rec_"+e+"_expanded",fbox_id:"grid_"+this.name+"_frec_"+e+"_expanded"}),!0===n.isCancelled)return!1;$(this.box).find("#grid_"+this.name+"_rec_"+e).removeAttr("expanded").removeClass("w2ui-expanded"),$(this.box).find("#grid_"+this.name+"_frec_"+e).removeAttr("expanded").removeClass("w2ui-expanded"),$(this.box).find("#grid_"+this.name+"_cell_"+this.get(i,!0)+"_expand div").html("+"),$(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded").css("height","0px"),$(this.box).find("#grid_"+this.name+"_frec_"+e+"_expanded").css("height","0px"),setTimeout(()=>{$(this.box).find("#grid_"+this.name+"_rec_"+e+"_expanded_row").remove(),$(this.box).find("#grid_"+this.name+"_frec_"+e+"_expanded_row").remove(),r.w2ui.expanded=!1,this.trigger($.extend(n,{phase:"after"})),this.resizeRecords()},300)}return!0}sort(i,e,s){var t=this.trigger({phase:"before",type:"sort",target:this.name,field:i,direction:e,multiField:s});if(!0!==t.isCancelled){if(null!=i){let t=this.sortData.length;for(let e=0;e<this.sortData.length;e++)if(this.sortData[e].field==i){t=e;break}null==e&&(e=null==this.sortData[t]?"asc":(null==this.sortData[t].direction&&(this.sortData[t].direction=""),"asc"===this.sortData[t].direction.toLowerCase()?"desc":"asc")),!1===this.multiSort&&(this.sortData=[],t=0),1!=s&&(this.sortData=[],t=0),null==this.sortData[t]&&(this.sortData[t]={}),this.sortData[t].field=i,this.sortData[t].direction=e}else this.sortData=[];("object"!=typeof this.url?this.url:this.url.get)?(this.trigger($.extend(t,{phase:"after",direction:e})),this.last.xhr_offset=0,this.reload()):(this.localSort(!1,!0),0<this.searchData.length&&this.localSearch(!0),this.last.scrollTop=0,$(this.box).find("#grid_"+this.name+"_records").prop("scrollTop",0),this.trigger($.extend(t,{phase:"after",direction:e})),this.refresh())}}copy(e,t){if($.isPlainObject(e))return this.trigger($.extend(e,{phase:"after"})),e.text;var l=this.getSelection();if(0===l.length)return"";let r="";if("object"==typeof l[0]){let t=l[0].column,i=l[0].column,s=[];for(let e=0;e<l.length;e++)l[e].column<t&&(t=l[e].column),l[e].column>i&&(i=l[e].column),-1==s.indexOf(l[e].index)&&s.push(l[e].index);s.sort((e,t)=>e-t);for(let e=0;e<s.length;e++){var n=s[e];for(let e=t;e<=i;e++)!0!==this.columns[e].hidden&&(r+=this.getCellCopy(n,e)+"\t");r=r.substr(0,r.length-1),r+="\n"}}else{for(let e=0;e<this.columns.length;e++){var i=this.columns[e];if(!0!==i.hidden){let e=i.text||i.field;i.text&&i.text.length<3&&i.tooltip&&(e=i.tooltip),r+='"'+w2utils.stripTags(e)+'"\t'}}r=r.substr(0,r.length-1),r+="\n";for(let e=0;e<l.length;e++){var s=this.get(l[e],!0);for(let e=0;e<this.columns.length;e++)!0!==this.columns[e].hidden&&(r+='"'+this.getCellCopy(s,e)+'"\t');r=r.substr(0,r.length-1),r+="\n"}}r=r.substr(0,r.length-1);let a;return null==e?(a=this.trigger({phase:"before",type:"copy",target:this.name,text:r,cut:88==t.keyCode,originalEvent:t}),!0===a.isCancelled?"":(r=a.detail.text,this.trigger($.extend(a,{phase:"after"})),r)):!1===e?(a=this.trigger({phase:"before",type:"copy",target:this.name,text:r,cut:88==t.keyCode,originalEvent:t}),!0===a.isCancelled?"":(r=a.detail.text,a)):void 0}getCellCopy(e,t){return w2utils.stripTags(this.getCellHTML(e,t))}paste(l,e){var t=this.getSelection();let r=this.get(t[0].recid,!0);var n,a,o,h=t[0].column,e=this.trigger({phase:"before",type:"paste",target:this.name,text:l,index:r,column:h,originalEvent:e});if(!0!==e.isCancelled){if(l=e.detail.text,"row"==this.selectType||0===t.length)return console.log("ERROR: You can paste only if grid.selectType = 'cell' and when at least one cell selected."),void this.trigger($.extend(e,{phase:"after"}));if("object"!=typeof l){let s=[];l=l.split("\n");for(let e=0;e<l.length;e++){var d=l[e].split("\t");let t=0;var u=this.records[r];let i=[];if(null!=u){for(let e=0;e<d.length;e++)this.columns[h+t]&&(n=u,a=this.columns[h+t].field,o=d[e],n.w2ui=n.w2ui||{},n.w2ui.changes=n.w2ui.changes||{},n.w2ui.changes[a]=o,i.push(h+t),t++);for(let e=0;e<i.length;e++)s.push({recid:u.recid,column:i[e]});r++}}this.selectNone(),this.select(s)}else this.selectNone(),this.select([{recid:this.records[r],column:h}]);this.refresh(),this.trigger($.extend(e,{phase:"after"}))}}resize(){var e=(new Date).getTime();if(this.box&&$(this.box).attr("name")==this.name){$(this.box).find("> div.w2ui-grid-box").css("width",$(this.box).width()).css("height",$(this.box).height());var t=this.trigger({phase:"before",type:"resize",target:this.name});if(!0!==t.isCancelled)return this.resizeBoxes(),this.resizeRecords(),this.trigger($.extend(t,{phase:"after"})),(new Date).getTime()-e}}update({cells:t,fullCellRefresh:i,ignoreColumns:l}={}){var e=(new Date).getTime();let d=this;if(null==this.box)return 0;if(Array.isArray(t))for(let e=0;e<t.length;e++){var s=t[e].index,r=t[e].column;if(!(s<0))if(null!=s&&null!=r){let e=this.records[s]??{};e.w2ui=e.w2ui??{},e.w2ui._update=e.w2ui._update??{cells:[]};let t=e.w2ui._update.row1,i=e.w2ui._update.row2;null!=t&&t.isConnected&&null!=i&&i.isColSelected||(t=this.box.querySelector(`#grid_${this.name}_rec_${w2utils.escapeId(e.recid)}`),i=this.box.querySelector(`#grid_${this.name}_frec_${w2utils.escapeId(e.recid)}`),e.w2ui._update.row1=t,e.w2ui._update.row2=i),n(e,t,i,s,r)}else console.log("ERROR: Wrong argument for grid.update({ cells }), cells should be [{ index: X, column: Y }, ...]")}else for(let e=this.last.range_start-1;e<=this.last.range_end;e++){let s=e;s=0<this.last.searchIds.length?this.last.searchIds[e]:e;let l=this.records[s];if(!(s<0||null==l)){l.w2ui=l.w2ui??{},l.w2ui._update=l.w2ui._update??{cells:[]};let t=l.w2ui._update.row1,i=l.w2ui._update.row2;null!=t&&t.isConnected&&null!=i&&i.isColSelected||(t=this.box.querySelector(`#grid_${this.name}_rec_${w2utils.escapeId(l.recid)}`),i=this.box.querySelector(`#grid_${this.name}_frec_${w2utils.escapeId(l.recid)}`),l.w2ui._update.row1=t,l.w2ui._update.row2=i);for(let e=0;e<this.columns.length;e++)n(l,t,i,s,e)}}return(new Date).getTime()-e;function n(e,s,r,n,a){var o=d.columns[a];if(!Array.isArray(l)||!l.includes(a)&&!l.includes(o.field)){let l=e.w2ui._update.cells[a];if(null!=l&&l.isConnected||(l=d.box.querySelector(`#grid_${d.name}_data_${n}_${a}`),e.w2ui._update.cells[a]=l),null!=l){if(i)$(l).replaceWith(d.getCellHTML(n,a,!1)),l=d.box.querySelector(`#grid_${d.name}_data_${n}_${a}`),e.w2ui._update.cells[a]=l;else{let e=l.children[0],{value:t,style:i,className:s}=d.getCellValue(n,a,!1,!0);if(e.innerHTML!=t&&(e.innerHTML=t),""!=i&&l.style.cssText!=i&&(l.style.cssText=i),""!=s){let t=["w2ui-grid-data"],i=[];n=s.split(" ").filter(e=>!!e);l.classList.forEach(e=>{t.includes(e)||i.push(e)}),l.classList.remove(...i),l.classList.add(...n)}}if(d.columns[a].style&&d.columns[a].style!=l.style.cssText&&(l.style.cssText=d.columns[a].style??""),null!=e.w2ui.class){if("string"==typeof e.w2ui.class){let t=["w2ui-odd","w2ui-even","w2ui-record"],i=[];var h=e.w2ui.class.split(" ").filter(e=>!!e);s&&r&&(s.classList.forEach(e=>{t.includes(e)||i.push(e)}),s.classList.remove(...i),s.classList.add(...h),r.classList.remove(...i),r.classList.add(...h))}if($.isPlainObject(e.w2ui.class)&&"string"==typeof e.w2ui.class[o.field]){let t=["w2ui-grid-data"],i=[];h=e.w2ui.class[o.field].split(" ").filter(e=>!!e);l.classList.forEach(e=>{t.includes(e)||i.push(e)}),l.classList.remove(...i),l.classList.add(...h)}}null!=e.w2ui.style&&(s&&r&&"string"==typeof e.w2ui.style&&s.style.cssText!==e.w2ui.style&&(s.style.cssText="height: "+d.recordHeight+"px;"+e.w2ui.style,s.setAttribute("custom_style",e.w2ui.style),r.style.cssText="height: "+d.recordHeight+"px;"+e.w2ui.style,r.setAttribute("custom_style",e.w2ui.style)),$.isPlainObject(e.w2ui.style)&&"string"==typeof e.w2ui.style[o.field]&&l.style.cssText!==e.w2ui.style[o.field]&&(l.style.cssText=e.w2ui.style[o.field]))}}}}refreshCell(e,t){var i=this.get(e,!0),t=this.getColumn(t,!0),e=!this.records[i]||this.records[i].recid!=e;let s=$(this.box).find((e?".w2ui-grid-summary ":"")+"#grid_"+this.name+"_data_"+i+"_"+t);if(0==s.length)return!1;s.replaceWith(this.getCellHTML(i,t,e))}refreshRow(t,i){let s=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t)),l=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t));if(0<s.length){null==i&&(i=this.get(t,!0));var r=s.attr("line"),n=!this.records[i]||this.records[i].recid!=t,a="object"!=typeof this.url?this.url:this.url.get;if(0<this.searchData.length&&!a)for(let e=0;e<this.last.searchIds.length;e++)this.last.searchIds[e]==i&&(i=e);r=this.getRecordHTML(i,r,n);$(s).replaceWith(r[0]),$(l).replaceWith(r[1]);let e=this.records[i].w2ui?this.records[i].w2ui.style:"";"string"==typeof e&&(s=$(this.box).find("#grid_"+this.name+"_frec_"+w2utils.escapeId(t)),l=$(this.box).find("#grid_"+this.name+"_rec_"+w2utils.escapeId(t)),s.attr("custom_style",e),l.attr("custom_style",e),s.hasClass("w2ui-selected")&&(e=e.replace("background-color","none")),s[0].style.cssText="height: "+this.recordHeight+"px;"+e,l[0].style.cssText="height: "+this.recordHeight+"px;"+e),n&&this.resize()}}refresh(){var e=(new Date).getTime(),t="object"!=typeof this.url?this.url:this.url.get;if(this.total<=0&&!t&&0===this.searchData.length&&(this.total=this.records.length),this.box){var s=this.trigger({phase:"before",target:this.name,type:"refresh"});if(!0!==s.isCancelled){this.show.header?$(this.box).find("#grid_"+this.name+"_header").html(w2utils.lang(this.header)+"&#160;").show():$(this.box).find("#grid_"+this.name+"_header").hide(),this.show.toolbar?$(this.box).find("#grid_"+this.name+"_toolbar").show():$(this.box).find("#grid_"+this.name+"_toolbar").hide(),this.searchClose();let i=$(this.box).find("#grid_"+this.name+"_search_all");!this.multiSearch&&"all"==this.last.field&&0<this.searches.length&&(this.last.field=this.searches[0].field,this.last.label=this.searches[0].label);for(let e=0;e<this.searches.length;e++)this.searches[e].field==this.last.field&&(this.last.label=this.searches[e].label);if(this.last.multi?(i.attr("placeholder","["+w2utils.lang("Multiple Fields")+"]"),$.fn.w2field&&i.w2field("clear")):i.attr("placeholder",w2utils.lang("Search")+" "+w2utils.lang(this.last.label,!0)),i.val()!=this.last.search){let e=this.last.search,t=i.data("w2field");t&&(e=t.format(e)),i.val(e)}this.refreshSearch(),this.refreshBody(),this.show.footer?$(this.box).find("#grid_"+this.name+"_footer").html(this.getFooterHTML()).show():$(this.box).find("#grid_"+this.name+"_footer").hide();var l=this.last.selection,t=0<this.records.length&&l.indexes.length==this.records.length,l=0<l.indexes.length&&0!==this.searchData.length&&l.indexes.length==this.last.searchIds.length;t||l?$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!0):$(this.box).find("#grid_"+this.name+"_check_all").prop("checked",!1),this.status();var r=this.find({"w2ui.expanded":!0},!0,!0);for(let t=0;t<r.length;t++){let e=this.records[r[t]].w2ui;e&&!Array.isArray(e.children)&&(e.expanded=!1)}return this.markSearch&&setTimeout(()=>{let t=[];for(let e=0;e<this.searchData.length;e++){var i=this.searchData[e],s=this.getSearch(i.field);s&&!s.hidden&&(s=this.getColumn(i.field,!0),t.push({field:i.field,search:i.value,col:s}))}0<t.length&&t.forEach(e=>{$(this.box).find('td[col="'+e.col+'"]').not(".w2ui-head").w2marker(e.search)})},50),this.updateToolbar(),this.trigger($.extend(s,{phase:"after"})),this.resize(),this.addRange("selection"),setTimeout(()=>{this.resize(),this.scroll()},1),this.reorderColumns&&!this.last.columnDrag?this.last.columnDrag=this.initColumnDrag():!this.reorderColumns&&this.last.columnDrag&&this.last.columnDrag.remove(),(new Date).getTime()-e}}}refreshSearch(){if(this.multiSearch&&0<this.searchData.length){0==$(this.box).find(".w2ui-grid-searches").length&&$(this.box).find(".w2ui-grid-toolbar").css("height",this.last._toolbar_height+35+"px").append(`<div id="grid_${this.name}_searches" class="w2ui-grid-searches"></div>`);let r=`
                <span id="grid_${this.name}_search_logic" class="w2ui-grid-search-logic"></span>
                <div class="grid-search-line"></div>`;this.searchData.forEach((i,e)=>{var t=this.getSearch(i.field,!0),s=this.searches[t];let l;if(l=Array.isArray(i.value)?`<span class="grid-search-count">${i.value.length}</span>`:`: ${i.value}`,s&&"date"==s.type)if("between"==i.operator){let e=i.value[0],t=i.value[1];Number(e)===e&&(e=w2utils.formatDate(e)),Number(t)===t&&(t=w2utils.formatDate(t)),l=`: ${e} - ${t}`}else{let e=i.value;Number(e)==e&&(e=w2utils.formatDate(e));let t=i.operator;"more"==t&&(t="since"),"less"==t&&(t="before"),"more:"==t.substr(0,5)&&(t="since"),l=`: ${t} ${e}`}r+=`<span class="w2ui-action" data-click="searchFieldDrop|${t}|${e}|this">
                    ${s?s.label:""}
                    ${l}
                    <span class="icon-chevron-down"></span>
                </span>`}),r+=`
                ${this.show.searchSave?`<div class="grid-search-line"></div>
                       <button class="w2ui-btn grid-search-btn" data-click="searchSave">${w2utils.lang("Save")}</button>
                      `:""}
                <button class="w2ui-btn grid-search-btn btn-remove"
                    data-click="searchReset">X</button>
            `,$(this.box).find(`#grid_${this.name}_searches`).html(r),$(this.box).find(`#grid_${this.name}_search_logic`).html(w2utils.lang("AND"==this.last.logic?"All":"Any"))}else $(this.box).find(".w2ui-grid-toolbar").css("height",this.last._toolbar_height).find(".w2ui-grid-searches").remove();this.searchSelected?($(this.box).find(`#grid_${this.name}_search_all`).val(" ").prop("readOnly",!0),$(this.box).find(`#grid_${this.name}_search_name`).show().find(".name-text").html(this.searchSelected.name)):($(this.box).find(`#grid_${this.name}_search_all`).prop("readOnly",!1),$(this.box).find(`#grid_${this.name}_search_name`).hide().find(".name-text").html("")),w2utils.bindEvents($(this.box).find(`#grid_${this.name}_searches .w2ui-action, #grid_${this.name}_searches button`),this)}refreshBody(){this.scroll();var e=this.getRecordsHTML(),t=this.getColumnsHTML(),t='<div id="grid_'+this.name+'_frecords" class="w2ui-grid-frecords" style="margin-bottom: '+(w2utils.scrollBarSize()-1)+'px;">'+e[0]+'</div><div id="grid_'+this.name+'_records" class="w2ui-grid-records" onscroll="w2ui[\''+this.name+"'].scroll(event);\">"+e[1]+'</div><div id="grid_'+this.name+'_scroll1" class="w2ui-grid-scroll1" style="height: '+w2utils.scrollBarSize()+'px"></div><div id="grid_'+this.name+'_fcolumns" class="w2ui-grid-fcolumns">    <table><tbody>'+t[0]+'</tbody></table></div><div id="grid_'+this.name+'_columns" class="w2ui-grid-columns">    <table><tbody>'+t[1]+"</tbody></table></div>";let n=$(this.box).find("#grid_"+this.name+"_body",this.box).html(t),a=$(this.box).find("#grid_"+this.name+"_records",this.box),i=$(this.box).find("#grid_"+this.name+"_frecords",this.box),o=this;"row"==this.selectType&&(a.on("mouseover mouseout","tr",function(e){$(o.box).find("#grid_"+o.name+"_frec_"+w2utils.escapeId($(this).attr("recid"))).toggleClass("w2ui-record-hover","mouseover"==e.type)}),i.on("mouseover mouseout","tr",function(e){$(o.box).find("#grid_"+o.name+"_rec_"+w2utils.escapeId($(this).attr("recid"))).toggleClass("w2ui-record-hover","mouseover"==e.type)})),w2utils.isIOS?a.add(i).on("click","tr",function(e){o.dblClick($(this).attr("recid"),e)}):a.add(i).on("click","tr",function(e){o.click($(this).attr("recid"),e)}).on("contextmenu","tr",function(e){o.contextMenu($(this).attr("recid"),null,e)}),n.data("scrolldata",{lastTime:0,lastDelta:0,time:0}).find(".w2ui-grid-frecords").on("mousewheel DOMMouseScroll ",function(e){e.preventDefault();let t=e.originalEvent,i=n.data("scrolldata"),s=$(this).siblings(".w2ui-grid-records").addBack().filter(".w2ui-grid-records"),l=null!=typeof t.wheelDelta?-1*t.wheelDelta/120:(t.detail||t.deltaY)/3,r=s.scrollTop();i.time=+new Date,i.lastTime<i.time-150&&(i.lastDelta=0),i.lastTime=i.time,i.lastDelta+=l,l=Math.abs(i.lastDelta)<1?0:Math.round(i.lastDelta),n.data("scrolldata",i),l*=(Math.round(a.height()/o.recordHeight)-1)*o.recordHeight/4,s.stop().animate({scrollTop:r+l},250,"linear")}),0===this.records.length&&this.msgEmpty?$(this.box).find("#grid_"+this.name+"_body").append('<div id="grid_'+this.name+'_empty_msg" class="w2ui-grid-empty-msg"><div>'+this.msgEmpty+"</div></div>"):0<$(this.box).find("#grid_"+this.name+"_empty_msg").length&&$(this.box).find("#grid_"+this.name+"_empty_msg").remove(),0<this.summary.length?(t=this.getSummaryHTML(),$(this.box).find("#grid_"+this.name+"_fsummary").html(t[0]).show(),$(this.box).find("#grid_"+this.name+"_summary").html(t[1]).show()):($(this.box).find("#grid_"+this.name+"_fsummary").hide(),$(this.box).find("#grid_"+this.name+"_summary").hide())}render(e){let c=this;var i=(new Date).getTime();if(null!=e&&(0<$(this.box).find("#grid_"+this.name+"_body").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-grid w2ui-inactive").html(""),this.box=e),this.box){var s="object"!=typeof this.url?this.url:this.url.get,e=this.trigger({phase:"before",target:this.name,type:"render",box:e});if(!0!==e.isCancelled){if(this.reset(!0),!this.last.field)if(this.multiSearch&&this.show.searchAll)this.last.field="all",this.last.label="All Fields";else{let e=0;for(;e<this.searches.length&&(this.searches[e].hidden||!1===this.searches[e].simple);)e++;e>=this.searches.length?(this.last.field="",this.last.label=""):(this.last.field=this.searches[e].field,this.last.label=this.searches[e].label)}if($(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-grid w2ui-inactive").html('<div class="w2ui-grid-box">    <div id="grid_'+this.name+'_header" class="w2ui-grid-header"></div>    <div id="grid_'+this.name+'_toolbar" class="w2ui-grid-toolbar"></div>    <div id="grid_'+this.name+'_body" class="w2ui-grid-body"></div>    <div id="grid_'+this.name+'_fsummary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_summary" class="w2ui-grid-body w2ui-grid-summary"></div>    <div id="grid_'+this.name+'_footer" class="w2ui-grid-footer"></div>    <textarea id="grid_'+this.name+'_focus" class="w2ui-grid-focus-input" '+(this.tabIndex?'tabindex="'+this.tabIndex+'"':"")+(w2utils.isIOS?"readonly":"")+"></textarea></div>"),"row"!=this.selectType&&$(this.box).addClass("w2ui-ss"),0<$(this.box).length&&($(this.box)[0].style.cssText+=this.style),this.initToolbar(),null!=this.toolbar&&this.toolbar.render($(this.box).find("#grid_"+this.name+"_toolbar")[0]),this.last._toolbar_height=$(this.box).find(`#grid_${this.name}_toolbar`).prop("offsetHeight"),this.last.field&&"all"!=this.last.field){let e=this.searchData;setTimeout(()=>{this.searchInitInput(this.last.field,1==e.length?e[0].value:null)},1)}$(this.box).find("#grid_"+this.name+"_footer").html(this.getFooterHTML()),this.last.state||(this.last.state=this.stateSave(!0)),this.stateRestore(),s&&(this.clear(),this.refresh());let t=!1;for(let e=0;e<this.searches.length;e++)if(this.searches[e].hidden){t=!0;break}t?(this.searchReset(!1),s||setTimeout(()=>{this.searchReset()},1)):this.reload(),$(this.box).find("#grid_"+this.name+"_focus").on("focus",function(e){clearTimeout(c.last.kbd_timer),c.hasFocus||c.focus()}).on("blur",function(e){clearTimeout(c.last.kbd_timer),c.last.kbd_timer=setTimeout(()=>{c.hasFocus&&c.blur()},100)}).on("paste",function(s){let l=s.originalEvent.clipboardData||null;if(l){let e=l.items;2==e.length&&(2==e.length&&"file"==e[1].kind&&(e=[e[1]]),2==e.length&&"text/plain"==e[0].type&&"text/html"==e[1].type&&(e=[e[1]]));let i=[];for(var r in e){let t=e[r];if("file"===t.kind){r=t.getAsFile();i.push({kind:"file",data:r})}else if("string"===t.kind&&("text/plain"===t.type||"text/html"===t.type)){s.preventDefault();let e=l.getData("text/plain");-1!=e.indexOf("\r")&&-1==e.indexOf("\n")&&(e=e.replace(/\r/g,"\n")),i.push({kind:"text/html"==t.type?"html":"text",data:e})}}1===i.length&&"file"!=i[0].kind&&(i=i[0].data),w2ui[c.name].paste(i,s.originalEvent),s.preventDefault()}}).on("keydown",function(e){w2ui[c.name].keydown.call(w2ui[c.name],e)});let u;return $(this.box).off("mousedown.mouseStart").on("mousedown.mouseStart",function(r){if(1==r.which&&("text"==c.last.userSelect&&(c.last.userSelect="",$(c.box).find(".w2ui-grid-body").css(w2utils.cssPrefix("user-select","none"))),!("row"==c.selectType&&($(r.target).parents().hasClass("w2ui-head")||$(r.target).hasClass("w2ui-head"))||c.last.move&&"expand"==c.last.move.type))){if(r.altKey)$(c.box).find(".w2ui-grid-body").css(w2utils.cssPrefix("user-select","text")),c.selectNone(),c.last.move={type:"text-select"},c.last.userSelect="text";else{let e=r.target,t={x:r.offsetX-10,y:r.offsetY-10},i=!1;for(;e&&(!e.classList||!e.classList.contains("w2ui-grid"));)e.tagName&&"TD"==e.tagName.toUpperCase()&&(i=!0),e.tagName&&"TR"!=e.tagName.toUpperCase()&&1==i&&(t.x+=e.offsetLeft,t.y+=e.offsetTop),e=e.parentNode;c.last.move={x:r.screenX,y:r.screenY,divX:0,divY:0,focusX:t.x,focusY:t.y,recid:$(r.target).parents("tr").attr("recid"),column:parseInt(("TD"==r.target.tagName.toUpperCase()?$(r.target):$(r.target).parents("td")).attr("col")),type:"select",ghost:!1,start:!0},null==c.last.move.recid&&(c.last.move.type="select-column");let s=r.target,l=$(c.box).find("#grid_"+c.name+"_focus");if(c.last.move){let e=c.last.move.focusX,t=c.last.move.focusY,i=$(s).parents("table").parent();(i.hasClass("w2ui-grid-records")||i.hasClass("w2ui-grid-frecords")||i.hasClass("w2ui-grid-columns")||i.hasClass("w2ui-grid-fcolumns")||i.hasClass("w2ui-grid-summary"))&&(e=c.last.move.focusX-$(c.box).find("#grid_"+c.name+"_records").scrollLeft(),t=c.last.move.focusY-$(c.box).find("#grid_"+c.name+"_records").scrollTop()),($(s).hasClass("w2ui-grid-footer")||0<$(s).parents("div.w2ui-grid-footer").length)&&(t=$(c.box).find("#grid_"+c.name+"_footer").position().top),i.hasClass("w2ui-scroll-wrapper")&&i.parent().hasClass("w2ui-toolbar")&&(e=c.last.move.focusX-i.scrollLeft()),l.css({left:e-10,top:t})}setTimeout(()=>{-1!=["INPUT","TEXTAREA","SELECT"].indexOf(s.tagName.toUpperCase())?$(s).focus():l.is(":focus")||l.focus()},50),c.multiSelect||c.reorderRows||"drag"!=c.last.move.type||delete c.last.move}if(1==c.reorderRows){let e=r.target;if("TD"!=e.tagName.toUpperCase()&&(e=$(e).parents("td")[0]),$(e).hasClass("w2ui-col-number")||$(e).hasClass("w2ui-col-order")){c.selectNone(),c.last.move.reorder=!0;var s=$(c.box).find(".w2ui-even.w2ui-empty-record").css("background-color"),l=$(c.box).find(".w2ui-odd.w2ui-empty-record").css("background-color");$(c.box).find(".w2ui-even td").not(".w2ui-col-number").css("background-color",s),$(c.box).find(".w2ui-odd td").not(".w2ui-col-number").css("background-color",l);let t=c.last.move,i=$(c.box).find(".w2ui-grid-records");if(!t.ghost){let e=$(c.box).find("#grid_"+c.name+"_rec_"+t.recid);l=e.parents("table").find("tr:first-child").clone();t.offsetY=r.offsetY,t.from=t.recid,t.pos=e.position(),t.ghost=$(e).clone(!0),t.ghost.removeAttr("id"),e.find("td").remove(),e.append('<td colspan="1000"><div style="height: '+c.recordHeight+'px; background-color: #eee; border-bottom: 1px dashed #aaa; border-top: 1px dashed #aaa;"></div></td>'),i.append('<div id="grid_'+c.name+'_ghost_line" style="position: absolute; z-index: 999999; pointer-events: none; width: 100%;"></div>'),i.append('<table id="grid_'+c.name+'_ghost" style="position: absolute; z-index: 999998; opacity: 0.9; pointer-events: none;"></table>'),$(c.box).find("#grid_"+c.name+"_ghost").append(l).append(t.ghost)}let e=$(c.box).find("#grid_"+c.name+"_ghost");e.css({top:t.pos.top,left:t.pos.left,"border-top":"1px solid #aaa","border-bottom":"1px solid #aaa"})}else c.last.move.reorder=!1}$(document).on("mousemove.w2ui-"+c.name,n).on("mouseup.w2ui-"+c.name,a),r.stopPropagation()}}),this.updateToolbar(),this.trigger($.extend(e,{phase:"after"})),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),(new Date).getTime()-i;function n(a){if(a.target.tagName){let n=c.last.move;if(n&&-1!=["select","select-column"].indexOf(n.type)&&(n.divX=a.screenX-n.x,n.divY=a.screenY-n.y,!(Math.abs(n.divX)<=1&&Math.abs(n.divY)<=1)))if(c.last.cancelClick=!0,1==c.reorderRows&&c.last.move.reorder){let e=$(a.target).parents("tr"),i=e.attr("recid");if("-none-"==i&&(i="bottom"),i!=n.from){let e=$(c.box).find("#grid_"+c.name+"_rec_"+i);$(c.box).find(".insert-before"),e.addClass("insert-before"),n.lastY=a.screenY,n.to=i;var s=e.position();let t=$(c.box).find("#grid_"+c.name+"_ghost_line");s?t.css({top:s.top,left:n.pos.left,"border-top":"2px solid #769EFC"}):t.css({"border-top":"2px solid transparent"})}let t=$(c.box).find("#grid_"+c.name+"_ghost");t.css({top:n.pos.top+n.divY,left:n.pos.left})}else{n.start&&n.recid&&(c.selectNone(),n.start=!1);let r=[];var t=("TR"==a.target.tagName.toUpperCase()?$(a.target):$(a.target).parents("tr")).attr("recid");if(null==t){if("row"!=c.selectType&&(!c.last.move||"select"!=c.last.move.type)){s=parseInt($(a.target).parents("td").attr("col"));if(isNaN(s))c.removeRange("column-selection"),$(c.box).find(".w2ui-grid-columns .w2ui-col-header, .w2ui-grid-fcolumns .w2ui-col-header").removeClass("w2ui-col-selected"),$(c.box).find(".w2ui-col-number").removeClass("w2ui-row-selected"),delete n.colRange;else{let e=s+"-"+s;n.column<s&&(e=n.column+"-"+s),n.column>s&&(e=s+"-"+n.column);let t=[];var i=e.split("-");for(let e=parseInt(i[0]);e<=parseInt(i[1]);e++)t.push(e);if(n.colRange!=e&&(u=c.trigger({phase:"before",type:"columnSelect",target:c.name,columns:t,isCancelled:!1}),!0!==u.isCancelled)){null==n.colRange&&c.selectNone();var l=e.split("-");$(c.box).find(".w2ui-grid-columns .w2ui-col-header, .w2ui-grid-fcolumns .w2ui-col-header").removeClass("w2ui-col-selected");for(let e=parseInt(l[0]);e<=parseInt(l[1]);e++)$(c.box).find("#grid_"+c.name+"_column_"+e+" .w2ui-col-header").addClass("w2ui-col-selected");$(c.box).find(".w2ui-col-number").not(".w2ui-head").addClass("w2ui-row-selected"),n.colRange=e,c.removeRange("column-selection"),c.addRange({name:"column-selection",range:[{recid:c.records[0].recid,column:l[0]},{recid:c.records[c.records.length-1].recid,column:l[1]}],style:"background-color: rgba(90, 145, 234, 0.1)"})}}}}else{let l=c.get(n.recid,!0);if(!(null==l||c.records[l]&&c.records[l].recid!=n.recid)){let e=c.get(t,!0);if(null!=e){let i=parseInt(n.column),s=parseInt(("TD"==a.target.tagName.toUpperCase()?$(a.target):$(a.target).parents("td")).attr("col"));isNaN(i)&&isNaN(s)&&(i=0,s=c.columns.length-1),l>e&&(h=l,l=e,e=h);var o,h="ind1:"+l+",ind2;"+e+",col1:"+i+",col2:"+s;if(n.range!=h){n.range=h;for(let t=l;t<=e;t++)if(!(0<c.last.searchIds.length&&-1==c.last.searchIds.indexOf(t)))if("row"!=c.selectType){i>s&&(o=i,i=s,s=o);for(let e=i;e<=s;e++)c.columns[e].hidden||r.push({recid:c.records[t].recid,column:parseInt(e)})}else r.push(c.records[t].recid);if("row"!=c.selectType){var d=c.getSelection();let e=[];for(let i=0;i<r.length;i++){let t=!1;for(let e=0;e<d.length;e++)r[i].recid==d[e].recid&&r[i].column==d[e].column&&(t=!0);t||e.push({recid:r[i].recid,column:r[i].column})}c.select(e),e=[];for(let i=0;i<d.length;i++){let t=!1;for(let e=0;e<r.length;e++)r[e].recid==d[i].recid&&r[e].column==d[i].column&&(t=!0);t||e.push({recid:d[i].recid,column:d[i].column})}c.unselect(e)}else if(c.multiSelect){let t=c.getSelection();for(let e=0;e<r.length;e++)-1==t.indexOf(r[e])&&c.select(r[e]);for(let e=0;e<t.length;e++)-1==r.indexOf(t[e])&&c.unselect(t[e])}}}}}}}}function a(t){let s=c.last.move;if(setTimeout(()=>{delete c.last.cancelClick},1),!$(t.target).parents().hasClass(".w2ui-head")&&!$(t.target).hasClass(".w2ui-head")){if(s&&-1!=["select","select-column"].indexOf(s.type)){if(null!=s.colRange&&!0!==u.isCancelled){var l=s.colRange.split("-");let i=[];for(let e=0;e<c.records.length;e++){let t=[];for(let e=parseInt(l[0]);e<=parseInt(l[1]);e++)t.push(e);i.push({recid:c.records[e].recid,column:t})}c.removeRange("column-selection"),c.trigger($.extend(u,{phase:"after"})),c.select(i)}if(1==c.reorderRows&&c.last.move.reorder)if(null!=s.to){var i=c.trigger({phase:"before",target:c.name,type:"reorderRow",recid:s.from,moveBefore:s.to});if(!0===i.isCancelled)return o(),void delete c.last.move;var r=c.get(s.from,!0);let e=c.get(s.to,!0);"bottom"==s.to&&(e=c.records.length);t=c.records[r];null!=r&&null!=e&&(c.records.splice(r,1),r>e?c.records.splice(e,0,t):c.records.splice(e-1,0,t)),o(),c.trigger($.extend(i,{phase:"after"}))}else o()}delete c.last.move,$(document).off(".w2ui-"+c.name)}}function o(){$(c.box).find("#grid_"+c.name+"_ghost").remove(),$(c.box).find("#grid_"+c.name+"_ghost_line").remove(),c.refresh(),delete c.last.move}}}}destroy(){var e=this.trigger({phase:"before",target:this.name,type:"destroy"});!0!==e.isCancelled&&($(this.box).off(),"object"==typeof this.toolbar&&this.toolbar.destroy&&this.toolbar.destroy(),0<$(this.box).find("#grid_"+this.name+"_body").length&&$(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-grid w2ui-inactive").html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],this.trigger($.extend(e,{phase:"after"})))}initColumnOnOff(){if(this.show.toolbarColumns){let i=[{id:"line-numbers",text:"Line #",checked:this.show.lineNumbers}];for(let t=0;t<this.columns.length;t++){var s=this.columns[t];let e=this.columns[t].text;!1!==s.hideable&&(!e&&this.columns[t].tooltip&&(e=this.columns[t].tooltip),e=e||"- column "+(parseInt(t)+1)+" -",i.push({id:s.field,text:w2utils.stripTags(e),checked:!s.hidden}))}var e="object"!=typeof this.url?this.url:this.url.get;(e&&this.show.skipRecords||this.show.saveRestoreState)&&i.push({text:"--"}),e&&this.show.skipRecords&&(e=`
                ${w2utils.lang("Skip")}
                <input id="${this.name}_skip" type="text" style="width: 60px" value="${his.offset}"
                    onkeydown="if ([48,49,50,51,52,53,54,55,56,57,58,13,8,46,37,39].indexOf(event.keyCode) == -1) { event.preventDefault() }"
                    onkeypress="if (event.keyCode == 13) {
                        w2ui['${this.name}'].skip(this.value);
                    }">
                ${w2utils.lang("records")}
            `,i.push({id:"",test:e,group:!1,icon:"w2ui-icon-empty"})),this.show.saveRestoreState&&i.push({id:"stateSave",text:w2utils.lang("Save Grid State"),icon:"w2ui-icon-empty",group:!1},{id:"stateReset",text:w2utils.lang("Restore Default State"),icon:"w2ui-icon-empty",group:!1});let t=[];return i.forEach(e=>{e.text=w2utils.lang(e.text),e.checked&&t.push(e.id)}),this.toolbar.set("w2ui-column-on-off",{selected:t,items:i}),i}}initColumnDrag(e){if(this.columnGroups&&this.columnGroups.length)throw"Draggable columns are not currently supported with column groups.";let o=this,h={};function t(){h.pressed=!1,clearTimeout(h.timeout)}function i(n){h.timeout&&clearTimeout(h.timeout);let a=this;h.pressed=!0,h.timeout=setTimeout(()=>{if(h.pressed&&0!==h.numberPreColumnsPresent){let e,i,t,s,l,r=["w2ui-col-number","w2ui-col-expand","w2ui-col-select"].concat(["w2ui-head-last"]);if($(n.originalEvent.target).parents().hasClass("w2ui-head")){for(let e=0,t=r.length;e<t;e++)if($(n.originalEvent.target).parents().hasClass(r[e]))return;if(h.numberPreColumnsPresent=$(o.box).find(".w2ui-head.w2ui-col-number, .w2ui-head.w2ui-col-expand, .w2ui-head.w2ui-col-select").length,h.columnHead=s=$(n.originalEvent.target).parents(".w2ui-head"),h.originalPos=l=parseInt(s.attr("col"),10),!0===(e=o.trigger({type:"columnDragStart",phase:"before",originalEvent:n,origColumnNumber:l,target:s[0]})).isCancelled)return!1;i=h.columns=$(o.box).find(".w2ui-head:not(.w2ui-head-last)"),$(document).on("mouseup",u),$(document).on("mousemove",d),h.ghost=$(a).clone(!0),$(h.ghost).find('[col]:not([col="'+h.originalPos+'"]), .w2ui-toolbar, .w2ui-grid-header').remove(),$(h.ghost).find(".w2ui-col-number, .w2ui-col-expand, .w2ui-col-select").remove(),$(h.ghost).find(".w2ui-grid-body").css({top:0}),t=$(h.ghost).find('[col="'+h.originalPos+'"]'),$(document.body).append(h.ghost),$(h.ghost).css({width:0,height:0,margin:0,position:"fixed",zIndex:999999,opacity:0}).addClass(".w2ui-grid-ghost").animate({width:t.width(),height:$(o.box).find(".w2ui-grid-body").first().height(),left:n.pageX,top:n.pageY,opacity:.8},0),h.offsets=[];for(let e=0,t=i.length;e<t;e++)h.offsets.push($(i[e]).offset().left);o.trigger($.extend(e,{phase:"after"}))}}},150)}function d(e){var t,i,s;h.pressed&&(i=e.originalEvent.pageX,s=e.originalEvent.pageY,t=h.offsets,e=$(".w2ui-head:not(.w2ui-head-last)").width(),h.targetInt=Math.max(h.numberPreColumnsPresent,function(i,s,l){{if(i<=s[0])return 0;if(i>=s[s.length-1]+l)return s.length;for(let e=0,t=s.length;e<t;e++){var r=s[e],n=s[e+1]||s[e]+l,a=(n-s[e])/2+s[e];if(r<i&&i<=a)return e;if(a<i&&i<=n)return e+1}return 0}}(i,t,e)),function(e){h.marker||h.markerLeft||(h.marker=$('<div class="col-intersection-marker"><div class="top-marker"></div><div class="bottom-marker"></div></div>'),h.markerLeft=$('<div class="col-intersection-marker"><div class="top-marker"></div><div class="bottom-marker"></div></div>'));h.lastInt&&h.lastInt===e||(h.lastInt=e,h.marker.remove(),h.markerLeft.remove(),$(".w2ui-head").removeClass("w2ui-col-intersection"),e>=h.columns.length?($(h.columns[h.columns.length-1]).children("div:last").append(h.marker.addClass("right").removeClass("left")),$(h.columns[h.columns.length-1]).addClass("w2ui-col-intersection")):e<=h.numberPreColumnsPresent?($(h.columns[h.numberPreColumnsPresent]).prepend(h.marker.addClass("left").removeClass("right")).css({position:"relative"}),$(h.columns[h.numberPreColumnsPresent]).prev().addClass("w2ui-col-intersection")):($(h.columns[e]).children("div:last").prepend(h.marker.addClass("left").removeClass("right")),$(h.columns[e]).prev().children("div:last").append(h.markerLeft.addClass("right").removeClass("left")).css({position:"relative"}),$(h.columns[e-1]).addClass("w2ui-col-intersection")))}(h.targetInt),i=i,s=s,$(h.ghost).css({left:i-10,top:s-10}))}function u(e){h.pressed=!1;let t,i,s,l,r,n=$(o.box).find(".w2ui-grid-ghost");if(!0===(t=o.trigger({type:"columnDragEnd",phase:"before",originalEvent:e,target:h.columnHead[0]})).isCancelled)return!1;s=o.columns[h.originalPos],l=o.columns,r=$(h.columns[Math.min(h.lastInt,h.columns.length-1)]),(i=h.lastInt<h.columns.length?parseInt(r.attr("col")):l.length)!==h.originalPos+1&&i!==h.originalPos&&r&&r.length?($(h.ghost).animate({top:$(o.box).offset().top,left:r.offset().left,width:0,height:0,opacity:.2},300,function(){$(this).remove(),n.remove()}),l.splice(i,0,$.extend({},s)),l.splice(l.indexOf(s),1)):($(h.ghost).remove(),n.remove()),$(document).off("mouseup",u),$(document).off("mousemove",d),h.marker&&h.marker.remove(),h={},o.refresh(),o.trigger($.extend(t,{phase:"after",targetColumnNumber:i-1}))}return h.lastInt=void 0,h.pressed=!1,h.timeout=null,h.columnHead=null,$(o.box).off("mousedown.colDrag").on("mousedown.colDrag",i),$(o.box).off("mouseup.colDrag").on("mouseup.colDrag",t),{remove(){$(o.box).off("mousedown.colDrag",i),$(o.box).off("mouseup.colDrag",t),$(o.box).find(".w2ui-head").removeAttr("draggable"),o.last.columnDrag=!1}}}columnOnOff(e,t){let i=this.trigger("columnOnOff",{target:this.name,field:t,originalEvent:e});if(!0!==i.isCancelled){var s=this.find({"w2ui.expanded":!0},!0);for(let e=0;e<s.length;e++){var l=this.records[e].w2ui;l&&!Array.isArray(l.children)&&(this.records[e].w2ui.expanded=!1)}"line-numbers"==t?(this.show.lineNumbers=!this.show.lineNumbers,this.refresh()):(t=this.getColumn(t)).hidden?this.showColumn(t.field):this.hideColumn(t.field),i.finish()}}initToolbar(){let l=this;if(null==this.toolbar.render){let t=this.toolbar.items||[];var e;if(this.toolbar.items=[],this.toolbar=new w2toolbar(w2utils.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.show.toolbarReload&&this.toolbar.items.push(w2utils.extend({},this.buttons.reload)),this.show.toolbarColumns&&this.toolbar.items.push(w2utils.extend({},this.buttons.columns)),this.show.toolbarSearch&&(e=`
                <div class="w2ui-grid-search-input">
                    ${this.buttons.search.html}
                    <div id="grid_${this.name}_search_name" class="w2ui-grid-search-name">
                        <span class="name-icon w2ui-icon-search"></span>
                        <span class="name-text"></span>
                        <span class="name-cross w2ui-action" data-click="searchReset">x</span>
                    </div>
                    <input type="text" id="grid_${this.name}_search_all" class="w2ui-search-all" tabindex="-1"
                        autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                        placeholder="${w2utils.lang(this.last.label,!0)}" value="${this.last.search}"
                        data-focus="searchSuggest" data-click="stop"
                    >
                    <div class="w2ui-search-drop w2ui-action" data-click="searchOpen"
                            style="${this.multiSearch?"":"display: none"}">
                        <span class="w2ui-icon-drop"></span>
                    </div>
                </div>`,this.toolbar.items.push({id:"w2ui-search",type:"html",html:e,onRefresh(e){e.done(()=>{let e=query(this.box).find(`#grid_${l.name}_search_all`);w2utils.bindEvents(query(this.box).find(`#grid_${l.name}_search_all, .w2ui-action`),l),e.on("change",function(e){let t=this.value;var i=jQuery(this).data("selected");let s=jQuery(this).data("w2field");s&&(t=s.clean(t)),s&&"list"==s.type&&i&&void 0===i.id?l.searchReset():l.search(l.last.field,t),l.searchSuggest(!0,!0,this)}).on("keydown",function(e){40==e.keyCode&&l.searchSuggest(!0)})})}})),Array.isArray(t)){let e=t.map(e=>e.id);this.show.toolbarAdd&&!e.includes(this.buttons.add.id)&&this.toolbar.items.push(w2utils.extend({},this.buttons.add)),this.show.toolbarEdit&&!e.includes(this.buttons.edit.id)&&this.toolbar.items.push(w2utils.extend({},this.buttons.edit)),this.show.toolbarDelete&&!e.includes(this.buttons.delete.id)&&this.toolbar.items.push(w2utils.extend({},this.buttons.delete)),this.show.toolbarSave&&!e.includes(this.buttons.save.id)&&((this.show.toolbarAdd||this.show.toolbarDelete||this.show.toolbarEdit)&&this.toolbar.items.push({type:"break",id:"w2ui-break2"}),this.toolbar.items.push(w2utils.extend({},this.buttons.save)))}this.toolbar.items.push(...t),this.toolbar.on("click",e=>{let i=this.trigger("toolbar",{target:e.target,originalEvent:e});if(!0!==i.isCancelled){let t;switch(e.detail.item.id){case"w2ui-reload":if(t=this.trigger("reload",{target:this.name}),!0===t.isCancelled)return!1;this.reload(),t.finish();break;case"w2ui-column-on-off":e.detail.subItem?(s=e.detail.subItem.id,["stateSave","stateReset"].includes(s)?this[s]():this.columnOnOff(e,e.detail.subItem.id)):(console.log(this.initColumnOnOff()),this.initResize(),this.resize());break;case"w2ui-add":if(t=this.trigger("add",{target:this.name,recid:null}),!0===t.isCancelled)return!1;t.finish();break;case"w2ui-edit":{var s=this.getSelection();let e=null;if(1==s.length&&(e=s[0]),t=this.trigger("edit",{target:this.name,recid:e}),!0===t.isCancelled)return!1;t.finish();break}case"w2ui-delete":this.delete();break;case"w2ui-save":this.save()}i.finish()}}),this.toolbar.on("refresh",e=>{if("w2ui-search"==e.target){let e=this.searchData;setTimeout(()=>{this.searchInitInput(this.last.field,1==e.length?e[0].value:null)},1)}})}}initResize(){let r=this;$(this.box).find(".w2ui-resizer").off(".grid-col-resize").on("click.grid-col-resize",function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault()}).on("mousedown.grid-col-resize",function(e){e=e||window.event,r.last.colResizing=!0,r.last.tmp={x:e.screenX,y:e.screenY,gx:e.screenX,gy:e.screenY,col:parseInt($(this).attr("name"))},r.last.tmp.tds=$(r.box).find("#grid_"+r.name+"_body table tr:first-child td[col="+r.last.tmp.col+"]"),e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault();for(let e=0;e<r.columns.length;e++)r.columns[e].hidden||(null==r.columns[e].sizeOriginal&&(r.columns[e].sizeOriginal=r.columns[e].size),r.columns[e].size=r.columns[e].sizeCalculated);let i={phase:"before",type:"columnResize",target:r.name,column:r.last.tmp.col,field:r.columns[r.last.tmp.col].field};i=r.trigger($.extend(i,{resizeBy:0,originalEvent:e}));let s;$(document).off(".grid-col-resize").on("mousemove.grid-col-resize",function(e){var t;1==r.last.colResizing&&(e=e||window.event,i=r.trigger($.extend(i,{resizeBy:e.screenX-r.last.tmp.gx,originalEvent:e})),!0!==i.isCancelled?(r.last.tmp.x=e.screenX-r.last.tmp.x,r.last.tmp.y=e.screenY-r.last.tmp.y,t=parseInt(r.columns[r.last.tmp.col].size)+r.last.tmp.x+"px",r.columns[r.last.tmp.col].size=t,s&&clearTimeout(s),s=setTimeout(()=>{r.resizeRecords(),r.scroll()},100),r.last.tmp.tds.css({width:t}),r.last.tmp.x=e.screenX,r.last.tmp.y=e.screenY):i.isCancelled=!1)}).on("mouseup.grid-col-resize",function(e){$(document).off(".grid-col-resize"),r.resizeRecords(),r.scroll(),r.trigger($.extend(i,{phase:"after",originalEvent:e})),setTimeout(()=>{r.last.colResizing=!1},1)})}).on("dblclick.grid-col-resize",function(e){let t=parseInt($(this).attr("name")),i=r.columns[t],s=0;if(!1===i.autoResize)return!0;e.stopPropagation?e.stopPropagation():e.cancelBubble=!0,e.preventDefault&&e.preventDefault(),$(r.box).find('.w2ui-grid-records td[col="'+t+'"] > div',r.box).each(()=>{var e=this.offsetWidth-this.scrollWidth;e<s&&(s=e-3)});let l={phase:"before",type:"columnAutoResize",target:r.name,column:i,field:i.field};l=r.trigger($.extend(l,{resizeBy:Math.abs(s),originalEvent:e})),!0!==l.isCancelled?(s<0&&(i.size=Math.min(parseInt(i.size)+Math.abs(s),i.max||1/0)+"px",r.resizeRecords(),r.resizeRecords(),r.scroll()),r.trigger($.extend(l,{phase:"after",originalEvent:e}))):l.isCancelled=!1}).each((e,t)=>{let i=$(t).parent();$(t).css({height:i.height(),"margin-left":i.width()-3+"px"})})}resizeBoxes(){let e=$(this.box).find("#grid_"+this.name+"_header"),t=$(this.box).find("#grid_"+this.name+"_toolbar"),i=$(this.box).find("#grid_"+this.name+"_fsummary"),s=$(this.box).find("#grid_"+this.name+"_summary"),l=$(this.box).find("#grid_"+this.name+"_footer"),r=$(this.box).find("#grid_"+this.name+"_body");this.show.header&&e.css({top:"0px",left:"0px",right:"0px"}),this.show.toolbar&&t.css({top:0+(this.show.header?w2utils.getSize(e,"height"):0)+"px",left:"0px",right:"0px"}),0<this.summary.length&&(i.css({bottom:0+(this.show.footer?w2utils.getSize(l,"height"):0)+"px"}),s.css({bottom:0+(this.show.footer?w2utils.getSize(l,"height"):0)+"px",right:"0px"})),this.show.footer&&l.css({bottom:"0px",left:"0px",right:"0px"}),r.css({top:0+(this.show.header?w2utils.getSize(e,"height"):0)+(this.show.toolbar?w2utils.getSize(t,"height"):0)+"px",bottom:0+(this.show.footer?w2utils.getSize(l,"height"):0)+(0<this.summary.length?w2utils.getSize(s,"height"):0)+"px",left:"0px",right:"0px"})}resizeRecords(){let s=this;$(this.box).find(".w2ui-empty-record").remove();let e=$(this.box),t=$(this.box).find("> div.w2ui-grid-box");var i=$(this.box).find("#grid_"+this.name+"_header"),l=$(this.box).find("#grid_"+this.name+"_toolbar");let r=$(this.box).find("#grid_"+this.name+"_summary"),n=$(this.box).find("#grid_"+this.name+"_fsummary");var a,o,h=$(this.box).find("#grid_"+this.name+"_footer");let d=$(this.box).find("#grid_"+this.name+"_body"),u=$(this.box).find("#grid_"+this.name+"_columns"),c=$(this.box).find("#grid_"+this.name+"_fcolumns"),p=$(this.box).find("#grid_"+this.name+"_records"),f=$(this.box).find("#grid_"+this.name+"_frecords"),m=$(this.box).find("#grid_"+this.name+"_scroll1"),g=8*String(this.total).length+10;g<34&&(g=34),null!=this.lineNumberWidth&&(g=this.lineNumberWidth);let w=!1,y=!1,b=0;for(let e=0;e<this.columns.length;e++)this.columns[e].frozen||this.columns[e].hidden||(a=parseInt(this.columns[e].sizeCalculated||this.columns[e].size),b+=a);p.width()<b&&(w=!0),d.height()-u.height()<$(p).find(">table").height()+(w?w2utils.scrollBarSize():0)&&(y=!0),this.fixedBody?(o=t.height()-(this.show.header?w2utils.getSize(i,"height"):0)-(this.show.toolbar?w2utils.getSize(l,"height"):0)-("none"!=r.css("display")?w2utils.getSize(r,"height"):0)-(this.show.footer?w2utils.getSize(h,"height"):0),d.css("height",o)):(x=w2utils.getSize(u,"height")+w2utils.getSize($(this.box).find("#grid_"+this.name+"_records table"),"height")+(w?w2utils.scrollBarSize():0),this.height=x+(this.show.header?w2utils.getSize(i,"height"):0)+(this.show.toolbar?w2utils.getSize(l,"height"):0)+("none"!=r.css("display")?w2utils.getSize(r,"height"):0)+(this.show.footer?w2utils.getSize(h,"height"):0),t.css("height",this.height),d.css("height",x),e.css("height",w2utils.getSize(t,"height")));let v=this.records.length;var x="object"!=typeof this.url?this.url:this.url.get;if(0==this.searchData.length||x||(v=this.last.searchIds.length),this.fixedBody||(y=!1),w||y?(u.find("> table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",w2utils.scrollBarSize()).show(),p.css({top:(0<this.columnGroups.length&&this.show.columns?1:0)+w2utils.getSize(u,"height")+"px","-webkit-overflow-scrolling":"touch","overflow-x":w?"auto":"hidden","overflow-y":y?"auto":"hidden"})):(u.find("> table > tbody > tr:nth-child(1) td.w2ui-head-last").hide(),p.css({top:(0<this.columnGroups.length&&this.show.columns?1:0)+w2utils.getSize(u,"height")+"px",overflow:"hidden"}),0<p.length&&(this.last.scrollTop=0,this.last.scrollLeft=0)),w?(f.css("margin-bottom",w2utils.scrollBarSize()),m.show()):(f.css("margin-bottom",0),m.hide()),f.css({overflow:"hidden",top:p.css("top")}),this.show.emptyRecords&&!y){let t=Math.floor(p.height()/this.recordHeight)-1,e=0;if(p[0]&&(e=p[0].scrollHeight-t*this.recordHeight),e>=this.recordHeight&&(e-=this.recordHeight,t++),this.fixedBody){for(let e=v;e<t;e++)_(e,this.recordHeight,this);_(t,e,this)}}function _(e,t,i){let s="",l="";var r;s+='<tr class="'+(e%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+t+'px">',l+='<tr class="'+(e%2?"w2ui-even":"w2ui-odd")+' w2ui-empty-record" recid="-none-" style="height: '+t+'px">',i.show.lineNumbers&&(s+='<td class="w2ui-col-number"></td>'),i.show.selectColumn&&(s+='<td class="w2ui-grid-data w2ui-col-select"></td>'),i.show.expandColumn&&(s+='<td class="w2ui-grid-data w2ui-col-expand"></td>'),l+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',i.show.orderColumn&&(l+='<td class="w2ui-grid-data w2ui-col-order" col="order"></td>');for(let e=0;e<i.columns.length;e++){var n=i.columns[e];(n.hidden||e<i.last.colStart||e>i.last.colEnd)&&!n.frozen||(r='<td class="w2ui-grid-data" '+(null!=n.attr?n.attr:"")+' col="'+e+'"></td>',n.frozen?s+=r:l+=r)}s+='<td class="w2ui-grid-data-last"></td> </tr>',l+='<td class="w2ui-grid-data-last" col="end"></td> </tr>',$(i.box).find("#grid_"+i.name+"_frecords > table").append(s),$(i.box).find("#grid_"+i.name+"_records > table").append(l)}let C,k;if(0<d.length){let i=parseInt(d.width())-(y?w2utils.scrollBarSize():0)-(this.show.lineNumbers?g:0)-(this.show.selectColumn?26:0)-(this.show.expandColumn?26:0)-1;C=i;let s=!1;for(let t=k=0;t<this.columns.length;t++){let e=this.columns[t];0<e.gridMinWidth&&(e.gridMinWidth>C&&!0!==e.hidden&&(e.hidden=!0,s=!0),e.gridMinWidth<C&&!0===e.hidden&&(e.hidden=!1,s=!0))}if(!0===s)return void this.refresh();for(let t=0;t<this.columns.length;t++){let e=this.columns[t];e.hidden||("px"==String(e.size).substr(String(e.size).length-2).toLowerCase()?(i-=parseFloat(e.size),this.columns[t].sizeCalculated=e.size,this.columns[t].sizeType="px"):(k+=parseFloat(e.size),this.columns[t].sizeType="%",delete e.sizeCorrected))}if(100!=k&&0<k)for(let t=0;t<this.columns.length;t++){let e=this.columns[t];e.hidden||"%"==e.sizeType&&(e.sizeCorrected=Math.round(100*parseFloat(e.size)*100/k)/100+"%")}for(let e=0;e<this.columns.length;e++){var T=this.columns[e];T.hidden||"%"==T.sizeType&&(null!=this.columns[e].sizeCorrected?this.columns[e].sizeCalculated=Math.floor(i*parseFloat(T.sizeCorrected)/100)-1+"px":this.columns[e].sizeCalculated=Math.floor(i*parseFloat(T.size)/100)-1+"px")}}let S=0;for(let t=0;t<this.columns.length;t++){let e=this.columns[t];e.hidden||(null==e.min&&(e.min=20),parseInt(e.sizeCalculated)<parseInt(e.min)&&(e.sizeCalculated=e.min+"px"),parseInt(e.sizeCalculated)>parseInt(e.max)&&(e.sizeCalculated=e.max+"px"),S+=parseInt(e.sizeCalculated))}let q=parseInt(C)-parseInt(S);if(0<q&&0<k){let t=0;for(;;){let e=this.columns[t];if(null!=e)if(e.hidden||"px"==e.sizeType)t++;else{if(e.sizeCalculated=parseInt(e.sizeCalculated)+1+"px",q--,0===q)break;t++}else t=0}}else 0<q&&u.find("> table > tbody > tr:nth-child(1) td.w2ui-head-last").css("width",w2utils.scrollBarSize()).show();let E=1;this.show.lineNumbers&&(E+=g),this.show.selectColumn&&(E+=26),this.show.expandColumn&&(E+=26);for(let e=0;e<this.columns.length;e++)this.columns[e].hidden||this.columns[e].frozen&&(E+=parseInt(this.columns[e].sizeCalculated));c.css("width",E),f.css("width",E),n.css("width",E),m.css("width",E),u.css("left",E),p.css("left",E),r.css("left",E),u.find("> table > tbody > tr:nth-child(1) td").add(c.find("> table > tbody > tr:nth-child(1) td")).each((e,i)=>{$(i).hasClass("w2ui-col-number")&&$(i).css("width",g);var t=$(i).attr("col");if(null!=t){if("start"==t){let t=0;for(let e=0;e<s.last.colStart;e++)!s.columns[e]||s.columns[e].frozen||s.columns[e].hidden||(t+=parseInt(s.columns[e].sizeCalculated));$(i).css("width",t+"px")}s.columns[t]&&$(i).css("width",s.columns[t].sizeCalculated)}if($(i).hasClass("w2ui-head-last"))if(s.last.colEnd+1<s.columns.length){let t=0;for(let e=s.last.colEnd+1;e<s.columns.length;e++)!s.columns[e]||s.columns[e].frozen||s.columns[e].hidden||(t+=parseInt(s.columns[e].sizeCalculated));$(i).css("width",t+"px")}else $(i).css("width",w2utils.scrollBarSize()+(0<q&&0===k?q:0)+"px")}),3==u.find("> table > tbody > tr").length&&u.find("> table > tbody > tr:nth-child(1) td").add(c.find("> table > tbody > tr:nth-child(1) td")).html("").css({height:"0px",border:"0px",padding:"0px",margin:"0px"}),p.find("> table > tbody > tr:nth-child(1) td").add(f.find("> table > tbody > tr:nth-child(1) td")).each((e,i)=>{$(i).hasClass("w2ui-col-number")&&$(i).css("width",g);var t=$(i).attr("col");if(null!=t){if("start"==t){let t=0;for(let e=0;e<s.last.colStart;e++)!s.columns[e]||s.columns[e].frozen||s.columns[e].hidden||(t+=parseInt(s.columns[e].sizeCalculated));$(i).css("width",t+"px")}s.columns[t]&&$(i).css("width",s.columns[t].sizeCalculated)}if($(i).hasClass("w2ui-grid-data-last")&&0===$(i).parents(".w2ui-grid-frecords").length)if(s.last.colEnd+1<s.columns.length){let t=0;for(let e=s.last.colEnd+1;e<s.columns.length;e++)!s.columns[e]||s.columns[e].frozen||s.columns[e].hidden||(t+=parseInt(s.columns[e].sizeCalculated));$(i).css("width",t+"px")}else $(i).css("width",(0<q&&0===k?q:0)+"px")}),r.find("> table > tbody > tr:nth-child(1) td").add(n.find("> table > tbody > tr:nth-child(1) td")).each((e,i)=>{$(i).hasClass("w2ui-col-number")&&$(i).css("width",g);var t=$(i).attr("col");if(null!=t){if("start"==t){let t=0;for(let e=0;e<s.last.colStart;e++)!s.columns[e]||s.columns[e].frozen||s.columns[e].hidden||(t+=parseInt(s.columns[e].sizeCalculated));$(i).css("width",t+"px")}s.columns[t]&&$(i).css("width",s.columns[t].sizeCalculated)}$(i).hasClass("w2ui-grid-data-last")&&0===$(i).parents(".w2ui-grid-frecords").length&&$(i).css("width",w2utils.scrollBarSize()+(0<q&&0===k?q:0)+"px")}),this.initResize(),this.refreshRanges(),(this.last.scrollTop||this.last.scrollLeft)&&0<p.length&&(u.prop("scrollLeft",this.last.scrollLeft),p.prop("scrollTop",this.last.scrollTop),p.prop("scrollLeft",this.last.scrollLeft))}getSearchesHTML(){let s=`
            <div class="search-title">
                ${w2utils.lang("Advanced Search")}
                <span class="search-logic" style="${this.show.searchLogic?"":"display: none"}">
                    <select id="grid_${this.name}_logic" class="w2ui-input">
                        <option value="AND" ${"AND"==this.last.logic?"selected":""}>${w2utils.lang("All")}</option>
                        <option value="OR" ${"OR"==this.last.logic?"selected":""}>${w2utils.lang("Any")}</option>
                    </select>
                </span>
            </div>
            <table cellspacing="0"><tbody>
        `;for(let i=0;i<this.searches.length;i++){let t=this.searches[i];if(t.type=String(t.type).toLowerCase(),!t.hidden){null==t.inTag&&(t.inTag=""),null==t.outTag&&(t.outTag=""),null==t.style&&(t.style=""),null==t.type&&(t.type="text"),null==t.label&&null!=t.caption&&(console.log("NOTICE: grid search.caption property is deprecated, please use search.label. Search ->",t),t.label=t.caption);var l=`<select id="grid_${this.name}_operator_${i}" class="w2ui-input" data-change="initOperator|${i}">
                    ${this.getOperators(t.type,t.operators)}
                </select>`;s+=`<tr>
                        <td class="caption">${w2utils.lang(t.label)||""}</td>
                        <td class="operator">${l}</td>
                        <td class="value">`;let e;switch(t.type){case"text":case"alphanumeric":case"hex":case"color":case"list":case"combo":case"enum":e="width: 250px;",-1!=["hex","color"].indexOf(t.type)&&(e="width: 90px;"),s+=`<input rel="search" type="text" id="grid_${this.name}_field_${i}" name="${t.field}"
                               class="w2ui-input" style="${e+t.style}" ${t.inTag}>`;break;case"int":case"float":case"money":case"currency":case"percent":case"date":case"time":case"datetime":e="width: 90px;","datetime"==t.type&&(e="width: 140px;"),s+=`<input id="grid_${this.name}_field_${i}" name="${t.field}" ${t.inTag} rel="search" type="text"
                                class="w2ui-input" style="${e+t.style}">
                            <span id="grid_${this.name}_range_${i}" style="display: none">&#160;-&#160;&#160;
                                <input rel="search" type="text" class="w2ui-input" style="${e+t.style}" id="grid_${this.name}_field2_${i}" name="${t.field}" ${t.inTag}>
                            </span>`;break;case"select":s+=`<select rel="search" class="w2ui-input" style="${t.style}" id="grid_${this.name}_field_${i}"
                                name="${t.field}" ${t.inTag}></select>`}s+=t.outTag+"    </td></tr>"}}return s+=`<tr>
            <td colspan="2" class="actions">
                <button type="button" class="w2ui-btn close-btn" data-click="searchClose">${w2utils.lang("Close")}</button>
            </td>
            <td class="actions">
                <button type="button" class="w2ui-btn" data-click="searchReset">${w2utils.lang("Reset")}</button>
                <button type="button" class="w2ui-btn w2ui-btn-blue" data-click="search">${w2utils.lang("Search")}</button>
            </td>
        </tr></tbody></table>`,s}getOperators(e,t){let i=this.operators[this.operatorsMap[e]]||[];null!=t&&Array.isArray(t)&&(i=t);let s="";return i.forEach(e=>{let t=e;Array.isArray(e)?(t=e[1],e=e[0],null==t&&(t=e)):$.isPlainObject(e)&&(t=e.text,e=e.oper),s+=`<option value="${e}">${w2utils.lang(t)}</option>\n`}),s}initOperator(e){let i;var t=this.searches[e],s=this.getSearchData(t.field);let l=$(this.box).find(`#grid_${this.name}_range_${e}`),r=$(this.box).find(`#grid_${this.name}_field_${e}`),n=$(this.box).find(`#grid_${this.name}_field2_${e}`),a=$(this.box).find(`#grid_${this.name}_operator_${e}`);var o,h=a.val();switch(r.show(),l.hide(),h){case"between":l.show(),$.fn.w2field&&n.w2field(t.type,t.options);break;case"null":case"not null":r.hide(),r.val(h),r.trigger("change")}switch(t.type){case"text":case"alphanumeric":"in"==h||"not in"==h?(o=r.data("w2field"))&&"clear"!=o.type||(r.w2field("enum",t.options),s&&Array.isArray(s.value)&&r.data("selected",s.value)):(o=r.data("selected"),r.w2field("clear"),r.removeData("w2field"),Array.isArray(o)&&0<o.length&&o[0].text&&r.val(o[0].text));break;case"int":case"float":case"hex":case"color":case"money":case"currency":case"percent":case"date":case"time":case"datetime":$.fn.w2field&&(r.w2field(t.type,t.options),n.w2field(t.type,t.options)),setTimeout(()=>{r.keydown(),n.keydown()},1);break;case"list":case"combo":case"enum":i=t.options,"list"==t.type&&(i.selected={}),"enum"==t.type&&(i.selected=[]),s&&(i.selected=s.value),$.fn.w2field&&r.w2field(t.type,$.extend({openOnFocus:!0},i)),s&&null!=s.text&&r.data("selected",{id:s.value,text:s.text});break;case"select":i='<option value="">--</option>';for(let e=0;e<t.options.items.length;e++){var d=t.options.items[e];if($.isPlainObject(t.options.items[e])){let e=d.id,t=d.text;null==e&&null!=d.value&&(e=d.value),null==t&&null!=d.text&&(t=d.text),null==e&&(e=""),i+='<option value="'+e+'">'+t+"</option>"}else i+='<option value="'+d+'">'+d+"</option>"}r.html(i)}}initSearches(){let t=this;for(let r=0;r<this.searches.length;r++){let e=this.searches[r];var n=this.getSearchData(e.field);e.type=String(e.type).toLowerCase(),"object"!=typeof e.options&&(e.options={});let t=e.operator,i=this.operators[this.operatorsMap[e.type]]||[];e.operators&&(i=e.operators),$.isPlainObject(t)&&(t=t.oper),i.forEach((e,t)=>{$.isPlainObject(e)&&(i[t]=e.oper)}),n&&n.operator&&(t=n.operator);var a=this.defaultOperator[this.operatorsMap[e.type]];-1==i.indexOf(t)&&(t=a),$(this.box).find(`#grid_${this.name}_operator_${r}`).val(t),this.initOperator(r);let s=$(this.box).find(`#grid_${this.name}_field_${r}`),l=$(this.box).find(`#grid_${this.name}_field2_${r}`);null!=n&&("int"==n.type&&-1!=["in","not in"].indexOf(n.operator)&&s.w2field("clear").val(n.value),Array.isArray(n.value)?-1!=["in","not in"].indexOf(n.operator)?s.val(n.value).trigger("change"):(s.val(n.value[0]).trigger("change"),l.val(n.value[1]).trigger("change")):null!=n.value&&s.val(n.value).trigger("change"))}$(this.box).find(`#w2overlay-${this.name}-search-overlay .w2ui-grid-search-advanced *[rel=search]`).on("keypress",function(e){13==e.keyCode&&(t.search(),w2tooltip.hide(t.name+"-search-overlay"))})}getColumnsHTML(){let h=this,e="",t="";var i,s,l;return this.show.columnHeaders&&(t=0<this.columnGroups.length?(i=r(!0),s=function(){let l="<tr>",r="<tr>",n="",e=h.columnGroups.length-1;null==h.columnGroups[e].text&&null!=h.columnGroups[e].caption&&(console.log("NOTICE: grid columnGroup.caption property is deprecated, please use columnGroup.text. Group -> ",h.columnGroups[e]),h.columnGroups[e].text=h.columnGroups[e].caption);""!=h.columnGroups[h.columnGroups.length-1].text&&h.columnGroups.push({text:""});h.show.lineNumbers&&(l+='<td class="w2ui-head w2ui-col-number">    <div>&#160;</div></td>');h.show.selectColumn&&(l+='<td class="w2ui-head w2ui-col-select">    <div style="height: 25px">&#160;</div></td>');h.show.expandColumn&&(l+='<td class="w2ui-head w2ui-col-expand">    <div style="height: 25px">&#160;</div></td>');let a=0;r+='<td id="grid_'+h.name+'_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>',h.show.orderColumn&&(r+='<td class="w2ui-head w2ui-col-order" col="order">    <div style="height: 25px">&#160;</div></td>');for(let e=0;e<h.columnGroups.length;e++){let t=h.columnGroups[e],i=h.columns[a]||{};null!=t.colspan&&(t.span=t.colspan),null!=t.span&&t.span==parseInt(t.span)||(t.span=1),null==i.text&&null!=i.caption&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column ->",i),i.text=i.caption);let s=0;for(let e=a;e<a+t.span;e++)h.columns[e]&&!h.columns[e].hidden&&s++;if(e==h.columnGroups.length-1&&(s=100),!(s<=0))if(!0===t.main){let t="";for(let e=0;e<h.sortData.length;e++)h.sortData[e].field==i.field&&("asc"===(h.sortData[e].direction||"").toLowerCase()&&(t="w2ui-sort-up"),"desc"===(h.sortData[e].direction||"").toLowerCase()&&(t="w2ui-sort-down"));let e="";!1!==i.resizable&&(e='<div class="w2ui-resizer" name="'+a+'"></div>');var o=w2utils.lang("function"==typeof i.text?i.text(i):i.text);n='<td id="grid_'+h.name+"_column_"+a+'" class="w2ui-head '+t+'" col="'+a+'"     rowspan="2" colspan="'+s+'"     oncontextmenu = "w2ui[\''+h.name+"'].contextMenu(null, "+a+', event);"    onclick="w2ui[\''+h.name+"'].columnClick('"+i.field+"', event);\"    ondblclick=\"w2ui['"+h.name+"'].columnDblClick('"+i.field+"', event);\">"+e+'    <div class="w2ui-col-group w2ui-col-header '+(t?"w2ui-col-sorted":"")+'">        <div class="'+t+'"></div>'+(o||"&#160;")+"    </div></td>",i&&i.frozen?l+=n:r+=n}else{o=w2utils.lang("function"==typeof t.text?t.text(t):t.text);n='<td id="grid_'+h.name+"_column_"+a+'" class="w2ui-head" col="'+a+'"         colspan="'+s+'">    <div class="w2ui-col-group">'+(o||"&#160;")+"    </div></td>",i&&i.frozen?l+=n:r+=n}a+=t.span}return l+="<td></td></tr>",r+='<td id="grid_'+h.name+'_column_end" class="w2ui-head" col="end"></td></tr>',[l,r]}(),l=r(!1),e=i[0]+s[0]+l[0],i[1]+s[1]+l[1]):(l=r(!0),e=l[0],l[1])),[e,t];function r(i){let s="<tr>",l="<tr>";h.show.lineNumbers&&(s+='<td class="w2ui-head w2ui-col-number"        onclick="w2ui[\''+h.name+"'].columnClick('line-number', event);\"       ondblclick=\"w2ui['"+h.name+"'].columnDblClick('line-number', event);\">    <div>#</div></td>"),h.show.selectColumn&&(s+='<td class="w2ui-head w2ui-col-select"       onclick="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;">    <div>        <input type="checkbox" id="grid_'+h.name+'_check_all" tabindex="-1"            style="'+(0==h.multiSelect?"display: none;":"")+'"            onmousedown="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;"            onclick="let grid = w2ui[\''+h.name+"'];               if (this.checked) grid.selectAll(); else grid.selectNone();               if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;               clearTimeout(grid.last.kbd_timer); /* keep focus */            \"/>    </div></td>"),h.show.expandColumn&&(s+='<td class="w2ui-head w2ui-col-expand">    <div>&#160;</div></td>');let r=0,n=0,a;l+='<td id="grid_'+h.name+'_column_start" class="w2ui-head" col="start" style="border-right: 0"></td>',h.show.orderColumn&&(l+='<td class="w2ui-head w2ui-col-order" col="order">    <div>&#160;</div></td>');for(let t=0;t<h.columns.length;t++){let e=h.columns[t];var o;null==e.text&&null!=e.caption&&(console.log("NOTICE: grid column.caption property is deprecated, please use column.text. Column -> ",e),e.text=e.caption),null==e.size&&(e.size="100%"),t==n&&(a=h.columnGroups[r++]||{},n+=a.span),(t<h.last.colStart||t>h.last.colEnd)&&!e.frozen||e.hidden||!0===a.main&&!i||(o=h.getColumnCellHTML(t),e&&e.frozen?s+=o:l+=o)}return s+='<td class="w2ui-head w2ui-head-last"><div>&#160;</div></td>',l+='<td class="w2ui-head w2ui-head-last" col="end"><div>&#160;</div></td>',s+="</tr>",l+="</tr>",[s,l]}}getColumnCellHTML(t){let i=this.columns[t];if(null==i)return"";var e=!this.reorderColumns||this.columnGroups&&this.columnGroups.length?"":" w2ui-reorder-cols-head ";let s="";for(let e=0;e<this.sortData.length;e++)this.sortData[e].field==i.field&&("asc"===(this.sortData[e].direction||"").toLowerCase()&&(s="w2ui-sort-up"),"desc"===(this.sortData[e].direction||"").toLowerCase()&&(s="w2ui-sort-down"));var l,r=this.last.selection.columns;let n=!1;for(l in r)for(let e=0;e<r[l].length;e++)r[l][e]==t&&(n=!0);var a=w2utils.lang("function"==typeof i.text?i.text(i):i.text);w2utils.lang("function"==typeof i.tooltip?i.tooltip(i):i.tooltip);return'<td id="grid_'+this.name+"_column_"+t+'" col="'+t+'" class="w2ui-head '+s+e+'"     onmouseEnter = "w2ui[\''+this.name+"'].columnTooltipShow('"+t+"', event);\"    onmouseLeave  = \"w2ui['"+this.name+"'].columnTooltipHide('"+t+"', event);\"    oncontextmenu = \"w2ui['"+this.name+"'].contextMenu(null, "+t+', event);"    onclick="w2ui[\''+this.name+"'].columnClick('"+i.field+"', event);\"    ondblclick=\"w2ui['"+this.name+"'].columnDblClick('"+i.field+"', event);\">"+(!1!==i.resizable?'<div class="w2ui-resizer" name="'+t+'"></div>':"")+'    <div class="w2ui-col-header '+(s?"w2ui-col-sorted":"")+" "+(n?"w2ui-col-selected":"")+'">        <div class="'+s+'"></div>'+(a||"&#160;")+"    </div></td>"}columnTooltipShow(e,t){let i=query(this.box).find("#grid_"+this.name+"_column_"+e);var s=this.columns[e],e=this.columnTooltip;w2tooltip.show({name:this.name+"-column-tooltip",anchor:i.get(0),html:s.tooltip,position:e})}columnTooltipHide(e,t){w2tooltip.hide(this.name+"-column-tooltip")}getRecordsHTML(){let e=this.records.length;var t="object"!=typeof this.url?this.url:this.url.get;0==this.searchData.length||t||(e=this.last.searchIds.length),e>this.vs_start?this.last.show_extra=this.vs_extra:this.last.show_extra=this.vs_start;let i=$(this.box).find("#grid_"+this.name+"_records"),s=Math.floor((i.height()||0)/this.recordHeight)+this.last.show_extra+1;(!this.fixedBody||s>e)&&(s=e);var l=this.getRecordHTML(-1,0);let r="<table><tbody>"+l[0],n="<table><tbody>"+l[1];r+='<tr id="grid_'+this.name+'_frec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>',n+='<tr id="grid_'+this.name+'_rec_top" line="top" style="height: 0px">    <td colspan="2000"></td></tr>';for(let e=0;e<s;e++)l=this.getRecordHTML(e,e+1),r+=l[0],n+=l[1];t=(e-s)*this.recordHeight;return r+='<tr id="grid_'+this.name+'_frec_bottom" rec="bottom" line="bottom" style="height: '+t+'px; vertical-align: top">    <td colspan="2000" style="border-right: 1px solid #D6D5D7;"></td></tr><tr id="grid_'+this.name+'_frec_more" style="display: none; ">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',n+='<tr id="grid_'+this.name+'_rec_bottom" rec="bottom" line="bottom" style="height: '+t+'px; vertical-align: top">    <td colspan="2000" style="border: 0"></td></tr><tr id="grid_'+this.name+'_rec_more" style="display: none">    <td colspan="2000" class="w2ui-load-more"></td></tr></tbody></table>',this.last.range_start=0,this.last.range_end=s,[r,n]}getSummaryHTML(){if(0!==this.summary.length){var s=this.getRecordHTML(-1,0);let t="<table><tbody>"+s[0],i="<table><tbody>"+s[1];for(let e=0;e<this.summary.length;e++)s=this.getRecordHTML(e,e+1,!0),t+=s[0],i+=s[1];return t+="</tbody></table>",i+="</tbody></table>",[t,i]}}scroll(e){let c=this;var p="object"!=typeof this.url?this.url:this.url.get;let f=$(this.box).find("#grid_"+this.name+"_records"),m=$(this.box).find("#grid_"+this.name+"_frecords");e&&(n=e.target.scrollTop,r=e.target.scrollLeft,this.last.scrollTop=n,this.last.scrollLeft=r,$(this.box).find("#grid_"+this.name+"_columns")[0].scrollLeft=r,$(this.box).find("#grid_"+this.name+"_summary")[0].scrollLeft=r,m[0].scrollTop=n),this.last.bubbleEl&&(w2tooltip.hide(this.name+"-bubble"),this.last.bubbleEl=null);let a=null,o=null;if(this.disableCVS||0<this.columnGroups.length)a=0,o=this.columns.length-1;else{var i,s=f.width();let t=0;for(let e=0;e<this.columns.length;e++)this.columns[e].frozen||this.columns[e].hidden||(i=parseInt(this.columns[e].sizeCalculated||this.columns[e].size),t+i+30>this.last.scrollLeft&&null==a&&(a=e),t+i-30>this.last.scrollLeft+s&&null==o&&(o=e),t+=i);null==o&&(o=this.columns.length-1)}if(null!=a&&(a<0&&(a=0),o<0&&(o=0),a==o&&(0<a?a--:o++),a!=this.last.colStart||o!=this.last.colEnd)){let l=$(this.box);var r=Math.abs(a-this.last.colStart),n=Math.abs(o-this.last.colEnd);if(r<5&&n<5){let e=l.find(".w2ui-grid-columns #grid_"+this.name+"_column_start"),t=l.find(".w2ui-grid-columns .w2ui-head-last"),i=l.find("#grid_"+this.name+"_records .w2ui-grid-data-spacer"),s=l.find("#grid_"+this.name+"_records .w2ui-grid-data-last"),r=l.find("#grid_"+this.name+"_summary .w2ui-grid-data-spacer"),n=l.find("#grid_"+this.name+"_summary .w2ui-grid-data-last");if(a>this.last.colStart)for(let e=this.last.colStart;e<a;e++)l.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+e).remove(),l.find("#grid_"+this.name+'_records td[col="'+e+'"]').remove(),l.find("#grid_"+this.name+'_summary td[col="'+e+'"]').remove();if(o<this.last.colEnd)for(let e=this.last.colEnd;e>o;e--)l.find("#grid_"+this.name+"_columns #grid_"+this.name+"_column_"+e).remove(),l.find("#grid_"+this.name+'_records td[col="'+e+'"]').remove(),l.find("#grid_"+this.name+'_summary td[col="'+e+'"]').remove();if(a<this.last.colStart)for(let l=this.last.colStart-1;l>=a;l--)this.columns[l]&&(this.columns[l].frozen||this.columns[l].hidden)||(e.after(this.getColumnCellHTML(l)),i.each((e,t)=>{var i=$(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+l+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),l,!1)),$(t).after(s)}),r.each((e,t)=>{var i=$(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+l+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),l,!0)),$(t).after(s)}));if(o>this.last.colEnd)for(let l=this.last.colEnd+1;l<=o;l++)this.columns[l]&&(this.columns[l].frozen||this.columns[l].hidden)||(t.before(this.getColumnCellHTML(l)),s.each((e,t)=>{var i=$(t).parent().attr("index");let s='<td class="w2ui-grid-data" col="'+l+'" style="height: 0px"></td>';null!=i&&(s=this.getCellHTML(parseInt(i),l,!1)),$(t).before(s)}),n.each((e,t)=>{var i=$(t).parent().attr("index")||-1,i=this.getCellHTML(parseInt(i),l,!0);$(t).before(i)}));this.last.colStart=a,this.last.colEnd=o,this.resizeRecords()}else{this.last.colStart=a,this.last.colEnd=o;var r=this.getColumnsHTML(),n=this.getRecordsHTML(),g=this.getSummaryHTML();let e=l.find("#grid_"+this.name+"_columns"),t=l.find("#grid_"+this.name+"_records"),i=l.find("#grid_"+this.name+"_frecords"),s=l.find("#grid_"+this.name+"_summary");e.find("tbody").html(r[1]),i.html(n[0]),t.prepend(n[1]),null!=g&&s.html(g[1]),setTimeout(()=>{t.find("> table").not("table:first-child").remove(),s[0]&&(s[0].scrollLeft=this.last.scrollLeft)},1),this.resizeRecords()}}let w=this.records.length;if(w>this.total&&-1!==this.total&&(w=this.total),0==this.searchData.length||p||(w=this.last.searchIds.length),0!==w&&0!==f.length&&0!==f.height()){w>this.vs_start?this.last.show_extra=this.vs_extra:this.last.show_extra=this.vs_start;let e=Math.round(f[0].scrollTop/this.recordHeight+1),t=e+(Math.round(f.height()/this.recordHeight)-1);if(e>w&&(e=w),t>=w-1&&(t=w),$(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-right").html((this.show.statusRange?w2utils.formatNumber(this.offset+e)+"-"+w2utils.formatNumber(this.offset+t)+(-1!=this.total?" "+w2utils.lang("of")+" "+w2utils.formatNumber(this.total):""):"")+(p&&this.show.statusBuffered?" ("+w2utils.lang("buffered")+" "+w2utils.formatNumber(w)+(0<this.offset?", skip "+w2utils.formatNumber(this.offset):"")+")":"")),p||this.fixedBody&&!(-1!=this.total&&this.total<=this.vs_start)){let t=Math.floor(f[0].scrollTop/this.recordHeight)-this.last.show_extra,i=t+Math.floor(f.height()/this.recordHeight)+2*this.last.show_extra+1;t<1&&(t=1),i>this.total&&-1!=this.total&&(i=this.total);let s=f.find("#grid_"+this.name+"_rec_top"),l=f.find("#grid_"+this.name+"_rec_bottom"),r=m.find("#grid_"+this.name+"_frec_top"),n=m.find("#grid_"+this.name+"_frec_bottom");-1!=String(s.next().prop("id")).indexOf("_expanded_row")&&(s.next().remove(),r.next().remove()),this.total>i&&-1!=String(l.prev().prop("id")).indexOf("_expanded_row")&&(l.prev().remove(),n.prev().remove());g=parseInt(s.next().attr("line")),p=parseInt(l.prev().attr("line"));let e,a,o,h,d;if(g<t||1==g||this.last.pull_refresh){if(i<=p+this.last.show_extra-2&&i!=this.total)return;for(this.last.pull_refresh=!1;;){if(a=m.find("#grid_"+this.name+"_frec_top").next(),o=f.find("#grid_"+this.name+"_rec_top").next(),"bottom"==o.attr("line"))break;if(!(parseInt(o.attr("line"))<t))break;a.remove(),o.remove()}e=f.find("#grid_"+this.name+"_rec_bottom").prev(),h=e.attr("line"),"top"==h&&(h=t);for(let e=parseInt(h)+1;e<=i;e++)this.records[e-1]&&(o=this.records[e-1].w2ui,o&&!Array.isArray(o.children)&&(o.expanded=!1),d=this.getRecordHTML(e-1,e),l.before(d[1]),n.before(d[0]));y(),setTimeout(()=>{this.refreshRanges()},0)}else{if(t>=g-this.last.show_extra+2&&1<t)return;for(;;){if(a=m.find("#grid_"+this.name+"_frec_bottom").prev(),o=f.find("#grid_"+this.name+"_rec_bottom").prev(),"top"==o.attr("line"))break;if(!(parseInt(o.attr("line"))>i))break;a.remove(),o.remove()}e=f.find("#grid_"+this.name+"_rec_top").next(),h=e.attr("line"),"bottom"==h&&(h=i);for(let e=parseInt(h)-1;e>=t;e--)this.records[e-1]&&(o=this.records[e-1].w2ui,o&&!Array.isArray(o.children)&&(o.expanded=!1),d=this.getRecordHTML(e-1,e),s.after(d[1]),r.after(d[0]));y(),setTimeout(()=>{this.refreshRanges()},0)}g=(t-1)*this.recordHeight;let u=(w-i)*this.recordHeight;if(u<0&&(u=0),s.css("height",g+"px"),r.css("height",g+"px"),l.css("height",u+"px"),n.css("height",u+"px"),this.last.range_start=t,this.last.range_end=i,Math.floor(f[0].scrollTop/this.recordHeight)+Math.floor(f.height()/this.recordHeight)+10>w&&!0!==this.last.pull_more&&(w<this.total-this.offset||-1==this.total&&this.last.xhr_hasMore)){!0===this.autoLoad&&(this.last.pull_more=!0,this.last.xhr_offset+=this.limit,this.request("get"));let e=$(this.box).find("#grid_"+this.name+"_rec_more, #grid_"+this.name+"_frec_more");e.show().eq(1).off(".load-more").on("click.load-more",function(){$(this).find("td").html('<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>'),c.last.pull_more=!0,c.last.xhr_offset+=c.limit,c.request("get")}).find("td").html(c.autoLoad?'<div><div style="width: 20px; height: 20px;" class="w2ui-spinner"></div></div>':'<div style="padding-top: 15px">'+w2utils.lang("Load ${count} more...",{count:c.limit})+"</div>")}function y(){c.markSearch&&(clearTimeout(c.last.marker_timer),c.last.marker_timer=setTimeout(()=>{let t=[];for(let e=0;e<c.searchData.length;e++){var i=c.searchData[e],s=c.getSearch(i.field);s&&!s.hidden&&(s=c.getColumn(i.field,!0),t.push({field:i.field,search:i.value,col:s}))}0<t.length&&t.forEach(e=>{$(c.box).find('td[col="'+e.col+'"]').not(".w2ui-head").w2marker(e.search)})},50))}}}}getRecordHTML(t,e,i){let s="",l="",r=this.last.selection,n;if(-1==t){s+='<tr line="0">',l+='<tr line="0">',this.show.lineNumbers&&(s+='<td class="w2ui-col-number" style="height: 0px;"></td>'),this.show.selectColumn&&(s+='<td class="w2ui-col-select" style="height: 0px;"></td>'),this.show.expandColumn&&(s+='<td class="w2ui-col-expand" style="height: 0px;"></td>'),l+='<td class="w2ui-grid-data w2ui-grid-data-spacer" col="start" style="height: 0px; width: 0px;"></td>',this.show.orderColumn&&(l+='<td class="w2ui-col-order" style="height: 0px;" col="order"></td>');for(let e=0;e<this.columns.length;e++){var a=this.columns[e],o='<td class="w2ui-grid-data" col="'+e+'" style="height: 0px;"></td>';a.frozen&&!a.hidden?s+=o:a.hidden||e<this.last.colStart||e>this.last.colEnd||(l+=o)}return s+='<td class="w2ui-grid-data-last" style="height: 0px"></td>',l+='<td class="w2ui-grid-data-last" col="end" style="height: 0px"></td>',s+="</tr>",l+="</tr>",[s,l]}var h="object"!=typeof this.url?this.url:this.url.get;if(!0!==i)if(0<this.searchData.length&&!h){if(t>=this.last.searchIds.length)return"";t=this.last.searchIds[t],n=this.records[t]}else{if(t>=this.records.length)return"";n=this.records[t]}else{if(t>=this.summary.length)return"";n=this.summary[t]}if(!n)return"";null!=n.recid||null==this.recid||null!=(h=this.parseField(n,this.recid))&&(n.recid=h);let d=!1;-1!=r.indexes.indexOf(t)&&(d=!0);let u=n.w2ui?n.w2ui.style:"";null!=u&&"string"==typeof u||(u="");let c=n.w2ui?n.w2ui.class:"";if(null!=c&&"string"==typeof c||(c=""),s+='<tr id="grid_'+this.name+"_frec_"+n.recid+'" recid="'+n.recid+'" line="'+e+'" index="'+t+'"  class="'+(e%2==0?"w2ui-even":"w2ui-odd")+" w2ui-record "+c+(d&&"row"==this.selectType?" w2ui-selected":"")+(n.w2ui&&!1===n.w2ui.editable?" w2ui-no-edit":"")+(n.w2ui&&!0===n.w2ui.expanded?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(d||""==u?u.replace("background-color","none"):u)+'" '+(""!=u?'custom_style="'+u+'"':"")+">",l+='<tr id="grid_'+this.name+"_rec_"+n.recid+'" recid="'+n.recid+'" line="'+e+'" index="'+t+'"  class="'+(e%2==0?"w2ui-even":"w2ui-odd")+" w2ui-record "+c+(d&&"row"==this.selectType?" w2ui-selected":"")+(n.w2ui&&!1===n.w2ui.editable?" w2ui-no-edit":"")+(n.w2ui&&!0===n.w2ui.expanded?" w2ui-expanded":"")+'"  style="height: '+this.recordHeight+"px; "+(d||""==u?u.replace("background-color","none"):u)+'" '+(""!=u?'custom_style="'+u+'"':"")+">",this.show.lineNumbers&&(s+='<td id="grid_'+this.name+"_cell_"+t+"_number"+(i?"_s":"")+'"    class="w2ui-col-number '+(d?" w2ui-row-selected":"")+'"'+(this.reorderRows?' style="cursor: move"':"")+">"+(!0!==i?this.getLineHTML(e,n):"")+"</td>"),this.show.selectColumn&&(s+='<td id="grid_'+this.name+"_cell_"+t+"_select"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-select">'+(!0===i||n.w2ui&&!0===n.w2ui.hideCheckBox?"":'    <div>        <input class="w2ui-grid-select-check" type="checkbox" tabindex="-1" '+(d?'checked="checked"':"")+' style="pointer-events: none"/>    </div>')+"</td>"),this.show.expandColumn){let e="";e=n.w2ui&&!0===n.w2ui.expanded?"-":"+",!n.w2ui||"none"!=n.w2ui.expanded&&Array.isArray(n.w2ui.children)&&n.w2ui.children.length||(e=""),n.w2ui&&"spinner"==n.w2ui.expanded&&(e='<div class="w2ui-spinner" style="width: 16px; margin: -2px 2px;"></div>'),s+='<td id="grid_'+this.name+"_cell_"+t+"_expand"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-expand">'+(!0!==i?'    <div ondblclick="if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;"             onclick="w2ui[\''+this.name+"'].toggle(jQuery(this).parents('tr').attr('recid'));                 if (event.stopPropagation) event.stopPropagation(); else event.cancelBubble = true;\">        "+e+" </div>":"")+"</td>"}l+='<td class="w2ui-grid-data-spacer" col="start" style="border-right: 0"></td>',this.show.orderColumn&&(l+='<td id="grid_'+this.name+"_cell_"+t+"_order"+(i?"_s":"")+'" class="w2ui-grid-data w2ui-col-order" col="order">'+(!0!==i?'<div title="Drag to reorder">&nbsp;</div>':"")+"</td>");let p=0,f=0;for(;;){let e=1;var m=this.columns[p];if(null==m)break;if(m.hidden)p++,0<f&&f--;else if(0<f){if(p++,null==this.columns[p])break;n.w2ui.colspan[this.columns[p-1].field]=0,f--}else{if(n.w2ui){let e=n.w2ui.colspan;var g=this.columns[p].field;e&&0===e[g]&&delete e[g]}if(!(p<this.last.colStart||p>this.last.colEnd)||m.frozen){if(n.w2ui&&"object"==typeof n.w2ui.colspan){var w=parseInt(n.w2ui.colspan[m.field])||null;if(1<w){let t=0;for(let e=p;e<p+w&&!(e>=this.columns.length);e++)this.columns[e].hidden&&t++;e=w-t,f=w-1}}g=this.getCellHTML(t,p,i,e);m.frozen?s+=g:l+=g,p++}else p++}}return s+='<td class="w2ui-grid-data-last"></td>',l+='<td class="w2ui-grid-data-last" col="end"></td>',s+="</tr>",l+="</tr>",[s,l]}getLineHTML(e){return"<div>"+e+"</div>"}getCellHTML(i,s,e,t){let l=this,r=this.columns[s];if(null==r)return"";let n=(!0!==e?this.records:this.summary)[i],{value:a,style:o,className:h,attr:d,divAttr:u}=this.getCellValue(i,s,e,!0);var c=-1!==i?this.getCellEditable(i,s):"";let p="max-height: "+parseInt(this.recordHeight)+"px;"+(r.clipboardCopy?"margin-right: 20px":"");var f=!e&&n&&n.w2ui&&n.w2ui.changes&&null!=n.w2ui.changes[r.field];let m=this.last.selection,g=!1,w="";if(-1!=m.indexes.indexOf(i)&&(g=!0),null==t&&(t=n&&n.w2ui&&n.w2ui.colspan&&n.w2ui.colspan[r.field]?n.w2ui.colspan[r.field]:1),0===s&&n&&n.w2ui&&Array.isArray(n.w2ui.children)){let t=0,e=this.get(n.w2ui.parent_recid,!0);for(;;){if(null==e)break;t++;var y=this.records[e].w2ui;if(null==y||null==y.parent_recid)break;e=this.get(y.parent_recid,!0)}if(n.w2ui.parent_recid)for(let e=0;e<t;e++)w+='<span class="w2ui-show-children w2ui-icon-empty"></span>';w+='<span class="w2ui-show-children '+(0<n.w2ui.children.length?n.w2ui.expanded?"w2ui-icon-collapse":"w2ui-icon-expand":"w2ui-icon-empty")+'"  onclick="event.stopPropagation(); w2ui[\''+this.name+"'].toggle(jQuery(this).parents('tr').attr('recid'))\"></span>"}if(!0===r.info&&(r.info={}),null!=r.info){let e="w2ui-icon-info";"function"==typeof r.info.icon?e=r.info.icon(n):"object"==typeof r.info.icon?e=r.info.icon[this.parseField(n,r.field)]||"":"string"==typeof r.info.icon&&(e=r.info.icon);let t=r.info.style||"";"function"==typeof r.info.style?t=r.info.style(n):"object"==typeof r.info.style?t=r.info.style[this.parseField(n,r.field)]||"":"string"==typeof r.info.style&&(t=r.info.style),w+='<span class="w2ui-info '+e+'" style="'+t+'" '+(null!=r.info.showOn?"on"+r.info.showOn:"onclick")+"=\"event.stopPropagation(); w2ui['"+this.name+"'].showBubble("+i+", "+s+')"></span>'}let b=a;c&&-1!=["checkbox","check"].indexOf(c.type)&&(p+="text-align: center;",b='<input tabindex="-1" type="checkbox" '+(b?'checked="checked"':"")+" onclick=\"    let obj = w2ui['"+this.name+"'];     obj.editChange.call(obj, this, "+(e?-(i+1):i)+", "+s+', event); "/>',w=""),b=`<div style="${p}" ${function(e){let t;l.show.recordTitles&&(null!=r.title?("function"==typeof r.title&&(t=r.title.call(l,n,i,s)),"string"==typeof r.title&&(t=r.title)):t=w2utils.stripTags(String(e).replace(/"/g,"''")));return null!=t?'title="'+String(t)+'"':""}(b)} ${u}>${w}${String(b)}</div>`,null==b&&(b=""),"string"==typeof r.render&&(c=r.render.toLowerCase().split(":"),-1!=["number","int","float","money","currency","percent","size"].indexOf(c[0])&&(o+="text-align: right;")),n&&n.w2ui&&("object"==typeof n.w2ui.style&&("string"==typeof n.w2ui.style[s]&&(o+=n.w2ui.style[s]+";"),"string"==typeof n.w2ui.style[r.field]&&(o+=n.w2ui.style[r.field]+";")),"object"==typeof n.w2ui.class&&("string"==typeof n.w2ui.class[s]&&(h+=n.w2ui.class[s]+" "),"string"==typeof n.w2ui.class[r.field]&&(h+=n.w2ui.class[r.field]+" ")));let v=!1;g&&-1!=$.inArray(s,m.columns[i])&&(v=!0);let x,_;return r.clipboardCopy&&(x="string"==typeof r.clipboardCopy?r.clipboardCopy:w2utils.lang("Copy to clipboard"),_=`<span onmouseEnter="jQuery(this).w2tag('${x}', { name: '${this.name}-bubble', position: 'top|bottom' })"
                onclick="w2ui['${this.name}'].clipboardCopy(${i}, ${s}); jQuery(this).w2tag(w2utils.lang('Copied'), { name: '${this.name}-bubble', position: 'top|bottom' }); event.stopPropagation();"
                onmouseLeave="jQuery(this).w2tag({ name: '${this.name}-bubble' })" class="w2ui-clipboard-copy w2ui-icon-paste"></span>`),b='<td class="w2ui-grid-data'+(v?" w2ui-selected":"")+" "+h+(f?" w2ui-changed":"")+'"    id="grid_'+this.name+"_data_"+i+"_"+s+'" col="'+s+'"    style="'+o+(null!=r.style?r.style:"")+'" '+(null!=r.attr?r.attr:"")+d+(1<t?'colspan="'+t+'"':"")+">"+b+(_&&w2utils.stripTags(b)?_:"")+"</td>",-1===i&&!0===e&&(b='<td class="w2ui-grid-data" col="'+s+'" style="height: 0px; '+o+'" '+(1<t?'colspan="'+t+'"':"")+"></td>"),b}clipboardCopy(e,t){e=this.records[e];let i=this.columns[t],s=i?this.parseField(e,i.field):"";"function"==typeof i.clipboardCopy&&(s=i.clipboardCopy(e)),$(this.box).find("#grid_"+this.name+"_focus").text(s).select(),document.execCommand("copy")}showBubble(l,r){let n=this.columns[r].info;if(n){let s="";var a=this.records[l];let e=query(this.box).find("#grid_"+this.name+"_data_"+l+"_"+r+" .w2ui-info");if(this.last.bubbleEl&&w2tooltip.hide(this.name+"-bubble"),this.last.bubbleEl=e,null==n.fields){n.fields=[];for(let e=0;e<this.columns.length;e++){var i=this.columns[e];n.fields.push(i.field+("string"==typeof i.render?":"+i.render:""))}}let t=n.fields;if("function"==typeof t&&(t=t(a,l,r)),"function"==typeof n.render)s=n.render(a,l,r);else if(Array.isArray(t)){s='<table cellpadding="0" cellspacing="0">';for(let e=0;e<t.length;e++){var o=String(t[e]).split(":");if(""!=o[0]&&"-"!=o[0]&&"--"!=o[0]&&"---"!=o[0]){let e=this.getColumn(o[0]);null==e&&(e={field:o[0],caption:o[0]});let t=e?this.parseField(a,e.field):"";1<o.length&&(w2utils.formatters[o[1]]?t=w2utils.formatters[o[1]](t,o[2]||null,a):console.log('ERROR: w2utils.formatters["'+o[1]+'"] does not exists.')),(!0===n.showEmpty||null!=t&&""!=t)&&(null!=n.maxLength&&"string"==typeof t&&t.length>n.maxLength&&(t=t.substr(0,n.maxLength)+"..."),s+="<tr><td>"+e.text+"</td><td>"+((0===t?"0":t)||"")+"</td></tr>")}else s+='<tr><td colspan=2><div style="border-top: '+(""==o[0]?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>'}s+="</table>"}else if($.isPlainObject(t)){for(var h in s='<table cellpadding="0" cellspacing="0">',t){let i=t[h];if(""!=i&&"-"!=i&&"--"!=i&&"---"!=i){var d=String(i).split(":");let e=this.getColumn(d[0]);null==e&&(e={field:d[0],caption:d[0]});let t=e?this.parseField(a,e.field):"";1<d.length&&(w2utils.formatters[d[1]]?t=w2utils.formatters[d[1]](t,d[2]||null,a):console.log('ERROR: w2utils.formatters["'+d[1]+'"] does not exists.')),"function"==typeof i&&(t=i(a,l,r)),(!0===n.showEmpty||null!=t&&""!=t)&&(null!=n.maxLength&&"string"==typeof t&&t.length>n.maxLength&&(t=t.substr(0,n.maxLength)+"..."),s+="<tr><td>"+h+"</td><td>"+((0===t?"0":t)||"")+"</td></tr>")}else s+='<tr><td colspan=2><div style="border-top: '+(""==i?"0":"1")+'px solid #C1BEBE; margin: 6px 0px;"></div></td></tr>'}s+="</table>"}w2tooltip.show(w2utils.extend({name:this.name+"-bubble",html:s,anchor:e.get(0),position:"top|bottom",class:"w2ui-info-bubble",style:"",hideOn:["doc-click"]},n.options??{})).hide(()=>[this.last.bubbleEl=null])}}getCellEditable(e,t){var i=this.columns[t],s=this.records[e];if(!s||!i)return null;let l=s.w2ui?s.w2ui.editable:null;return!1===l?null:(null!=l&&!0!==l||(l=i&&0<Object.keys(i.editable).length?i.editable:null,"function"==typeof l&&(i=this.getCellValue(e,t,!1),l=l.call(this,s,e,t,i))),l)}getCellValue(t,i,e,s){let l=this.columns[i];var r=(!0!==e?this.records:this.summary)[t];let n=this.parseField(r,l.field),a="",o="",h="",d="";if(r&&r.w2ui&&r.w2ui.changes&&null!=r.w2ui.changes[l.field]&&(n=r.w2ui.changes[l.field],n instanceof Object&&0<Object.keys(l.editable).length&&(l.options&&l.options.items?(e=l.options.items.find(e=>e.id==n.id),n=e?e.text:n.id):(null!=n.id&&null==n.text&&(n=n.id),null!=n.text&&(n=n.text)))),null!=l.render&&-1!==t){if("function"==typeof l.render&&null!=r){let e;try{e=l.render(r,{self:this,value:n,index:t,colIndex:i})}catch(e){throw new Error(`Render function for column "${l.field}" in grid "${this.name}": -- `+e.message)}null!=e&&"object"==typeof e&&"function"!=typeof e?(null!=e.id&&null!=e.text?n=e.text:"string"==typeof e.html?n=(e.html||"").trim():(n="",console.log("ERROR: render function should return a primitive or an object of the following structure.",{html:"",attr:"",style:"",class:"",divAttr:""})),h=e.attr??"",o=e.style??"",a=e.class??"",d=e.divAttr??""):n=String(e||"").trim()}if("object"!=typeof l.render||null!=(u=l.render[n])&&""!==u&&(n=u),"string"==typeof l.render){var u=l.render.toLowerCase().indexOf(":");let e=[];-1==u?(e[0]=l.render.toLowerCase(),e[1]=""):(e[0]=l.render.toLowerCase().substr(0,u),e[1]=l.render.toLowerCase().substr(u+1));let t=w2utils.formatters[e[0]];l.options&&!1===l.options.autoFormat&&(t=null),n="function"==typeof t?t(n,e[1],r):""}}return null==n&&(n=""),s?{value:n,attr:h,style:o,className:a,divAttr:d}:n}getFooterHTML(){return'<div>    <div class="w2ui-footer-left"></div>    <div class="w2ui-footer-right"></div>    <div class="w2ui-footer-center"></div></div>'}status(i){if(null!=i)$(this.box).find("#grid_"+this.name+"_footer").find(".w2ui-footer-left").html(i);else{let t="";i=this.getSelection();if(0<i.length&&(this.show.statusSelection&&1<i.length&&(t=String(i.length).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1"+w2utils.settings.groupSymbol)+" "+w2utils.lang("selected")),this.show.statusRecordID&&1==i.length)){let e=i[0];"object"==typeof e&&(e=e.recid+", "+w2utils.lang("Column")+": "+e.column),t=w2utils.lang("Record ID")+": "+e+" "}$(this.box).find("#grid_"+this.name+"_footer .w2ui-footer-left").html(t)}}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),setTimeout(()=>{$(this.box).find("#grid_"+this.name+"_empty_msg").remove(),w2utils.lock(...i)},10)}unlock(e){setTimeout(()=>{0<$(this.box).find(".w2ui-message").not(".w2ui-closing").length||w2utils.unlock(this.box,e)},25)}stateSave(e){if(!w2utils.hasLocalStorage)return null;let t={columns:[],show:$.extend({},this.show),last:{search:this.last.search,multi:this.last.multi,logic:this.last.logic,label:this.last.label,field:this.last.field,scrollTop:this.last.scrollTop,scrollLeft:this.last.scrollLeft},sortData:[],searchData:[]},l;for(let e=0;e<this.columns.length;e++){let i=this.columns[e],s={};Object.keys(this.stateColProps).forEach((e,t)=>{this.stateColProps[e]&&(l=void 0!==i[e]?i[e]:this.colDefaults[e]||null,s[e]=l)}),t.columns.push(s)}for(let e=0;e<this.sortData.length;e++)t.sortData.push($.extend({},this.sortData[e]));for(let e=0;e<this.searchData.length;e++)t.searchData.push($.extend({},this.searchData[e]));var i=this.trigger({phase:"before",type:"stateSave",target:this.name,state:t});if(!0!==i.isCancelled){if(!0!==e&&this.useLocalStorage)try{let e=JSON.parse(localStorage.w2ui||"{}");e=e||{},e.states||(e.states={}),e.states[this.stateId||this.name]=t,localStorage.w2ui=JSON.stringify(e)}catch(e){return delete localStorage.w2ui,null}return this.trigger($.extend(i,{phase:"after"})),t}}stateRestore(i){let s="object"!=typeof this.url?this.url:this.url.get;if(!i){if(!w2utils.hasLocalStorage&&this.useLocalStorage)return!1;try{let e=JSON.parse(localStorage.w2ui||"{}");e=e||{},e.states||(e.states={}),i=e.states[this.stateId||this.name]}catch(e){return delete localStorage.w2ui,null}}var e=this.trigger({phase:"before",type:"stateRestore",target:this.name,state:i});if(!0!==e.isCancelled){if($.isPlainObject(i)){$.extend(this.show,i.show),$.extend(this.last,i.last);let e=this.last.scrollTop,t=this.last.scrollLeft;for(let e=0;e<i.columns.length;e++){var l=i.columns[e],r=this.getColumn(l.field,!0);null!==r&&($.extend(this.columns[r],l),e!==r&&this.columns.splice(e,0,this.columns.splice(r,1)[0]))}this.sortData.splice(0,this.sortData.length);for(let e=0;e<i.sortData.length;e++)this.sortData.push(i.sortData[e]);this.searchData.splice(0,this.searchData.length);for(let e=0;e<i.searchData.length;e++)this.searchData.push(i.searchData[e]);setTimeout(()=>{s||(0<this.sortData.length&&this.localSort(),0<this.searchData.length&&this.localSearch()),this.last.scrollTop=e,this.last.scrollLeft=t,this.refresh()},1)}return this.trigger($.extend(e,{phase:"after"})),!0}}stateReset(){if(this.stateRestore(this.last.state),w2utils.hasLocalStorage&&this.useLocalStorage)try{let e=JSON.parse(localStorage.w2ui||"{}");e.states&&e.states[this.stateId||this.name]&&delete e.states[this.stateId||this.name],localStorage.w2ui=JSON.stringify(e)}catch(e){return delete localStorage.w2ui,null}}parseField(e,i){if(this.nestedFields){let t="";try{t=e;var s=String(i).split(".");for(let e=0;e<s.length;e++)t=t[s[e]]}catch(e){t=""}return t}return e?e[i]:""}prepareData(){let t=this;for(let e=0;e<this.records.length;e++)!function i(s){for(let e=0;e<t.columns.length;e++){let i=t.columns[e];if(null!=s[i.field]&&"string"==typeof i.render){if(-1!=["number","int","float","money","currency","percent"].indexOf(i.render.split(":")[0])&&"number"!=typeof s[i.field]&&(s[i.field]=parseFloat(s[i.field])),-1!=["date","age"].indexOf(i.render.split(":")[0])&&!s[i.field+"_"]){let e=s[i.field];w2utils.isInt(e)&&(e=parseInt(e)),s[i.field+"_"]=new Date(e)}if(-1!=["time"].indexOf(i.render))if(w2utils.isTime(s[i.field])){let e=w2utils.isTime(s[i.field],!0),t=new Date;t.setHours(e.hours,e.minutes,e.seconds||0,0),s[i.field+"_"]||(s[i.field+"_"]=t)}else{let e=s[i.field];w2utils.isInt(e)&&(e=parseInt(e)),e=null!=e?new Date(e):new Date;let t=new Date;t.setHours(e.getHours(),e.getMinutes(),e.getSeconds(),0),s[i.field+"_"]||(s[i.field+"_"]=t)}}}if(s.w2ui&&s.w2ui.children&&!0!==s.w2ui.expanded)for(let t=0;t<s.w2ui.children.length;t++){let e=s.w2ui.children[t];i(e)}}(this.records[e])}nextCell(e,t,i){var s=t+1;if(s>=this.columns.length)return null==(e=this.nextRow(e))?e:this.nextCell(e,-1,i);var l=this.records[e].w2ui,t=this.columns[s],l=l&&l.colspan&&!isNaN(l.colspan[t.field])?parseInt(l.colspan[t.field]):1;if(null==t)return null;if(t&&t.hidden||0===l)return this.nextCell(e,s,i);if(i){l=this.getCellEditable(e,s);if(null==l||-1!=["checkbox","check"].indexOf(l.type))return this.nextCell(e,s,i)}return{index:e,colIndex:s}}prevCell(e,t,i){var s=t-1;if(s<0)return null==(e=this.prevRow(e))?e:this.prevCell(e,this.columns.length,i);if(s<0)return null;var l=this.records[e].w2ui,t=this.columns[s],l=l&&l.colspan&&!isNaN(l.colspan[t.field])?parseInt(l.colspan[t.field]):1;if(null==t)return null;if(t&&t.hidden||0===l)return this.prevCell(e,s,i);if(i){l=this.getCellEditable(e,s);if(null==l||-1!=["checkbox","check"].indexOf(l.type))return this.prevCell(e,s,i)}return{index:e,colIndex:s}}nextRow(e,t,i){var s=this.last.searchIds;let l=null;if(-1==(i=null==i?1:i))return this.records.length-1;if(e+i<this.records.length&&0===s.length||0<s.length&&e<s[s.length-i]){if(e+=i,0<s.length)for(;;){if(-1!=$.inArray(e,s)||e>this.records.length)break;e+=i}var r=this.records[e].w2ui,n=this.columns[t],n=r&&r.colspan&&null!=n&&!isNaN(r.colspan[n.field])?parseInt(r.colspan[n.field]):1;l=0===n?this.nextRow(e,t,i):e}return l}prevRow(e,t,i){var s=this.last.searchIds;let l=null;if(-1==(i=null==i?1:i))return 0;if(0<=e-i&&0===s.length||0<s.length&&e>s[0]){if(e-=i,0<s.length)for(;;){if(-1!=$.inArray(e,s)||e<0)break;e-=i}var r=this.records[e].w2ui,n=this.columns[t],n=r&&r.colspan&&null!=n&&!isNaN(r.colspan[n.field])?parseInt(r.colspan[n.field]):1;l=0===n?this.prevRow(e,t,i):e}return l}selectionSave(){return this.last._selection=this.getSelection(),this.last._selection}selectionRestore(e){var t=(new Date).getTime();this.last.selection={indexes:[],columns:{}};let i=this.last.selection;var s,l=this.last._selection;if(l)for(let e=0;e<l.length;e++)$.isPlainObject(l[e])?null!=(s=this.get(l[e].recid,!0))&&(-1==i.indexes.indexOf(s)&&i.indexes.push(s),i.columns[s]||(i.columns[s]=[]),i.columns[s].push(l[e].column)):null!=(s=this.get(l[e],!0))&&i.indexes.push(s);return delete this.last._selection,!0!==e&&this.refresh(),(new Date).getTime()-t}message(e){return w2utils.message({owner:this,box:this.box,after:".w2ui-grid-header"},e)}confirm(e){return w2utils.confirm({owner:this,box:this.box,after:".w2ui-grid-header"},e)}}class w2form extends w2base{constructor(e){super(e.name),this.name=null,this.header="",this.box=null,this.url="",this.routeData={},this.formURL="",this.formHTML="",this.page=0,this.pageStyle="",this.recid=0,this.fields=[],this.actions={},this.record={},this.original=null,this.method=null,this.dataType=null,this.postData={},this.httpHeaders={},this.toolbar={},this.tabs={},this.style="",this.focus=0,this.autosize=!0,this.nestedFields=!0,this.multipart=!1,this.tabindexBase=0,this.isGenerated=!1,this.last={xhr:null,errors:[]},this.onRequest=null,this.onLoad=null,this.onValidate=null,this.onSubmit=null,this.onProgress=null,this.onSave=null,this.onChange=null,this.onInput=null,this.onRender=null,this.onRefresh=null,this.onResize=null,this.onDestroy=null,this.onAction=null,this.onToolbar=null,this.onError=null,this.msgRefresh="Loading...",this.msgSaving="Saving...",this.ALL_TYPES=["text","textarea","email","pass","password","int","float","money","currency","percent","hex","alphanumeric","color","date","time","datetime","toggle","checkbox","radio","check","checks","list","combo","enum","file","select","map","array","div","custom","html","empty"],this.LIST_TYPES=["select","radio","check","checks","list","combo","enum"],this.W2FIELD_TYPES=["int","float","money","currency","percent","hex","alphanumeric","color","date","time","datetime","list","combo","enum","file"],w2utils.extend(this,e);var t,i,s=e.record,l=e.original,r=e.fields,n=e.toolbar;let a=e.tabs;if(Object.assign(this,{record:{},original:null,fields:[],tabs:{},toolbar:{},handlers:[]}),r&&(r=function l(r){let n=[];let a=[];if(w2utils.isPlainObject(r)){let e=r;function o(t){let i=["html"];return null==t.html&&(t.html={}),Object.keys(t).forEach(e=>{-1==i.indexOf(e)&&-1!=["label","attr","style","text","span","page","column","anchor","group","groupStyle","groupTitleStyle","groupCollapsible"].indexOf(e)&&(t.html[e]=t[e],delete t[e])}),t}function h(t,i){let s=["style","html"];Object.keys(t).forEach(e=>{-1==s.indexOf(e)&&-1!=["span","column","attr","text","label"].indexOf(e)&&t[e]&&!i.html[e]&&(i.html[e]=t[e])})}r=[],Object.keys(e).forEach(i=>{let s=e[i];if("group"==s.type){if(s.text=i,w2utils.isPlainObject(s.fields)){let i=s.fields;s.fields=[],Object.keys(i).forEach(e=>{let t=i[e];t.field=e,s.fields.push(o(t))})}r.push(s)}else if("tab"==s.type){let e={id:i,text:i};s.style&&(e.style=s.style),a.push(e);let t=l(s.fields).fields;t.forEach(e=>{e.html=e.html||{},e.html.page=a.length-1,h(s,e)}),r.push(...t)}else s.field=i,r.push(o(s))})}r.forEach(s=>{if("group"==s.type){let i={group:s.text||"",groupStyle:s.style||"",groupTitleStyle:s.titleStyle||"",groupCollapsible:!0===s.collapsible};Array.isArray(s.fields)&&s.fields.forEach(e=>{let t=w2utils.clone(e);null==t.html&&(t.html={}),w2utils.extend(t.html,i),Array("span","column","attr","label","page").forEach(e=>{null==t.html[e]&&null!=s[e]&&(t.html[e]=s[e])}),null==t.field&&null!=t.name&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",s),t.field=t.name),n.push(t)})}else{let e=w2utils.clone(s);null==e.field&&null!=e.name&&(console.log("NOTICE: form field.name property is deprecated, please use field.field. Field ->",s),e.field=e.name),n.push(e)}});return{fields:n,tabs:a}}(r),this.fields=r.fields,!a&&0<r.tabs.length&&(a=r.tabs)),Array.isArray(a)){w2utils.extend(this.tabs,{tabs:[]});for(let e=0;e<a.length;e++){var o=a[e];"object"==typeof o?(this.tabs.tabs.push(o),!0===o.active&&(this.tabs.active=o.id)):this.tabs.tabs.push({id:o,text:o})}}else w2utils.extend(this.tabs,a);for(t in w2utils.extend(this.toolbar,n),s)w2utils.isPlainObject(s[t])?this.record[t]=w2utils.clone(s[t]):this.record[t]=s[t];for(i in l)w2utils.isPlainObject(l[i])?this.original[i]=w2utils.clone(l[i]):this.original[i]=l[i];""!==this.formURL?fetch(this.formURL).then(e=>e.text()).then(e=>{this.formHTML=e,this.isGenerated=!0}):this.formURL||this.formHTML||(this.formHTML=this.generateHTML(),this.isGenerated=!0)}get(t,i){if(0===arguments.length){let t=[];for(let e=0;e<this.fields.length;e++)null!=this.fields[e].field&&t.push(this.fields[e].field);return t}for(let e=0;e<this.fields.length;e++)if(this.fields[e].field==t)return!0===i?e:this.fields[e];return null}set(t,i){for(let e=0;e<this.fields.length;e++)if(this.fields[e].field==t)return w2utils.extend(this.fields[e],i),this.refresh(t),!0;return!1}getValue(t,i){if(this.nestedFields){let e=void 0;try{var s=!0===i?this.original:this.record;e=String(t).split(".").reduce((e,t)=>e[t],s)}catch(e){}return e}return this.record[t]}setValue(e,l){if((""===l||null==l||Array.isArray(l)&&0===l.length||w2utils.isPlainObject(l)&&0==Object.keys(l).length)&&(l=null),!this.nestedFields)return this.record[e]=l,!0;try{let s=this.record;return String(e).split(".").map((e,t,i)=>{i.length-1!==t?s=s[e]||(s[e]={},s[e]):s[e]=l}),!0}catch(e){return!1}}getFieldValue(e){let s=this.get(e);if(null!=s){var l=s.el;let t=this.getValue(e);var r=this.getValue(e,!0);let i=l.value;if(["int","float","percent","money","currency"].includes(s.type)&&(i=s.w2field.clean(i)),["radio"].includes(s.type)&&(e=query(l).closest("div").find("input:checked").get(0),i=e?s.options.items[query(e).data("index")].id:null),["toggle","checkbox"].includes(s.type)&&(i=l.checked),-1!==["check","checks"].indexOf(s.type)){i=[];let e=query(l).closest("div").find("input:checked");0<e.length&&e.each(e=>{e=s.options.items[query(e).data("index")];i.push(e.id)}),Array.isArray(t)||(t=[])}l=l._w2field?.selected;if(["list","enum","file"].includes(s.type)&&l){var n=l,a=t;if(Array.isArray(n)){i=[];for(let e=0;e<n.length;e++)i[e]=w2utils.clone(n[e])}if(Array.isArray(a)){t=[];for(let e=0;e<a.length;e++)t[e]=w2utils.clone(a[e])}w2utils.isPlainObject(n)&&(i=w2utils.clone(n)),w2utils.isPlainObject(a)&&(t=w2utils.clone(a))}return["map","array"].includes(s.type)&&(i="map"==s.type?{}:[],s.$el.parent().find(".w2ui-map-field").each(e=>{var t=query(e).find(".w2ui-map.key").val(),e=query(e).find(".w2ui-map.value").val();"map"==s.type?i[t]=e:i.push(e)})),{current:i,previous:t,original:r}}}setFieldValue(e,r){let n=this.get(e);if(null!=n){let s=n.el;switch(n.type){case"toggle":case"checkbox":s.checked=!!r;break;case"radio":{r=r?.id??r;let i=query(s).closest("div").find("input"),e=n.options.items;e.forEach((e,t)=>{e.id===r&&i.filter(`[data-index="${t}"]`).prop("checked",!0)});break}case"check":case"checks":{r=(r=!Array.isArray(r)?[r]:r).map(e=>e?.id??e);let i=query(s).closest("div").find("input"),e=n.options.items;e.forEach((e,t)=>{i.filter(`[data-index="${t}"]`).prop("checked",!!r.includes(e.id))});break}case"list":case"combo":let t=r;null==t?.id&&n.options.items.forEach(e=>{e.id===r&&(t=e)}),t!=r&&this.setValue(n.name,t),"list"==n.type?(n.w2field.selected=t,n.w2field.refresh()):n.el.value=t?.text??r;break;case"enum":case"file":{let s=r;Array.isArray(s)||(s=[s]),Array.isArray(r)||(r=[r]);let l=!1;s.forEach((t,i)=>{null==t?.id&&Array.isArray(n.options.items)&&n.options.items.forEach(e=>{e.id==t&&(s[i]=e,l=!0)})}),l&&this.setValue(n.name,s),n.w2field.selected=s,n.w2field.refresh();break}case"map":case"array":"map"!=n.type||null!=r&&w2utils.isPlainObject(r)||(this.setValue(n.field,{}),r=this.getValue(n.field)),"array"!=n.type||null!=r&&Array.isArray(r)||(this.setValue(n.field,[]),r=this.getValue(n.field));var i=query(n.el).parent().find(".w2ui-map-container");n.el.mapRefresh(r,i);break;case"div":case"custom":query(s).html(r);break;case"html":case"empty":break;default:s.value=r}}}show(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&e.hidden&&(e.hidden=!1,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),this.updateEmptyGroups(),i}hide(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&!e.hidden&&(e.hidden=!0,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),this.updateEmptyGroups(),i}enable(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&e.disabled&&(e.disabled=!1,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),i}disable(){let i=[];for(let t=0;t<arguments.length;t++){let e=this.get(arguments[t]);e&&!e.disabled&&(e.disabled=!0,i.push(e.field))}return 0<i.length&&this.refresh.apply(this,i),i}updateEmptyGroups(){query(this.box).find(".w2ui-group").each(e=>{!function(e){let t=!0;return e.each(e=>{"none"!=e.style.display&&(t=!1)}),t}(query(e).find(".w2ui-field"))?query(e).show():query(e).hide()})}change(){Array.from(arguments).forEach(e=>{let t=this.get(e);t.$el&&t.$el.change()})}reload(e){("object"!=typeof this.url?this.url:this.url.get)&&0!==this.recid&&null!=this.recid?this.request(e):"function"==typeof e&&e()}clear(){0!=arguments.length?Array.from(arguments).forEach(e=>{let s=this.record;String(e).split(".").map((e,t,i)=>{i.length-1!==t?s=s[e]:delete s[e]}),this.refresh(e)}):(this.recid=0,this.record={},this.original=null,this.refresh())}error(e){let t=this.trigger("error",{target:this.name,message:e,xhr:this.last.xhr});!0!==t.isCancelled&&(setTimeout(()=>{this.message(e)},1),t.finish())}message(e){return w2utils.message({owner:this,box:this.box,after:".w2ui-form-header"},e)}confirm(e){return w2utils.confirm({owner:this,box:this.box,after:".w2ui-form-header"},e)}validate(e){null==e&&(e=!0);let i=[];for(let t=0;t<this.fields.length;t++){let e=this.fields[t];var s,l;switch(null==this.getValue(e.field)&&this.setValue(e.field,""),-1!=["int","float","currency","money"].indexOf(e.type)&&(s=this.getValue(e.field),l=e.options.min,r=e.options.max,null!=l&&s<l&&i.push({field:e,error:w2utils.lang("Should be more than ${min}",{min:l})}),null!=r&&r<s&&i.push({field:e,error:w2utils.lang("Should be less than ${max}",{max:r})})),e.type){case"alphanumeric":this.getValue(e.field)&&!w2utils.isAlphaNumeric(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not alpha-numeric")});break;case"int":this.getValue(e.field)&&!w2utils.isInt(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not an integer")});break;case"percent":case"float":this.getValue(e.field)&&!w2utils.isFloat(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not a float")});break;case"currency":case"money":this.getValue(e.field)&&!w2utils.isMoney(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not in money format")});break;case"color":case"hex":this.getValue(e.field)&&!w2utils.isHex(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not a hex number")});break;case"email":this.getValue(e.field)&&!w2utils.isEmail(this.getValue(e.field))&&i.push({field:e,error:w2utils.lang("Not a valid email")});break;case"checkbox":1==this.getValue(e.field)?this.setValue(e.field,!0):this.setValue(e.field,!1);break;case"date":e.options.format||(e.options.format=w2utils.settings.dateFormat),this.getValue(e.field)&&!w2utils.isDate(this.getValue(e.field),e.options.format)&&i.push({field:e,error:w2utils.lang("Not a valid date")+": "+e.options.format})}var r=this.getValue(e.field);e.required&&!0!==e.hidden&&!["div","custom","html","empty"].includes(e.type)&&(null==r||""===r||Array.isArray(r)&&0===r.length||w2utils.isPlainObject(r)&&0==Object.keys(r).length)&&i.push({field:e,error:w2utils.lang("Required field")}),e.options&&!0!==e.hidden&&0<e.options.minLength&&-1==["enum","list","combo"].indexOf(e.type)&&this.getValue(e.field).length<e.options.minLength&&i.push({field:e,error:w2utils.lang("Field should be at least ${count} characters.",{count:e.options.minLength})})}let t=this.trigger("validate",{target:this.name,errors:i});if(!0!==t.isCancelled)return this.last.errors=i,e&&this.showErrors(),t.finish(),i}showErrors(){let e=this.last.errors;e.length<=0||(this.goto(e[0].field.page),query(e[0].field.$el).parents(".w2ui-field")[0].scrollIntoView(!0),e.forEach(t=>{var i=w2utils.extend({anchorClass:"w2ui-error",class:"w2ui-light",position:"right|left",hideOn:["input"]},t.options);if(null!=t.field){let e=t.field.el;"radio"===t.field.type?e=query(t.field.el).closest("div").get(0):["enum","file"].includes(t.field.type),w2tooltip.show(w2utils.extend({anchor:e,name:`${this.name}-${t.field.field}-error`,html:t.error},i))}}),query(e[0].field.$el).parents(".w2ui-page").off(".hideErrors").on("scroll.hideErrors",e=>{this.hideErrors()}))}hideErrors(){this.fields.forEach(e=>{w2tooltip.hide(`${this.name}-${e.field}-error`)})}getChanges(){let e={};return null!=this.original&&"object"==typeof this.original&&0==Object.keys(this.record).length&&(e=function e(t,i,s){if(Array.isArray(t)&&Array.isArray(i))for(;t.length<i.length;)t.push(null);for(var l in t)null!=t[l]&&"object"==typeof t[l]?(s[l]=e(t[l],i[l]||{},{}),(!s[l]||0==Object.keys(s[l]).length&&Object.keys(0==i[l].length))&&delete s[l]):(t[l]!=i[l]||null==t[l]&&null!=i[l])&&(s[l]=t[l]);return 0!=Object.keys(s).length?s:null}(this.record,this.original,{})),e}getCleanRecord(e){let l=w2utils.clone(this.record);return this.fields.forEach(t=>{if(-1!=["list","combo","enum"].indexOf(t.type)){var s={nestedFields:!0,record:l};let i=this.getValue.call(s,t.field);w2utils.isPlainObject(i)&&null!=i.id&&this.setValue.call(s,t.field,i.id),Array.isArray(i)&&i.forEach((e,t)=>{w2utils.isPlainObject(e)&&e.id&&(i[t]=e.id)})}if("map"==t.type){s={nestedFields:!0,record:l};let e=this.getValue.call(s,t.field);e._order&&delete e._order}}),!0===e&&Object.keys(l).forEach(e=>{this.get(e)||delete l[e]}),l}request(t,l){let r=this;if("function"==typeof t&&(l=t,t=null),null==t&&(t={}),this.url&&("object"!=typeof this.url||this.url.get)){null==this.recid&&(this.recid=0);let e={cmd:"get"};e.recid=this.recid,e.name=this.name,w2utils.extend(e,this.postData),w2utils.extend(e,t);let s=this.trigger("request",{target:this.name,url:this.url,method:this.method,postData:e,httpHeaders:this.httpHeaders});if(!0!==s.isCancelled){this.record={},this.original=null,this.lock(w2utils.lang(this.msgRefresh));let t=s.detail.url;if("object"==typeof t&&t.get&&(t=t.get),this.last.xhr)try{this.last.xhr.abort()}catch(e){}if(0!=Object.keys(this.routeData).length){var n=w2utils.parseRoute(t);if(0<n.keys.length)for(let e=0;e<n.keys.length;e++)null!=this.routeData[n.keys[e].name]&&(t=t.replace(new RegExp(":"+n.keys[e].name,"g"),this.routeData[n.keys[e].name]))}t=new URL(t,location);let e={method:"GET",headers:s.detail.httpHeaders},i=s.detail.postData;s.detail.dataType??this.dataType??w2utils.settings.dataType;function a(e){r.unlock();let t=r.trigger("error",{response:e,xhr:r.last.xhr});!0!==t.isCancelled&&(e.status&&200!=e.status?r.error(e.status+": "+e.statusText):(console.log("ERROR: Server request failed.",e,". ","Expected Response:",{error:!1,record:{field1:1,field2:"item"}},"OR:",{error:!0,message:"Error description"}),r.error(String(e))),t.finish())}Object.keys(i).forEach(e=>t.searchParams.append(e,i[e])),this.method&&(e.method=this.method),s.detail.method&&(e.method=s.detail.method),this.last.xhr=fetch(t,e).catch(a).then(e=>{if(r.unlock(),200==e.status){let t=r.trigger("load",{target:r.name,xhr:this.last.xhr,data:e});!0!==t.isCancelled?e.json().catch(a).then(e=>{!0===(e=!e.record?{error:!1,record:e}:e).error?r.error(w2utils.lang(e.message)):r.record=w2utils.clone(e.record),t.finish(),r.refresh(),r.setFocus(),"function"==typeof l&&l(e)}):"function"==typeof l&&l({error:!0,message:w2utils.lang("Request aborted.")})}else a(e)}),s.finish()}else"function"==typeof l&&l({error:!0,message:w2utils.lang("Request aborted.")})}}submit(e,t){return this.save(e,t)}save(r,n){let a=this;if("function"==typeof r&&(n=r,r=null),0===a.validate(!0).length)if(null==r&&(r={}),a.url&&("object"!=typeof a.url||a.url.save)){a.lock(w2utils.lang(a.msgSaving)+' <span id="'+a.name+'_progress"></span>');let e={cmd:"save"};e.recid=a.recid,e.name=a.name,w2utils.extend(e,a.postData),w2utils.extend(e,r),a.multipart||a.fields.forEach(e=>{"file"===e.type&&Array.isArray(a.getValue(e.field))&&a.getValue(e.field).forEach(e=>{delete e.file})}),e.record=w2utils.clone(a.record);let l=a.trigger("submit",{target:a.name,url:a.url,method:a.method,postData:e,httpHeaders:a.httpHeaders});if(!0!==l.isCancelled){let t=l.detail.url;if("object"==typeof t&&t.save&&(t=t.save),0<Object.keys(a.routeData).length){var o=w2utils.parseRoute(t);if(0<o.keys.length)for(let e=0;e<o.keys.length;e++)null!=a.routeData[o.keys[e].name]&&(t=t.replace(new RegExp(":"+o.keys[e].name,"g"),a.routeData[o.keys[e].name]))}t=new URL(t,location);let i={method:"POST",headers:l.detail.httpHeaders,body:l.detail.postData};r=l.detail.dataType??this.dataType??w2utils.settings.dataType;let s=l.detail.postData;switch(r){case"HTTP":i.type="GET",Object.keys(s).forEach(e=>t.searchParams.append(e,s[e])),delete i.body;break;case"HTTPJSON":i.type="GET",s=JSON.stringify({request:s}),Object.keys(s).forEach(e=>t.searchParams.append(e,s[e])),delete i.body;break;case"RESTFULL":break;case"RESTFULLJSON":i.body=JSON.stringify(i.body),i.headers.contentType="application/json";break;case"JSON":if(i.headers.contentType="application/json",a.multipart){function h(e,t,i,s){for(var l in null==s&&(s=""),t){var r=""==s?l:"${p}[${prop}]",n=i&&i[l];!function t(i,s,l){if("object"==typeof i&&i instanceof File&&e.append(l,i),"object"==typeof i)if(i&&i.constructor===Array)for(let e=0;e<i.length;e++){var r=s&&s[e];t(i[e],r,l+"["+e+"]")}else h(e,i,s,l)}(t[l],n,r)}}let e=new FormData;e.append("__body",JSON.stringify(i.body)),h(e,i.body),i.body=e}else i.body=JSON.stringify(i.body)}function d(e){a.unlock();let t=a.trigger("error",{response:e,xhr:a.last.xhr});!0!==t.isCancelled&&(e.status&&200!=e.status?a.error(e.status+": "+e.statusText):(console.log("ERROR: Server request failed.",e,". ","Expected Response:",{error:!1,record:{field1:1,field2:"item"}},"OR:",{error:!0,message:"Error description"}),a.error(String(e))),t.finish())}this.method&&(i.method=this.method),l.detail.method&&(i.method=l.detail.method),this.last.xhr=fetch(t,i).catch(d).then(e=>{if(a.unlock(),200==e.status){let t=a.trigger("save",{target:a.name,xhr:this.last.xhr,data:e});!0!==t.isCancelled&&e.json().catch(d).then(e=>{!0===e.error?a.error(w2utils.lang(e.message)):a.original=null,t.finish(),a.refresh(),"function"==typeof n&&n(e,this.last.xhr)})}else d(e)}),l.finish()}}else console.log("ERROR: Form cannot be saved because no url is defined.")}lock(e,t){let i=Array.from(arguments);i.unshift(this.box),w2utils.lock(...i)}unlock(e){var t=this.box;w2utils.unlock(t,e)}lockPage(e,t,i){e=query(this.box).find(".page-"+e);return!!e.length&&(w2utils.lock(e,t,i),!0)}unlockPage(e,t){e=query(this.box).find(".page-"+e);return!!e.length&&(w2utils.unlock(e,t),!0)}goto(e){this.page!==e&&(null!=e&&(this.page=e),!0===query(this.box).data("autoSize")&&(query(this.box).get(0).clientHeight=0),this.refresh())}generateHTML(){let l=[],t="",r,n,a,o;var h;for(let e=0;e<this.fields.length;e++){a="",o=this.tabindexBase+e+1,h=' tabindex="'+o+'"';let i=this.fields[e];null==i.html&&(i.html={}),null==i.options&&(i.options={}),null!=i.html.caption&&null==i.html.label&&(console.log("NOTICE: form field.html.caption property is deprecated, please use field.html.label. Field ->",i),i.html.label=i.html.caption),null==i.html.label&&(i.html.label=i.field),i.html=w2utils.extend({label:"",span:6,attr:"",text:"",style:"",page:0,column:0},i.html),null==r&&(r=i.html.page),null==n&&(n=i.html.column);let s=`<input id="${i.field}" name="${i.field}" class="w2ui-input" type="text" ${i.html.attr+h}>`;switch(i.type){case"pass":case"password":s=s.replace('type="text"','type="password"');break;case"checkbox":s=`
                        <label class="w2ui-box-label">
                            <input id="${i.field}" name="${i.field}" class="w2ui-input" type="checkbox" ${i.html.attr+h}>
                            <span>${i.html.label}</span>
                        </label>`;break;case"check":case"checks":{null==i.options.items&&null!=i.html.items&&(i.options.items=i.html.items);let t=i.options.items;s="",Array.isArray(t)||(t=[]),0<t.length&&(t=w2utils.normMenu.call(this,t,i));for(let e=0;e<t.length;e++)s+=`
                            <label class="w2ui-box-label">
                                <input id="${i.field+e}" name="${i.field}" class="w2ui-input" type="checkbox"
                                    ${i.html.attr+h} data-value="${t[e].id}" data-index="${e}">
                                <span>&#160;${t[e].text}</span>
                            </label>
                            <br>`;break}case"radio":{s="",null==i.options.items&&null!=i.html.items&&(i.options.items=i.html.items);let t=i.options.items;Array.isArray(t)||(t=[]),0<t.length&&(t=w2utils.normMenu.call(this,t,i));for(let e=0;e<t.length;e++)s+=`
                            <label class="w2ui-box-label">
                                <input id="${i.field+e}" name="${i.field}" class="w2ui-input" type="radio"
                                    ${i.html.attr+(0===e?h:"")}
                                    data-value="${t[e].id}" data-index="${e}">
                                <span>&#160;${t[e].text}</span>
                            </label>
                            <br>`;break}case"select":{s=`<select id="${i.field}" name="${i.field}" class="w2ui-input" ${i.html.attr+h}>`,null==i.options.items&&null!=i.html.items&&(i.options.items=i.html.items);let t=i.options.items;Array.isArray(t)||(t=[]),0<t.length&&(t=w2utils.normMenu.call(this,t,i));for(let e=0;e<t.length;e++)s+=`<option value="${t[e].id}">${t[e].text}</option>`;s+="</select>";break}case"textarea":s=`<textarea id="${i.field}" name="${i.field}" class="w2ui-input" ${i.html.attr+h}></textarea>`;break;case"toggle":s=`<input id="${i.field}" name="${i.field}" class="w2ui-input w2ui-toggle" type="checkbox" ${i.html.attr+h}>
                            <div><div></div></div>`;break;case"map":case"array":i.html.key=i.html.key||{},i.html.value=i.html.value||{},i.html.tabindex_str=h,s='<span style="float: right">'+(i.html.text||"")+'</span><input id="'+i.field+'" name="'+i.field+'" type="hidden" '+i.html.attr+h+'><div class="w2ui-map-container"></div>';break;case"div":case"custom":s='<div id="'+i.field+'" name="'+i.field+'" '+i.html.attr+h+' class="w2ui-input">'+(i&&i.html&&i.html.html?i.html.html:"")+"</div>";break;case"html":case"empty":s=i&&i.html?(i.html.html||"")+(i.html.text||""):""}if(""!==t&&(r!=i.html.page||n!=i.html.column||i.html.group&&t!=i.html.group)&&(l[r][n]+="\n   </div>\n  </div>",t=""),i.html.group&&t!=i.html.group){let e="";i.html.groupCollapsible&&(e='<span class="w2ui-icon-collapse" style="width: 15px; display: inline-block; position: relative; top: -2px;"></span>'),a+='\n <div class="w2ui-group">\n   <div class="w2ui-group-title w2ui-eaction" style="'+(i.html.groupTitleStyle||"")+"; "+(""!=e?"cursor: pointer; user-select: none":"")+'"'+(""!=e?'data-group="'+w2utils.base64encode(i.html.group)+'"':"")+(""!=e?'data-click="toggleGroup|'+i.html.group+'"':"")+">"+e+w2utils.lang(i.html.group)+'</div>\n   <div class="w2ui-group-fields" style="'+(i.html.groupStyle||"")+'">',t=i.html.group}if(null==i.html.anchor){let e=null!=i.html.span?"w2ui-span"+i.html.span:"";-1==i.html.span&&(e="w2ui-span-none");let t="<label"+("none"==e?' style="display: none"':"")+">"+w2utils.lang("checkbox"!=i.type?i.html.label:i.html.text)+"</label>";i.html.label||(t=""),a+='\n      <div class="w2ui-field '+e+'" style="'+(i.hidden?"display: none;":"")+i.html.style+'">\n         '+t+("empty"===i.type?s:"\n         <div>"+s+("array"!=i.type&&"map"!=i.type?w2utils.lang("checkbox"!=i.type?i.html.text:""):"")+"</div>")+"\n      </div>"}else l[i.html.page].anchors=l[i.html.page].anchors||{},l[i.html.page].anchors[i.html.anchor]='<div class="w2ui-field w2ui-field-inline" style="'+(i.hidden?"display: none;":"")+i.html.style+'">'+("empty"===i.type?s:"<div>"+w2utils.lang("checkbox"!=i.type?i.html.label:i.html.text,!0)+s+w2utils.lang("checkbox"!=i.type?i.html.text:"")+"</div>")+"</div>";null==l[i.html.page]&&(l[i.html.page]={}),null==l[i.html.page][i.html.column]&&(l[i.html.page][i.html.column]=""),l[i.html.page][i.html.column]+=a,r=i.html.page,n=i.html.column}if(""!==t&&(l[r][n]+="\n   </div>\n  </div>"),this.tabs.tabs)for(let e=0;e<this.tabs.tabs.length;e++)null==l[e]&&(l[e]=[]);let i="";if(0<Object.keys(this.actions).length){for(var s in i+='\n<div class="w2ui-buttons">',o=this.tabindexBase+this.fields.length+1,this.actions){let e=this.actions[s],t={text:"",style:"",class:""};w2utils.isPlainObject(e)?(null==e.text&&null!=e.caption&&(console.log("NOTICE: form action.caption property is deprecated, please use action.text. Action ->",e),e.text=e.caption),e.text&&(t.text=e.text),e.style&&(t.style=e.style),e.class&&(t.class=e.class)):(t.text=s,-1!==["save","update","create"].indexOf(s.toLowerCase())?t.class="w2ui-btn-blue":t.class=""),i+='\n    <button name="'+s+'" class="w2ui-btn '+t.class+'" style="'+t.style+'" tabindex="'+o+'">'+w2utils.lang(t.text)+"</button>",o++}i+="\n</div>"}a="";for(let i=0;i<l.length;i++){if(a+='<div class="w2ui-page page-'+i+'" style="'+(0!==i?"display: none;":"")+this.pageStyle+'">',!l[i])return console.log(`ERROR: Page ${i} does not exist`),!1;l[i].before&&(a+=l[i].before),a+='<div class="w2ui-column-container">',Object.keys(l[i]).sort().forEach((e,t)=>{e==parseInt(e)&&(a+='<div class="w2ui-column col-'+e+'">'+(l[i][e]||"")+"\n</div>")}),a+="\n</div>",l[i].after&&(a+=l[i].after),a+="\n</div>",l[i].anchors&&Object.keys(l[i].anchors).forEach((e,t)=>{a=a.replace(e,l[i].anchors[e])})}return a+=i,a}toggleGroup(e,t){let i=query(this.box).find('.w2ui-group-title[data-group="'+w2utils.base64encode(e)+'"]');if(0!==i.length){let e=query(i.prop("nextElementSibling"));(t=void 0===t?"none"==e.css("display"):t)?(e.show(),i.find("span").addClass("w2ui-icon-collapse").removeClass("w2ui-icon-expand")):(e.hide(),i.find("span").addClass("w2ui-icon-expand").removeClass("w2ui-icon-collapse"))}}action(e,t){var i=this.actions[e];let s=i;w2utils.isPlainObject(i)&&i.onClick&&(s=i.onClick);let l=this.trigger("action",{target:e,action:i,originalEvent:t});!0!==l.isCancelled&&("function"==typeof s&&s.call(this,t),l.finish())}resize(){let d=this,e=this.trigger("resize",{target:this.name});if(!0!==e.isCancelled){let l=query(this.box).find(":scope > div.w2ui-form-box"),r=query(this.box).find(":scope > div .w2ui-form-header"),n=query(this.box).find(":scope > div .w2ui-form-toolbar"),a=query(this.box).find(":scope > div .w2ui-form-tabs"),o=query(this.box).find(":scope > div .w2ui-page");var t=query(this.box).find(":scope > div .w2ui-page.page-"+this.page+" > div");let h=query(this.box).find(":scope > div .w2ui-buttons");var{headerHeight:i,tbHeight:s,tabsHeight:u}=c();function c(){var e=d.box.getBoundingClientRect(),t=""!==d.header?w2utils.getSize(r,"height"):0,i=Array.isArray(d.toolbar?.items)&&0<d.toolbar?.items?.length?w2utils.getSize(n,"height"):0,s=Array.isArray(d.tabs?.tabs)&&0<d.tabs?.tabs?.length?w2utils.getSize(a,"height"):0;return l.css({width:e.width+"px",height:e.height+"px"}),n.css({top:t+"px"}),a.css({top:t+i+"px"}),o.css({top:t+i+s+"px"}),o.css({bottom:(0<h.length?w2utils.getSize(h,"height"):0)+"px"}),{width:e.width,height:e.height,headerHeight:t,tbHeight:i,tabsHeight:s}}this.autosize&&(0!==query(this.box).get(0).clientHeight&&"yes"!=query(this.box).data("autosize")||(query(this.box).css({height:i+s+u+15+(0<o.length?w2utils.getSize(t,"height"):0)+(0<h.length?w2utils.getSize(h,"height"):0)+"px"}),query(this.box).data("autosize","yes")),c()),e.finish()}}refresh(){var t=(new Date).getTime();let c=this;if(this.box&&this.isGenerated&&query(this.box).html()){let e=this.trigger("refresh",{target:this.name,page:this.page,field:arguments[0],fields:arguments});if(!0!==e.isCancelled){let s=Array.from(this.fields.keys());0<arguments.length?s=Array.from(arguments).map((e,t)=>("string"!=typeof e&&console.log("ERROR: Arguments in refresh functions should be field names"),this.get(e,!0))).filter((e,t)=>null!=e):(query(this.box).find("input, textarea, select").each(e=>{var t=null!=query(e).attr("name")?query(e).attr("name"):query(e).attr("id");let i=this.get(t);if(i){let t=query(e).closest(".w2ui-page");if(0<t.length)for(let e=0;e<100;e++)if(t.hasClass("page-"+e)){i.page=e;break}}}),query(this.box).find(".w2ui-page").hide(),query(this.box).find(".w2ui-page.page-"+this.page).show(),query(this.box).find(".w2ui-form-header").html(w2utils.lang(this.header)),"object"==typeof this.tabs&&Array.isArray(this.tabs.tabs)&&0<this.tabs.tabs.length?(query(this.box).find("#form_"+this.name+"_tabs").show(),this.tabs.active=this.tabs.tabs[this.page].id,this.tabs.refresh()):query(this.box).find("#form_"+this.name+"_tabs").hide(),"object"==typeof this.toolbar&&Array.isArray(this.toolbar.items)&&0<this.toolbar.items.length?(query(this.box).find("#form_"+this.name+"_toolbar").show(),this.toolbar.refresh()):query(this.box).find("#form_"+this.name+"_toolbar").hide());for(let t=0;t<s.length;t++){let l=this.fields[s[t]];null==l.name&&null!=l.field&&(l.name=l.field),null==l.field&&null!=l.name&&(l.field=l.name),l.$el=query(this.box).find(`[name='${String(l.name).replace(/\\/g,"\\\\")}']`),l.el=l.$el.get(0),l.el&&(l.el.id=l.name),l.w2field&&l.w2field.reset(),l.$el.off(".w2form").on("change.w2form",function(e){let t=c.getFieldValue(l.field);var i;["enum","file"].includes(l.type)&&(i=l.el._w2field?.helpers?.multi,query(i).removeClass("w2ui-error")),null!=this._previous&&(t.previous=this._previous,delete this._previous);let s=c.trigger("change",{target:this.name,field:this.name,value:t,originalEvent:e});!0!==s.isCancelled&&(c.setValue(this.name,t.current),s.finish())}).on("input.w2form",function(e){null==c.original&&(0<Object.keys(c.record).length?c.original=w2utils.clone(c.record):c.original={});var t=c.getFieldValue(l.field);null==this._previous&&(this._previous=t.previous);let i=c.trigger("input",{target:c.name,value:t,originalEvent:e});!0!==i.isCancelled&&(c.setValue(this.name,t.current),i.finish())}),l.required?l.$el.closest(".w2ui-field").addClass("w2ui-required"):l.$el.closest(".w2ui-field").removeClass("w2ui-required"),null!=l.disabled&&(l.disabled?(null==l.$el.data("tabIndex")&&l.$el.data("tabIndex",l.$el.prop("tabIndex")),l.$el.prop("readonly",!0).prop("tabindex",-1).closest(".w2ui-field").addClass("w2ui-disabled")):l.$el.prop("readonly",!1).prop("tabIndex",l.$el.data("tabIndex")).closest(".w2ui-field").removeClass("w2ui-disabled"));let e=l.el;e=e||query(this.box).find("#"+l.field),l.hidden?query(e).closest(".w2ui-field").hide():query(e).closest(".w2ui-field").show()}query(this.box).find("button, input[type=button]").each(e=>{query(e).off("click").on("click",function(e){let t=this.value;this.id&&(t=this.id),this.name&&(t=this.name),c.action(t,e)})});for(let e=0;e<s.length;e++){let i=this.fields[s[e]];var l,r=this.getValue(i.name)??"";if(i.el){if(i.$el.hasClass("w2ui-input")||i.$el.addClass("w2ui-input"),i.type=String(i.type).toLowerCase(),i.options||(i.options={}),this.LIST_TYPES.includes(i.type)&&(null==(l=i.options.items)&&(i.options.items=[]),i.options.items=w2utils.normMenu.call(this,l,i)),"select"==i.type){let e=i.options.items,t="";e.forEach(e=>{t+=`<option value="${e.id}">${e.text}</option>`}),i.$el.html(t)}this.W2FIELD_TYPES.includes(i.type)&&(i.w2field=i.w2field??new w2field(w2utils.extend({},i.options,{type:i.type})),i.w2field.render(i.el)),["map","array"].includes(i.type)&&function(d){let u;d.el.mapAdd=function(e,t,i){var s=(e.disabled?" readOnly ":"")+(e.html.tabindex_str||""),e=`
                            <div class="w2ui-map-field" style="margin-bottom: 5px" data-index="${i}">
                            ${"map"==e.type?`<input type="text" ${e.html.key.attr+s} class="w2ui-input w2ui-map key">
                                    ${e.html.key.text||""}
                                `:""}
                            <input type="text" ${e.html.value.attr+s} class="w2ui-input w2ui-map value">
                                ${e.html.value.text||""}
                            </div>`;t.append(e)},d.el.mapRefresh=function(l,n){let r,a,o;var h;"map"==d.type&&(null==(l=!w2utils.isPlainObject(l)?{}:l)._order&&(l._order=Object.keys(l)),r=l._order),"array"==d.type&&(Array.isArray(l)||(l=[]),r=l.map((e,t)=>t));for(let e=n.find(".w2ui-map-field").length-1;e>=r.length;e--)n.find(`div[data-index='${e}']`).remove();for(let s=0;s<r.length;s++){let t=r[s],e=n.find(`div[data-index='${s}']`);0==e.length&&(d.el.mapAdd(d,n,s),e=n.find(`div[data-index='${s}']`)),e.attr("data-key",t),a=e.find(".w2ui-map.key"),o=e.find(".w2ui-map.value");let i=l[t];"array"!=d.type||0<(h=l.filter(e=>e.key==t)).length&&(i=h[0].value),a.val(t),o.val(i),!0!==d.disabled&&!1!==d.disabled||(a.prop("readOnly",!!d.disabled),o.prop("readOnly",!!d.disabled))}var e=r.length;let t=n.find(`div[data-index='${e}']`);0!==t.length||a&&""==a.val()&&""==o.val()||a&&(!0===a.prop("readOnly")||!0===a.prop("disabled"))||d.el.mapAdd(d,n,e),!0!==d.disabled&&!1!==d.disabled||(t.find(".key").prop("readOnly",!!d.disabled),t.find(".value").prop("readOnly",!!d.disabled));e=query(d.el).get(0)?.nextSibling;query(e).find("input.w2ui-map").off(".mapChange").on("keyup.mapChange",function(e){let t=query(e.target).closest(".w2ui-map-field");var i=t.get(0).nextElementSibling,s=t.get(0).previousElementSibling;if(13==e.keyCode){var l=u??i;if(l instanceof HTMLElement){let e=query(l).find("input");0<e.length&&e.get(0).focus()}u=void 0}l=query(e.target).hasClass("key")?"key":"value";38==e.keyCode&&s&&(query(s).find(`input.${l}`).get(0).select(),e.preventDefault()),40==e.keyCode&&i&&(query(i).find(`input.${l}`).get(0).select(),e.preventDefault())}).on("keydown.mapChange",function(e){38!=e.keyCode&&40!=e.keyCode||e.preventDefault()}).on("input.mapChange",function(e){let t=query(e.target).closest("div");var i=t.data("index"),e=t.get(0).nextElementSibling;if(""==t.find("input").val()||e){if(""==t.find("input").val()&&e){let t=!0;query(e).find("input").each(e=>{""!=e.value&&(t=!1)}),t&&query(e).remove()}}else d.el.mapAdd(d,n,parseInt(i)+1)}).on("change.mapChange",function(e){null==c.original&&(0<Object.keys(c.record).length?c.original=w2utils.clone(c.record):c.original={});let{current:t,previous:i,original:s}=c.getFieldValue(d.field),l=query(e.target).closest(".w2ui-map-container");"map"==d.type&&(t._order=[]),l.find(".w2ui-map.key").each(e=>{t._order.push(e.value)});let r=c.trigger("change",{target:d.field,field:d.field,originalEvent:e,value:{current:t,previous:i,original:s}});!0!==r.isCancelled&&("map"==d.type&&(t._order=t._order.filter(e=>""!==e),delete t[""]),"array"==d.type&&(t=t.filter(e=>""!==e)),""==query(e.target).parent().find("input").val()&&(u=e.target),c.setValue(d.field,t),d.el.mapRefresh(t,n),r.finish())})}}(i),this.setFieldValue(i.field,r),i.$el.trigger("change")}}return e.finish(),this.resize(),(new Date).getTime()-t}}}render(t){var i=(new Date).getTime();let s=this;if("object"==typeof t&&(0<query(this.box).find("#form_"+this.name+"_tabs").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-form").html(""),this.box=t),(this.isGenerated||this.formHTML)&&this.box){let e=this.trigger("render",{target:this.name,box:null!=t?t:this.box});if(!0!==e.isCancelled){t='<div class="w2ui-form-box">'+(""!==this.header?'<div class="w2ui-form-header">'+w2utils.lang(this.header)+"</div>":"")+'    <div id="form_'+this.name+'_toolbar" class="w2ui-form-toolbar" style="display: none"></div>    <div id="form_'+this.name+'_tabs" class="w2ui-form-tabs" style="display: none"></div>'+this.formHTML+"</div>";if(query(this.box).attr("name",this.name).addClass("w2ui-reset w2ui-form").html(t),0<query(this.box).length&&(query(this.box)[0].style.cssText+=this.style),w2utils.bindEvents(query(this.box).find(".w2ui-eaction"),this),"function"!=typeof this.toolbar.render&&(this.toolbar=new w2toolbar(w2utils.extend({},this.toolbar,{name:this.name+"_toolbar",owner:this})),this.toolbar.on("click",function(e){let t=s.trigger("toolbar",{target:e.target,originalEvent:e});!0!==t.isCancelled&&t.finish()})),"object"==typeof this.toolbar&&"function"==typeof this.toolbar.render&&this.toolbar.render(query(this.box).find("#form_"+this.name+"_toolbar")[0]),"function"!=typeof this.tabs.render&&(this.tabs=new w2tabs(w2utils.extend({},this.tabs,{name:this.name+"_tabs",owner:this,active:this.tabs.active})),this.tabs.on("click",function(e){s.goto(this.get(e.target,!0))})),"object"==typeof this.tabs&&"function"==typeof this.tabs.render&&(this.tabs.render(query(this.box).find("#form_"+this.name+"_tabs")[0]),this.tabs.active&&this.tabs.click(this.tabs.active)),e.finish(),this.resize(),("object"!=typeof this.url?this.url:this.url.get)&&0!==this.recid&&null!=this.recid?this.request():this.refresh(),this.last.observeResize=new ResizeObserver(()=>{this.resize()}),this.last.observeResize.observe(this.box),-1!=this.focus){let e=0,t=()=>{0<query(s.box).find("input, select, textarea").length?s.setFocus():(e++,e<20&&setTimeout(t,50))};t()}return(new Date).getTime()-i}}}setFocus(e){void 0===e&&(e=this.focus);let t;if(w2utils.isInt(e)){if(e<0)return;for(var i=query(this.box).find("div:not(.w2ui-field-helper) > input, select, textarea, div > label:nth-child(1) > [type=radio]").filter(":not(.file-input)");null==i[e].offsetParent&&i.length>=e;)e++;i[e]&&(t=query(i[e]))}else"string"==typeof e&&(t=query(this.box).find(`[name='${e}']`));return 0<t.length&&t.get(0).focus(),t}destroy(){let e=this.trigger("destroy",{target:this.name});!0!==e.isCancelled&&("object"==typeof this.toolbar&&this.toolbar.destroy&&this.toolbar.destroy(),"object"==typeof this.tabs&&this.tabs.destroy&&this.tabs.destroy(),0<query(this.box).find("#form_"+this.name+"_tabs").length&&query(this.box).removeAttr("name").removeClass("w2ui-reset w2ui-form").html(""),this.last.observeResize?.disconnect(),delete w2ui[this.name],e.finish())}}class w2field extends w2base{constructor(e,t){super(),"string"==typeof e&&null==t&&(t={type:e}),"object"==typeof e&&null==t&&(t=w2utils.clone(e)),"string"==typeof e&&"object"==typeof t&&(t.type=e),t.type=String(t.type).toLowerCase(),this.el=t.el??null,this.selected=null,this.helpers={},this.type=t.type??"text",this.options=w2utils.clone(t),this.onSearch=t.onSearch??null,this.onRequest=t.onRequest??null,this.onLoad=t.onLoad??null,this.onError=t.onError??null,this.onClick=t.onClick??null,this.onAdd=t.onAdd??null,this.onNew=t.onNew??null,this.onRemove=t.onRemove??null,this.onMouseEnter=t.onMouseEnter??null,this.onMouseLeave=t.onMouseLeave??null,this.onScroll=t.onScroll??null,this.tmp={},delete this.options.type,delete this.options.onSearch,delete this.options.onRequest,delete this.options.onLoad,delete this.options.onError,delete this.options.onClick,delete this.options.onMouseEnter,delete this.options.onMouseLeave,delete this.options.onScroll,this.el&&this.render(this.el)}render(e){e instanceof HTMLElement?(e._w2field?e._w2field.reset():e._w2field=this,this.el=e,this.init()):console.log("ERROR: Cannot init w2field on empty subject")}init(){let t=this.options,e;if(["INPUT","TEXTAREA"].includes(this.el.tagName.toUpperCase())){switch(this.type){case"text":case"int":case"float":case"money":case"currency":case"percent":case"alphanumeric":case"bin":case"hex":e={min:null,max:null,step:1,autoFormat:!0,autoCorrect:!0,currencyPrefix:w2utils.settings.currencyPrefix,currencySuffix:w2utils.settings.currencySuffix,currencyPrecision:w2utils.settings.currencyPrecision,decimalSymbol:w2utils.settings.decimalSymbol,groupSymbol:w2utils.settings.groupSymbol,arrow:!1,keyboard:!0,precision:null,prefix:"",suffix:""},this.options=w2utils.extend({},e,t),t=this.options,t.numberRE=new RegExp("["+t.groupSymbol+"]","g"),t.moneyRE=new RegExp("["+t.currencyPrefix+t.currencySuffix+t.groupSymbol+"]","g"),t.percentRE=new RegExp("["+t.groupSymbol+"%]","g"),["text","alphanumeric","hex","bin"].includes(this.type)&&(t.arrow=!1,t.keyboard=!1);break;case"color":e={prefix:"#",suffix:`<div style="width: ${parseInt(getComputedStyle(this.el)["font-size"])||12}px">&#160;</div>`,arrow:!1,advanced:null,transparent:!0},this.options=w2utils.extend({},e,t),t=this.options;break;case"date":e={format:w2utils.settings.dateFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:!0},this.options=w2utils.extend({type:"date"},e,t),t=this.options,null==query(this.el).attr("placeholder")&&query(this.el).attr("placeholder",t.format);break;case"time":e={format:w2utils.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,btnNow:!0,noMinutes:!1},this.options=w2utils.extend({type:"time"},e,t),t=this.options,null==query(this.el).attr("placeholder")&&query(this.el).attr("placeholder",t.format);break;case"datetime":e={format:w2utils.settings.dateFormat+"|"+w2utils.settings.timeFormat,keyboard:!0,autoCorrect:!0,start:null,end:null,startTime:null,endTime:null,blockDates:[],blockWeekdays:[],colored:{},btnNow:!0,noMinutes:!1},this.options=w2utils.extend({type:"datetime"},e,t),t=this.options,null==query(this.el).attr("placeholder")&&query(this.el).attr("placeholder",t.placeholder||t.format);break;case"list":case"combo":e={items:[],selected:{},url:null,recId:null,recText:null,method:null,interval:350,postData:{},minLength:1,cacheMax:250,maxDropHeight:350,maxDropWidth:null,minDropWidth:null,match:"begins",icon:null,iconStyle:"",align:"both",altRows:!0,onSearch:null,onRequest:null,onLoad:null,onError:null,renderDrop:null,compare:null,filter:!0,hideSelected:!1,prefix:"",suffix:"",openOnFocus:!1,markSearch:!1},"function"==typeof t.items&&(t._items_fun=t.items),t.items=w2utils.normMenu.call(this,t.items),"list"===this.type&&(query(this.el).addClass("w2ui-select"),!w2utils.isPlainObject(t.selected)&&Array.isArray(t.items)&&t.items.forEach(e=>{e&&e.id===t.selected&&(t.selected=w2utils.clone(e))})),t=w2utils.extend({},e,t),this.options=t,w2utils.isPlainObject(t.selected)||(t.selected={}),this.selected=t.selected,query(this.el).attr("autocapitalize","off").attr("autocomplete","off").attr("autocorrect","off").attr("spellcheck","false"),null!=t.selected.text&&query(this.el).val(t.selected.text);break;case"enum":e={items:[],selected:[],max:0,url:null,recId:null,recText:null,interval:350,method:null,postData:{},minLength:1,cacheMax:250,maxItemWidth:250,maxDropHeight:350,maxDropWidth:null,match:"contains",align:"both",altRows:!0,openOnFocus:!1,markSearch:!1,renderDrop:null,renderItem:null,compare:null,filter:!0,hideSelected:!0,style:"",onSearch:null,onRequest:null,onLoad:null,onError:null,onClick:null,onAdd:null,onNew:null,onRemove:null,onMouseEnter:null,onMouseLeave:null,onScroll:null},t=w2utils.extend({},e,t,{suffix:""}),"function"==typeof t.items&&(t._items_fun=t.items),t.items=w2utils.normMenu.call(this,t.items),t.selected=w2utils.normMenu.call(this,t.selected),this.options=t,Array.isArray(t.selected)||(t.selected=[]),this.selected=t.selected;break;case"file":e={selected:[],max:0,maxSize:0,maxFileSize:0,maxItemWidth:250,maxDropHeight:350,maxDropWidth:null,readContent:!0,silent:!0,align:"both",altRows:!0,renderItem:null,style:"",onClick:null,onAdd:null,onRemove:null,onMouseEnter:null,onMouseLeave:null},t=w2utils.extend({},e,t),this.options=t,Array.isArray(t.selected)||(t.selected=[]),this.selected=t.selected,null==query(this.el).attr("placeholder")&&query(this.el).attr("placeholder",w2utils.lang("Attach files by dragging and dropping or Click to Select"))}query(this.el).css("box-sizing","border-box").addClass("w2field w2ui-input").off(".w2field").on("change.w2field",e=>{this.change(e)}).on("click.w2field",e=>{this.click(e)}).on("focus.w2field",e=>{this.focus(e)}).on("blur.w2field",e=>{"list"!==this.type&&this.blur(e)}).on("keydown.w2field",e=>{this.keyDown(e)}).on("keyup.w2field",e=>{this.keyUp(e)}),this.addPrefix(),this.addSuffix(),this.addSearch(),this.addMultiSearch(),this.refresh(),this.change(new Event("change"))}else console.log("ERROR: w2field could only be applied to INPUT or TEXTAREA.",this.el)}get(){let e;return e=-1!==["list","enum","file"].indexOf(this.type)?this.selected:query(this.el).val(),e}set(t,e){if(-1!==["list","enum","file"].indexOf(this.type)){if("list"!==this.type&&e){Array.isArray(this.selected)||(this.selected=[]),this.selected.push(t);let e=w2menu.get(this.el.id+"_menu");e&&(e.options.selected=this.selected),query(this.el).trigger("input").trigger("change")}else{e="enum"===this.type?[t]:t;this.selected=e,query(this.el).trigger("input").trigger("change")}this.refresh()}else query(this.el).val(t)}setIndex(t,i){if(-1!==["list","enum"].indexOf(this.type)){var s=this.options.items;if(s&&s[t]){"list"==this.type&&(this.selected=s[t]),"enum"==this.type&&(i||(this.selected=[]),this.selected.push(s[t]));let e=w2menu.get(this.el.id+"_menu");return e&&(e.options.selected=this.selected),query(this.el).trigger("input").trigger("change"),this.refresh(),!0}}return!1}refresh(){let s=this.options;var i,l,e=(new Date).getTime(),t=getComputedStyle(this.el);if("list"==this.type){if(query(this.el).parent().css("white-space","nowrap"),this.helpers.prefix&&this.helpers.prefix.hide(),!this.helpers.search)return;null==this.selected&&s.icon?s.prefix=`
                    <span class="w2ui-icon ${s.icon} "style="cursor: pointer; font-size: 14px;
                        display: inline-block; margin-top: -1px; color: #7F98AD; ${s.iconStyle}">
                    </span>`:s.prefix="",this.addPrefix();let e=query(this.helpers.search_focus),t=query(e[0].previousElementSibling);e.css({outline:"none"}),""===e.val()?(e.css("opacity",0),t.css("opacity",0),this.selected&&this.selected.id&&(i=this.selected.text,l=this.findItemIndex(s.items,this.selected.id),null!=i&&(query(this.el).val(w2utils.lang(i)),query(this.helpers.search_focus).data({selected:i,selectedIndex:l[0]})))):(e.css("opacity",1),t.css("opacity",1),query(this.el).val(""),setTimeout(()=>{this.helpers.prefix&&this.helpers.prefix.hide(),s.icon?(e.css("margin-left","17px"),query(this.helpers.search).find(".w2ui-icon-search").addClass("show-search")):(e.css("margin-left","0px"),query(this.helpers.search).find(".w2ui-icon-search").removeClass("show-search"))},1)),query(this.el).prop("readonly")||query(this.el).prop("disabled")?setTimeout(()=>{this.helpers.prefix&&query(this.helpers.prefix).css("opacity","0.6"),this.helpers.suffix&&query(this.helpers.suffix).css("opacity","0.6")},1):setTimeout(()=>{this.helpers.prefix&&query(this.helpers.prefix).css("opacity","1"),this.helpers.suffix&&query(this.helpers.suffix).css("opacity","1")},1)}let r=this.helpers.multi;if(["enum","file"].includes(this.type)&&r){let i="";Array.isArray(this.selected)&&this.selected.forEach((e,t)=>{i+=`
                        <div class="li-item" index="${t}" style="max-width: ${parseInt(s.maxItemWidth)}px; ${e.style||""}">
                        ${"function"==typeof s.renderItem?s.renderItem(e,t,`<div class="w2ui-list-remove" index="${t}">&#160;&#160;</div>`):`
                               ${e.icon?`<span class="w2ui-icon ${e.icon}"></span>`:""}
                               <div class="w2ui-list-remove" index="${t}">&#160;&#160;</div>
                               ${("enum"===this.type?e.text:e.name)??e.id??e}
                               ${e.size?`<span class="file-size"> - ${w2utils.formatSize(e.size)}</span>`:""}
                            `}
                        </div>`});let e=r.find(".w2ui-multi-items");if(s.style&&r.attr("style",r.attr("style")+";"+s.style),query(this.el).css("z-index","-1"),query(this.el).prop("readonly")||query(this.el).prop("disabled")?setTimeout(()=>{r[0].scrollTop=0,r.addClass("w2ui-readonly").find(".li-item").css("opacity","0.9").parent().find(".li-search").hide().find("input").prop("readonly",!0).closest(".w2ui-multi-items").find(".w2ui-list-remove").hide()},1):setTimeout(()=>{r.removeClass("w2ui-readonly").find(".li-item").css("opacity","1").parent().find(".li-search").show().find("input").prop("readonly",!1).closest(".w2ui-multi-items").find(".w2ui-list-remove").show()},1),0<this.selected?.length&&query(this.el).attr("placeholder",""),r.find(".w2ui-enum-placeholder").remove(),e.find(".li-item").remove(),""!==i?e.prepend(i):null!=query(this.el).attr("placeholder")&&""===r.find("input").val()&&(t=w2utils.stripSpaces(`
                    padding-top: ${t["padding-top"]};
                    padding-left: ${t["padding-left"]};
                    box-sizing: ${t["box-sizing"]};
                    line-height: ${t["line-height"]};
                    font-size: ${t["font-size"]};
                    font-family: ${t["font-family"]};
                `),r.prepend(`<div class="w2ui-enum-placeholder" style="${t}">${query(this.el).attr("placeholder")}</div>`)),r.off(".w2item").on("scroll.w2item",e=>{let t=this.trigger("scroll",{target:this.el,originalEvent:e});!0!==t.isCancelled&&(w2tooltip.hide(this.el.id+"_preview"),t.finish())}).find(".li-item").on("click.w2item",e=>{let s=query(e.target).closest(".li-item");var i=s.attr("index"),l=this.selected[i];if(!query(s).hasClass("li-search")){e.stopPropagation();let t;if(query(e.target).hasClass("w2ui-list-remove"))query(this.el).prop("readonly")||query(this.el).prop("disabled")||(t=this.trigger("remove",{target:this.el,originalEvent:e,item:l}),!0!==t.isCancelled&&(this.selected.splice(i,1),query(this.el).trigger("input").trigger("change"),query(e.target).remove()));else if(t=this.trigger("click",{target:this.el,originalEvent:e.originalEvent,item:l}),!0!==t.isCancelled){let e=l.tooltip;if("file"===this.type&&(/image/i.test(l.type)&&(e=`
                                    <div class="w2ui-file-preview">
                                        <img src="${l.content?"data:"+l.type+";base64,"+l.content:""}"
                                            style="max-width: 300px">
                                    </div>`),e+=`
                                <div class="w2ui-file-info">
                                    <div class="file-caption">${w2utils.lang("Name")}:</div>
                                    <div class="file-value">${l.name}</div>
                                    <div class="file-caption">${w2utils.lang("Size")}:</div>
                                    <div class="file-value">${w2utils.formatSize(l.size)}</div>
                                    <div class="file-caption">${w2utils.lang("Type")}:</div>
                                    <div class="file-value file-type">${l.type}</div>
                                    <div class="file-caption">${w2utils.lang("Modified")}:</div>
                                    <div class="file-value">${w2utils.date(l.modified)}</div>
                                </div>`),e){let i=this.el.id+"_preview";w2tooltip.show({name:i,anchor:s.get(0),html:e,hideOn:["doc-click"],class:""}).show(e=>{let t=query(`#w2overlay-${i} img`);t.on("load",function(e){var t=this.clientWidth,i=this.clientHeight;t<300&i<300||(i<=t&&300<t&&query(this).css("width","300px"),t<i&&300<i&&query(this).css("height","300px"))}).on("error",function(e){this.style.display="none"})})}t.finish()}}}).on("mouseenter.w2item",t=>{var i=query(t.target).closest(".li-item");if(!query(i).hasClass("li-search")){i=this.selected[query(t.target).attr("index")];let e=this.trigger("mouseEnter",{target:this.el,originalEvent:t,item:i});!0!==e.isCancelled&&e.finish()}}).on("mouseleave.w2item",t=>{var i=query(t.target).closest(".li-item");if(!query(i).hasClass("li-search")){i=this.selected[query(t.target).attr("index")];let e=this.trigger("mouseLeave",{target:this.el,originalEvent:t,item:i});!0!==e.isCancelled&&e.finish()}}),"enum"===this.type){let e=this.helpers.multi.find("input");e.css({width:"15px"})}else this.helpers.multi.find(".li-search").hide();this.resize()}return(new Date).getTime()-e}resize(){var e=this.el.clientWidth,t=(this.el.clientHeight,getComputedStyle(this.el)),i=this.helpers.search,s=this.helpers.multi,l=this.helpers.suffix,r=this.helpers.prefix;i&&query(i).css("width",e),s&&query(s).css("width",e-parseInt(t["margin-left"],10)-parseInt(t["margin-right"],10)),l&&this.addSuffix(),r&&this.addPrefix();l=this.helpers.multi;if(["enum","file"].includes(this.type)&&l){query(this.el).css("height","auto");let e=query(l).find(":scope div.w2ui-multi-items").get(0).clientHeight+5;e<20&&(e=20),e>this.tmp["max-height"]&&(e=this.tmp["max-height"]),e<this.tmp["min-height"]&&(e=this.tmp["min-height"]);r=w2utils.getSize(this.el,"height")-2;r>e&&(e=r),query(l).css({height:e+"px",overflow:e==this.tmp["max-height"]?"auto":"hidden"}),query(l).css("height",e+"px"),query(this.el).css({height:e+"px"})}this.tmp.current_width=e}reset(){null!=this.tmp&&(query(this.el).css("height","auto"),Array("padding-left","padding-right","background-color","border-color").forEach(e=>{this.tmp&&null!=this.tmp["old-"+e]&&(query(this.el).css(e,this.tmp["old-"+e]),delete this.tmp["old-"+e])}),clearInterval(this.tmp.sizeTimer)),query(this.el).val(this.clean(query(this.el).val())).removeClass("w2field").removeData().off(".w2field"),Object.keys(this.helpers).forEach(e=>{query(this.helpers[e]).remove()}),this.helpers={}}clean(e){if("number"==typeof e)return e;var t=this.options;return e=String(e).trim(),["int","float","money","currency","percent"].includes(this.type)&&("string"==typeof e&&(t.autoFormat&&(["money","currency"].includes(this.type)&&(e=String(e).replace(t.moneyRE,"")),"percent"===this.type&&(e=String(e).replace(t.percentRE,"")),["int","float"].includes(this.type)&&(e=String(e).replace(t.numberRE,""))),e=e.replace(/\s+/g,"").replace(new RegExp(t.groupSymbol,"g"),"").replace(t.decimalSymbol,".")),e=""!==e&&w2utils.isFloat(e)?Number(e):""),e}format(e){var t=this.options;if(t.autoFormat&&""!==e){switch(this.type){case"money":case"currency":""!==(e=w2utils.formatNumber(e,t.currencyPrecision,!0))&&(e=t.currencyPrefix+e+t.currencySuffix);break;case"percent":""!==(e=w2utils.formatNumber(e,t.precision,!0))&&(e+="%");break;case"float":e=w2utils.formatNumber(e,t.precision,!0);break;case"int":e=w2utils.formatNumber(e,0,!0)}var i=parseInt(1e3).toLocaleString(w2utils.settings.locale,{useGrouping:!0}).slice(1,2);i!==this.options.groupSymbol&&(e=e.replace(new RegExp(i,"g"),this.options.groupSymbol))}return e}change(e){if(-1!==["int","float","money","currency","percent"].indexOf(this.type)){var t=query(this.el).val(),i=this.format(this.clean(query(this.el).val()));if(""!==t&&t!=i)return query(this.el).val(i),e.stopPropagation(),e.preventDefault(),!1}if("color"===this.type){let e=query(this.el).val();"rgb"!==e.substr(0,3).toLowerCase()&&(e="#"+e,8!==(s=query(this.el).val().length)&&6!==s&&3!==s&&(e=""));var s=query(this.el).get(0).nextElementSibling;query(s).find("div").css("background-color",e),query(this.el).hasClass("has-focus")&&this.updateOverlay()}if(-1!==["list","enum","file"].indexOf(this.type)&&this.refresh(),-1!==["date","time","datetime"].indexOf(this.type)){let e=parseInt(this.el.value);w2utils.isInt(this.el.value)&&3e3<e&&("time"===this.type&&(e=w2utils.formatTime(new Date(e),this.options.format)),"date"===this.type&&(e=w2utils.formatDate(new Date(e),this.options.format)),"datetime"===this.type&&(e=w2utils.formatDateTime(new Date(e),this.options.format)),query(this.el).val(e).trigger("input").trigger("change"))}}click(e){["list","combo","enum"].includes(this.type)&&(query(this.el).hasClass("has-focus")||this.focus(e),"combo"==this.type&&this.updateOverlay(),"list"==this.type&&(this.updateOverlay(),e.stopPropagation())),["date","time","datetime","color"].includes(this.type)&&this.updateOverlay()}focus(e){if("list"!=this.type||document.activeElement!=this.el){if(-1!==["color","date","time","datetime"].indexOf(this.type)){if(query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;this.updateOverlay()}if(-1!==["list","combo","enum"].indexOf(this.type)){if(query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;if("function"==typeof this.options._items_fun&&(this.options.items=w2utils.normMenu.call(this,this.options._items_fun)),this.helpers.search){let e=this.helpers.search_focus;e.value="",e.select()}if("enum"==this.type){let e=query(this.el.previousElementSibling).find(".li-search input").get(0);document.activeElement!==e&&e.focus()}this.resize(),!1===this.options.openOnFocus&&!query(this.el).hasClass("has-focus")||setTimeout(()=>{this.updateOverlay()},100)}var t;"file"==this.type&&(t=query(this.el).get(0).previousElementSibling,query(t).addClass("has-focus")),query(this.el).addClass("has-focus")}else this.helpers.search_focus.focus()}blur(e){var i,s=query(this.el).val().trim();if(query(this.el).removeClass("has-focus"),["int","float","money","currency","percent"].includes(this.type)&&""!==s){let e=s,t="";this.isStrValid(s)?(i=this.clean(s),null!=this.options.min&&i<this.options.min&&(e=this.options.min,t=`Should be >= ${this.options.min}`),null!=this.options.max&&i>this.options.max&&(e=this.options.max,t=`Should be <= ${this.options.max}`)):e="",this.options.autoCorrect&&(query(this.el).val(e).trigger("input").trigger("change"),t&&(w2tooltip.show({name:this.el.id+"_error",anchor:this.el,html:t}),setTimeout(()=>{w2tooltip.hide(this.el.id+"_error")},3e3)))}if(["date","time","datetime"].includes(this.type)&&this.options.autoCorrect&&""!==s){let e="date"==this.type?w2utils.isDate:"time"==this.type?w2utils.isTime:w2utils.isDateTime;w2date.inRange(this.el.value,this.options)&&e.bind(w2utils)(this.el.value,this.options.format)||query(this.el).val("").trigger("input").trigger("change")}"enum"===this.type&&query(this.helpers.multi).find("input").val("").css("width","15px"),"file"==this.type&&(s=this.el.previousElementSibling,query(s).removeClass("has-focus")),"list"===this.type&&(this.el.value=this.selected?.text??"")}keyDown(i,s){var l=this.options,s=i.keyCode||s&&s.keyCode;let r=!1,t,n,a,o,e,h;if(["int","float","money","currency","percent","hex","bin","color","alphanumeric"].includes(this.type)&&!(i.metaKey||i.ctrlKey||i.altKey||this.isStrValid(i.key??"1",!0)||[9,8,13,27,37,38,39,40,46].includes(i.keyCode)))return i.preventDefault(),i.stopPropagation?i.stopPropagation():i.cancelBubble=!0,!1;if(["int","float","money","currency","percent"].includes(this.type)){if(!l.keyboard||query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;switch(t=parseFloat(query(this.el).val().replace(l.moneyRE,""))||0,n=l.step,(i.ctrlKey||i.metaKey)&&(n=10*l.step),s){case 38:if(i.shiftKey)break;e=t+n<=l.max||null==l.max?Number((t+n).toFixed(12)):l.max,query(this.el).val(e).trigger("input").trigger("change"),r=!0;break;case 40:if(i.shiftKey)break;e=t-n>=l.min||null==l.min?Number((t-n).toFixed(12)):l.min,query(this.el).val(e).trigger("input").trigger("change"),r=!0}r&&(i.preventDefault(),this.moveCaret2end())}if(["date","datetime"].includes(this.type)){if(!l.keyboard||query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;let e=("date"==this.type?w2utils.isDate:w2utils.isDateTime).bind(w2utils),t=("date"==this.type?w2utils.formatDate:w2utils.formatDateTime).bind(w2utils);switch(a=864e5,n=1,(i.ctrlKey||i.metaKey)&&(n=10),o=e(query(this.el).val(),l.format,!0),o||(o=new Date,a=0),s){case 38:if(i.shiftKey)break;10==n?o.setMonth(o.getMonth()+1):o.setTime(o.getTime()+a),h=t(o.getTime(),l.format),query(this.el).val(h).trigger("input").trigger("change"),r=!0;break;case 40:if(i.shiftKey)break;10==n?o.setMonth(o.getMonth()-1):o.setTime(o.getTime()-a),h=t(o.getTime(),l.format),query(this.el).val(h).trigger("input").trigger("change"),r=!0}r&&(i.preventDefault(),this.moveCaret2end(),this.updateOverlay())}if("time"===this.type){if(!l.keyboard||query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;n=i.ctrlKey||i.metaKey?60:1,t=query(this.el).val();let e=w2date.str2min(t)||w2date.str2min((new Date).getHours()+":"+((new Date).getMinutes()-1));switch(s){case 38:if(i.shiftKey)break;e+=n,r=!0;break;case 40:if(i.shiftKey)break;e-=n,r=!0}r&&(i.preventDefault(),query(this.el).val(w2date.min2str(e)).trigger("input").trigger("change"),this.moveCaret2end())}if(["list","enum"].includes(this.type))switch(s){case 8:case 46:if("list"==this.type){let e=query(this.helpers.search_focus);""==e.val()&&(this.selected=null,w2menu.hide(this.el.id+"_menu"),this.refresh())}else{let e=query(this.helpers.multi).find("input");if(""==e.val()){w2menu.hide(this.el.id+"_menu"),this.selected.pop();let e=w2menu.get(this.el.id+"_menu");e&&(e.options.selected=this.selected),this.refresh()}}break;case 9:case 16:break;case 27:w2menu.hide(this.el.id+"_menu"),this.refresh()}}keyUp(t){if("list"==this.type){let e=query(this.helpers.search_focus);""===e.val()?(query(e).css("opacity",0),query(this.el).attr("placeholder",this.tmp.pholder),this.el.value=this.selected?.text??""):(query(e).css("opacity",1),query(this.el).attr("placeholder",""),this.el.value=""),13==t.keyCode?setTimeout(()=>{e.val(""),w2menu.hide(this.el.id+"_menu"),this.refresh()},1):[8,9,16,27,46].includes(t.keyCode)?w2menu.hide(this.el.id+"_menu"):this.updateOverlay()}if("combo"==this.type&&this.updateOverlay(),"enum"==this.type){let e=this.helpers.multi.find("input");t=getComputedStyle(e.get(0)),t=w2utils.getStrWidth(e.val(),`font-family: ${t["font-family"]}; font-size: ${t["font-size"]};`);e.css({width:t+15+"px"}),this.resize()}}findItemIndex(e,i,s){let l=[];return s=s||[],e.forEach((e,t)=>{e.id===i&&(l=s.concat([t]),this.options.index=[t]),0==l.length&&e.items&&0<e.items.length&&(s.push(t),l=this.findItemIndex(e.items,i,s),s.pop())}),l}updateOverlay(e){let l=this.options;if("color"===this.type){if(query(this.el).prop("readonly")||query(this.el).prop("disabled"))return;w2color.show({name:this.el.id+"_color",anchor:this.el,transparent:l.transparent,advanced:l.advanced,color:this.el.value,liveUpdate:!0}).select(e=>{e=e.detail.color;query(this.el).val(e).trigger("input").trigger("change")}).liveUpdate(e=>{e=e.detail.color;query(this.helpers.suffix).find(":scope > div").css("background-color","#"+e)})}if(["list","combo","enum"].includes(this.type)){var i,s=this.el;let t=this.el;if("enum"===this.type&&(s=this.helpers.multi.get(0),t=query(s).find("input").get(0)),"list"===this.type&&(s=this.selected,w2utils.isPlainObject(s)&&0<Object.keys(s).length&&(0<(i=this.findItemIndex(l.items,s.id)).length&&(l.index=i)),t=this.helpers.search_focus),query(this.el).hasClass("has-focus")){let e=w2utils.lang("No matches");null!=l.url&&String(query(t).val()).length<l.minLength&&!0!==this.tmp.emptySet&&(e=w2utils.lang("${count} letters or more...",{count:l.minLength})),null!=l.url&&""===query(t).val()&&!0!==this.tmp.emptySet&&(e=w2utils.lang(l.msgSearch||"Type to search...")),i=w2utils.extend({},l,{name:this.el.id+"_menu",anchor:t,selected:this.selected,search:!1,render:l.renderDrop,anchorClass:"",offsetY:5,maxHeight:l.maxDropHeight,maxWidth:l.maxDropWidth,minWidth:l.minDropWidth,msgNoItems:e}),this.tmp.overlay=w2menu.show(i).select(e=>{if(["list","combo"].includes(this.type))this.selected=e.detail.item,query(t).val(""),query(this.el).val(this.selected.text).trigger("input").trigger("change");else{let i=this.selected,s=e.detail?.item;if(s){let t=this.trigger("add",{target:this.el,item:s,originalEvent:e});if(!0!==t.isCancelled){i.length>=l.max&&0<l.max&&i.pop(),delete s.hidden,i.push(s),query(this.el).trigger("input").trigger("change"),query(this.helpers.multi).find("input").val("");let e=w2menu.get(this.el.id+"_menu");e&&(e.options.selected=this.selected),t.finish()}}}})}}["date","time","datetime"].includes(this.type)&&(query(this.el).prop("readonly")||query(this.el).prop("disabled")||w2date.show(w2utils.extend({name:this.el.id+"_date",anchor:this.el,value:this.el.value},this.options)).select(e=>{e=e.detail.date;null!=e&&query(this.el).val(e).trigger("input").trigger("change")}))}isStrValid(e,t){let i=!0;switch(this.type){case"int":i=!(!t||!["-",this.options.groupSymbol].includes(e))||w2utils.isInt(e.replace(this.options.numberRE,""));break;case"percent":e=e.replace(/%/g,"");break;case"float":i=!(!t||!["-",this.options.decimalSymbol,this.options.groupSymbol].includes(e))||w2utils.isFloat(e.replace(this.options.numberRE,""));break;case"money":case"currency":i=!(!t||!["-",this.options.decimalSymbol,this.options.groupSymbol,this.options.currencyPrefix,this.options.currencySuffix].includes(e))||w2utils.isFloat(e.replace(this.options.moneyRE,""));break;case"bin":i=w2utils.isBin(e);break;case"color":case"hex":i=w2utils.isHex(e);break;case"alphanumeric":i=w2utils.isAlphaNumeric(e)}return i}addPrefix(){var e,t;this.options.prefix&&(t=getComputedStyle(this.el),null==this.tmp["old-padding-left"]&&(this.tmp["old-padding-left"]=t["padding-left"]),this.helpers.prefix&&query(this.helpers.prefix).remove(),query(this.el).before(`<div class="w2ui-field-helper">${this.options.prefix}</div>`),e=query(this.el).get(0).previousElementSibling,query(e).css({color:t.color,"font-family":t["font-family"],"font-size":t["font-size"],height:this.el.clientHeight+"px","padding-top":t["padding-top"],"padding-bottom":t["padding-bottom"],"padding-left":this.tmp["old-padding-left"],"padding-right":0,"margin-top":parseInt(t["margin-top"],10)+2+"px","margin-bottom":parseInt(t["margin-bottom"],10)+1+"px","margin-left":t["margin-left"],"margin-right":0}),query(this.el).css("padding-left",e.clientWidth+"px"),this.helpers.prefix=e)}addSuffix(){if(this.options.prefix||this.options.arrow){let e,t=this;var i=getComputedStyle(this.el);null==this.tmp["old-padding-right"]&&(this.tmp["old-padding-right"]=i["padding-right"]);var s=parseInt(i["padding-right"]||0);this.options.arrow&&(this.helpers.arrow&&query(this.helpers.arrow).remove(),query(this.el).after('<div class="w2ui-field-helper" style="border: 1px solid transparent">&#160;    <div class="w2ui-field-up" type="up">        <div class="arrow-up" type="up"></div>    </div>    <div class="w2ui-field-down" type="down">        <div class="arrow-down" type="down"></div>    </div></div>'),e=query(this.el).get(0).nextElementSibling,query(e).css({color:i.color,"font-family":i["font-family"],"font-size":i["font-size"],height:this.el.clientHeight+"px",padding:0,"margin-top":parseInt(i["margin-top"],10)+1+"px","margin-bottom":0,"border-left":"1px solid silver",width:"16px",transform:"translateX(-100%)"}).on("mousedown",function(e){query(e.target).hasClass("arrow-up")&&t.keyDown(e,{keyCode:38}),query(e.target).hasClass("arrow-down")&&t.keyDown(e,{keyCode:40})}),s+=e.clientWidth,query(this.el).css("padding-right",s+"px"),this.helpers.arrow=e),""!==this.options.suffix&&(this.helpers.suffix&&query(this.helpers.suffix).remove(),query(this.el).after(`<div class="w2ui-field-helper">${this.options.suffix}</div>`),e=query(this.el).get(0).nextElementSibling,query(e).css({color:i.color,"font-family":i["font-family"],"font-size":i["font-size"],height:this.el.clientHeight+"px","padding-top":i["padding-top"],"padding-bottom":i["padding-bottom"],"padding-left":0,"padding-right":i["padding-right"],"margin-top":parseInt(i["margin-top"],10)+2+"px","margin-bottom":parseInt(i["margin-bottom"],10)+1+"px",transform:"translateX(-100%)"}),query(this.el).css("padding-right",e.clientWidth+"px"),this.helpers.suffix=e)}}addSearch(){if("list"===this.type){this.helpers.search&&query(this.helpers.search).remove();let e=parseInt(query(this.el).attr("tabIndex"));isNaN(e)||-1===e||(this.tmp["old-tabIndex"]=e),this.tmp["old-tabIndex"]&&(e=this.tmp["old-tabIndex"]),null!=e&&!isNaN(e)||(e=0);let t="";null!=query(this.el).attr("id")&&(t='id="'+query(this.el).attr("id")+'_search"');var i=`
            <div class="w2ui-field-helper">
                <span class="w2ui-icon w2ui-icon-search"></span>
                <input ${t} type="text" tabIndex="${e}" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"/>
            </div>`;query(this.el).attr("tabindex",-1).before(i);var s=query(this.el).get(0).previousElementSibling;this.helpers.search=s,this.helpers.search_focus=query(s).find("input").get(0);i=getComputedStyle(this.el);query(s).css({width:this.el.clientWidth,"margin-top":i["margin-top"],"margin-left":i["margin-left"],"margin-bottom":i["margin-bottom"],"margin-right":i["margin-right"]}).find("input").css({cursor:"default",width:"100%",opacity:1,padding:i.padding,margin:i.margin,border:"1px solid transparent","background-color":"transparent"}),query(s).find("input").off(".helper").on("focus.helper",e=>{query(e.target).val(""),this.tmp.pholder=query(this.el).attr("placeholder")??"",this.focus(e),e.stopPropagation()}).on("blur.helper",e=>{query(e.target).val(""),null!=this.tmp.pholder&&query(this.el).attr("placeholder",this.tmp.pholder),this.blur(e),e.stopPropagation()}).on("keydown.helper",e=>{this.keyDown(e)}).on("keyup.helper",e=>{this.keyUp(e)}),query(s).on("click",e=>{query(e.target).find("input").focus()}),this.refresh()}}addMultiSearch(){if(["enum","file"].includes(this.type)){query(this.helpers.multi).remove();let e="";var l,r,n=getComputedStyle(this.el),a=w2utils.stripSpaces(`
            margin-top: 0px;
            margin-bottom: 0px;
            margin-left: ${n["margin-left"]};
            margin-right: ${n["margin-right"]};
            width: ${w2utils.getSize(this.el,"width")-parseInt(n["margin-left"],10)-parseInt(n["margin-right"],10)}px;
        `);null==this.tmp["min-height"]&&(l=this.tmp["min-height"]=parseInt(("none"!=n["min-height"]?n["min-height"]:0)||0),r=parseInt(n.height),this.tmp["min-height"]=Math.max(l,r)),null==this.tmp["max-height"]&&"none"!=n["max-height"]&&(this.tmp["max-height"]=parseInt(n["max-height"]));let t="";null!=query(this.el).attr("id")&&(t=`id="${query(this.el).attr("id")}_search"`);let i=parseInt(query(this.el).attr("tabIndex"));isNaN(i)||-1===i||(this.tmp["old-tabIndex"]=i),this.tmp["old-tabIndex"]&&(i=this.tmp["old-tabIndex"]),null!=i&&!isNaN(i)||(i=0),"enum"===this.type&&(e=`
            <div class="w2ui-field-helper w2ui-list" style="${a}">
                <div class="w2ui-multi-items">
                    <div class="li-search">
                        <input ${t} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            tabindex="${i}"
                            ${query(this.el).prop("readonly")?"readonly":""}
                            ${query(this.el).prop("disabled")?"disabled":""}>
                    </div>
                </div>
            </div>`),"file"===this.type&&(e=`
            <div class="w2ui-field-helper w2ui-list" style="${a}">
                <div class="w2ui-multi-file">
                    <input name="attachment" class="file-input" type="file" tabindex="-1"'
                        style="width: 100%; height: 100%; opacity: 0" title=""
                        ${1!==this.options.max?"multiple":""}
                        ${query(this.el).prop("readonly")?"readonly":""}
                        ${query(this.el).prop("disabled")?"disabled":""}
                        ${query(this.el).attr("accept")?' accept="'+query(this.el).attr("accept")+'"':""}>
                </div>
                <div class="w2ui-multi-items">
                    <div class="li-search" style="display: none">
                        <input ${t} type="text" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            tabindex="${i}"
                            ${query(this.el).prop("readonly")?"readonly":""}
                            ${query(this.el).prop("disabled")?"disabled":""}>
                    </div>
                </div>
            </div>`),this.tmp["old-background-color"]=n["background-color"],this.tmp["old-border-color"]=n["border-color"],query(this.el).before(e).css({"border-color":"transparent","background-color":"transparent"});let s=query(this.el.previousElementSibling);this.helpers.multi=s,query(this.el).attr("tabindex",-1),s.on("click",e=>{this.focus(e)}),s.find("input:not(.file-input)").on("click",e=>{this.click(e)}).on("focus",e=>{this.focus(e)}).on("blur",e=>{this.blur(e)}).on("keydown",e=>{this.keyDown(e)}).on("keyup",e=>{this.keyUp(e)}),"file"===this.type&&s.find("input.file-input").off(".drag").on("click.drag",e=>{e.stopPropagation(),query(this.el).prop("readonly")||query(this.el).prop("disabled")||this.focus(e)}).on("dragenter.drag",e=>{query(this.el).prop("readonly")||query(this.el).prop("disabled")||s.addClass("w2ui-file-dragover")}).on("dragleave.drag",e=>{query(this.el).prop("readonly")||query(this.el).prop("disabled")||s.removeClass("w2ui-file-dragover")}).on("drop.drag",t=>{if(!query(this.el).prop("readonly")&&!query(this.el).prop("disabled")){s.removeClass("w2ui-file-dragover");let e=Array.from(t.dataTransfer.files);e.forEach(e=>{this.addFile(e)}),this.focus(t),t.preventDefault(),t.stopPropagation()}}).on("dragover.drag",e=>{e.preventDefault(),e.stopPropagation()}).on("change.drag",e=>{void 0!==e.target.files&&Array.from(e.target.files).forEach(e=>{this.addFile(e)}),this.focus(e)}),this.refresh()}}addFile(t){var e=this.options;let i=this.selected,s={name:t.name,type:t.type,modified:t.lastModifiedDate,size:t.size,content:null,file:t},l=0,r=0,n=[];Array.isArray(i)&&i.forEach(e=>{e.name==t.name&&e.size==t.size&&n.push(w2utils.lang('The file "${name}" (${size}) is already added.',{name:t.name,size:w2utils.formatSize(t.size)})),l+=e.size,r++}),0!==e.maxFileSize&&s.size>e.maxFileSize&&n.push(w2utils.lang("Maximum file size is ${size}",{size:w2utils.formatSize(e.maxFileSize)})),0!==e.maxSize&&l+s.size>e.maxSize&&n.push(w2utils.lang("Maximum total size is ${size}",{size:w2utils.formatSize(e.maxSize)})),0!==e.max&&r>=e.max&&n.push(w2utils.lang("Maximum number of files is ${count}",{count:e.max}));let a=this.trigger("add",{target:this.el,file:s,total:r,totalSize:l,errors:n});if(!0!==a.isCancelled){if(!0!==e.silent&&0<n.length)return w2tooltip.show(this.el,"Errors: "+n.join("<br>")),void console.log("ERRORS (while adding files): ",n);if(i.push(s),"undefined"!=typeof FileReader&&!0===e.readContent){let e=new FileReader,i=this;e.onload=function(e){let t=e.target.result;e=t.indexOf(",");s.content=t.substr(e+1),i.refresh(),query(i.el).trigger("input").trigger("change"),a.finish()},e.readAsDataURL(t)}else this.refresh(),query(this.el).trigger("input").trigger("change"),a.finish()}}moveCaret2end(){setTimeout(()=>{this.el.setSelectionRange(this.el.value.length,this.el.value.length)},0)}}!function(r){if(r){r.w2globals=function(){var t,i;t=window,i={w2ui:w2ui,w2utils:w2utils,query:query,w2locale:w2locale,w2event:w2event,w2base:w2base,w2popup:w2popup,w2alert:w2alert,w2confirm:w2confirm,w2prompt:w2prompt,Dialog:Dialog,w2tooltip:w2tooltip,w2menu:w2menu,w2color:w2color,w2date:w2date,Tooltip:Tooltip,w2toolbar:w2toolbar,w2sidebar:w2sidebar,w2tabs:w2tabs,w2layout:w2layout,w2grid:w2grid,w2form:w2form,w2field:w2field},Object.keys(i).forEach(e=>{t[e]=i[e]})};let e=String(void 0).split("?")[1]||"";function t(t,i){if(r.isPlainObject(t)){let e;return"w2form"==i&&(e=new w2form(t),0<this.find(".w2ui-field").length&&(e.formHTML=this.html())),"w2grid"==i&&(e=new w2grid(t)),"w2layout"==i&&(e=new w2layout(t)),"w2sidebar"==i&&(e=new w2sidebar(t)),"w2tabs"==i&&(e=new w2tabs(t)),"w2toolbar"==i&&(e=new w2toolbar(t)),0!==r(this).length&&e.render(this[0]),e}{let e=w2ui[r(this).attr("name")];return e?0<arguments.length?(e[t]&&e[t].apply(e,Array.prototype.slice.call(arguments,1)),this):e:null}}"globals"!=e&&"globals="!=e.substr(0,8)||r.w2globals(),r.fn.w2render=function(e){0<r(this).length&&("string"==typeof e&&w2ui[e]&&w2ui[e].render(r(this)[0]),"object"==typeof e&&e.render(r(this)[0]))},r.fn.w2destroy=function(e){"string"==typeof(e=!e&&0<this.length?this.attr("name"):e)&&w2ui[e]&&w2ui[e].destroy(),"object"==typeof e&&e.destroy()},r.fn.w2field=function(s,l){return 0!==arguments.length?this.each((e,t)=>{let i=r(t).data("w2field");return i,i=new w2field(s,l),i.render(t),i}):r(this).data("w2field")},r.fn.w2form=function(e){return t.call(this,e,"w2form")},r.fn.w2grid=function(e){return t.call(this,e,"w2grid")},r.fn.w2layout=function(e){return t.call(this,e,"w2layout")},r.fn.w2sidebar=function(e){return t.call(this,e,"w2sidebar")},r.fn.w2tabs=function(e){return t.call(this,e,"w2tabs")},r.fn.w2toolbar=function(e){return t.call(this,e,"w2toolbar")},r.fn.w2popup=function(e){0<this.length?w2popup.template(this[0],null,e):e.url&&w2popup.load(e)},r.fn.w2marker=function(){let i=Array.from(arguments);return Array.isArray(i[0])&&(i=i[0]),r(this).each((e,t)=>{w2utils.marker(t,i)})},r.fn.w2tag=function(i,s){return this.each((e,t)=>{null!=i||null!=s?("object"==typeof i?s=i:(s=s??{}).html=i,w2tooltip.show(t,s)):w2tooltip.hide()})},r.fn.w2overlay=function(i,s){return this.each((e,t)=>{null!=i||null!=s?("object"==typeof i?s=i:s.html=i,Object.assign(s,{class:"w2ui-white",hideOn:["doc-click"]}),w2tooltip.show(t,s)):w2tooltip.hide()})},r.fn.w2menu=function(i,s){return this.each((e,t)=>{"object"==typeof i&&(s=i),"object"==typeof i?s=i:s.items=i;w2menu.show(t,s)})},r.fn.w2color=function(s,l){return this.each((e,t)=>{let i=w2color.show(t,s);"function"==typeof l&&i.select(l)})}}}(window.jQuery),function(t,i){if("function"==typeof define&&define.amd)return define(()=>i);if("undefined"!=typeof exports){if("undefined"!=typeof module&&module.exports)return exports=module.exports=i;t=exports}t&&Object.keys(i).forEach(e=>{t[e]=i[e]})}(self,{w2ui:w2ui,w2utils:w2utils,query:query,w2locale:w2locale,w2event:w2event,w2base:w2base,w2popup:w2popup,w2alert:w2alert,w2confirm:w2confirm,w2prompt:w2prompt,Dialog:Dialog,w2tooltip:w2tooltip,w2menu:w2menu,w2color:w2color,w2date:w2date,Tooltip:Tooltip,w2toolbar:w2toolbar,w2sidebar:w2sidebar,w2tabs:w2tabs,w2layout:w2layout,w2grid:w2grid,w2form:w2form,w2field:w2field});